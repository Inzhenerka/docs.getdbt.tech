name: Docs pages diff badge (gist)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "website/**"
      - "**/*.md"
      - "**/*.mdx"
  push:
    branches: ["test-badge"]  # change to "current" for prod
    paths:
      - "website/**"
      - "**/*.md"
      - "**/*.mdx"
  workflow_dispatch:

permissions:
  contents: read
jobs:
  make-diff-badge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare branches

      - name: Count added and removed .md + .mdx files
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          
          # Determine base branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_BRANCH="current"  # Default base branch for push events
            HEAD_SHA="${{ github.sha }}"
            BASE_SHA="origin/${BASE_BRANCH}"
          fi
          
          echo "Comparing HEAD ($HEAD_SHA) against BASE ($BASE_SHA)"
          
          # Fetch base branch for comparison
          git fetch origin ${BASE_BRANCH}:refs/remotes/origin/${BASE_BRANCH} 2>/dev/null || echo "Base branch ${BASE_BRANCH} not found"
          
          # Count added files (files in HEAD but not in BASE, or new files)
          ADDED=$(git diff --name-status --diff-filter=A "$BASE_SHA" "$HEAD_SHA" -- "website/docs/**/*.md" "website/docs/**/*.mdx" "website/snippets/**/*.md" "website/snippets/**/*.mdx" 2>/dev/null | wc -l | tr -d ' \n' || echo 0)
          
          # Count removed files (files in BASE but not in HEAD)
          REMOVED=$(git diff --name-status --diff-filter=D "$BASE_SHA" "$HEAD_SHA" -- "website/docs/**/*.md" "website/docs/**/*.mdx" "website/snippets/**/*.md" "website/snippets/**/*.mdx" 2>/dev/null | wc -l | tr -d ' \n' || echo 0)
          
          # Also count renamed files as added+removed
          RENAMED=$(git diff --name-status --diff-filter=R "$BASE_SHA" "$HEAD_SHA" -- "website/docs/**/*.md" "website/docs/**/*.mdx" "website/snippets/**/*.md" "website/snippets/**/*.mdx" 2>/dev/null | wc -l | tr -d ' \n' || echo 0)
          
          echo "Added: $ADDED"
          echo "Removed: $REMOVED"
          echo "Renamed: $RENAMED"
          
          # For renamed files, count as both added and removed
          ADDED=$((ADDED + RENAMED))
          REMOVED=$((REMOVED + RENAMED))
          
          echo "added=${ADDED}" >> "$GITHUB_OUTPUT"
          echo "removed=${REMOVED}" >> "$GITHUB_OUTPUT"
          
          # Format message for badge (e.g., "+5 -2" or "+3" or "-1")
          if [ "$ADDED" -gt 0 ] && [ "$REMOVED" -gt 0 ]; then
            MESSAGE="+${ADDED} -${REMOVED}"
          elif [ "$ADDED" -gt 0 ]; then
            MESSAGE="+${ADDED}"
          elif [ "$REMOVED" -gt 0 ]; then
            MESSAGE="-${REMOVED}"
          else
            MESSAGE="0"
          fi
          
          echo "message=${MESSAGE}" >> "$GITHUB_OUTPUT"
          echo "Badge message: ${MESSAGE}"

      - name: Update diff badge JSON in Gist
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: 618181e9b63cd72035c4eef203705cec
          filename: docs_diff.json
          label: docs changes
          message: ${{ steps.diff.outputs.message }}
          color: ${{ steps.diff.outputs.added > steps.diff.outputs.removed && 'success' || steps.diff.outputs.removed > steps.diff.outputs.added && 'critical' || 'informational' }}
          cacheSeconds: 300

