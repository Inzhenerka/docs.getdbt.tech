name: Docs total pages badge (test)

on:
  push:
    branches: ["test-badge"]
    paths:
      - "website/**"
      - "**/*.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  compute-badge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Ensure jq
        run: |
          command -v jq >/dev/null || { sudo apt-get update && sudo apt-get install -y jq; }

      - name: Count total (.md in website/docs + website/snippets)
        id: counts
        run: |
          mkdir -p .badges
          count() { [[ -d "$1" ]] && find "$1" -type f -iname "*.md" \
            -not -path "*/_partials/*" -not -path "*/_includes/*" -not -path "*/_components/*" | wc -l | tr -d ' ' || echo 0; }
          DOCS=$(count website/docs)
          SNIPPETS=$(count website/snippets)
          echo "total=$((DOCS + SNIPPETS))" >> "$GITHUB_OUTPUT"

      - name: Write badge JSON
        run: |
          jq -n --arg label "docs total" --arg message "${{ steps.counts.outputs.total }}" \
            '{schemaVersion:1,label:$label,message:$message,color:"informational",cacheSeconds:3600}' \
            > .badges/total.json

      - name: Commit to test-badge
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .badges/total.json
          git diff --cached --quiet && { echo "No changes."; exit 0; }
          git commit -m "chore(badges): update docs total (test)"
          git push origin HEAD:test-badge
