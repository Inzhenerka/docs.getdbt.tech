## Устранение неполадок {#troubleshooting}

Если эндпоинт PrivateLink был создан и настроен в <Constant name="cloud" />, но соединение по‑прежнему не работает, проверьте следующие элементы сетевой конфигурации, чтобы убедиться, что запросы и ответы могут успешно маршрутизироваться между <Constant name="cloud" /> и базовым сервисом.

### Конфигурация {#configuration}

Начните с конфигурации:

<Expandable alt_header="1. Группа безопасности NLB">

Сетевой балансировщик нагрузки (Network Load Balancer, NLB), связанный с VPC Endpoint Service, либо не должен иметь привязанной Security Group, либо Security Group должна содержать правило, разрешающее запросы из соответствующих *приватных CIDR-диапазонов* <Constant name="cloud" />. Обратите внимание, что это отличается от статических публичных IP-адресов, указанных на странице <Constant name="cloud" /> Connection. Служба поддержки dbt может предоставить корректные приватные CIDR-диапазоны по запросу.
   - **Note***: Чтобы проверить, является ли это причиной проблемы, можно временно добавить правило разрешения `10.0.0.0/8` — это должно обеспечить соединение до тех пор, пока правило не будет уточнено до более узкого CIDR-диапазона.

</Expandable>

<Expandable alt_header="2. Слушатель NLB и целевая группа">

Проверьте, что к NLB подключён Listener, который соответствует порту, к которому пытается подключиться <Constant name="cloud" />. У этого Listener должно быть настроено действие, перенаправляющее трафик в Target Group с таргетами, указывающими на ваш бэкенд‑сервис. По крайней мере один (а лучше — все) из этих таргетов должен иметь статус **Healthy**. Нездоровые (Unhealthy) таргеты могут указывать на то, что сам бэкенд‑сервис действительно находится в некорректном состоянии, либо на то, что сервис защищён Security Group, которая не разрешает запросы от NLB.

</Expandable>

<Expandable alt_header="3. Балансировка нагрузки между зонами">

Убедитесь, что для вашего NLB включена опция _Cross-zone load balancing_ (проверьте вкладку **Attributes** у NLB в консоли AWS). Если она отключена, а зоны, к которым подключён <Constant name="cloud" />, не совпадают с зонами, в которых запущен сервис, запросы могут маршрутизироваться некорректно. Включение cross-zone load balancing также делает соединение более устойчивым в случае отказа одной из зон. При использовании cross-zone connectivity могут взиматься дополнительные платы за передачу данных, однако для запросов от <Constant name="cloud" /> они, как правило, будут минимальными.

</Expandable>

<Expandable alt_header="4. Таблицы маршрутизации и ACL">

Если все вышеперечисленное проверено, возможно, что запросы неправильно маршрутизируются внутри частной сети. Это может быть связано с неправильной конфигурацией таблиц маршрутизации VPC или списков контроля доступа. Проверьте эти настройки с вашим сетевым администратором, чтобы убедиться, что запросы могут быть маршрутизированы от сервиса конечной точки VPC к поддерживающему сервису и что ответ может быть возвращен к сервису конечной точки VPC. Один из способов проверить это — создать конечную точку VPC в другой VPC в вашей сети, чтобы проверить, что подключение работает независимо от подключения dbt.

</Expandable>

### Мониторинг {#monitoring}

Чтобы помочь изолировать проблемы с подключением по PrivateLink от <Constant name="cloud" />, можно использовать несколько источников мониторинга для проверки активности запросов. Для того чтобы в мониторинге появились данные, запросы сначала должны быть отправлены на endpoint. Обратитесь в службу поддержки dbt, чтобы узнать, когда выполнялось тестирование подключения, или запросить новые попытки подключения. Используйте это время, чтобы сопоставить его с активностью в следующих источниках мониторинга.

<Expandable alt_header="Мониторинг сервиса конечной точки VPC">

В консоли AWS перейдите в VPC -> Endpoint Services. Выберите тестируемый сервис конечной точки и нажмите вкладку **Monitoring**. Обновите временной интервал, чтобы включить время, когда были отправлены попытки тестового подключения. Если есть активность в графиках _New connections_ и _Bytes processed_, значит, запросы были получены сервисом конечной точки, что предполагает, что конечная точка dbt маршрутизируется правильно.

</Expandable>

<Expandable alt_header="Мониторинг NLB">

В консоли AWS перейдите в EC2 -> Load Balancers. Выберите тестируемый сетевой балансировщик нагрузки (NLB) и нажмите вкладку **Monitoring**. Обновите временной интервал, чтобы включить время, когда были отправлены попытки тестового подключения. Если есть активность в графиках _New flow count_ и _Processed bytes_, значит, запросы были получены NLB от сервиса конечной точки, что предполагает, что слушатель NLB, целевая группа и группа безопасности настроены правильно.

</Expandable>

<Expandable alt_header="Логи потоков VPC">

Логи потоков VPC могут предоставить различную полезную информацию о запросах, маршрутизируемых через ваши VPC, хотя иногда их может быть сложно найти и интерпретировать. Логи потоков могут записываться либо в S3, либо в CloudWatch Logs, поэтому определите доступность этих логов для вашей VPC и запросите их соответствующим образом. Логи потоков записывают идентификатор сетевого интерфейса (ENI), исходный и целевой IP и порт, а также информацию о том, был ли запрос принят или отклонен группой безопасности и/или сетевым ACL. Это может быть полезно для понимания, прибыл ли запрос на определенный сетевой интерфейс и был ли этот запрос принят, что может выявить чрезмерно ограничительные правила. Для получения дополнительной информации о доступе и интерпретации логов потоков VPC см. соответствующую [документацию AWS](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html).

</Expandable>