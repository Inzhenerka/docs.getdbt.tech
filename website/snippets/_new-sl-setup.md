import SLEnvVars from '/snippets/_sl-env-vars.md';

Вы должны входить в группу **Owner** и иметь соответствующую [лицензию](/docs/cloud/manage-access/seats-and-users) и [права доступа](/docs/cloud/manage-access/enterprise-permissions), чтобы администрировать Semantic Layer на уровне окружения и проекта.

- **Тарифы Enterprise+ и Enterprise**:
  - лицензия Developer с правами Account Admin, или
  - роль Owner с лицензией Developer и назначенными правами Project Creator, Database Admin или Admin.
- **Тариф Starter**: роль Owner с лицензией Developer.
- **Free trial**: вы находитесь на бесплатном пробном периоде тарифа Starter в роли Owner, что означает, что у вас есть доступ к dbt Semantic Layer.

### 1. Выберите окружение

Выберите окружение, в котором вы хотите включить Семантический слой:

1. Перейдите в **Account settings** в навигационном меню.
2. В разделе **Settings** нажмите **Projects** и выберите конкретный проект, для которого вы хотите включить Semantic Layer.
3. На странице **Project details** перейдите в раздел **Semantic Layer**. Выберите **Configure Semantic Layer**.

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/new-sl-configure.png" width="70%" title="Раздел Semantic Layer на странице «Project details»"/>

4. На странице **Настройка конфигурации Семантического слоя** выберите окружение развертывания, которое вы хотите для Семантического слоя, и нажмите **Сохранить**. Это предоставляет администраторам гибкость в выборе окружения, в котором будет включен Семантический слой.

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-select-env.png" width="75%" title="Выберите окружение развертывания, относительно которого будет выполняться ваш Semantic Layer."/>

### 2. Настройка учетных данных и создание токенов

Существует два варианта настройки <Constant name="semantic_layer" /> с использованием API‑токенов:

- [Добавить учетные данные и создать сервисные токены](#add-a-credential-and-create-service-tokens)
- [Настроить учетные данные для разработки и создать персональные токены](#configure-development-credentials-and-create-a-personal-token)

#### Добавить учетные данные и создать сервисные токены

Первый вариант — использовать [сервисные токены](/docs/dbt-cloud-apis/service-tokens) для аутентификации. Эти токены связаны с учетными данными платформы данных, которые вы предварительно настраиваете. Настроенные учетные данные используются для выполнения запросов, которые Semantic Layer отправляет к вашей платформе данных.

Эти учетные данные контролируют физический доступ к данным, к которым обращается Семантический слой, и все политики доступа, установленные на платформе данных для этих учетных данных, будут соблюдаться.

| Возможность | Тариф Starter | Тарифы Enterprise+ и Enterprise |
| --- | --- | --- |
| Service tokens | Можно создать несколько service token, связанных с одними учётными данными (credential). | Можно использовать несколько credential и привязывать к каждому из них несколько service token. Обратите внимание, что один service token нельзя привязать более чем к одному credential. |
| Credentials per project | Один credential на проект. | Можно [добавить несколько](#4-add-more-credentials) credential на проект. |
| Link multiple service tokens to a single credential | ✅ | ✅ |

*Если вы используете тариф Starter и вам нужно добавить больше credential, рассмотрите возможность перехода на [Enterprise+ или Enterprise plan](https://www.getdbt.com/contact). Все пользователи Enterprise могут обратиться к разделу [Add more credentials](#4-add-more-credentials) для получения подробных инструкций по добавлению нескольких credential.*

##### 1. Выберите среду развертывания
   - После выбора deployment environment вы увидите страницу **Credentials & service tokens**.  
   - Нажмите кнопку **Add Semantic Layer credential**.  

##### 2. Настройте учетные данные
   - В разделе **1. Add credentials** введите учетные данные, специфичные для вашей data platform, которые Semantic Layer будет использовать.
   - Используйте учетные данные с минимально необходимыми правами. Semantic Layer требует доступ на чтение к схемам, содержащим dbt models, используемые в ваших semantic models для downstream‑приложений.
   - <SLEnvVars/>

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-add-credential.png" width="55%" title="Добавьте учётные данные и сопоставьте их с service token." />

##### 3. Создайте или свяжите сервисные токены
   - Если у вас есть права на создание service token, после добавления credential вы увидите опцию [**Map new service token**](/docs/use-dbt-semantic-layer/setup-sl#map-service-tokens-to-credentials). Укажите имя token, установите разрешения **Semantic Layer Only** и **Metadata Only**, затем нажмите **Save**.  
   - После генерации token вы больше не сможете просмотреть его значение, поэтому обязательно сохраните его в безопасном месте.
   - Если у вас нет доступа к созданию service token, вы увидите сообщение с предложением связаться с администратором, чтобы он создал token для вас. Администраторы могут создавать и связывать token по мере необходимости.
   <Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-credential-no-service-token.png" width="70%" title="Если у вас нет прав на создание service token, вы можете создать credential и попросить администратора создать token для вас." />

:::info
- Тариф Starter позволяет создавать несколько service token, привязанных к одному базовому credential, однако в каждом проекте может быть только один credential.
- Все тарифы Enterprise позволяют [добавлять несколько credential](#4-add-more-credentials) и связывать их с service token для более гибкого управления доступом.

<a href="https://www.getdbt.com/contact">Запишитесь на бесплатную live‑демонстрацию</a>, чтобы узнать о всех возможностях <Constant name="cloud" /> Enterprise и более высоких тарифов.
:::

#### Настройте учетные данные для разработки и создайте персональный токен

Использование [personal access tokens (PATs)](/docs/dbt-cloud-apis/user-tokens) также поддерживается как метод аутентификации для dbt <Constant name="semantic_layer" />. Это позволяет использовать аутентификацию на уровне пользователя и снижает необходимость совместного использования token между пользователями. При аутентификации с помощью PAT запросы выполняются с использованием ваших персональных development credentials.

Чтобы использовать PAT в <Constant name="semantic_layer" />:

1. Настройте ваши development credentials.
   1. Нажмите на имя вашего аккаунта в левом нижнем меню и перейдите в **Account settings** > **Credentials**.
   2. Выберите ваш проект.  
   3. Нажмите **Edit**.  
   4. Перейдите в раздел **Development credentials** и введите необходимые данные.  
   5. Нажмите **Save**.
2. [Создайте personal access token](/docs/dbt-cloud-apis/user-tokens). Обязательно скопируйте token.  

Сгенерированный PAT можно использовать как метод аутентификации для <Constant name="semantic_layer" /> [API](/docs/dbt-cloud-apis/sl-api-overview) и [integrations](/docs/cloud-integrations/avail-sl-integrations). 

### 3. Просмотрите сведения о подключении
1. Вернитесь на страницу **Project details**, чтобы посмотреть параметры подключения для downstream‑инструментов.
2. Скопируйте и передайте соответствующим командам Environment ID, service или personal token, Host, а также имя service или personal token для настройки подключения BI‑инструментов. Если ваш инструмент использует GraphQL API, сохраните информацию о GraphQL API host вместо JDBC URL.

    Для информации о том, как подключиться к другим интеграциям, обратитесь к [Доступные интеграции](/docs/cloud-integrations/avail-sl-integrations).

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-configure-example.png" width="50%" title="После настройки вам будут предоставлены данные для подключения, которые можно использовать для подключения ваших downstream‑инструментов." />

### 4. Добавьте дополнительные учетные данные <Lifecycle status="managed_plus,managed" />
Все тарифные планы <Constant name="cloud" /> Enterprise при желании позволяют добавлять несколько учетных данных и сопоставлять их с service tokens. Это обеспечивает более детальный контроль и настраиваемый доступ для разных команд, после чего эти учетные данные можно передавать соответствующим командам для настройки подключения BI‑инструментов. Эти учетные данные управляют физическим доступом к базовым данным, к которым обращается Semantic Layer.

Мы рекомендуем настраивать учетные данные и сервисные токены в соответствии с вашими командами и их ролями. Например, создавайте токены или учетные данные, которые соответствуют потребностям вашей команды, например, предоставляя доступ к схемам, связанным с финансами, для финансовой команды.

<Expandable alt_header="Соображения по связыванию учетных данных">

- Администраторы могут связывать несколько сервисных токенов с одними учетными данными в проекте, но каждый сервисный токен может быть связан только с одними учетными данными на проект.
- Когда вы отправляете запрос через API, сервисный токен связанного учетного данных будет следовать политикам доступа к представлениям и таблицам, используемым для построения ваших запросов семантического слоя.
- <SLEnvVars/>
</Expandable>

#### 1. Добавление дополнительных учетных данных
- После настройки окружения на странице **Credentials & service tokens** нажмите кнопку **Add Semantic Layer credential**, чтобы создать несколько учетных данных и сопоставить их с service token. <br />
- В разделе **1. Add credentials** заполните поля учетных данных для вашей платформы данных. Мы рекомендуем использовать учетные данные с правами “read-only”.
   <Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-add-credential.png" width="55%" title="Добавьте учётные данные и сопоставьте их с service token." />

#### 2. Сопоставление service tokens с учетными данными
- В разделе **2. Map new service token** [сопоставьте service token с учетными данными](/docs/use-dbt-semantic-layer/setup-sl#map-service-tokens-to-credentials), которые вы настроили на предыдущем шаге. <Constant name="cloud" /> автоматически выбирает необходимый набор разрешений для service token (Semantic Layer Only и Metadata Only).
- Чтобы добавить еще один service token в процессе настройки, нажмите **Add Service Token**. 
- Позже вы можете привязать дополнительные service tokens к тем же учетным данным на странице **Semantic Layer Configuration Details**. Чтобы добавить еще один service token к существующей конфигурации Semantic Layer, нажмите **Add service token** в разделе **Linked service tokens**.
- Нажмите **Save**, чтобы связать service token с учетными данными. Не забудьте скопировать и надежно сохранить service token, так как после генерации он больше не будет доступен для просмотра.
<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-credentials-service-token.png" width="90%" title="Используйте страницу конфигурации, чтобы управлять несколькими credential или привязывать/отвязывать service token для более тонкого контроля."/>

#### 3. Удалите учетные данные
- Чтобы удалить учетные данные, вернитесь на страницу **Учетные данные и сервисные токены**.
- В разделе **Связанные сервисные токены** нажмите **Редактировать** и выберите **Удалить учетные данные**, чтобы удалить учетные данные.

   Когда вы удаляете учетные данные, любые сервисные токены, связанные с этими учетными данными в проекте, перестанут работать и будут недоступны для конечных пользователей.

### Удаление конфигурации
Вы можете удалить всю конфигурацию Semantic Layer для проекта. Обратите внимание, что удаление конфигурации Semantic Layer приведёт к удалению всех учётных данных и отвязке всех service token от проекта. Также это приведёт к тому, что все запросы к Semantic Layer будут завершаться с ошибкой.

Следуйте этим шагам, чтобы удалить конфигурацию Семантического слоя для проекта:

1. Перейдите на страницу **Детали проекта**.
2. В разделе **Семантический слой** выберите **Удалить Семантический слой**.
3. Подтвердите удаление, нажав **Да, удалить семантический слой** в всплывающем окне подтверждения.

Чтобы повторно включить настройку Семантического слоя dbt в будущем, вам нужно будет воссоздать ваши конфигурации, следуя [предыдущим шагам](#set-up-dbt-semantic-layer). Если ваши семантические модели и метрики все еще находятся в вашем проекте, никаких изменений не требуется. Если вы их удалили, вам нужно будет снова настроить конфигурации YAML.

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-delete-config.png" width="90%" title="Удаление конфигурации семантического слоя для проекта."/>

## Дополнительная конфигурация

 Следующие дополнительные гибкие конфигурации для учетных данных Семантического слоя.

### Сопоставьте сервисные токены с учетными данными
- После настройки вашего окружения вы можете сопоставить дополнительные сервисные токены с теми же учетными данными, если у вас есть необходимые [разрешения](/docs/cloud/manage-access/about-user-access#permission-sets).
- Перейдите на страницу **Учетные данные и сервисные токены** и нажмите кнопку **+Добавить сервисный токен** в разделе **Связанные сервисные токены**.
- Введите имя сервисного токена и выберите необходимый набор разрешений (Только Семантический слой и Только метаданные).
- Нажмите **Сохранить**, чтобы связать сервисный токен с учетными данными.
- Не забудьте скопировать и сохранить сервисный токен в безопасном месте, так как он не будет доступен для просмотра после генерации.

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-add-service-token.gif" title="Сопоставьте дополнительные сервисные токены с учетными данными." />

### Отвяжите сервисные токены
- Отвяжите сервисный токен от учетных данных, нажав **Отвязать** в разделе **Связанные сервисные токены**. Если вы попытаетесь выполнить запрос к Семантическому слою с отвязанными учетными данными, вы столкнетесь с ошибкой в вашем BI-инструменте, так как не будет сопоставлен действительный токен.

### Управление со страницы сервисных токенов
**Просмотр учетных данных из сервисного токена**
- Просмотрите ваши учетные данные Семантического слоя напрямую, перейдя на страницу **API токены**, а затем **Сервисные токены**.
- Выберите сервисный токен, чтобы просмотреть учетные данные, с которыми он связан. Это полезно, если вы хотите узнать, какие сервисные токены сопоставлены с учетными данными в вашем проекте.

#### Создайте новый сервисный токен
- На странице **Сервисные токены** создайте новый сервисный токен и сопоставьте его с учетными данными (при условии, что разрешение на семантический слой существует). Это полезно, если вы хотите создать новый сервисный токен и напрямую сопоставить его с учетными данными в вашем проекте.
- Убедитесь, что выбрали правильный набор разрешений для сервисного токена (Только Семантический слой и Только метаданные).

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/sl-create-service-token-page.png" width="100%" title="Создайте новый сервисный токен и сопоставьте учетные данные напрямую на отдельной странице «Service tokens»."/>
