---
title: "Как начать работать со стратегиями ветвления в git и dbt"
description: "Как настроить dbt Cloud для распространённых стратегий работы с git"
slug: git-branching-strategies-with-dbt

authors: [christine_berger, carol_ohms, taylor_dunlap, steve_dowling]

tags: [analytics craft]
hide_table_of_contents: false

date: 2025-03-10
is_featured: true
---

Привет! Мы — Кристин и Кэрол, Resident Architects в dbt Labs. Наша повседневная работа
связана с тем, чтобы помогать командам достигать как технических, так и
бизнес-ориентированных целей. Работая с самым разным кругом клиентов — от
небольших стартапов до крупных корпораций — мы накопили ценный опыт в сопровождении
команд при внедрении архитектуры, которая решает их ключевые болевые точки.

Информация, которой мы собираемся поделиться, основана не только на нашем опыте —
мы регулярно сотрудничаем с другими экспертами, такими как Taylor Dunlap и
Steve Dowling, которые внесли значительный вклад в формирование этих рекомендаций.
Их работа заключается в том, чтобы быть критически важным мостом для команд между
реализацией и бизнес-результатами, в конечном итоге помогая выработать
целостное техническое видение через выявление проблем и решений.

**Зачем мы здесь?**  
Мы помогаем командам с архитектурой dbt, которая включает в себя инструменты,
процессы и конфигурации, используемые для начала разработки и деплоя с dbt.
За кулисами происходит множество решений, направленных на стандартизацию этих
составляющих — и во многом они определяются тем, каким мы хотим видеть процесс
разработки. Стремление к ***идеальному*** workflow часто приводит к тому, что
команды застревают в бесконечном планировании и обсуждениях, что замедляет или даже
полностью останавливает разработку. Если вам это знакомо, мы надеемся, что наши
рекомендации помогут вам чувствовать себя увереннее и начать разблокировать
разработку — даже если пока не всё до конца продумано!

<!-- truncate -->

Есть три основных инструмента, которые играют ключевую роль в разработке с dbt:
- **Репозиторий**  
  Содержит код, который мы хотим изменить или задеплоить, а также инструменты для
  управления процессами изменений.
- **Платформа данных**  
  Содержит данные для входных источников (загружаемые из других систем), а также
  базы данных и схемы для выходных данных, плюс управление правами доступа к объектам.
- **Проект dbt**  
  Помогает управлять процессами разработки и деплоя нашего кода на платформу данных
  (и делает ещё много полезных вещей!)

<Lightbox src="/img/blog/2025-01-28-git-branching-strategies-and-dbt/1_dbt_eco.png" title="dbt's relationship to git and the data platform" width="85%" />

Независимо от того, как именно вы **определяете** workflow разработки, следующие
ключевые этапы присутствуют всегда:
- **Development**: как команда вносит и тестирует изменения в код
- **Quality Assurance**: как команда убеждается, что изменения работают корректно и дают ожидаемый результат
- **Promotion**: как изменения продвигаются на следующий этап
- **Deployment**: как изменения становятся доступными для других

В этой статье мы в основном сосредоточимся на git и репозитории, на том, как код
соотносится с заполнением платформы данных, а также на типичных конфигурациях dbt,
которые мы используем для этого. По ходу статьи мы будем постоянно привязываться
к этапам workflow разработки.

## Почему стоит сосредоточиться на git
Контроль версий (и git в частности) является фундаментом современной разработки —
как с dbt, так и без него. Он упрощает совместную работу команд любого размера и
позволяет легко отслеживать изменения кода в проекте. Понимание этих управляемых
процессов и того, как выглядит код на каждом этапе, значительно упрощает понимание
того, как нам нужно настраивать платформу данных и dbt.

## ⭐️ Как «просто начать» ⭐️
В этой статье мы довольно глубоко разбираем темы, связанные с git — это будет
полезно, если ваша команда уже знакома с некоторыми вариантами и хочет лучше
разобраться в компромиссах. Если же вы только начинаете и у вас нет чётких
предпочтений, **мы рекомендуем начать с Direct Promotion**.

Direct Promotion — это основа всех стратегий ветвления в git. Она хорошо работает
при базовом знании git, требует минимальных настроек и легко эволюционирует в
другую стратегию, если и когда это потребуется вашей команде. Мы понимаем, что
такая рекомендация может вызывать мысли в духе «а что если?». **Мы предлагаем
думать о начале с direct promotion как о пошиве костюма**. Разработчики могут
носить его, пока вы разбираетесь с подгонкой, и это гораздо более информативный
шаг вперёд, потому что позволяет увидеть, как костюм работает *в движении* —
а итоговые корректировки могут сильно отличаться от тех, которые казались нужными,
когда он был статичен.

Лучшее в подходе «просто начать» — это то, что позже изменить конфигурации dbt
под другую git-стратегию совсем несложно (и мы это рассмотрим), поэтому не стоит
воспринимать это как критическое решение, которое приведёт к месяцам поломанной
разработки из‑за перенастройки, если вы сразу выберете неидеальный вариант.
На самом деле смена git-стратегии в dbt Cloud может занять всего несколько минут.

## Стратегии ветвления
После первого коммита в репозитории всегда есть одна основная ветка по умолчанию,
которая обычно называется `main` или `master` — в дальнейших примерах мы будем
использовать `main`. Ветка `main` *всегда является конечной точкой*, куда мы
стремимся доставить изменения, и чаще всего соответствует понятию «production» —
этот термин вы тоже будете видеть дальше.

***Главный вопрос — как мы хотим выстроить процесс доставки изменений от разработки
до `main`***. Этот процесс должен учитывать все этапы workflow: development,
quality assurance, promotion и deployment. **Стратегии ветвления** определяют,
как именно выглядит этот процесс. В dbt мы не изобретаем велосипед — существует
множество общепринятых стратегий, которые были описаны, реализованы, доработаны
и протестированы как минимум за последнее десятилетие.

Существует две основные стратегии, которые охватывают все варианты ветвления:
**Direct Promotion** и **Indirect Promotion**. Начнём с их общего описания:

- Что это за стратегия?
- Как workflow разработки выглядит для команды?
- Какие **правила ветвления и вспомогательные механизмы репозитория** используются?
- Как обычно настраивается **dbt Cloud** для этой стратегии?
- Как ветки и процессы dbt сопоставляются с **платформой данных**?

В конце мы сравним стратегии и ответим на часто задаваемые вопросы.

:::info[Перед началом]

Существует *множество* способов настроить каждый инструмент (особенно dbt) под
ваши задачи. Описания стратегий ниже намеренно сфокусированы на том, что мы считаем
минимальным стандартом, позволяющим быстро запустить команды в работу. Это стартовые
конфигурации и практики, которые легко изменить и доработать позже. Расширение этих
настроек мы оставляем на усмотрение читателя!

:::

## Direct promotion

**Direct promotion** означает, что в репозитории есть только одна долгоживущая ветка —
в нашем случае `main`. Вот как выглядит workflow для этой стратегии:

<Lightbox src="/img/blog/2025-01-28-git-branching-strategies-and-dbt/2_direct_git.png" title="Direct promotion branching strategy" width="85%" />

### Как выглядит workflow разработки для команды?

Структура:

- `feature` — индивидуальная ветка разработчика, где выполняются изменения по задаче
- `main` — ветка с «production»-версией кода

Workflow:

- **Development**: я создаю ветку `feature` от `main`, чтобы вносить изменения, тестировать их и проводить первичную самопроверку
- **Quality Assurance**: я открываю pull request, сравнивающий `feature` с `main`, который затем проходит ревью у коллег (обязательно), стейкхолдеров или предметных экспертов (SME). В этой стратегии мы настоятельно рекомендуем привлекать стейкхолдеров или SME к PR, потому что следующий шаг меняет `main`.
- **Promotion**: после всех необходимых одобрений и проверок я мержу изменения в `main`
- **Deployment**: после мержа и деплоя `main` другие могут видеть и использовать мои изменения

### Правила ветвления и вспомогательные механизмы репозитория
Как минимум мы рекомендуем настроить:
- **Защиту ветки** `main` ([например, такие настройки в GitHub](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches)), с требованиями:
  - все изменения через pull request (никаких прямых коммитов в `main`)
  - pull request должен иметь как минимум одно одобрение ревьюера
- **Шаблон PR** ([например, наш базовый шаблон PR](https://docs.getdbt.com/blog/analytics-pull-request-template)) для `feature` → `main`

### Процессы и окружения dbt Cloud

Вот та же стратегия ветвления, но уже с процессами dbt Cloud, которые мы хотим
использовать:

<Lightbox src="/img/blog/2025-01-28-git-branching-strategies-and-dbt/3_direct_dbt_deployment.png" title="Direct Promotion strategy with dbt cloud processes denoted" width="85%" />

Чтобы создать jobs из диаграммы, нам нужны окружения dbt Cloud. Типовые конфигурации
для этого сценария выглядят так:

| Environment Name | [Environment Type](https://docs.getdbt.com/docs/dbt-cloud-environments#types-of-environments) | [Deployment Type](https://docs.getdbt.com/docs/deploy/deploy-environments#staging-environment) | Base Branch | Will handle… |
| --- | --- | --- | --- | --- |
| Development | development | - | `main` | Операции в IDE (включая создание feature-веток) |
| Continuous Integration | deployment | General | `main` | CI job |
| Production | deployment | Production | `main` | Deployment job |

### Организация платформы данных
Теперь нужно определить, где именно мы будем создавать объекты на платформе данных.
Для этого настраиваются параметры **database** и **schema** в окружениях.
Вот та же диаграмма, но с отображением того, как объекты из веток попадают на
платформу данных:

<Lightbox src="/img/blog/2025-01-28-git-branching-strategies-and-dbt/4_direct_data_population.png" title="Direct Promotion strategy with branch relations to data platform objects" width="85%" />

Дополним ранее созданную таблицу окружений dbt Cloud сопоставлением с платформой данных:

| Environment Name | **Database** | **Schema** |
| --- | --- | --- |
| Development | `development` | Задаётся пользователем в Profile Settings > Credentials |
| Continuous Integration | `development` | Любое безопасное значение, например `dev_ci` (даже не обязательно, чтобы схема существовала). Job всё равно переопределит схему под конкретный PR. |
| Production | `production` | `analytics` |

:::note
Здесь показаны конфигурации окружений, однако база данных по умолчанию задаётся на
более высоком уровне — в **[connection](https://docs.getdbt.com/docs/cloud/connect-data-platform/about-connections)** (это обязательная настройка окружения). *Deployment*-окружения при необходимости могут переопределять database из connection.
:::

### Пример direct promotion

*В этом примере Steve использует термин “QA” для обозначения окружения, которое
собирает изменённый код из pull request’ов feature-веток. Это эквивалент нашего
окружения “Continuous Integration” — отличный пример того, как можно выбирать
названия, наиболее понятные вашей команде!*

<LoomVideo id="59c71a9549b5497f99ef86622aad945e" />

*(Перевод продолжения статьи можно предоставить отдельным сообщением, так как объём очень большой.)*
