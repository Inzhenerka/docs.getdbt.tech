---
title: "Работы по непрерывной интеграции в dbt Cloud"
sidebar_label: "CI работы"
description: "Узнайте, как создать и настроить проверки CI для тестирования изменений кода перед развертыванием в производственной среде."
---

Вы можете настроить [непрерывную интеграцию](/docs/deploy/continuous-integration) (CI) для запуска, когда кто-то открывает новый pull request (PR) в вашем репозитории dbt Git. Запуская и тестируя только _измененные_ модели, dbt Cloud обеспечивает максимальную эффективность и экономию ресурсов на вашей платформе данных.

## Предварительные требования
- У вас есть аккаунт dbt Cloud.
- Функции CI:
   - Для функций [параллельных проверок CI](/docs/deploy/continuous-integration#concurrent-ci-checks) и [умной отмены устаревших сборок](/docs/deploy/continuous-integration#smart-cancellation) ваш аккаунт dbt Cloud должен быть на [плане Team или Enterprise](https://www.getdbt.com/pricing/).
   - [SQL линтинг](/docs/deploy/continuous-integration#sql-linting) доступен на [релизных треках dbt Cloud](/docs/dbt-versions/cloud-release-tracks) и для аккаунтов dbt Cloud [Team или Enterprise](https://www.getdbt.com/pricing/). Вы должны иметь [настроенный SQLFluff](/docs/deploy/continuous-integration#to-configure-sqlfluff-linting) в вашем проекте.
- Функции [Расширенного CI](/docs/deploy/advanced-ci):
   - Для функции [сравнения изменений](/docs/deploy/advanced-ci#compare-changes) ваш аккаунт dbt Cloud должен быть на [плане Enterprise](https://www.getdbt.com/pricing/) и иметь включенные функции Расширенного CI. Пожалуйста, попросите вашего [администратора dbt Cloud включить](/docs/cloud/account-settings#account-access-to-advanced-ci-features) эту функцию для вас. После включения опция **dbt compare** станет доступной в настройках CI работы.
- Настройте [соединение с вашим Git провайдером](/docs/cloud/git/git-configuration-in-dbt-cloud). Эта интеграция позволяет dbt Cloud запускать работы от вашего имени для триггера работ.
   - Если вы используете нативную интеграцию с [GitLab](/docs/cloud/git/connect-gitlab), вам нужен платный или самохостингованный аккаунт, который включает поддержку вебхуков GitLab и [токенов доступа к проекту](https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html). Если вы используете GitLab Free, запросы на слияние будут триггерить CI работы, но обновления статуса CI работ (успех или неудача работы) не будут возвращаться в GitLab.

## Настройка CI работ {#set-up-ci-jobs}

dbt Labs рекомендует создавать вашу CI работу в отдельной [среде развертывания](/docs/deploy/deploy-environments#create-a-deployment-environment) dbt Cloud, которая подключена к тестовой базе данных. Наличие отдельной среды, предназначенной для CI, обеспечит лучшую изоляцию между вашими временными схемами CI и сборками производственных данных. Кроме того, иногда командам необходимо, чтобы их CI работы запускались, когда PR создается для ветки, отличной от основной. Если ваша команда поддерживает тестовую ветку как часть процесса выпуска, наличие отдельной среды позволит вам установить [пользовательскую ветку](/faqs/Environments/custom-branch-settings), и, соответственно, работа CI в этой выделенной среде будет запускаться только при создании PR для указанной пользовательской ветки. Чтобы узнать больше, обратитесь к разделу [Начало работы с CI тестами](/guides/set-up-ci).

Чтобы упростить создание CI работ, многие параметры на странице **CI работа** установлены на значения по умолчанию, которые рекомендует использовать dbt Labs. Если вы не хотите использовать значения по умолчанию, вы можете изменить их.

1. На странице вашей среды развертывания нажмите **Создать работу** > **Работа по непрерывной интеграции**, чтобы создать новую CI работу.

2. Параметры в разделе **Настройки работы**:
    - **Имя работы** &mdash; Укажите имя для этой CI работы.
    - **Описание** &mdash; Укажите описание для CI работы.
    - **Среда** &mdash; По умолчанию это будет установлено на среду, из которой вы создали CI работу. Используйте выпадающий список, чтобы изменить значение по умолчанию.

3. Параметры в разделе **Git триггер**:
    - **Запуск по pull requests** &mdash; По умолчанию это включено. Каждый раз, когда разработчик открывает pull request или отправляет коммит в существующий pull request, эта работа будет запущена.
      - **Запуск на черновом pull request** &mdash; Включите эту опцию, если вы хотите также запускать работу каждый раз, когда разработчик открывает черновой pull request или отправляет коммит в этот черновой pull request.

4. Параметры в разделе **Настройки выполнения**:
    - **Команды** &mdash; По умолчанию это включает команду `dbt build --select state:modified+`. Это информирует dbt Cloud о том, чтобы строить только новые или измененные модели и их зависимые объекты. Важно, что сравнение состояния может происходить только при выбранной отложенной среде для сравнения состояния. Нажмите **Добавить команду**, чтобы добавить больше [команд](/docs/deploy/job-commands), которые вы хотите вызвать при выполнении этой работы.
    - **Линтинг** &mdash; Включите эту опцию, чтобы dbt [линтил SQL файлы](/docs/deploy/continuous-integration#sql-linting) в вашем проекте как первый шаг в `dbt run`. Если эта проверка вызывает ошибку, dbt может либо **Остановить выполнение при ошибке**, либо **Продолжить выполнение при ошибке**.
    - **dbt compare**<Lifecycle status="enterprise" /> &mdash; Включите эту опцию, чтобы сравнить последнее примененное состояние производственной среды (если оно существует) с последними изменениями из pull request и определить, в чем заключаются эти различия. Чтобы включить сравнение на уровне записей и анализ первичного ключа, вы должны добавить [ограничение первичного ключа](/reference/resource-properties/constraints) или [тест уникальности](/reference/resource-properties/data-tests#unique). В противном случае вы получите сообщение об ошибке "Отсутствует первичный ключ" в dbt Cloud.

      Чтобы просмотреть отчет о сравнении, перейдите на вкладку [Сравнить](/docs/deploy/run-visibility#compare-tab) в деталях выполнения работы. Резюме отчета также доступно из pull request в вашем Git провайдере (см. [пример отчета CI](#example-ci-report)).

      :::info Советы по оптимизации
      Когда вы включаете флажок **dbt compare**, вы можете настроить команду сравнения для оптимизации вашей CI работы. Например, если у вас есть большие модели, которые требуют много времени для сравнения, вы можете исключить их, чтобы ускорить процесс, используя [`--exclude` флаг](/reference/node-selection/exclude). Обратитесь к [пользовательским командам сравнения изменений](/docs/deploy/job-commands#compare-changes-custom-commands) для получения дополнительной информации.

      Кроме того, если вы установите [`event_time`](/reference/resource-configs/event-time) в ваших моделях/семенах/снимках/источниках, это позволит вам сравнивать совпадающие диапазоны дат между таблицами, фильтруя по перекрывающимся диапазонам дат. Это полезно для более быстрого рабочего процесса CI или настройки пользовательской выборки.
      :::

    - **Сравнить изменения с окружением (Отложение)** &mdash; По умолчанию это установлено на **Производственную** среду, если вы ее создали. Эта опция позволяет dbt Cloud проверять состояние кода в PR по сравнению с кодом, работающим в отложенной среде, чтобы проверять только измененный код, а не строить полную таблицу или весь DAG.

      :::info
      Более старые версии dbt Cloud позволяют вам откладывать только на конкретную работу, а не на среду. Отложение на работу сравнивает состояние с кодом проекта, который был выполнен в последнем успешном запуске отложенной работы. Отложение на среду более эффективно, так как dbt Cloud будет сравнивать с представлением проекта (которое хранится в `manifest.json`) последнего успешного запуска работы развертывания, который выполнялся в отложенной среде. Учитывая _все_ [работы развертывания](/docs/deploy/deploy-jobs), которые выполняются в отложенной среде, dbt Cloud получит более точное, актуальное состояние представления проекта.
      :::

    - **Тайм-аут выполнения** &mdash; Отменить CI работу, если время выполнения превышает значение тайм-аута. Вы можете использовать эту опцию, чтобы помочь гарантировать, что проверка CI не потребляет слишком много ресурсов вашего хранилища. Если вы включите опцию **dbt compare**, значение тайм-аута по умолчанию устанавливается на `3600` (один час), чтобы предотвратить длительные сравнения.

5. (по желанию) Параметры в разделе **Расширенные настройки**:
    - **Переменные окружения** &mdash; Определите [переменные окружения](/docs/build/environment-variables), чтобы настроить поведение вашего проекта, когда выполняется эта CI работа. Вы можете указать, что CI работа выполняется в _Тестовой_ или _CI_ среде, установив переменную окружения и изменив код вашего проекта, чтобы он вел себя по-разному в зависимости от контекста. Команды часто обрабатывают только подмножество данных для CI запусков, используя переменные окружения для ветвления логики в коде своего проекта dbt.
    - **Имя цели** &mdash; Определите [имя цели](/docs/build/custom-target-names). Аналогично **Переменным окружения**, эта опция позволяет вам настроить поведение проекта. Вы можете использовать эту опцию, чтобы указать, что CI работа выполняется в _Тестовой_ или _CI_ среде, установив имя цели и изменив код вашего проекта, чтобы он вел себя по-разному в зависимости от контекста.
    - **Версия dbt** &mdash; По умолчанию это установлено на наследование [версии dbt](/docs/dbt-versions/core) из среды. dbt Labs настоятельно рекомендует не изменять значение по умолчанию. Эта опция для изменения версии на уровне работы полезна только при обновлении проекта до следующей версии dbt; в противном случае несоответствующие версии между средой и работой могут привести к путанице.
    - **Потоки** &mdash; По умолчанию это установлено на 4 [потока](/docs/core/connect-data-platform/connection-profiles#understanding-threads). Увеличьте количество потоков, чтобы увеличить параллелизм выполнения моделей.
    - **Генерировать документацию при выполнении** &mdash; Включите это, если вы хотите [сгенерировать документацию проекта](/docs/collaborate/build-and-view-your-docs) при выполнении этой работы. Это отключено по умолчанию, так как тестирование генерации документации на каждой проверке CI не является рекомендуемой практикой.
    - **Проверка свежести источников** &mdash; Включите эту опцию, чтобы вызвать команду `dbt source freshness` перед выполнением этой CI работы. Обратитесь к [Свежести источников](/docs/deploy/source-freshness) для получения дополнительной информации.

   <Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/create-ci-job.png" width="90%" title="Пример страницы CI работы в интерфейсе dbt Cloud"/>

### Пример проверки CI в pull request {#example-ci-check}
Следующий пример представляет собой проверку CI в pull request GitHub. Зеленая галочка означает, что сборка и тесты dbt прошли успешно. Нажав на раздел dbt Cloud, вы перейдете к соответствующему запуску CI в dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-github-pr.png" width="60%" title="Пример проверки CI в pull request GitHub"/>

### Пример отчета CI в pull request <Lifecycle status="preview" /> {#example-ci-report}
Следующий пример представляет собой отчет CI в pull request GitHub, который отображается, когда опция **dbt compare** включена для CI работы. Он отображает общее резюме моделей, которые изменились в результате pull request.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-github-ci-report.png" width="75%" title="Пример комментария отчета CI в pull request GitHub"/>

## Запуск CI работы с помощью API

Если вы не используете нативную интеграцию dbt Cloud с [GitHub](/docs/cloud/git/connect-github), [GitLab](/docs/cloud/git/connect-gitlab) или [Azure DevOps](/docs/cloud/git/connect-azure-devops), вы можете использовать [Административный API](/docs/dbt-cloud-apis/admin-cloud-api), чтобы запустить CI работу. Однако dbt Cloud не будет автоматически удалять временную схему за вас. Это связано с тем, что автоматическое удаление зависит от входящих вебхуков от Git провайдеров, которые доступны только через нативные интеграции.

### Предварительные требования

- У вас есть аккаунт dbt Cloud.
- Для функций [Параллельных проверок CI](/docs/deploy/continuous-integration#concurrent-ci-checks) и [Умной отмены устаревших сборок](/docs/deploy/continuous-integration#smart-cancellation) ваш аккаунт dbt Cloud должен быть на [плане Team или Enterprise](https://www.getdbt.com/pricing/).

1. Настройте CI работу с помощью [Create Job](/dbt-cloud/api-v2#/operations/Create%20Job) API конечной точки, используя `"job_type": ci` или из [интерфейса dbt Cloud](#set-up-ci-jobs).
2. Вызовите [Trigger Job Run](/dbt-cloud/api-v2#/operations/Trigger%20Job%20Run) API конечную точку, чтобы запустить CI работу. Вы должны включить оба этих поля в полезную нагрузку:
   - Укажите идентификатор pull request (PR), используя одно из этих полей:

      - `github_pull_request_id`
      - `gitlab_merge_request_id`
      - `azure_devops_pull_request_id`
      - `non_native_pull_request_id` (например, BitBucket)
   - Укажите `git_sha` или `git_branch`, чтобы нацелиться на правильный коммит или ветку для выполнения работы.

## Семантические проверки в CI  <Lifecycle status="team,enterprise" />

Автоматически тестируйте свои семантические узлы (метрики, семантические модели и сохраненные запросы) во время кодовых ревью, добавляя проверки в вашем CI задании, гарантируя, что любые изменения кода, внесенные в модели dbt, не нарушают эти метрики.

Для этого добавьте команду `dbt sl validate --select state:modified+` в CI работу. Это гарантирует проверку измененных семантических узлов и их зависимостей.

<Lightbox src="/img/docs/dbt-cloud/deployment/sl-ci-job.png" width="90%" title="Семантические проверки в рабочем процессе CI" />

#### Преимущества
- Тестирование семантических узлов в CI работе поддерживает отложение и выбор семантических узлов.
- Это позволяет выявлять проблемы на ранних этапах разработки и предоставлять высококачественные данные вашим конечным пользователям.
- Семантическая проверка выполняет объясняющий запрос в хранилище данных для семантических узлов, чтобы гарантировать, что сгенерированный SQL будет выполняться.
- Для семантических узлов и моделей, которые не являются зависимыми от измененных моделей, dbt Cloud откладывает на производственные модели.

### Настройка семантических проверок в вашей CI работе
Чтобы узнать, как это настроить, выполните следующие шаги:

1. Перейдите на страницу **Настройки работы** и нажмите **Редактировать**.
2. Добавьте команду `dbt sl validate --select state:modified+` в разделе **Команды** в разделе **Настройки выполнения**. Команда использует выбор состояния и отложение для выполнения проверки на любых семантических узлах, находящихся ниже изменений модели. Чтобы сократить время работы, мы рекомендуем запускать CI только на измененных семантических моделях.
3. Нажмите **Сохранить**, чтобы сохранить изменения.

В следующем разделе описаны дополнительные команды и случаи использования, такие как проверка всех семантических узлов, проверка конкретных семантических узлов и т.д.

<Lightbox src="/img/docs/dbt-cloud/deployment/ci-dbt-sl-validate-downstream.jpg" width="90%" title="Проверка семантических узлов, находящихся ниже изменений модели, в вашей CI работе." />

### Случаи использования

Используйте или комбинируйте различные селекторы или команды для проверки семантических узлов в вашей CI работе. Семантические проверки в CI поддерживают следующие случаи использования:

<Expandable alt_header="Семантические узлы, находящиеся ниже изменений модели (рекомендуется)"> 

Чтобы проверить семантические узлы, которые находятся ниже изменения модели, добавьте две команды в разделе **Настройки выполнения** вашей работы:

```bash
dbt build --select state:modified+
dbt sl validate --select state:modified+
```

- Первая команда строит измененные модели.
- Вторая команда проверяет семантические узлы, находящиеся ниже измененных моделей.

Перед выполнением семантических проверок dbt Cloud должен построить измененные модели. Этот процесс гарантирует, что семантические узлы ниже будут проверены с использованием схемы CI через API семантического слоя dbt.

Для семантических узлов и моделей, которые не являются зависимыми от измененных моделей, dbt Cloud откладывает на производственные модели.

<Lightbox src="/img/docs/dbt-cloud/deployment/ci-dbt-sl-validate-downstream.jpg" width="90%" title="Проверка семантических узлов, находящихся ниже изменений модели, в вашей CI работе." />

</Expandable>

<Expandable alt_header="Измененные семантические узлы или узлы, на которые влияют измененные узлы.">

Чтобы проверить только измененные семантические узлы, используйте следующую команду (с [выбором состояния](/reference/node-selection/syntax#state-selection)):

```bash
dbt sl validate --select state:modified+
```

<Lightbox src="/img/docs/dbt-cloud/deployment/ci-dbt-sl-validate-modified.jpg" width="90%" title="Используйте выбор состояния для проверки измененных моделей определения метрик в вашей CI работе." />

Это будет проверять только семантические узлы. Он будет использовать состояние отложенного, установленное в вашей работе оркестрации, откладывая на ваши производственные модели.

</Expandable>

<Expandable alt_header="Выбор конкретных семантических узлов">

Используйте синтаксис селектора, чтобы выбрать _конкретные_ семантические узлы, которые вы хотите проверить:

```bash
dbt sl validate --select metric:revenue
```

<Lightbox src="/img/docs/dbt-cloud/deployment/ci-dbt-sl-validate-select.jpg" width="90%" title="Используйте выбор состояния для проверки измененных моделей определения метрик в вашей CI работе." />

В этом примере CI работа будет проверять выбранный семантический узел `metric:revenue`. Чтобы выбрать несколько семантических узлов, используйте синтаксис селектора: `dbt sl validate --select metric:revenue metric:customers`.

Если вы не укажете селектор, dbt Cloud проверит все семантические узлы в вашем проекте.

</Expandable>

<Expandable alt_header="Выбор всех семантических узлов">

Чтобы проверить _все_ семантические узлы в вашем проекте, добавьте следующую команду, чтобы отложить на вашу производственную схему при генерации запросов проверки в хранилище:

   ```bash
   dbt sl validate
   ```

<Lightbox src="/img/docs/dbt-cloud/deployment/ci-dbt-sl-validate-all.jpg" width="90%" title="Проверка всех семантических узлов в вашей CI работе, добавив команду: 'dbt sl validate' в настройки выполнения вашей работы." />

</Expandable>

## Устранение неполадок

<FAQ path="Troubleshooting/gitlab-webhook"/>

<DetailsToggle alt_header="Временные схемы не удаляются">
Если ваши временные схемы не удаляются после слияния или закрытия PR, это обычно указывает на одну из следующих проблем:
- Вы переопределили макрос <code>generate_schema_name</code>, и он не использует <code>dbt_cloud_pr_</code> в качестве префикса.

Чтобы решить эту проблему, измените ваш макрос так, чтобы имя временной схемы PR содержало требуемый префикс. Например:

- ✅ Имя временной схемы PR содержит префикс <code>dbt_cloud_pr_</code> (например, <code>dbt_cloud_pr_123_456_marketing</code>).
- ❌ Имя временной схемы PR не содержит префикс <code>dbt_cloud_pr_</code> (например, <code>marketing</code>).

Макрос создает схему, но нет моделей dbt, записывающих в эту схему. dbt Cloud не удаляет временные схемы, в которые не было записано в результате выполнения модели dbt.

</DetailsToggle>

<DetailsToggle alt_header="Сообщения об ошибках, относящиеся к схемам из предыдущих PR">

Если вы получаете сообщение об ошибке, связанное со схемой, ссылающееся на <i>предыдущий</i> PR, это обычно указывает на то, что вы не используете производственную работу для вашего отложения и вместо этого используете <i>само</i>. Если предыдущий PR уже был слит, схема предыдущего PR могла быть удалена к моменту запуска CI работы для текущего PR.

Чтобы исправить эту проблему, выберите успешный запуск производственной работы для отложения вместо самоотложения.

</DetailsToggle>

<DetailsToggle alt_header="Неудачные запуски производственной работы на этапе 'Клонирование репозитория Git'">

dbt Cloud может проверять только коммиты, которые принадлежат оригинальному репозиторию. dbt Cloud <i>не может</i> проверять коммиты, которые принадлежат форку этого репозитория.

Если вы получаете следующее сообщение об ошибке на этапе **Клонирование репозитория Git** вашего запуска работы:

```
Сообщение об ошибке:
Клонирование в '/tmp/jobs/123456/target'...
Репозиторий успешно клонирован.
Проверка на e845be54e6dc72342d5a8f814c8b3316ee220312...>
Не удалось проверить на указанной ревизии.
git checkout e845be54e6dc72342d5a8f814c8b3316ee220312
fatal: ссылка не является деревом: e845be54e6dc72342d5a8f814c8b3316ee220312
```

Проверьте, что ваш PR не пытается слить с использованием коммита, который принадлежит форку репозитория, прикрепленного к вашему проекту dbt.
</DetailsToggle>

<DetailsToggle alt_header="Статус PR для CI работы остается в 'ожидании' в Azure DevOps после завершения работы">

Когда вы запускаете CI работу, статус pull request должен отображаться как `ожидание`, пока он ждет обновления от dbt. После завершения CI работы dbt отправляет статус в Azure DevOps (ADO), и статус изменится на `успешно` или `неудачно`.

Если статус не обновляется после выполнения работы, проверьте, есть ли какие-либо политики веток git, блокирующие ADO от получения этих обновлений.

Одной из потенциальных проблем являются **Условия сброса** в политике ветки репозитория ADO. Если вы включите флажок **Сбросить статус, когда есть новые изменения** (в разделе **Условия сброса**), это может предотвратить dbt от обновления ADO о статусе выполнения вашей CI работы.
Вы можете найти соответствующую информацию здесь:
- [Проверки статуса Azure DevOps Services](https://learn.microsoft.com/en-us/azure/devops/repos/git/branch-policies?view=azure-devops&tabs=browser#status-checks)
- [Pull Request Azure DevOps Services застрял в ожидании обновления статуса](https://support.hashicorp.com/hc/en-us/articles/18670331556627-Azure-DevOps-Services-Pull-Request-Stuck-Waiting-on-Status-Update-from-Terraform-Cloud-Enterprise-Run)
- [Статус pull request](https://learn.microsoft.com/en-us/azure/devops/repos/git/pull-request-status?view=azure-devops#pull-request-status)

</DetailsToggle>