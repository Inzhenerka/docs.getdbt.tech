---
title: "Merge jobs в dbt"
sidebar_label: "Merge jobs"
description: "Узнайте, как запускать выполнение dbt‑джоба при слиянии pull request в Git."
---

# Merge jobs в dbt <Lifecycle status="self_service,managed" />

Вы можете настроить merge job для реализации workflow непрерывного развертывания (continuous deployment, CD) в <Constant name="cloud" />. Merge job запускает dbt‑джоб в момент, когда кто‑то сливает Git pull request в production. Такой workflow создаёт бесшовный процесс разработки, при котором изменения в коде автоматически обновляют production‑данные. Кроме того, этот workflow можно использовать для запуска `dbt compile`, чтобы обновлять manifest окружения — это делает последующие запуски CI‑джобов более производительными.

Используя CD в <Constant name="cloud" />, вы можете воспользоваться deferral, чтобы собирать только изменённую модель и все downstream‑изменения. При использовании merge jobs состояние обновляется практически мгновенно, что позволяет всегда иметь самую актуальную информацию о состоянии в [<Constant name="explorer" />](/docs/explore/explore-projects).

:::note Triggering merge jobs in monorepos
Если у вас monorepo с несколькими dbt‑проектами, слияние одного pull request в одном из проектов приведёт к запуску джобов для всех проектов, подключённых к этому monorepo. Чтобы избежать этого, вы можете использовать отдельные target‑ветки для каждого проекта (например, `main-project-a`, `main-project-b`) и тем самым разделить CI‑триггеры.
:::

## Prerequisites
- У вас есть аккаунт <Constant name="cloud" />. 
- У вас настроено [подключение к вашему провайдеру <Constant name="git" />](/docs/cloud/git/git-configuration-in-dbt-cloud). Эта интеграция позволяет <Constant name="cloud" /> запускать джобы от вашего имени для их триггера.
   - Если вы используете нативную интеграцию [GitLab](/docs/cloud/git/connect-gitlab), вам потребуется платный или self‑hosted аккаунт с поддержкой GitLab webhooks и [project access tokens](https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html). Если вы используете GitLab Free, merge request будут запускать CI‑джобы, но обновления статуса CI‑джобов (успех или ошибка выполнения) не будут передаваться обратно в GitLab.
- Для deferral (который используется по умолчанию) убедитесь, что в окружении, на которое вы ссылаетесь, был как минимум один успешный запуск джоба.

1. На странице вашей среды развертывания нажмите **Создать задание** > **Задание на объединение**.
1. Опции в разделе **Настройки задания**:
    - **Имя задания** &mdash; Укажите имя для задания на объединение.
    - **Описание** &mdash; Предоставьте описание задания.
    - **Среда** &mdash; По умолчанию установлена среда, из которой вы создали задание.
1. В разделе **Git-триггер** опция **Запуск при слиянии** включена по умолчанию. Каждый раз, когда PR сливается (в базовую ветку, настроенную в среде) в вашем Git-репозитории, это задание будет запускаться.
1. Опции в разделе **Настройки выполнения**:
    - **Команды** &mdash; По умолчанию включает команду `dbt build --select state:modified+`. Это информирует dbt Cloud о необходимости строить только новые или измененные модели и их зависимые элементы. Важно, что сравнение состояния может происходить только тогда, когда выбрана отложенная среда для сравнения состояния. Нажмите **Добавить команду**, чтобы добавить больше [команд](/docs/deploy/job-commands), которые вы хотите вызвать при выполнении этого задания.
    - **Сравнить изменения с** &mdash; По умолчанию установлено сравнение изменений со средой, из которой вы создали задание. Эта опция позволяет dbt Cloud проверять состояние кода в PR по сравнению с кодом, работающим в отложенной среде, чтобы проверять только измененный код, вместо построения полной таблицы или всего DAG. Чтобы изменить настройки по умолчанию, вы можете выбрать **Без отложенного выполнения**, **Это задание** для самопроверки или выбрать другую среду.
1. (опционально) Опции в разделе **Расширенные настройки**:
    - **Переменные среды** &mdash; Определите [переменные среды](/docs/build/environment-variables), чтобы настроить поведение вашего проекта при выполнении этого задания.
    - **Имя цели** &mdash; Определите [имя цели](/docs/build/custom-target-names). Подобно переменным среды, эта опция позволяет настроить поведение проекта.
    - **Тайм-аут выполнения** &mdash; Отмените это задание, если время выполнения превышает значение тайм-аута.
    - **Версия dbt** &mdash; По умолчанию установлено наследование [версии dbt](/docs/dbt-versions/core) из среды. dbt Labs настоятельно рекомендует не изменять настройку по умолчанию. Эта опция изменения версии на уровне задания полезна только при обновлении проекта до следующей версии dbt; в противном случае несоответствие версий между средой и заданием может привести к запутанному поведению.
    - **Потоки** &mdash; По умолчанию установлено 4 [потока](/docs/core/connect-data-platform/connection-profiles#understanding-threads). Увеличьте количество потоков, чтобы увеличить параллелизм выполнения модели.

1. На странице среды развертывания нажмите **Create job** > **Merge job**.
1. Параметры в разделе **Job settings**:
    - **Job name** — укажите имя для merge‑джобы.
    - **Description** — добавьте описание джобы.
    - **Environment** — по умолчанию установлено значение среды, из которой вы создаёте эту джобу.
1. В разделе **<Constant name="git" /> trigger** опция **Run on merge** включена по умолчанию. Каждый раз, когда PR сливается (в базовую ветку, настроенную в среде) в вашем репозитории <Constant name="git" />, эта джоба будет автоматически запускаться.
1. Параметры в разделе **Execution settings**:
    - **Commands** — по умолчанию здесь указан командный вызов `dbt build --select state:modified+`. Он сообщает <Constant name="cloud" />, что нужно собирать только новые или изменённые модели и все их downstream‑зависимости. Важно учитывать, что сравнение состояния возможно только при выборе отложенной (deferred) среды, с которой будет выполняться сравнение. Нажмите **Add command**, чтобы добавить дополнительные [commands](/docs/deploy/job-commands), которые должны выполняться при запуске этой джобы.
    - **Compare changes against** — по умолчанию изменения сравниваются со средой, из которой вы создали эту джобу. Эта опция позволяет <Constant name="cloud" /> сравнивать состояние кода в PR с кодом, выполняющимся в отложенной среде, чтобы проверять только изменённый код, а не пересобирать всю таблицу или весь DAG. Чтобы изменить настройки по умолчанию, вы можете выбрать **No deferral**, **This job** для самодеферации или указать другую среду.
1. (необязательно) Параметры в разделе **Advanced settings**:
    - **Environment variables** — определите [environment variables](/docs/build/environment-variables), чтобы настроить поведение проекта при выполнении этой джобы.
    - **Target name** — задайте [target name](/docs/build/custom-target-names). Аналогично переменным окружения, эта опция позволяет настраивать поведение проекта.
    - **Run timeout** — отменить выполнение джобы, если время выполнения превышает заданный лимит.
    - **dbt version** — по умолчанию используется версия [dbt version](/docs/dbt-versions/core), унаследованная от среды. dbt Labs настоятельно рекомендует не менять это значение. Возможность задать версию dbt на уровне джобы полезна только при обновлении проекта на следующую версию dbt; в противном случае несовпадение версий между средой и джобой может привести к непредсказуемому поведению.
    - **Threads** — по умолчанию установлено значение 4 [threads](/docs/core/connect-data-platform/connection-profiles#understanding-threads). Увеличьте количество потоков, чтобы повысить параллельность выполнения моделей.

## Проверка событий push в Git

Задания на объединение требуют событий push, поэтому убедитесь, что они включены у вашего Git-провайдера, особенно если у вас уже есть существующая интеграция с Git. Однако для новой настройки интеграции вы можете пропустить эту проверку, так как события push обычно включены по умолчанию.

Задачи слияния (merge jobs) требуют событий push, поэтому убедитесь, что они включены у вашего провайдера <Constant name="git" />, особенно если у вас уже существует интеграция с <Constant name="git" />. Однако при настройке новой интеграции эту проверку можно пропустить, так как события push обычно включены по умолчанию.

Следующий пример показывает, когда события push уже установлены в GitHub:

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-github-push-events.png" title="Пример включенной опции Pushes в настройках GitHub"/>

</Expandable>

<Expandable alt_header="Пример GitLab" >

Следующий пример показывает, когда события push уже установлены в GitLab:

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-gitlab-push-events.png" title="Пример включенной опции Push events в настройках GitLab"/>

</Expandable>

<Expandable alt_header="Пример Azure DevOps" >

Следующий пример показывает создание нового триггера **Code pushed** в Azure DevOps. Создайте новую подписку на сервисные хуки, если события push не были установлены:

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-azuredevops-new-event.png" title="Пример создания нового триггера для push-событий в Azure DevOps"/>

</Expandable>