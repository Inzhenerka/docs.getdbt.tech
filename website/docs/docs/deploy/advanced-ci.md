---
title: "Расширенная CI"
id: "advanced-ci"
sidebar_label: "Расширенная CI"
description: "Расширенная CI позволяет разработчикам сравнивать изменения, демонстрируя изменения, которые вносит код."
image: /img/docs/dbt-cloud/example-ci-compare-changes-tab.png
---

# Продвинутый CI <Lifecycle status="managed,managed_plus" />

[Процессы непрерывной интеграции](/docs/deploy/continuous-integration) помогают повысить управление и улучшить качество данных. Кроме того, для этих CI задач вы можете использовать функции Расширенной CI, такие как [сравнение изменений](#compare-changes), которые предоставляют детали об изменениях между тем, что в настоящее время находится в вашей производственной среде, и последним коммитом pull-запроса, давая вам возможность наблюдать, как изменения данных зависят от изменений в коде. Анализируя изменения данных, которые вносит код, вы можете гарантировать, что всегда поставляете надежные продукты данных в процессе разработки.

:::info Как включить эту функцию

Вы можете включить Advanced CI в <Constant name="cloud" />. Подробнее о том, как включить эту функцию в вашей учетной записи <Constant name="cloud" />, см. в разделе [Account access to Advanced CI features](/docs/cloud/account-settings#account-access-to-advanced-ci-features).

:::

## Предварительные требования
- У вас есть учетная запись <Constant name="cloud" /> уровня Enterprise или Enterprise+.
- У вас включены [Advanced CI features](/docs/cloud/account-settings#account-access-to-advanced-features).
- Вы используете поддерживаемую платформу данных: BigQuery, Databricks, Postgres, Redshift или Snowflake. Поддержка дополнительных платформ данных появится в ближайшее время.

## Функция сравнения изменений {#compare-changes}

Для [CI jobs](/docs/deploy/ci-jobs), в которых включена опция [**dbt compare**](/docs/deploy/ci-jobs#set-up-ci-jobs), <Constant name="cloud" /> сравнивает изменения между последним применённым состоянием production‑окружения (по умолчанию используется deferral для снижения вычислительных затрат) и последними изменениями из pull request каждый раз, когда pull request открывается или в него отправляются новые коммиты.

dbt сообщает о различиях в сравнении в:

- **<Constant name="cloud" />** &mdash; Показывает изменения (если они есть) в первичных ключах, строках и столбцах данных на вкладке [Compare tab](/docs/deploy/run-visibility#compare-tab) на странице [Job run details](/docs/deploy/run-visibility#job-run-details).  
- **Pull request от вашего провайдера <Constant name="git" />** &mdash; Показывает сводку изменений в виде комментария <Constant name="git" />.

<Lightbox src="/img/docs/dbt-cloud/example-ci-compare-changes-tab.png" width="85%" title="Пример вкладки Сравнение" />

### Оптимизация сравнений

Когда в вашей модели указан столбец [`event_time`](/reference/resource-configs/event-time), сравнение изменений может оптимизировать сравнения, используя только пересекающийся временной интервал (то есть временной интервал, существующий как в CI, так и в производственной среде), помогая избежать неправильных изменений количества строк и возвращать результаты быстрее.

Это полезно в таких сценариях, как:
- **Подмножество данных в CI** &mdash; Когда CI строит только [подмножество данных](/best-practices/best-practice-workflows#limit-the-data-processed-when-in-development) (например, за последние 7 дней), сравнение изменений интерпретировало бы исключенные данные как "удаленные строки". Настройка `event_time` позволяет избежать этой проблемы, ограничивая сравнения пересекающимся временным интервалом, предотвращая ложные предупреждения об удалении данных, которые просто отфильтрованы в CI.
- **Более свежие данные в CI, чем в производстве** &mdash; Когда ваша CI задача включает более свежие данные, чем в производстве (потому что она выполнялась более недавно), сравнение изменений пометило бы дополнительные строки как "новые" данные, хотя это просто более свежие данные в CI. С настроенным `event_time` сравнение включает только общий временной интервал и корректно отражает фактические изменения в данных.

<Lightbox src="/img/docs/deploy/apples_to_apples.png" width="90%" title="event_time обеспечивает точное сравнение одного и того же временного среза данных между вашими средами CI и производства." />

## О кэшированных данных

После [сравнения изменений](#compare-changes) <Constant name="cloud" /> сохраняет кэш из не более чем 100 записей для каждой изменённой модели в целях предпросмотра. Благодаря кэшированию этих данных вы можете просматривать примеры изменённых данных, не запуская повторное сравнение с хранилищем данных каждый раз (что помогает снизить вычислительные затраты). Для отображения изменений <Constant name="cloud" /> использует кэшированную версию выборки записей данных. Эти записи данных запрашиваются из базы данных с использованием конфигурации подключения (например, пользователя, роли, service account и т.д.), которая задана в окружении CI‑job.

Вы контролируете, какие данные использовать. Это может включать синтетические данные, если данные до производства или разработки строго регулируются или являются конфиденциальными.

- Выбранные данные кэшируются в системах dbt Labs на срок до 30 дней. Никакие данные не сохраняются в системах dbt Labs после этого периода.
- Кэш зашифрован и хранится в Amazon S3 или Azure blob storage в регионе вашего аккаунта.
- dbt Labs не будет получать доступ к кэшированным данным из Расширенной CI для своей выгоды, и данные используются только для предоставления услуг по вашему указанию.
- Сторонние субподрядчики, кроме субподрядчиков по хранению, не будут иметь доступа к кэшированным данным.

Если вы получите доступ к выполнению CI задачи, которому более 30 дней, вы не сможете увидеть результаты сравнения. Вместо этого появится сообщение, указывающее, что данные устарели.

<Lightbox src="/img/docs/deploy/compare-expired.png" width="60%" title="Пример сообщения об устаревших данных на вкладке Сравнение" />

## Разрешения на подключение

Функция сравнения изменений использует те же учетные данные, что и задание CI, как это определено в окружении задания CI. Администратор <Constant name="cloud" /> должен убедиться, что клиентские учетные данные CI имеют корректные ограничения, поскольку все пользователи учетной записи клиента смогут просматривать результаты сравнения и кэшированные данные.

Если используется динамическое маскирование данных в хранилище данных, кэшированные данные больше не будут динамически маскированы в выводе Расширенной CI, в зависимости от разрешений пользователей, которые их просматривают. dbt Labs рекомендует ограничить доступ пользователей к немаскированным данным или рассмотреть возможность использования синтетических данных для функциональности тестирования Расширенной CI.

<Lightbox src="/img/docs/deploy/compare-credentials.png" width="60%" title="Пример учетных данных в пользовательских настройках" />

## Устранение неполадок

<Expandable alt_header="Compare Changes: модели CI должны находиться на одном хосте/подключении базы данных">

Функция Compare Changes работает только в том случае, если модели CI и production находятся на одном и том же хосте базы данных и используют одно и то же подключение. Compare Changes выполняет SQL-запросы в окружении текущего CI‑задания, чтобы сравнить модель CI (например, `ci.dbt_cloud_123.foo`) с production‑моделью (`prod.analytics.foo`).

Если CI‑задание использует defer на production‑задание, которое работает с другим подключением к базе данных или на другом хосте, функция Compare Changes не будет работать ожидаемым образом. Это происходит потому, что CI‑окружение не может получить доступ к production‑объектам или выполнять запросы к ним на другом хосте.

В следующем примере CI‑задание не может получить доступ к production‑модели для сравнения, так как они находятся на разных хостах базы данных:

  - CI‑задание dbt в окружении `ci.dbt_cloud_123.foo`, которое подключается к хосту `abc123.rds.amazonaws.com`
  - production‑задание dbt в окружении `prod.analytics.foo`, которое подключается к хосту `def456.rds.amazonaws.com`

</Expandable>
