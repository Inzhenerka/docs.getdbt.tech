---
title: "Планировщик задач"
id: "job-scheduler"
sidebar_label: "Планировщик задач"
description: "Планировщик задач dbt Cloud ставит в очередь запланированные или инициированные через API запуски, прежде чем подготовить задачу для входа в облачную платформу данных. Внедрите наблюдаемость в рабочие процессы трансформации с помощью встроенного планирования, ведения журналов и оповещений." 
tags: [scheduler]
---

Планировщик задач является основой выполнения задач в dbt Cloud, обеспечивая мощность и простоту в создании конвейеров данных как в контексте непрерывной интеграции, так и в производственной среде. Планировщик освобождает команды от необходимости строить и поддерживать собственную инфраструктуру и гарантирует своевременность и надежность трансформаций данных.

Планировщик позволяет как выполнение задач на основе cron, так и выполнение по событиям dbt команд в платформе данных пользователя. В частности, он обрабатывает:

- Выполнение задач dbt Cloud на основе cron, которые запускаются с предопределенной периодичностью
- Выполнение задач dbt Cloud по событиям, которые запускаются по завершении другой задачи ([триггер на завершение задачи](/docs/deploy/deploy-jobs#trigger-on-job-completion))
- Выполнение задач dbt Cloud CI, инициируемых при слиянии запроса на изменение в ветку ([слияние задач](/docs/deploy/merge-jobs))
- Выполнение задач dbt Cloud, инициируемых через API
- Выполнение задач dbt Cloud, инициируемых вручную пользователем для **Запустить сейчас**

Планировщик выполняет различные задачи, включая постановку задач в очередь, создание временных окружений для выполнения необходимых команд dbt, предоставление журналов для отладки и исправления, а также хранение артефактов dbt для прямого использования/ввода через API Discovery.

Планировщик обеспечивает выполнение dbt в тестовых и производственных средах, упрощая и повышая уверенность в рабочих процессах CI/CD и позволяя внедрять наблюдаемость и управление при развертывании dbt в масштабах.

## Условия планировщика

Ознакомьтесь с этими полезными терминами, чтобы лучше понять, как работает планировщик задач.

| Термин | Определение |
| --- | --- |
| Планировщик | Движок dbt Cloud, который управляет выполнением задач. Планировщик ставит в очередь запланированные или инициированные через API запуски задач, подготавливает окружение для выполнения команд задач в вашей облачной платформе данных и хранит и предоставляет журналы и артефакты, которые являются побочными продуктами выполнения. |
| Задача | Набор шагов выполнения, настроек и триггер для вызова команд dbt в проекте на облачной платформе данных пользователя. |
| Очередь задач | Очередь задач служит зоной ожидания для запусков задач, когда они запланированы или инициированы; запуски остаются в очереди до начала выполнения. Более конкретно, планировщик проверяет очередь на наличие запусков, которые должны быть выполнены, гарантирует, что запуск имеет право на начало, а затем подготавливает окружение с соответствующими настройками, учетными данными и командами для начала выполнения. Как только выполнение начинается, запуск покидает очередь. |
| Переизбыточная задача | Ситуация, когда продолжительность выполнения задачи, запланированной по cron, становится больше, чем частота расписания задачи, что приводит к тому, что очередь задач будет расти быстрее, чем планировщик сможет обрабатывать запуски задачи. |
| Деактивированная задача | Ситуация, когда задача достигла 100 последовательных неудачных запусков. |
| Время подготовки | Время, которое требуется dbt Cloud для создания краткосрочного окружения для выполнения команд задач в облачной платформе данных пользователя. Время подготовки наиболее значительно варьируется в начале часа, когда планировщик dbt Cloud испытывает большой трафик запусков. |
| Запуск | Одно уникальное выполнение задачи dbt. |
| Слот запуска | Слоты запуска контролируют количество задач, которые могут выполняться одновременно. У планов разработчиков фиксированное количество слотов запуска, в то время как у корпоративных и командных планов слоты запуска неограничены. Каждая выполняемая задача занимает слот запуска на время выполнения. <br /><br />Командные и разработческие планы ограничены одним проектом каждый. Для дополнительных проектов рассмотрите возможность перехода на [корпоративный план](https://www.getdbt.com/pricing/).| 
| Потоки | Когда dbt строит DAG проекта, он пытается параллелизовать выполнение, используя потоки. [Количество потоков](/docs/running-a-dbt-project/using-threads) — это максимальное количество путей через DAG, над которыми dbt может работать одновременно. По умолчанию количество потоков в задаче равно 4. |
| Время ожидания | Количество времени, которое dbt Cloud ждет перед запуском задачи, либо потому, что нет доступных слотов, либо потому, что предыдущий запуск той же задачи все еще выполняется. |

## Очередь планировщика

Планировщик ставит в очередь задачу развертывания для обработки, когда она инициируется для выполнения по [установленному расписанию](/docs/deploy/deploy-jobs#schedule-days), [завершенной задаче](/docs/deploy/deploy-jobs#trigger-on-job-completion), вызову API или вручную.

Перед началом выполнения задачи планировщик проверяет эти условия, чтобы определить, может ли запуск начать выполнение:

- **Есть ли доступный слот запуска на аккаунте?** &mdash; Если все слоты запуска заняты, запланированный запуск будет ждать. Время ожидания отображается в dbt Cloud. Если время ожидания длительное, [переход на корпоративный план](https://www.getdbt.com/contact/) может предоставить больше слотов запуска и позволить увеличить параллельность задач.

- **Есть ли уже выполняющийся запуск этой же задачи?** &mdash; Планировщик выполняет различные запуски одной и той же задачи dbt Cloud последовательно, чтобы избежать конфликтов сборки моделей. Если задача уже выполняется, запланированная задача будет ждать, и время ожидания будет отображаться в dbt Cloud.

Если есть доступный слот запуска и нет активно выполняющегося экземпляра задачи, планировщик подготовит задачу для выполнения в вашей облачной платформе данных. Эта подготовка включает в себя подготовку пода Kubernetes с установленной правильной версией dbt, настройку переменных окружения, загрузку учетных данных платформы данных и авторизацию Git-поставщика, среди других задач по настройке окружения. Время, необходимое для подготовки задачи, отображается как **Время подготовки** в пользовательском интерфейсе.

<Lightbox src="/img/docs/dbt-cloud/deployment/deploy-scheduler.jpg" width="85%" title="Обзор выполнения задачи dbt Cloud"/>

### Обработка CI задач
По сравнению с задачами развертывания, планировщик ведет себя иначе при обработке [задач непрерывной интеграции (CI)](/docs/deploy/continuous-integration). Он ставит в очередь задачу CI для обработки, когда она инициируется для выполнения через запрос на изменение в Git, и условия, которые планировщик проверяет, чтобы определить, может ли запуск начать выполнение, также отличаются:

- **Будет ли запуск CI занимать слот запуска?** &mdash; Запуски CI не занимают слоты запуска и никогда не блокируют производственные запуски.
- **Есть ли уже выполняющийся запуск этой же задачи?** &mdash; Запуски CI могут выполняться одновременно (параллельно). Запуски CI строятся в уникальные временные схемы, и проверки CI выполняются параллельно, чтобы повысить продуктивность команды. Коллеги никогда не должны ждать, чтобы получить обзор проверки CI.

### Обработка задач слияния
Когда инициируется _слияние_ запроса на изменение в Git, планировщик ставит в очередь [задачу слияния](/docs/deploy/merge-jobs) для обработки.

- **Будет ли запуск задачи слияния занимать слот запуска?** &mdash; Да, задачи слияния занимают слоты запуска.
- **Есть ли уже выполняющийся запуск этой же задачи?** &mdash; У задачи слияния может быть только один запуск в процессе выполнения в любой момент времени. Если есть несколько запланированных запусков, планировщик поставит в очередь самый последний запуск и отменит все остальные запуски. Если есть выполняющийся запуск, он будет ждать завершения, прежде чем поставить в очередь следующий запуск.

## Память задач

В dbt Cloud настройка для выделения памяти, доступной для задачи, определяется на уровне аккаунта и применяется ко всем задачам, выполняемым в аккаунте; лимит памяти не может быть настроен для каждой задачи отдельно. Если выполняемая задача достигает своего лимита памяти, запуск завершается с сообщением об ошибке "лимит памяти".

Задачи потребляют много памяти в следующих ситуациях:
- Было указано высокое количество потоков
- Пользовательские макросы dbt пытаются загрузить данные в память вместо того, чтобы передавать вычисления на облачную платформу данных
- Наличие задачи, которая генерирует документацию проекта dbt для большого и сложного проекта dbt. 
  * Чтобы предотвратить проблемы с исчерпанием памяти, мы рекомендуем генерировать документацию в отдельной задаче, выделенной для этой задачи, и удалить `dbt docs generate` из всех других задач. Это особенно важно для больших и сложных проектов.

Смотрите [архитектуру dbt Cloud](/docs/cloud/about-cloud/architecture) для получения диаграммы архитектуры и информации о том, как данные перемещаются.

## Отмена запусков для переизбыточных задач

:::info Планировщик не отменит задачи, инициированные через API 
Планировщик не отменит переизбыточные задачи, инициированные через [API](/docs/dbt-cloud-apis/overview).
:::

Планировщик dbt Cloud предотвращает засорение очереди слишком большим количеством запусков задач, отменяя ненужные. Если задача выполняется дольше, чем ее запланированная частота, очередь будет расти быстрее, чем планировщик сможет обрабатывать запуски, что приведет к постоянно растущей очереди с запусками, которые не нужно обрабатывать (называемыми _переизбыточными задачами_).

Планировщик предотвращает засорение очереди, отменяя запуски, которые не нужны, гарантируя, что в очереди в любой момент времени будет только один запуск задачи. Если в очередь ставится новый запуск, планировщик отменяет любой ранее запланированный запуск для этой задачи и отображает сообщение об ошибке.

<Lightbox src="/img/docs/dbt-cloud/deployment/run-error-message.jpg" width="85%" title="Отмененные запуски отображают сообщение об ошибке, объясняющее, почему запуск был отменен, и рекомендации"/>

Чтобы предотвратить переизбыточное планирование, пользователи должны предпринять действия, либо оптимизировав задачу, чтобы она выполнялась быстрее, либо изменив ее [расписание](/docs/deploy/deploy-jobs#schedule-days).

## Деактивация задач <Lifecycle status='beta' />

Чтобы снизить ненужное потребление ресурсов и уменьшить конкуренцию за слоты запуска в вашем аккаунте, dbt Cloud деактивирует [задачу развертывания](/docs/deploy/deploy-jobs) или [CI задачу](/docs/deploy/ci-jobs), если она достигает 100 последовательных неудачных запусков, и указывает на это с помощью баннеров. Когда это происходит, запланированные и инициированные для выполнения задачи больше не будут ставиться в очередь.

Чтобы повторно активировать деактивированную задачу, вы можете:
- Обновить настройки задачи, чтобы исправить проблему, и сохранить задачу (рекомендуется)
- Выполнить ручной запуск, нажав **Запустить сейчас** на странице задачи

Пример баннера деактивации на странице задачи: 

<Lightbox src="/img/docs/dbt-cloud/deployment/example-deactivated-deploy-job.png" title="Пример баннера деактивации на странице задачи"/>

## Часто задаваемые вопросы

<FAQ path="Troubleshooting/job-memory-limits" />

## Связанные документы
- [Архитектура dbt Cloud](/docs/cloud/about-cloud/architecture#dbt-cloud-features-architecture)
- [Команды задач](/docs/deploy/job-commands)
- [Уведомления о задачах](/docs/deploy/job-notifications)
- [Webhooks](/docs/deploy/webhooks)
- [Непрерывная интеграция dbt Cloud](/docs/deploy/continuous-integration)