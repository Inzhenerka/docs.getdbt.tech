---
title: "Непрерывная интеграция в dbt Cloud"
sidebar_label: "Непрерывная интеграция"
description: "Вы можете настроить проверки непрерывной интеграции (CI), чтобы протестировать каждое изменение перед развертыванием кода в производственной среде, как в процессе разработки программного обеспечения."
pagination_next: "docs/deploy/advanced-ci"
---

Чтобы реализовать процесс непрерывной интеграции (CI) в dbt Cloud, вы можете настроить автоматизацию, которая тестирует изменения кода, выполняя [CI задания](/docs/deploy/ci-jobs) перед слиянием с производственной версией. dbt Cloud отслеживает состояние того, что работает в вашей производственной среде, поэтому, когда вы запускаете CI задание, только измененные данные в вашем запросе на слияние (PR) и их зависимые объекты строятся и тестируются в промежуточной схеме. Вы также можете просмотреть статус проверок CI (тестов) непосредственно из PR; эта информация отправляется вашему Git-поставщику, как только CI задание завершается. Кроме того, вы можете включить настройки в вашем Git-поставщике, которые позволяют одобрять PR только с успешными проверками CI для слияния.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/ci-workflow.png" width="90%" title="Процесс непрерывной интеграции в dbt Cloud"/>

Использование CI помогает:

- Повысить уверенность и гарантии в том, что изменения в проекте будут работать так, как ожидается, в производственной среде.
- Сократить время, необходимое для развертывания изменений кода в производственной среде, благодаря автоматизации сборки и тестирования, что приводит к лучшим бизнес-результатам.
- Позволить организациям вносить изменения в код стандартизированным и управляемым образом, что обеспечивает качество кода без ущерба для скорости.

## Как работает CI

Когда вы [настраиваете CI задания](/docs/deploy/ci-jobs#set-up-ci-jobs), dbt Cloud слушает уведомления от вашего Git-поставщика, указывающие на то, что новый PR был открыт или обновлен новыми коммитами. Когда dbt Cloud получает одно из этих уведомлений, оно ставит в очередь новый запуск CI задания.

dbt Cloud строит и тестирует модели, семантические модели, метрики и сохраненные запросы, затронутые изменением кода, в временной схеме, уникальной для PR. Этот процесс гарантирует, что код собирается без ошибок и соответствует ожиданиям, определенным тестами dbt проекта. Уникальное имя схемы следует соглашению об именовании `dbt_cloud_pr_<job_id>_<pr_id>` (например, `dbt_cloud_pr_1862_1704`) и может быть найдено в деталях запуска для данного запуска, как показано на следующем изображении:

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/using_ci_dbt_cloud.png" width="90%" title="Просмотр имени временной схемы для запуска, инициированного PR"/>

Когда запуск CI завершается, вы можете просмотреть статус запуска непосредственно из запроса на слияние. dbt Cloud обновляет запрос на слияние в GitHub, GitLab или Azure DevOps с сообщением о статусе, указывающим на результаты запуска. Сообщение о статусе указывает, успешно ли прошли модели и тесты.

dbt Cloud удаляет временную схему из вашего <Term id="data-warehouse" /> при закрытии или слиянии запроса на слияние. Если в вашем проекте есть настройка схемы с использованием макроса [generate_schema_name](/docs/build/custom-schemas#how-does-dbt-generate-a-models-schema-name), dbt Cloud может не удалить временную схему из вашего хранилища данных. Для получения дополнительной информации смотрите [Устранение неполадок](/docs/deploy/ci-jobs#troubleshooting).

## Различия между CI заданиями и другими заданиями развертывания

[dbt Cloud планировщик](/docs/deploy/job-scheduler) выполняет CI задания иначе, чем другие задания развертывания, в следующих важных аспектах:

- [**Параллельные проверки CI**](#concurrent-ci-checks) &mdash; Запуски CI, инициированные одним и тем же CI заданием dbt Cloud, выполняются параллельно, когда это уместно.
- [**Умная отмена устаревших сборок**](#smart-cancellation-of-stale-builds) &mdash; Автоматически отменяет устаревшие, находящиеся в процессе выполнения запуски CI, когда в PR появляются новые коммиты.
- [**Обработка слотов запуска**](#run-slot-treatment) &mdash; Запуски CI не занимают слот запуска.
- [**Линтинг SQL**](#sql-linting) &mdash; При включении автоматически проверяет все SQL файлы в вашем проекте на ошибки в качестве шага запуска перед сборкой вашего CI задания.

### Параллельные проверки CI

Когда у вас есть коллеги, работающие над одним и тем же проектом dbt и создающие запросы на слияние в одном и том же репозитории dbt, одно и то же CI задание будет инициировано. Поскольку каждый запуск строится в выделенной, временной схеме, связанной с запросом на слияние, dbt Cloud может безопасно выполнять запуски CI _параллельно_, а не _последовательно_ (в отличие от того, что делается с заданиями развертывания dbt Cloud). Поскольку никому не нужно ждать завершения одного запуска CI, прежде чем можно будет начать другой, с параллельными проверками CI ваша команда может быстрее тестировать и интегрировать код dbt.

Следующее описывает условия, при которых проверки CI выполняются параллельно и когда они не выполняются:

- Запуски CI с разными номерами PR выполняются параллельно.
- Запуски CI с _одинаковым_ номером PR и _разными_ SHA коммитов выполняются последовательно, поскольку они строятся в одной и той же схеме. dbt Cloud выполнит последний коммит и отменит все более старые, устаревшие коммиты. Для получения подробной информации смотрите [Умная отмена устаревших сборок](#smart-cancellation).
- Запуски CI с одинаковым номером PR и одинаковым SHA коммита, происходящие из разных проектов dbt Cloud, будут выполнять задания параллельно. Это может произойти, когда два CI задания настроены в разных проектах dbt Cloud, которые используют один и тот же репозиторий dbt.

### Умная отмена устаревших сборок

Когда вы отправляете новый коммит в PR, dbt Cloud ставит в очередь новый запуск CI для последнего коммита и отменяет любой запуск CI, который (теперь) устарел и все еще находится в процессе выполнения. Это может произойти, когда вы отправляете новые коммиты, пока сборка CI все еще выполняется и еще не завершена. Отменяя запуски безопасным и целенаправленным образом, dbt Cloud помогает повысить производительность и сократить расходы на платформу данных за счет ненужных запусков CI.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/example-smart-cancel-job.png" width="70%" title="Пример автоматически отмененного запуска"/>

### Обработка слотов запуска <Lifecycle status="team,enterprise" />

Запуски CI не занимают слоты запуска. Это гарантирует, что проверка CI никогда не заблокирует производственный запуск.

### Линтинг SQL <Lifecycle status="team,enterprise" />

Доступно на [релизных треках dbt Cloud](/docs/dbt-versions/cloud-release-tracks) и для аккаунтов dbt Cloud Team или Enterprise.

Когда [включено для вашего CI задания](/docs/deploy/ci-jobs#set-up-ci-jobs), dbt вызывает [SQLFluff](https://sqlfluff.com/) — модульный и настраиваемый линтер SQL, который предупреждает вас о сложных функциях, синтаксисе, форматировании и ошибках компиляции. По умолчанию он проверяет все измененные SQL файлы в вашем проекте (по сравнению с последним отложенным состоянием производства).

Если линтер сталкивается с ошибками, вы можете указать, должен ли dbt остановить выполнение задания при ошибке или продолжить выполнение при ошибке. При сбоях заданий это помогает сократить затраты на вычисления, избегая сборок для запросов на слияние, которые не соответствуют вашему CI контролю качества SQL кода.

#### Чтобы настроить линтинг SQLFluff:
Вы можете по желанию настроить правила линтинга SQLFluff, чтобы переопределить поведение по умолчанию.

- Используйте [Конфигурационные файлы SQLFluff](https://docs.sqlfluff.com/en/stable/configuration/setting_configuration.html#configuration-files), чтобы переопределить поведение линтинга по умолчанию в dbt.
- Создайте файл конфигурации `.sqlfluff` в вашем проекте, добавьте в него свои правила линтинга, и dbt Cloud будет использовать их при линтинге.
    - При настройке вы можете использовать `dbt` в качестве шаблонизатора (например, `templater = dbt`)
    - Если вы используете IDE dbt Cloud, dbt Cloud CLI или любой другой редактор, смотрите [Настройка линтинга](/docs/cloud/dbt-cloud-ide/lint-format#customize-linting) для получения рекомендаций о том, как добавить специфичные для dbt (или dbtonic) правила линтинга, которые мы используем для нашего проекта.
- Для получения полной информации смотрите [Пользовательское использование](https://docs.sqlfluff.com/en/stable/gettingstarted.html#custom-usage) в документации SQLFluff.