---
title: "История запросов моделей"
sidebar_label: "История запросов моделей"
description: "Импортируйте и автоматически генерируйте экспозиции из панелей управления и узнайте, как модели используются в инструментах нижнего уровня для более богатой линии."
image: /img/docs/collaborate/dbt-explorer/model-query-queried-models.jpg
---

# О истории запросов моделей <Lifecycle status='preview' />

История запросов моделей позволяет вам:

- Просматривать количество запросов на использование модели на основе журналов запросов вашего хранилища данных.
- Предоставлять командам данных информацию, чтобы они могли сосредоточить свое время и затраты на инфраструктуру на действительно используемых продуктах данных.
- Позволять аналитикам находить самые популярные модели, используемые другими пользователями.

История запросов моделей основана на едином запросе на использование из таблицы журналов запросов в вашем хранилище данных, агрегированном на ежедневной основе.

<Expandable alt_header="Что такое запрос на использование?">

Запрос на использование — это метрика запросов в вашем проекте dbt, которые использовали модель в заданный период времени. Он фильтрует только `select` операторы, чтобы оценить использование модели и исключает выполнения сборки и тестирования моделей dbt.

Например, если `model_super_santi` был запрошен 10 раз за последнюю неделю, это будет считаться 10 запросами на использование за этот конкретный период времени.
</Expandable>


:::info Поддержка Snowflake (предприятие или выше) и BigQuery

История запросов моделей для пользователей Snowflake доступна **только для уровня предприятия или выше**. Функция также поддерживает BigQuery. Поддержка дополнительных платформ будет добавлена в ближайшее время.
:::

## Предварительные условия

Чтобы получить доступ к функциям, вы должны выполнить следующие условия:

1. У вас есть учетная запись dbt Cloud на [плане предприятия](https://www.getdbt.com/pricing/). Учетные записи с одним арендатором должны связаться со своим представителем для настройки.
2. Вы настроили [производственную](https://docs.getdbt.com/docs/deploy/deploy-environments#set-as-production-environment) среду развертывания для каждого проекта, который вы хотите исследовать, с как минимум одним успешным выполнением задания.
3. У вас есть [административные права](/docs/cloud/manage-access/enterprise-permissions) в dbt Cloud для редактирования настроек проекта или настроек производственной среды.
4. Используйте Snowflake или BigQuery в качестве вашего хранилища данных и можете включить разрешения на историю запросов или работать с администратором для этого. Поддержка дополнительных платформ данных будет добавлена в ближайшее время.
   - Для пользователей Snowflake: Вы **должны** иметь подписку уровня предприятия или выше.

## Включение истории запросов в dbt Cloud

Чтобы включить историю запросов моделей в dbt Cloud, выполните следующие шаги:

1. Перейдите в раздел **Deploy**, затем **Environments**.
2. Выберите среду, помеченную как **PROD**, и нажмите **Settings**.
3. Нажмите **Edit** и прокрутите до раздела **Query History**, чтобы включить переключатель истории запросов. Когда он зеленый и справа, он включен.
4. Нажмите кнопку **Test Permissions**, чтобы проверить, достаточно ли разрешений для учетных данных развертывания для поддержки истории запросов.

<DocCarousel slidesPerView={1}>

<Lightbox src="/img/docs/collaborate/dbt-explorer/enable-query-history.jpg" width="95%" title="Включите историю запросов в настройках вашей среды." />
<Lightbox src="/img/docs/collaborate/dbt-explorer/enable-query-history-success.jpg" width="95%" title="Пример результата проверки разрешений после нажатия на Test Permissions." />

</DocCarousel>

## Разрешения учетных данных

Этот раздел объясняет разрешения и шаги, необходимые для включения и просмотра истории запросов моделей в dbt Explorer.

Функция истории запросов моделей использует учетные данные в вашей производственной среде для сбора метаданных из журналов запросов вашего хранилища данных. Это означает, что вам могут понадобиться повышенные разрешения в хранилище. Прежде чем вносить какие-либо изменения в разрешения вашей платформы данных, подтвердите настроенные разрешения в dbt Cloud:

1. Перейдите в раздел **Deploy**, затем **Environments**.
2. Выберите среду, помеченную как **PROD**, и нажмите **Settings**.
3. Посмотрите информацию в разделе **Deployment credentials**. 
   - Примечание: Запрос истории запросов влечет за собой затраты на хранилище / использование кредитов.
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-query-credentials.jpg" width="50%" title="Подтвердите свои учетные данные развертывания на странице настроек вашей среды." />

4. Скопируйте или сопоставьте эти разрешения учетных данных с разрешениями в хранилище и предоставьте вашему пользователю необходимые разрешения.

    <Expandable alt_header="Для Snowflake">

    Эта функция использует таблицы метаданных, доступные для учетных записей уровня предприятия Snowflake или выше, `QUERY_HISTORY` и `ACCESS_HISTORY`. Пользователь Snowflake, используемый в производственной среде, должен иметь разрешения `GOVERNANCE_VIEWER`, чтобы просматривать данные. 

    Это может быть предоставлено этому пользователю вашим пользователем `ACCOUNTADMIN` в Snowflake. Для получения дополнительной информации смотрите документацию Snowflake [здесь](https://docs.snowflake.com/en/sql-reference/account-usage#enabling-other-roles-to-use-schemas-in-the-snowflake-database).

    </Expandable>

    <Expandable alt_header="Для BigQuery">

    Эта функция использует метаданные из представления `INFORMATION_SCHEMA.JOBS` в BigQuery. Чтобы получить к этому доступ, пользователь, настроенный для вашей производственной среды, должен иметь следующие [IAM роли](https://cloud.google.com/bigquery/docs/access-control) для вашего проекта BigQuery:

    - `roles/bigquery.resourceViewer`
    - `roles/bigquery.jobs.create`

    </Expandable>

## Просмотр истории запросов в Explorer

Чтобы улучшить ваше исследование, вы можете просмотреть историю запросов моделей в различных местах в dbt Explorer:
- [Просмотр из графиков производительности](#view-from-performance-charts)
* [Просмотр из линии проекта](#view-from-project-lineage)
- [Просмотр из списка моделей](#view-from-model-list)

### Просмотр из графиков производительности

1. Перейдите в dbt Explorer, нажав на ссылку **Explore** в навигации.
2. На главной странице **Overview** нажмите на **Performance** в разделе **Project details**. Прокрутите вниз, чтобы увидеть **Самые потребляемые модели**.
3. Используйте выпадающее меню справа, чтобы выбрать желаемый период времени, с вариантами на срок до последних 3 месяцев. 

<Lightbox src="/img/docs/collaborate/dbt-explorer/most-consumed-models.jpg" width="85%" title="Просмотр самых потребляемых моделей на странице 'Performance' в dbt Explorer." />

4. Нажмите на модель для получения более подробной информации и перейдите на вкладку **Performance**.
5. На вкладке **Performance** прокрутите вниз до раздела **Model performance**. 
6. Выберите вкладку **Consumption queries**, чтобы просмотреть запросы на использование за определенный период для этой модели. 
<Lightbox src="/img/docs/collaborate/model-consumption-queries.jpg" width="90%" title="Просмотр запросов на использование с течением времени для данной модели." />

### Просмотр из линии проекта

1. Чтобы просмотреть вашу модель в линии проекта, перейдите на главную страницу **Overview** и нажмите на **Project lineage**.
2. В нижнем левом углу вашей линии нажмите на **Lenses** и выберите **Consumption queries**. 
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-consumption-lenses.jpg" width="85%" title="Просмотр запросов на использование модели в вашей линии с помощью функции 'Lenses'." />

3. Ваша линия должна отображать небольшой красный квадрат над каждой моделью, указывающий количество запросов на использование. Число для каждой модели представляет собой потребление модели за последние 30 дней.

### Просмотр из списка моделей

1. Чтобы просмотреть список моделей, перейдите на главную страницу **Overview**.
2. В левой навигации перейдите на вкладку **Resources** и нажмите на **Models**, чтобы просмотреть список моделей.
3. Вы можете просмотреть количество запросов на использование для моделей и отсортировать по наиболее или наименее потребляемым. Число запросов на использование для каждой модели представляет собой потребление за последние 30 дней.
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-consumption-list.jpg" width="85%" title="Просмотр потребления моделей на странице списка 'Models' в столбце 'Consumption'." />
