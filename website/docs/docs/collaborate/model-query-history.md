---
title: "История запросов модели"
sidebar_label: "История запросов модели"
description: "Импортируйте и автоматически создавайте экспозиции из дашбордов и понимайте, как модели используются в инструментах нижнего уровня для более богатой родословной."
image: /img/docs/collaborate/dbt-explorer/model-query-queried-models.jpg
---

# О истории запросов модели <Lifecycle status='preview' />

История запросов модели позволяет:

- Просматривать количество запросов на потребление для модели на основе логов запросов в хранилище данных.
- Предоставлять командам аналитиков информацию, чтобы они могли сосредоточить свое время и затраты на инфраструктуру на действительно используемых продуктах данных.
- Позволять аналитикам находить самые популярные модели, используемые другими людьми.

История запросов модели основана на единственном запросе потребления таблицы логов запросов в вашем хранилище данных, агрегированном на ежедневной основе.

<Expandable alt_header="Что такое запрос на потребление?">

Запрос на потребление — это метрика запросов в вашем проекте dbt, которые использовали модель в заданное время. Он фильтруется только по `select`-запросам, чтобы оценить потребление модели, и исключает выполнения сборки и тестирования моделей dbt.

Например, если `model_super_santi` был запрошен 10 раз за последнюю неделю, это будет считаться как 10 запросов на потребление за этот период времени.
</Expandable>

:::info Поддержка для Snowflake (уровень Enterprise или выше) и BigQuery

История запросов модели для пользователей Snowflake **доступна только для уровня Enterprise или выше**. Функция также поддерживает BigQuery. Дополнительные платформы появятся в ближайшее время.
:::

## Предварительные условия

Чтобы получить доступ к функциям, вы должны соответствовать следующим требованиям:

1. У вас есть аккаунт dbt Cloud на [плане Enterprise](https://www.getdbt.com/pricing/). Аккаунты с одним арендатором должны связаться с представителем своего аккаунта для настройки.
2. Вы настроили [производственную](https://docs.getdbt.com/docs/deploy/deploy-environments#set-as-production-environment) среду развертывания для каждого проекта, который вы хотите исследовать, с как минимум одним успешным запуском задания.
3. У вас есть [административные права](/docs/cloud/manage-access/enterprise-permissions) в dbt Cloud для редактирования настроек проекта или производственной среды.
4. Используйте Snowflake или BigQuery в качестве вашего хранилища данных и можете включить разрешения на историю запросов или работать с администратором для этого. Поддержка дополнительных платформ данных появится в ближайшее время.
   - Для пользователей Snowflake: у вас **должна** быть подписка на уровень Snowflake Enterprise или выше.

## Включение истории запросов в dbt Cloud

Чтобы включить историю запросов модели в dbt Cloud, выполните следующие шаги:

1. Перейдите в **Deploy**, затем **Environments**.
2. Выберите среду, помеченную как **PROD**, и нажмите **Settings**.
3. Нажмите **Edit** и прокрутите до раздела **Query History**, чтобы включить переключатель истории запросов. Когда он зеленый и находится справа, он включен.
4. Нажмите кнопку **Test Permissions**, чтобы убедиться, что разрешения учетных данных развертывания достаточны для поддержки истории запросов.

<DocCarousel slidesPerView={1}>

<Lightbox src="/img/docs/collaborate/dbt-explorer/enable-query-history.jpg" width="95%" title="Включите историю запросов в настройках вашей среды." />
<Lightbox src="/img/docs/collaborate/dbt-explorer/enable-query-history-success.jpg" width="95%" title="Пример результата проверки разрешений после нажатия на Test Permissions." />

</DocCarousel>

## Разрешения учетных данных

Этот раздел объясняет разрешения и шаги, которые вам нужны для включения и просмотра истории запросов модели в dbt Explorer.

Функция истории запросов модели использует учетные данные в вашей производственной среде для сбора метаданных из логов запросов вашего хранилища данных. Это означает, что вам могут понадобиться повышенные разрешения в хранилище. Перед внесением изменений в разрешения вашей платформы данных подтвердите настроенные разрешения в dbt Cloud:

1. Перейдите в **Deploy**, затем **Environments**.
2. Выберите среду, помеченную как **PROD**, и нажмите **Settings**.
3. Посмотрите информацию под **Deployment credentials**.
   - Примечание: Запрос истории запросов влечет за собой затраты на хранилище / использование кредитов.
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-query-credentials.jpg" width="50%" title="Подтвердите свои учетные данные развертывания на странице настроек вашей среды." />

4. Скопируйте или сопоставьте эти разрешения учетных данных с разрешениями хранилища и предоставьте вашему пользователю правильные разрешения.

    <Expandable alt_header="Для Snowflake">

    Эта функция использует таблицы метаданных, доступные для аккаунтов Snowflake уровня Enterprise или выше, `QUERY_HISTORY` и `ACCESS_HISTORY`. Пользователь Snowflake, используемый в производственной среде, должен иметь разрешения `GOVERNANCE_VIEWER` для просмотра данных.

    Это может быть предоставлено этому пользователю вашим пользователем `ACCOUNTADMIN` в Snowflake. Для получения более подробной информации, ознакомьтесь с документацией Snowflake [здесь](https://docs.snowflake.com/en/sql-reference/account-usage#enabling-other-roles-to-use-schemas-in-the-snowflake-database).

    </Expandable>

    <Expandable alt_header="Для BigQuery">

    Эта функция использует метаданные из представления `INFORMATION_SCHEMA.JOBS` в BigQuery. Чтобы получить доступ к этому, пользователь, настроенный для вашей производственной среды, должен иметь следующие [роли IAM](https://cloud.google.com/bigquery/docs/access-control) для вашего проекта BigQuery:

    - `roles/bigquery.resourceViewer`
    - `roles/bigquery.jobs.create`

    </Expandable>

## Просмотр истории запросов в Explorer

Чтобы улучшить ваше исследование, вы можете просматривать историю запросов вашей модели в различных местах в dbt Explorer:
- [Просмотр из графиков производительности](#view-from-performance-charts)
* [Просмотр из родословной проекта](#view-from-project-lineage)
- [Просмотр из списка моделей](#view-from-model-list)

### Просмотр из графиков производительности

1. Перейдите в dbt Explorer, нажав на ссылку **Explore** в навигации.
2. На главной странице **Overview** нажмите на **Performance** в разделе **Project details**. Прокрутите вниз, чтобы увидеть **Most consumed models**.
3. Используйте выпадающее меню справа, чтобы выбрать желаемый период времени, с доступными опциями до последних 3 месяцев.

<Lightbox src="/img/docs/collaborate/dbt-explorer/most-consumed-models.jpg" width="85%" title="Просмотр самых потребляемых моделей на странице 'Performance' в dbt Explorer." />

4. Нажмите на модель для получения более подробной информации и перейдите на вкладку **Performance**.
5. На вкладке **Performance** прокрутите вниз до раздела **Model performance**.
6. Выберите вкладку **Consumption queries**, чтобы просмотреть запросы на потребление за заданное время для этой модели.
<Lightbox src="/img/docs/collaborate/model-consumption-queries.jpg" width="90%" title="Просмотр запросов на потребление с течением времени для данной модели." />

### Просмотр из родословной проекта

1. Чтобы просмотреть вашу модель в родословной вашего проекта, перейдите на главную **Overview page** и нажмите на **Project lineage.**
2. В нижнем левом углу вашей родословной нажмите на **Lenses** и выберите **Consumption queries**.
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-consumption-lenses.jpg" width="85%" title="Просмотр запросов на потребление модели в вашей родословной с использованием функции 'Lenses'." />

3. Ваша родословная должна отображать маленький красный квадрат над каждой моделью, указывающий количество запросов на потребление. Число для каждой модели представляет потребление модели за последние 30 дней.

### Просмотр из списка моделей

1. Чтобы просмотреть список моделей, перейдите на главную **Overview page**.
2. В левой навигации перейдите на вкладку **Resources** и нажмите на **Models**, чтобы просмотреть список моделей.
3. Вы можете просмотреть количество запросов на потребление для моделей и отсортировать по наиболее или наименее потребляемым. Число запросов на потребление для каждой модели представляет потребление за последние 30 дней.
<Lightbox src="/img/docs/collaborate/dbt-explorer/model-consumption-list.jpg" width="85%" title="Просмотр потребления моделей на странице списка 'Models' в колонке 'Consumption'." />