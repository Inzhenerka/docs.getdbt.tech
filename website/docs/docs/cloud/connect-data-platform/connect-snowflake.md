---
title: "Подключение к Snowflake"
id: connect-snowflake
description: "Настройка подключения к Snowflake."
sidebar_label: "Подключение к Snowflake"
---

:::note

Подключения и учетные данные dbt Cloud наследуют разрешения настроенных учетных записей. Вы можете настроить роли и связанные с ними разрешения в Snowflake в соответствии с требованиями вашей компании и уточнить доступ к объектам базы данных в вашей учетной записи. См. [Разрешения Snowflake](/reference/database-permissions/snowflake-permissions) для получения дополнительной информации о настройке ролей в Snowflake.

Смотрите [Разрешения Snowflake](/reference/database-permissions/snowflake-permissions) для получения дополнительной информации о настройке ролей в Snowflake.

:::

Следующие поля обязательны при создании подключения к Snowflake

| Поле | Описание | Примеры |
| ----- | ----------- | -------- |
| Account | Учетная запись Snowflake, к которой нужно подключиться. Посмотрите [здесь](/docs/core/connect-data-platform/snowflake-setup#account), чтобы определить, как должно выглядеть поле учетной записи в зависимости от вашего региона. | <Snippet path="snowflake-acct-name" /> |
| Role | Обязательное поле, указывающее, какую роль следует принять после подключения к Snowflake | `transformer` |
| Database | Логическая база данных, к которой нужно подключиться и выполнять запросы. | `analytics` |
| Warehouse | Виртуальный склад, который будет использоваться для выполнения запросов. | `transforming` |

## Методы аутентификации

В этом разделе описаны различные методы аутентификации для подключения dbt Cloud к Snowflake. Настройте учетные данные для среды развертывания (Production, Staging, General) глобально в области [**Подключения**](/docs/deploy/deploy-environments#deployment-connection) в **Настройках учетной записи**. Отдельные пользователи настраивают свои учетные данные для разработки в области [**Учетные данные**](/docs/cloud/dbt-cloud-ide/develop-in-the-cloud#get-started-with-the-cloud-ide) своего профиля пользователя.

### Имя пользователя / Пароль

**Доступно в:** Средах разработки, Средах развертывания

Метод аутентификации `Имя пользователя / Пароль` является самым простым способом аутентификации учетных данных разработки или развертывания в проекте dbt. Просто введите ваше имя пользователя Snowflake (в частности, `login_name`) и соответствующий пароль пользователя Snowflake, чтобы аутентифицировать dbt Cloud для выполнения запросов от имени пользователя Snowflake.

**Примечание**: Поле схемы в разделе **Учетные данные разработчика** является обязательным полем.
<Lightbox src="/img/docs/dbt-cloud/snowflake-userpass-auth.png" width="70%" title="Аутентификация по имени пользователя/паролю Snowflake"/>

### Snowflake MFA

**Предварительные условия:**
- Среда разработки в проекте dbt Cloud
- Приложение аутентификации Duo
- Административный доступ к Snowflake (если настройки MFA еще не были применены к учетной записи)
- [Административный (запись) доступ](/docs/cloud/manage-access/seats-and-users) к средам dbt Cloud

dbt Cloud поддерживает [многофакторную аутентификацию (MFA)](https://docs.snowflake.com/en/user-guide/security-mfa) Snowflake в качестве еще одного варианта имени пользователя и пароля для повышения безопасности входа. Поддержка MFA в Snowflake осуществляется с помощью сервиса Duo Security.

- В dbt Cloud установите следующий [расширенный атрибут](/docs/dbt-cloud-environments#extended-attributes) на странице **Общие настройки** среды разработки, в разделе **Расширенные атрибуты**:

   ```yaml
  authenticator: username_password_mfa
   ```

- Чтобы уменьшить количество запросов к пользователю при подключении к Snowflake с MFA, [включите кэширование токенов](https://docs.snowflake.com/en/user-guide/security-mfa#using-mfa-token-caching-to-minimize-the-number-of-prompts-during-authentication-optional) в Snowflake.
- При желании, если пользователи пропускают запросы и их учетные записи Snowflake блокируются, вы можете предотвратить автоматические повторные попытки, добавив следующее в тот же раздел **Расширенные атрибуты**:

  ```yaml
  connect_retries: 0
  ```

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/extended-attributes-mfa.jpg" width="70%" title="Настройка имени пользователя и пароля MFA, а также connect_retries в настройках среды разработки." />

### Пара ключей

**Доступно в:** Средах разработки, Средах развертывания

Метод аутентификации `Пара ключей` использует [Аутентификацию по паре ключей](https://docs.snowflake.com/en/user-guide/key-pair-auth) Snowflake для аутентификации учетных данных разработки или развертывания для проекта dbt Cloud.

1. После [генерации зашифрованной пары ключей](https://docs.snowflake.com/en/user-guide/key-pair-auth.html#configuring-key-pair-authentication) убедитесь, что вы установили `rsa_public_key` для пользователя Snowflake для аутентификации в dbt Cloud:

   ```sql
   alter user jsmith set rsa_public_key='MIIBIjANBgkqh...';   
   ```

2. Наконец, заполните поля **Частный ключ** и **Пароль частного ключа** на странице **Учетные данные**, чтобы завершить настройку dbt Cloud для аутентификации с помощью пары ключей.
   - **Примечание:** Не зашифрованные частные ключи разрешены. Используйте пароль только в случае необходимости. Начиная с [версии dbt 1.7](/docs/dbt-versions/core-upgrade/upgrading-to-v1.7), dbt представил возможность указывать `private_key` непосредственно как строку вместо `private_key_path`. Эта строка `private_key` может быть в формате DER, закодированном в Base64, представляющем байты ключа, или в формате PEM в открытом виде. Обратитесь к [документации Snowflake](https://docs.snowflake.com/en/user-guide/key-pair-auth) для получения дополнительной информации о том, как они генерируют ключ.

3. Чтобы успешно заполнить поле Частный ключ, вы _должны_ включить закомментированные строки. Если вы получаете ошибку `Не удалось десериализовать данные ключа` или `JWT токен`, обратитесь к разделу [Устранение неполадок](#troubleshooting) для получения дополнительной информации.

**Пример:**

```sql
-----BEGIN ENCRYPTED PRIVATE KEY-----
< содержимое зашифрованного частного ключа здесь - строка 1 >
< содержимое зашифрованного частного ключа здесь - строка 2 >
< ... >
-----END ENCRYPTED PRIVATE KEY-----
```

   <Lightbox src="/img/docs/dbt-cloud/snowflake-keypair-auth.png" width="60%" title="Аутентификация по паре ключей Snowflake"/>

### Snowflake OAuth

**Доступно в:** Средах разработки, только для корпоративных планов

Метод аутентификации OAuth позволяет dbt Cloud выполнять запросы разработки от имени пользователя Snowflake без настройки пароля Snowflake в dbt Cloud.

Для получения дополнительной информации о настройке подключения Snowflake OAuth в dbt Cloud, пожалуйста, смотрите [документацию по настройке Snowflake OAuth](/docs/cloud/manage-access/set-up-snowflake-oauth).
<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/database-connection-snowflake-oauth.png" width="55%" title="Настройка подключения Snowflake OAuth"/>

## Настройка

Чтобы узнать, как оптимизировать производительность с помощью конфигураций, специфичных для платформы данных в dbt Cloud, обратитесь к [конфигурации, специфичной для Snowflake](/reference/resource-configs/snowflake-configs).

### URL пользовательского домена

Чтобы подключиться к Snowflake через пользовательский домен (vanity URL) вместо локатора учетной записи, используйте [расширенные атрибуты](/docs/dbt-cloud-environments#extended-attributes) для настройки параметра `host` с пользовательским доменом:

```yaml
host: https://custom_domain_to_snowflake.com
```

Эта конфигурация может конфликтовать с Snowflake OAuth при использовании PrivateLink. Если пользователи не могут достучаться до серверов аутентификации Snowflake с сетевой точки зрения, пожалуйста, [свяжитесь с поддержкой dbt](mailto:support@getdbt.com), чтобы найти обходной путь с этой архитектурой.

## Устранение неполадок
<!--может потребоваться превратить это в переключатель деталей, если появится больше элементов для устранения неполадок -->

Если вы получаете ошибку `Не удалось десериализовать данные ключа` или `JWT токен`, обратитесь к следующим причинам и решениям:

<DetailsToggle alt_header="Ошибка: `Не удалось десериализовать данные ключа`">

Возможная причина и решение для ошибки "Не удалось десериализовать данные ключа" в dbt Cloud.
- Это может быть связано с ошибками, такими как неправильное копирование, отсутствие дефисов или пропуск закомментированных строк.

**Решение**:
- Вы можете скопировать ключ из его источника и вставить его в текстовый редактор, чтобы проверить его перед использованием в dbt Cloud.

</DetailsToggle>

<DetailsToggle alt_header="Ошибка: `JWT токен`">

Возможная причина и решение для ошибки "JWT токен" в dbt Cloud.
- Это может быть временная проблема между Snowflake и dbt Cloud. При подключении к Snowflake dbt получает JWT токен, действительный только 60 секунд. Если в течение этого времени нет ответа от Snowflake, вы можете увидеть ошибку `JWT токен недействителен` в dbt Cloud.
- Публичный ключ был введен неправильно в Snowflake.

**Решения**
- dbt необходимо повторить попытки подключения к Snowflake.
- Подтвердите и введите публичный ключ Snowflake правильно. Кроме того, вы можете обратиться в Snowflake за помощью или обратиться к этой документации Snowflake для получения дополнительной информации: [Ошибка аутентификации на основе ключей с недействительным JWT токеном](https://community.snowflake.com/s/article/Key-Based-Authentication-Failed-with-JWT-token-is-invalid-Error).

</DetailsToggle>