---
title: "Настройка внешнего OAuth"
id: external-oauth
description: "Инструкции по настройке для dbt Cloud и внешних OAuth-соединений"
sidebar_label: "Настройка внешнего OAuth"
pagination_next: null
pagination_prev: null
---

# Настройка внешнего OAuth <Lifecycle status="enterprise" />

:::note 

Эта функция в настоящее время доступна только для поставщиков идентификации Okta и Entra ID, а также для [соединений с Snowflake](/docs/cloud/connect-data-platform/connect-snowflake).

:::


dbt Cloud Enterprise поддерживает [аутентификацию через внешний OAuth](https://docs.snowflake.com/en/user-guide/oauth-ext-overview) с внешними поставщиками. Когда внешний OAuth включен, пользователи могут авторизовать свои учетные данные для разработки с помощью единого входа (SSO) через поставщика идентификации (IdP). Это предоставляет пользователям возможность доступа к нескольким приложениям, включая dbt Cloud, без необходимости делиться своими учетными данными с сервисом. Это не только упрощает процесс аутентификации для пользователей в средах разработки, но и обеспечивает дополнительный уровень безопасности для вашей учетной записи dbt Cloud.

## Начало работы

Процесс настройки внешнего OAuth потребует некоторого взаимодействия между вашими учетными записями dbt Cloud, IdP и Snowflake, поэтому открытие их в нескольких вкладках браузера поможет ускорить процесс конфигурации:

- **dbt Cloud:** Вы будете в основном работать на странице **Настройки учетной записи** —> **Интеграции**. Вам понадобятся [соответствующие разрешения](/docs/cloud/manage-access/enterprise-permissions) для настройки интеграции и создания соединений.
- **Snowflake:** Откройте рабочий лист в учетной записи, которая имеет разрешения на [создание интеграции безопасности](https://docs.snowflake.com/en/sql-reference/sql/create-security-integration).
- **Okta:** Вам нужно будет работать в нескольких областях учетной записи Okta, но вы можете начать в разделе **Приложения**. Вам понадобятся разрешения для [создания приложения](https://help.okta.com/en-us/content/topics/security/custom-admin-role/about-role-permissions.htm#Application_permissions) и [сервера авторизации](https://help.okta.com/en-us/content/topics/security/custom-admin-role/about-role-permissions.htm#Authorization_server_permissions).
- **Entra ID:** Необходим администратор с доступом для создания [приложений Entra ID](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/custom-available-permissions), который также является пользователем Snowflake.

Если администраторы, отвечающие за эти продукты, являются разными людьми, лучше, чтобы они координировали свои действия одновременно, чтобы уменьшить трение.

### Команды Snowflake

Следующий шаблон предназначен для создания конфигураций OAuth в среде Snowflake:

```sql

create security integration your_integration_name
type = external_oauth
enabled = true
external_oauth_type = okta
external_oauth_issuer = ''
external_oauth_jws_keys_url = ''
external_oauth_audience_list = ('')
external_oauth_token_user_mapping_claim = 'sub'
external_oauth_snowflake_user_mapping_attribute = 'email_address'
external_oauth_any_role_mode = 'ENABLE'

```

Параметры `external_oauth_token_user_mapping_claim` и `external_oauth_snowflake_user_mapping_attribute` могут быть изменены в зависимости от потребностей вашей организации. Эти значения указывают на утверждение в токене пользователя. В приведенном примере Snowflake будет искать пользователя Snowflake, чей `email` соответствует значению в утверждении `sub`. 

**Примечание:** Роли по умолчанию Snowflake ACCOUNTADMIN, ORGADMIN или SECURITYADMIN по умолчанию заблокированы для внешнего OAuth и, вероятно, не смогут пройти аутентификацию. Дополнительную информацию см. в [документации Snowflake](https://docs.snowflake.com/en/sql-reference/sql/create-security-integration-oauth-external). 

## Конфигурация поставщика идентификации

Выберите поддерживаемого поставщика идентификации (IdP) для получения инструкций по настройке внешнего OAuth в их среде и завершения интеграции в dbt Cloud.

<Expandable alt_header="Okta">

### 1. Инициализация настроек dbt Cloud

1. В вашей учетной записи dbt Cloud перейдите в **Настройки учетной записи** —> **Интеграции**.
2. Прокрутите вниз до **Пользовательские интеграции** и нажмите **Добавить интеграции**.
3. Оставьте это окно открытым. Вы можете установить **Тип интеграции** на Okta и записать **URI перенаправления** внизу страницы. Скопируйте это в буфер обмена для использования на следующих шагах.

<Lightbox src="/img/docs/dbt-cloud/callback-uri.png" width="60%" title="Скопируйте URI обратного вызова внизу страницы интеграции в dbt Cloud" />

### 2. Создание приложения Okta

1. Разверните раздел **Приложения** на панели управления Okta и нажмите **Приложения**. Нажмите кнопку **Создать интеграцию приложения**.
2. Выберите **OIDC** в качестве метода входа и **Веб-приложения** в качестве типа приложения. Нажмите **Далее**.

<Lightbox src="/img/docs/dbt-cloud/create-okta-app.png" width="60%" title="Окно создания приложения Okta с выбранными OIDC и веб-приложением" />

3. Дайте приложению подходящее имя, например, “Внешнее OAuth-приложение для dbt Cloud”, чтобы его было легко идентифицировать.
4. В разделе **Тип предоставления** включите опцию **Токен обновления**.
5. Прокрутите вниз до опции **URI перенаправления для входа**. Вам нужно будет вставить URI перенаправления, который вы собрали из dbt Cloud на шаге 1.3.

<Lightbox src="/img/docs/dbt-cloud/configure-okta-app.png" width="60%" title="Окно конфигурации приложения Okta с URI перенаправления для входа, настроенным на значение dbt Cloud" />

6. Сохраните конфигурацию приложения. Вы вернетесь к этому, но пока переходите к следующим шагам.

### 3. Создание API Okta

1. Разверните раздел **Безопасность** и нажмите **API** в боковом меню Okta.
2. На экране API нажмите **Добавить сервер авторизации**. Дайте серверу авторизации имя (подходящее название для вашей учетной записи Snowflake будет уместным). В поле **Аудитория** скопируйте и вставьте URL-адрес входа в Snowflake (например, https://abdc-ef1234.snowflakecomputing.com). Дайте серверу подходящее описание и нажмите **Сохранить**.

<Lightbox src="/img/docs/dbt-cloud/create-okta-api.png" width="60%" title="Окно API Okta с установленным значением Аудитории на URL Snowflake" />

3. На экране конфигурации сервера авторизации откройте **URI метаданных** в новой вкладке. Вам понадобится информация с этого экрана на следующих шагах.

<Lightbox src="/img/docs/dbt-cloud/metadata-uri.png" width="60%" title="Страница настроек API Okta с выделенным URI метаданных" />

<Lightbox src="/img/docs/dbt-cloud/metadata-example.png" width="60%" title="Пример вывода URI метаданных" />

4. Нажмите на вкладку **Области** и **Добавить область**. В поле **Имя** добавьте `session:role-any`. (По желанию) Настройте **Отображаемую фразу** и **Описание** и нажмите **Создать**.

<Lightbox src="/img/docs/dbt-cloud/add-api-scope.png" width="60%" title="Область API, настроенная в окне Добавить область" />

5. Откройте вкладку **Политики доступа** и нажмите **Добавить политику**. Дайте политике **Имя** и **Описание** и установите **Назначить для** как **Следующие клиенты**. Начните вводить имя приложения, которое вы создали на шаге 2.3, и вы увидите, как оно автоматически заполняется. Выберите приложение и нажмите **Создать политику**.

<Lightbox src="/img/docs/dbt-cloud/add-api-assignment.png" width="60%" title="Поле назначения, автоматически заполняющее значение" />

6. На экране **политики доступа** нажмите **Добавить правило**.

<Lightbox src="/img/docs/dbt-cloud/add-api-rule.png" width="60%" title="Кнопка Добавить правило API выделена" />

7. Дайте правилу описательное имя и прокрутите вниз до **сроков действия токена**. Настройте параметры **Срок действия токена доступа**, **Срок действия токена обновления** и **но истечет, если не будет использован каждые** в соответствии с политиками вашей организации. Мы рекомендуем использовать значения по умолчанию: 1 час и 90 дней. Более строгие правила увеличивают вероятность того, что вашим пользователям придется повторно аутентифицироваться.

<Lightbox src="/img/docs/dbt-cloud/configure-token-lifetime.png" width="60%" title="Настройки срока действия токена в окне правила API" />

8. Вернитесь на вкладку **Настройки** и оставьте ее открытой в вашем браузере. Вам понадобится некоторая информация на следующих шагах.

### 4. Создание настроек OAuth в Snowflake

1. Откройте рабочий лист Snowflake и скопируйте/вставьте следующее:

```sql

create security integration your_integration_name
type = external_oauth
enabled = true
external_oauth_type = okta
external_oauth_issuer = ''
external_oauth_jws_keys_url = ''
external_oauth_audience_list = ('')
external_oauth_token_user_mapping_claim = 'sub'
external_oauth_snowflake_user_mapping_attribute = 'email_address'
external_oauth_any_role_mode = 'ENABLE'

```

2. Измените `your_integration_name` на что-то подходящее и описательное. Например, `dev_OktaAccountNumber_okta`. Скопируйте `external_oauth_issuer` и `external_oauth_jws_keys_url` из URI метаданных на шаге 3.3. Используйте тот же URL Snowflake, который вы ввели на шаге 3.2, в качестве `external_oauth_audience_list`.

Настройте другие параметры по мере необходимости, чтобы соответствовать конфигурациям вашей организации в Okta и Snowflake.

<Lightbox src="/img/docs/dbt-cloud/gather-uris.png" width="60%" title="URI эмитента и jws ключей в URL метаданных" />

3. Выполните шаги для создания интеграции в Snowflake.

### 5. Конфигурация интеграции в dbt Cloud

1. Вернитесь на страницу **Настройки учетной записи** —> **Интеграции** в dbt Cloud, на которой вы были в начале. Пора начинать заполнять все поля.
   1. `Имя интеграции`: Дайте интеграции описательное имя, которое включает идентифицирующую информацию о среде Okta, чтобы будущие пользователи не гадали, к чему она относится.
   2. `Client ID` и `Client secrets`: Получите их со страницы приложения Okta.
   <Lightbox src="/img/docs/dbt-cloud/gather-clientid-secret.png" width="60%" title="Client ID и секрет, выделенные в приложении Okta" />
   3. URL авторизации и URL токена: Найдите в URI метаданных.
   <Lightbox src="/img/docs/dbt-cloud/gather-authorization-token-endpoints.png" width="60%" title="URL авторизации и токена, выделенные в URI метаданных" />

2. **Сохраните** конфигурацию


### 6. Создание нового соединения в dbt Cloud


1. Перейдите в **Настройки учетной записи** и нажмите **Соединения** в меню. Нажмите **Добавить соединение**.
2. Настройте `Учетную запись`, `Базу данных` и `Склад` так, как вы обычно это делаете, а для `Метода OAuth` выберите внешний OAuth, который вы только что создали.


<Lightbox src="/img/docs/dbt-cloud/configure-new-connection.png" width="60%" title="Новое окно конфигурации в dbt Cloud с отображением внешнего OAuth как опции" />


3. Прокрутите вниз до поля **Конфигурации внешнего OAuth** и выберите конфигурацию из списка.


<Lightbox src="/img/docs/dbt-cloud/select-oauth-config.png" width="60%" title="Новое соединение, отображаемое в поле Конфигурации внешнего OAuth" />


4. **Сохраните** соединение, и теперь вы настроили внешний OAuth с Okta и Snowflake!

</Expandable>

<Expandable alt_header="Entra ID">

### 1. Инициализация настроек dbt Cloud

1. В вашей учетной записи dbt Cloud перейдите в **Настройки учетной записи** —> **Интеграции**.
2. Прокрутите вниз до **Пользовательские интеграции** и нажмите **Добавить интеграции**.
3. Оставьте это окно открытым. Вы можете установить **Тип интеграции** на Entra ID и записать **URI перенаправления** внизу страницы. Скопируйте это в буфер обмена для использования на следующих шагах.

### Entra ID

Вам нужно будет создать два приложения в портале Azure: сервер ресурсов и клиентское приложение.

:::important

Администратор, который создает приложения в учетной записи Microsoft Entra ID, также должен быть пользователем в Snowflake.

Поле `value`, собранное на этих шагах, отображается только один раз. После создания запишите его немедленно.

:::

В вашем портале Azure откройте **Entra ID** и нажмите **Регистрация приложений** в левом меню.

### 1. Создание сервера ресурсов

1. На экране регистрации приложений нажмите **Новая регистрация**.
   1. Дайте приложению имя.
   2. Убедитесь, что **Поддерживаемые типы учетных записей** установлены на “Учетные записи только в этом организационном каталоге (`Имя организации` - Один арендатор).”
   3. Нажмите **Зарегистрировать**, чтобы увидеть обзор приложения.
2. На странице обзора приложения нажмите **Экспонировать API** в левом меню.
3. Нажмите **Добавить** рядом с **URI идентификатора приложения**. Поле автоматически заполнится. Нажмите **Сохранить**.
4. Запишите поле `value` для использования на следующем шаге. _Это отображается только один раз. Обязательно запишите его немедленно. Microsoft скрывает поле, когда вы покидаете страницу и возвращаетесь._
5. На той же странице нажмите **Добавить область**.
   1. Дайте области имя.
   2. Установите “Кто может дать согласие?” на **Администраторы и пользователи**.
   3. Установите **Отображаемое имя согласия администратора** на session:role-any и дайте ему описание.
   4. Убедитесь, что **Состояние** установлено на **Включено**.
   5. Нажмите **Добавить область**.

### 2. Создание клиентского приложения

1. На странице **Регистрация приложений** нажмите **Новая регистрация**.
   1. Дайте приложению имя, которое уникально идентифицирует его как клиентское приложение.
   2. Убедитесь, что **Поддерживаемые типы учетных записей** установлены на “Учетные записи только в этом организационном каталоге (`Имя организации` - Один арендатор).”
   3. Установите **URI перенаправления** на **Веб** и скопируйте/вставьте **URI перенаправления** из dbt Cloud в поле.
   4. Нажмите **Зарегистрировать**.
2. На странице обзора приложения нажмите **Разрешения API** в левом меню и нажмите **Добавить разрешение**.
3. На всплывающем экране нажмите **API, которые использует моя организация**, найдите имя сервера ресурсов из предыдущих шагов и нажмите на него.
4. Убедитесь, что флажок для разрешения `session:role-any` включен, и нажмите **Добавить разрешения**.
5. Нажмите **Предоставить согласие администратора** и в всплывающем окне нажмите **Да**.
6. В левом меню нажмите **Сертификаты и секреты** и нажмите **Новый клиентский секрет**. Назовите секрет, установите срок действия и нажмите **Добавить**.
**Примечание**: Microsoft не позволяет устанавливать “навсегда” в качестве даты истечения. Максимальный срок — два года. Важно документировать дату истечения, чтобы вы могли обновить секрет до истечения срока или до того, как авторизация пользователя не пройдет.
7. Запишите `value` для использования на следующем шаге и запишите его немедленно.
**Примечание**: Entra ID не отобразит это значение снова, как только вы покинете этот экран.

### 3. Конфигурация Snowflake

Вам нужно будет переключаться между сайтом Entra ID и Snowflake. Держите свою учетную запись Entra ID открытой для этого процесса.

Скопируйте и вставьте следующее в качестве шаблона в рабочий лист Snowflake:

```sql

create or replace security integration <whatever you want to name it>
   type = external_oauth
   enabled = true
   external_oauth_type = azure
   external_oauth_issuer = '<AZURE_AD_ISSUER>'
   external_oauth_jws_keys_url = '<AZURE_AD_JWS_KEY_ENDPOINT>'
   external_oauth_audience_list = ('<SNOWFLAKE_APPLICATION_ID_URI>')
   external_oauth_token_user_mapping_claim = 'upn'
   external_oauth_any_role_mode = 'ENABLE'
   external_oauth_snowflake_user_mapping_attribute = 'login_name';

```

На сайте Entra ID:

1. В приложении Client ID в Entra ID нажмите **Конечные точки** и откройте **Документ метаданных федерации** в новой вкладке.
   - **entity ID** на этой странице соответствует полю `external_oauth_issuer` в конфигурации Snowflake.
2. Вернитесь к списку конечных точек и откройте **Документ метаданных OpenID Connect** в новой вкладке.
   - Поле **jwks_uri** соответствует полю `external_oauth_jws_keys_url` в Snowflake.
3. Перейдите к серверу ресурсов из предыдущих шагов.
   - **URI идентификатора приложения** соответствует полю `external_oauth_audience_list` в Snowflake.
4. Выполните конфигурации. Убедитесь, что администратор, создавший приложения Microsoft, также является пользователем Snowflake, иначе конфигурация не пройдет.

### 4. Конфигурация интеграции в dbt Cloud

1. Вернитесь на страницу **Настройки учетной записи** —> **Интеграции** в dbt Cloud, на которой вы были в начале. Пора начинать заполнять все поля. Вам придется немного поработать между учетной записью Entra ID и dbt Cloud.
2. `Имя интеграции`: Дайте интеграции описательное имя, которое включает идентифицирующую информацию о среде Entra ID, чтобы будущие пользователи не гадали, к чему она относится.
3. `Client secrets`: Найдите на странице **Сертификаты и секреты** в Client ID. `Value` — это `Client secret`. Обратите внимание, что он отображается только при создании; _Microsoft скрывает секрет, если вы вернетесь позже, и вам нужно будет создать его заново._
4. `Client ID`: Скопируйте `Application (client) ID` на странице обзора для идентификатора клиента.
5. `Authorization URL` и `Token URL`: На странице Client ID откройте вкладку `Конечные точки`. Эти URL соответствуют полям `OAuth 2.0 authorization endpoint (v2)` и `OAuth 2.0 token endpoint (v2)`. *Вы должны использовать v2 конечной точки `OAuth 2.0 authorization endpoint`. Не используйте V1.* Вы можете использовать любую версию конечной точки `OAuth 2.0 token endpoint`.
6. `URI идентификатора приложения`: Скопируйте поле `Application ID URI` с экрана обзора сервера ресурсов.

</Expandable>

## Часто задаваемые вопросы

<FAQ path="Troubleshooting/failed-snowflake-oauth-connection" />