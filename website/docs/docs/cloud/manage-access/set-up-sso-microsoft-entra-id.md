---
title: "Настройка SSO с Microsoft Entra ID (ранее Azure AD)"
description: "Узнайте, как администраторы dbt Cloud могут использовать Microsoft Entra ID для управления доступом в учетной записи dbt Cloud."
id: "set-up-sso-microsoft-entra-id"
sidebar_label: "Настройка SSO с Microsoft Entra ID"
---

import SetUpPages from '/snippets/_sso-docs-mt-available.md';

<SetUpPages features={'/snippets/_sso-docs-mt-available.md'}/>

dbt Cloud Enterprise поддерживает одноразовый вход (SSO) через Microsoft Entra ID (ранее Azure AD).
Вам понадобятся разрешения для создания и управления новым приложением Entra ID.
В настоящее время поддерживаются следующие функции:

* SSO, инициированный IdP
* SSO, инициированный SP
* Провизия "по требованию"

## Конфигурация

dbt Cloud поддерживает как одноарендные, так и многоарендные подключения SSO Microsoft Entra ID (ранее Azure AD). Для большинства корпоративных целей вы захотите использовать одноарендный поток при создании приложения Microsoft Entra ID.

### Создание приложения

Войдите в портал Azure для вашей организации. Используя страницу [**Microsoft Entra ID**](https://portal.azure.com/#home), вам нужно будет выбрать соответствующий каталог и затем зарегистрировать новое приложение.

1. В разделе **Управление** выберите **Регистрация приложений**.
2. Нажмите **+ Новая регистрация**, чтобы начать создание новой регистрации приложения.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-app-registration-empty.png" width="80%" title="Создание новой регистрации приложения"/>

3. Укажите конфигурации для полей **Имя** и **Поддерживаемые типы учетных записей**, как показано в следующей таблице:

| Поле | Значение |
| ----- | ----- |
| **Имя** | dbt Cloud |
| **Поддерживаемые типы учетных записей** | Учетные записи только в этом организационном каталоге _(одноарендный)_ |

4. Настройте **URI перенаправления**. В таблице ниже показаны соответствующие значения URI перенаправления для одноарендных и многоарендных развертываний. Для большинства корпоративных случаев использования вы захотите использовать одноарендный URI перенаправления. Замените `YOUR_AUTH0_URI` на [соответствующий URI Auth0](/docs/cloud/manage-access/sso-overview#auth0-multi-tenant-uris) для вашего региона и плана.

| Тип приложения | URI перенаправления |
| ----- | ----- |
| Одноарендный _(рекомендуется)_ | `https://YOUR_AUTH0_URI/login/callback` |
| Многоарендный | `https://YOUR_AUTH0_URI/login/callback` |

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-new-application-alternative.png" width="70%" title="Настройка новой регистрации приложения"/>

5. Сохраните регистрацию приложения, чтобы продолжить настройку SSO Microsoft Entra ID.

:::info Конфигурация с новым интерфейсом Microsoft Entra ID (опционально)

В зависимости от ваших настроек Microsoft Entra ID, ваша страница регистрации приложения может выглядеть иначе, чем показано на предыдущих скриншотах. Если вас _не_ просят настроить URI перенаправления на странице **Новая регистрация**, выполните шаги 6 - 7 ниже после создания регистрации приложения. Если вы смогли настроить URI перенаправления на предыдущих шагах, перейдите к [шагу 8](#adding-users-to-an-enterprise-application).
:::

6. После регистрации нового приложения без указания URI перенаправления, нажмите на **Регистрация приложения** и затем перейдите на вкладку **Аутентификация** для нового приложения.

7. Нажмите **+ Добавить платформу** и введите URI перенаправления для вашего приложения. См. шаг 4 выше для получения дополнительной информации о правильном значении URI перенаправления для вашего приложения dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-redirect-uri.png" title="Настройка URI перенаправления"/>

### Сопоставление пользователей и групп Azure &lt;-&gt; dbt Cloud

:::important

Существует [ограничение](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-fed-group-claims#important-caveats-for-this-functionality) на количество групп, которые Azure будет передавать (ограничено 150) через токен SSO, что означает, что если пользователь принадлежит более чем 150 группам, это будет выглядеть так, как будто он не принадлежит ни одной. Чтобы предотвратить это, настройте [назначения групп](https://learn.microsoft.com/en-us/entra/identity/enterprise-apps/assign-user-or-group-access-portal?pivots=portal) с приложением dbt Cloud в Azure и установите [запрос группы](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-fed-group-claims#add-group-claims-to-tokens-for-saml-applications-using-sso-configuration), чтобы Azure передавал только соответствующие группы.

:::

Пользователи и группы Azure, которые вы создадите в следующих шагах, сопоставляются с группами, созданными в dbt Cloud, на основе имени группы. Обратитесь к документации по [корпоративным разрешениям](enterprise-permissions) для получения дополнительной информации о том, как пользователи, группы и наборы разрешений настроены в dbt Cloud.

### Добавление пользователей в корпоративное приложение

После регистрации приложения следующим шагом будет назначение пользователей. Добавьте пользователей, которых вы хотите сделать видимыми для dbt, с помощью следующих шагов:

8. Вернитесь в [**Каталог по умолчанию**](https://portal.azure.com/#home) (или **Главная**) и нажмите **Корпоративные приложения**.
9. Нажмите на имя приложения, созданного ранее.
10. Нажмите **Назначить пользователей и группы**.
11. Нажмите **Добавить пользователя/группу**.
12. Назначьте дополнительных пользователей и группы по мере необходимости.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-enterprise-app-users.png" title="Добавление пользователей в корпоративное приложение"/>

:::info Требуется назначение пользователей?
В разделе **Свойства** проверьте настройку переключателя для **Требуется назначение пользователей?** и убедитесь, что она соответствует вашим требованиям. Большинство клиентов захотят, чтобы это было переключено на **Да**, чтобы только пользователи/группы, явно назначенные dbt Cloud, могли войти в систему. Если эта настройка переключена на **Нет**, любой пользователь сможет получить доступ к приложению, если у него есть прямая ссылка на приложение в соответствии с [документацией Microsoft Entra ID](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/assign-user-or-group-access-portal#configure-an-application-to-require-user-assignment).
:::

### Настройка разрешений

13. Вернитесь в [**Каталог по умолчанию**](https://portal.azure.com/#home) (или **Главная**) и затем **Регистрация приложений**.
14. Выберите ваше приложение и затем выберите **Разрешения API**.
15. Нажмите **+Добавить разрешение** и добавьте разрешения, показанные ниже.

| Имя API | Тип | Разрешение |
| -------- | ---- | ---------- |
| Microsoft Graph | Делегированное | `Directory.AccessAsUser.All` |
| Microsoft Graph | Делегированное | `Directory.Read.All` |
| Microsoft Graph | Делегированное | `User.Read` |

16. Сохраните эти разрешения, затем нажмите **Предоставить согласие администратора**, чтобы предоставить согласие администратора для этого каталога от имени всех ваших пользователей.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-permissions-overview.png" title="Настройка разрешений приложения" />

### Создание клиентского секрета

17. В разделе **Управление** нажмите **Сертификаты и секреты**.
18. Нажмите **+Новый клиентский секрет**.
19. Назовите клиентский секрет "dbt Cloud" (или аналогично), чтобы идентифицировать секрет.
20. Выберите **730 дней (24 месяца)** в качестве значения срока действия для этого секрета (рекомендуется).
21. Нажмите **Добавить**, чтобы завершить создание значения клиентского секрета (не ID клиентского секрета).
22. Запишите сгенерированный клиентский секрет в безопасное место. Позже в процессе настройки мы используем этот клиентский секрет в dbt Cloud для завершения настройки интеграции.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-secret-config.png" title="Настройка сертификатов и секретов" />
<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-secret-saved.png" title="Запись клиентского секрета" />

### Сбор клиентских учетных данных

23. Перейдите на страницу **Обзор** для регистрации приложения.
24. Обратите внимание на **ID приложения (клиента)** и **ID каталога (арендатора)**, показанные в этой форме, и запишите их вместе с вашим клиентским секретом. Мы будем использовать эти ключи на следующих шагах для завершения настройки интеграции в dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-overview.png" title="Сбор учетных данных. Храните их в безопасном месте" />

## Настройка dbt Cloud

Чтобы завершить настройку, выполните следующие шаги в приложении dbt Cloud.

### Предоставление учетных данных

25. В dbt Cloud нажмите на имя вашей учетной записи в левом меню и выберите **Настройки учетной записи**.
26. Нажмите **Одноразовый вход** в меню.
27. Нажмите кнопку **Редактировать** и укажите следующие данные SSO:

| Поле | Значение |
| ----- | ----- |
| **Войти&nbsp;с&nbsp;помощью** | Microsoft Entra ID Single Tenant |
| **ID&nbsp;клиента** | Вставьте **ID приложения (клиента)**, записанный на предыдущих шагах |
| **Секрет&nbsp;клиента** | Вставьте **Секрет клиента** (не забудьте использовать значение секрета вместо ID секрета) из предыдущих шагов; <br />**Примечание:** Когда срок действия клиентского секрета истечет, администратор Entra ID должен будет сгенерировать новый, чтобы вставить его в dbt Cloud для непрерывного доступа к приложению. |
| **ID&nbsp;арендатора** | Вставьте **ID каталога (арендатора)**, записанный на предыдущих шагах |
| **Домен** | Введите имя домена для вашего каталога Azure (например, `fishtownanalytics.com`). Используйте только основной домен; это не заблокирует доступ для других доменов. |
| **Slug** | Введите желаемый slug для входа. Пользователи смогут войти в dbt Cloud, перейдя по адресу `https://YOUR_ACCESS_URL/enterprise-login/LOGIN-SLUG`, заменив `YOUR_ACCESS_URL` на [соответствующий URL доступа](/docs/cloud/manage-access/sso-overview#auth0-multi-tenant-uris) для вашего региона и плана. Slug для входа должен быть уникальным для всех учетных записей dbt Cloud, поэтому выберите slug, который уникально идентифицирует вашу компанию. |

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-cloud-sso.png" title="Настройка Entra ID AD SSO в dbt Cloud" />

1.  Нажмите **Сохранить**, чтобы завершить настройку интеграции SSO Microsoft Entra ID. Отсюда вы можете перейти к URL-адресу входа, сгенерированному для _slug_ вашей учетной записи, чтобы протестировать вход с помощью Entra ID.

<Snippet path="login_url_note" />

## Настройка RBAC
Теперь, когда вы завершили настройку SSO с Entra ID, следующими шагами будет настройка
[групп RBAC](/docs/cloud/manage-access/enterprise-permissions) для завершения конфигурации управления доступом.

## Советы по устранению неполадок

Убедитесь, что имя домена, под которым существуют учетные записи пользователей в Azure, совпадает с доменом, который вы указали в [Предоставление учетных данных](#supplying-credentials) при настройке SSO.

<Lightbox src="/img/docs/dbt-cloud/dbt-cloud-enterprise/azure/azure-get-domain.png" title="Получение домена пользователя из Azure" />