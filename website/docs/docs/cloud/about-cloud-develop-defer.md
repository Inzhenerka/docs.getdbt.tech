---
title: Использование defer в dbt
id: about-cloud-develop-defer
description: "Узнайте, как использовать defer на prod при разработке с dbt."
sidebar_label: "Defer в dbt"
pagination_next: "docs/about-dbt-extension"
---

[Defer](/reference/node-selection/defer) — это мощная функция, которая позволяет разработчикам строить, запускать и тестировать только те модели, которые они изменили, без необходимости сначала запускать и строить все модели, которые идут перед ними (вышестоящие родительские модели). dbt обеспечивает это, используя манифест продакшена для сравнения и разрешает функцию `{{ ref() }}` с помощью вышестоящих продакшен-артефактов.

Как IDE dbt Cloud, так и CLI dbt Cloud позволяют пользователям нативно использовать defer к метаданным продакшена непосредственно в их рабочих процессах разработки.

И <Constant name="cloud_ide" />, и CLI <Constant name="cloud" /> позволяют пользователям нативно использовать продакшн‑метаданные напрямую в своих рабочих процессах разработки.

При использовании `--defer`, dbt Cloud будет следовать этому порядку выполнения для разрешения функций `{{ ref() }}`.

При использовании `--defer`, <Constant name="cloud" /> будет придерживаться следующего порядка выполнения при разрешении функций `{{ ref() }}`:

1. Если существует версия отложенного отношения в среде разработки, dbt в приоритетном порядке использует расположение базы данных среды разработки при разрешении ссылки.
2. Если версия в среде разработки не существует, dbt использует staging‑расположения родительских отношений на основе метаданных из staging‑окружения.
3. Если не существует ни версии в среде разработки, ни staging‑окружения, dbt использует production‑расположения родительских отношений на основе метаданных из production‑окружения. Обратите внимание, что dbt откладывает разрешение только к одному окружению за один запуск — либо staging, либо production.

Для чистого начала рекомендуется удалять схему разработки в начале и в конце вашего цикла разработки.

Если вам требуются дополнительные средства контроля над продакшен-данными, создайте [Промежуточную среду](/docs/deploy/deploy-environments#staging-environment), и dbt будет использовать её, а не продакшен-среду, для разрешения функций `{{ ref() }}`.

## Необходимая настройка

- Вы должны выбрать флажок **[Продакшен-среда](/docs/deploy/deploy-environments#set-as-production-environment)** на странице **Настройки среды**.
  - Это можно установить для одной среды развертывания на проект dbt Cloud.
- У вас должен быть успешный запуск задания.

- Необходимо выбрать флажок **[Production environment](/docs/deploy/deploy-environments#set-as-production-environment)** на странице **Environment Settings**.  
  - Это можно настроить только для одного окружения развертывания в рамках одного проекта <Constant name="cloud" />.
- Сначала у вас должен быть хотя бы один успешный запуск job.

### Defer в dbt Cloud IDE

### Defer в dbt IDE

Чтобы использовать defer в <Constant name="cloud_ide" />, у вас должны быть production-артефакты, сгенерированные deploy-задачей. <Constant name="cloud" /> сначала будет искать эти артефакты в окружении Staging (если оно существует), а если нет — в окружении Production.

Функция defer в <Constant name="cloud_ide" /> не будет работать, если окружение Staging существует, но ни одна deploy-задача ещё не запускалась. Это связано с тем, что необходимая метадата, на которой основан defer, появляется только после успешного выполнения deploy-задачи в окружении Staging.

Чтобы включить defer в <Constant name="cloud_ide" />, переключите кнопку **Defer to staging/production** на панели команд. После включения <Constant name="cloud" /> будет:

1. Загружать самый свежий manifest из окружения Staging или Production для сравнения
2. Передавать флаг `--defer` в команду (для любой команды, которая поддерживает этот флаг)

Например, если вы начнёте разработку в новой ветке с [пустой схемой разработки](/reference/node-selection/defer#usage), измените одну модель и выполните команду `dbt build -s state:modified` &mdash; будет выполнена только отредактированная модель. Все вызовы `{{ ref() }}` будут указывать на staging- или production-расположение соответствующих моделей.

<Lightbox src="/img/docs/dbt-cloud/defer-toggle.png" width="100%" title="Выберите переключатель «Defer to production» в правом нижнем углу панели команд, чтобы включить defer в Studio IDE."/>

### Defer в dbt CLI

Одно из ключевых отличий использования `--defer` в <Constant name="cloud_cli" /> по сравнению с <Constant name="cloud_ide" /> заключается в том, что в <Constant name="cloud_cli" /> флаг `--defer` *включён автоматически* для всех запусков при сравнении с production-артефактами. Вы можете отключить его с помощью флага `--no-defer`.

<Constant name="cloud_cli" /> предоставляет дополнительную гибкость, позволяя выбрать окружение-источник для артефактов defer. Вы можете вручную задать ключ `defer-env-id` либо в файле `dbt_project.yml`, либо в файле `dbt_cloud.yml`. По умолчанию <Constant name="cloud_cli" /> будет использовать метаданные из окружения «Staging» проекта (если оно определено), в противном случае — из «Production».

<File name="dbt_cloud.yml">

```yml
context:
  active-host: ...
  active-project: ...
  defer-env-id: '123456'
```

</File>

<File name="dbt_project.yml"> 

```yml
dbt-cloud:
  defer-env-id: '123456'
```

</File>