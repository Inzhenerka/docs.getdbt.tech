---
title: Использование defer в dbt Cloud
id: about-cloud-develop-defer
description: "Узнайте, как использовать defer для продакшена при разработке с dbt Cloud."
sidebar_label: "Использование defer в dbt Cloud"
pagination_next: "docs/cloud/cloud-cli-installation"
---

[Defer](/reference/node-selection/defer) — это мощная функция, которая позволяет разработчикам строить, запускать и тестировать только те модели, которые они редактировали, без необходимости сначала запускать и строить все модели, которые идут перед ними (родительские модели). dbt реализует это, используя манифест продакшена для сравнения и разрешая функцию `{{ ref() }}` с помощью артефактов продакшена.

Как dbt Cloud IDE, так и dbt Cloud CLI позволяют пользователям нативно использовать метаданные продакшена непосредственно в их рабочих процессах разработки.

<Lightbox src="/img/docs/reference/defer-diagram.png" width="50%" title="Используйте 'defer', чтобы модифицировать модели в конце конвейера, указывая на модели продакшена, вместо того чтобы запускать все родительские модели." />

При использовании `--defer` dbt Cloud будет следовать этому порядку выполнения для разрешения функций `{{ ref() }}`.

1. Если существует версия отложенной связи в среде разработки, dbt предпочитает использовать местоположение базы данных разработки при разрешении ссылки.
2. Если версия разработки не существует, dbt использует промежуточные местоположения родительских связей на основе метаданных из промежуточной среды.
3. Если ни версия разработки, ни промежуточная версия не существуют, dbt использует производственные местоположения родительских связей на основе метаданных из производственной среды.

**Примечание:** Передача флага `--favor-state` всегда будет разрешать ссылки, используя промежуточные метаданные, если они доступны; в противном случае по умолчанию используются производственные метаданные, независимо от наличия версии разработки, пропуская шаг #1.

Для чистого начала хорошей практикой является удаление схемы разработки в начале и в конце вашего цикла разработки.

Если вам требуется дополнительный контроль над данными продакшена, создайте [Промежуточную среду](/docs/deploy/deploy-environments#staging-environment), и dbt будет использовать ее вместо производственной среды для разрешения функций `{{ ref() }}`.

## Необходимая настройка

- Вы должны выбрать флажок **[Производственная среда](/docs/deploy/deploy-environments#set-as-production-environment)** на странице **Настройки среды**. 
  - Это можно установить для одной среды развертывания на проект dbt Cloud.
- Сначала у вас должен быть успешный запуск задания.

При использовании defer он сравнивает артефакты из последнего успешного задания в продакшене, исключая CI задания.

### Defer в dbt Cloud IDE

Чтобы включить defer в dbt Cloud IDE, переключите кнопку **Defer to production** на панели команд. После включения dbt Cloud будет:

1. Загружать самый последний манифест из производственной среды для сравнения
2. Передавать флаг `--defer` в команду (для любой команды, которая принимает этот флаг)

Например, если вы начнете разработку на новой ветке с [пустой схемой разработки](/reference/node-selection/defer#usage), отредактируете одну модель и выполните `dbt build -s state:modified` &mdash; только отредактированная модель будет запущена. Все функции `{{ ref() }}` будут указывать на производственное местоположение ссылочных моделей.

<Lightbox src="/img/docs/dbt-cloud/defer-toggle.jpg" width="100%" title="Выберите переключатель 'Defer to production' в правом нижнем углу панели команд, чтобы включить defer в dbt Cloud IDE." />

### Defer в dbt Cloud CLI

Одно из ключевых отличий между использованием `--defer` в dbt Cloud CLI и dbt Cloud IDE заключается в том, что `--defer` *автоматически* включен в dbt Cloud CLI для всех вызовов, по сравнению с артефактами продакшена. Вы можете отключить его с помощью флага `--no-defer`.

dbt Cloud CLI предлагает дополнительную гибкость, позволяя вам выбирать исходную среду для артефактов отложенного выполнения. Вы можете вручную установить ключ `defer-env-id` в вашем файле `dbt_project.yml` или `dbt_cloud.yml`. По умолчанию dbt Cloud CLI будет предпочитать метаданные из "Промежуточной" среды проекта (если она определена), в противном случае — "Производственной".

<File name="dbt_cloud.yml">

```yml
context:
  active-host: ...
  active-project: ...
  defer-env-id: '123456'
```

</File>

<File name="dbt_project.yml"> 

```yml
dbt-cloud:
  defer-env-id: '123456'
```

</File>