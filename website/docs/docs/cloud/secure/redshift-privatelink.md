---
title: "Настройка AWS PrivateLink для Redshift"
id: redshift-privatelink
description: "Настройка PrivateLink для Redshift"
sidebar_label: "PrivateLink для Redshift"
---

import SetUpPages from '/snippets/_available-tiers-privatelink.md';
import PrivateLinkTroubleshooting from '/snippets/_privatelink-troubleshooting.md';
import PrivateLinkCrossZone from '/snippets/_privatelink-cross-zone-load-balancing.md';
import CloudProviders from '/snippets/_privatelink-across-providers.md';

<SetUpPages features={'/snippets/_available-tiers-privatelink.md'}/>

AWS предоставляет два различных способа создания конечной точки VPC PrivateLink для кластера Redshift, который работает в другой VPC: 
- [Конечные точки PrivateLink, управляемые Redshift](https://docs.aws.amazon.com/redshift/latest/mgmt/managing-cluster-cross-vpc.html)
- [Конечные точки PrivateLink типа Interface для Redshift](https://docs.aws.amazon.com/redshift/latest/mgmt/security-private-link.html)

dbt Cloud поддерживает оба типа конечных точек, но есть ряд [факторов](https://docs.aws.amazon.com/redshift/latest/mgmt/managing-cluster-cross-vpc.html#managing-cluster-cross-vpc-considerations), которые следует учитывать при выборе типа конечной точки. Управляемые Redshift конечные точки обеспечивают гораздо более простую настройку без дополнительных затрат, что может сделать их предпочтительным вариантом для многих, но они могут быть недоступны в некоторых средах. На основе этих критериев вам нужно определить, какой тип подходит для вашей системы. Следуйте инструкциям из раздела ниже, который соответствует выбранному вами типу конечной точки.

<CloudProviders type='Redshift' />

:::note Redshift Serverless
Хотя Redshift Serverless поддерживает конечные точки VPC типа, управляемые Redshift, эта функциональность в настоящее время недоступна между учетными записями AWS. Из-за этого ограничения для подключения к кластеру Redshift Serverless через PrivateLink из dbt Cloud необходимо использовать конечную точку VPC типа Interface. 
:::

## Настройка управляемого Redshift PrivateLink

1. На работающем кластере Redshift выберите вкладку **Свойства**.

<Lightbox src="/img/docs/dbt-cloud/redshiftprivatelink1.png" title="Вкладка свойств Redshift"/>

2. В разделе **Предоставленные учетные записи** нажмите **Предоставить доступ**.

<Lightbox src="/img/docs/dbt-cloud/redshiftprivatelink2.png" title="Предоставленные учетные записи Redshift"/>

3. Введите идентификатор учетной записи AWS: `346425330055` - _ПРИМЕЧАНИЕ: Этот идентификатор учетной записи применяется только к многоарендным средам dbt Cloud. Для идентификаторов учетных записей виртуальной частной/одиночной аренды, пожалуйста, свяжитесь с [Поддержкой](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support)._

4. Выберите **Предоставить доступ ко всем VPC** — или — (по желанию) свяжитесь с [Поддержкой](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support) для получения соответствующего идентификатора региональной VPC, который следует указать в поле **Предоставить доступ к конкретным VPC**.

<Lightbox src="/img/docs/dbt-cloud/redshiftprivatelink3.png" title="Предоставление доступа Redshift"/>

5. Добавьте необходимую информацию в следующий шаблон и отправьте свой запрос в [поддержку dbt](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support):

```
Тема: Запрос на новый многоарендный PrivateLink
- Тип: Управляемый Redshift
- Имя кластера Redshift:
- Идентификатор учетной записи AWS кластера Redshift:
- Регион AWS кластера Redshift (например, us-east-1, eu-west-2):
- Многоарендная среда dbt Cloud (США, EMEA, AU):
```

import PrivateLinkSLA from '/snippets/_PrivateLink-SLA.md';

<PrivateLinkSLA />

## Настройка PrivateLink типа Interface для Redshift

### 1. Подготовка ресурсов AWS

Создание соединения VPC PrivateLink типа Interface требует создания нескольких ресурсов AWS в учетной записи, содержащей кластер Redshift:

- **Группа безопасности** — Если вы подключаетесь к существующему кластеру Redshift, она, вероятно, уже существует, однако вам может потребоваться добавить или изменить правила группы безопасности, чтобы разрешить трафик от сетевого балансировщика нагрузки (NLB), созданного для этой конечной точки службы.
- **Группа целевых объектов** — Группа целевых объектов будет прикреплена к NLB, чтобы указать, куда направлять запросы. Для групп целевых объектов NLB доступны различные типы целевых объектов, но вы будете использовать тип IP-адреса.
    
    - Тип целевого объекта: **IP**

        - **Стандартный Redshift**

            - Используйте IP-адреса из **Сетевых интерфейсов** кластера Redshift, когда это возможно. Хотя IP-адреса, указанные в разделе **IP-адреса узлов**, будут работать, они также более подвержены изменениям.
            <Lightbox src="/img/docs/dbt-cloud/redshiftprivatelink4.png" title="Тип целевого объекта: IP-адрес"/>

            - Вероятно, в начале будет только один сетевой интерфейс (NI), но если кластер переключится на другую зону доступности (AZ), для этой AZ также будет создан новый NI. IP-адрес NI из оригинальной AZ будет по-прежнему работать, но новый IP-адрес NI также можно добавить в группу целевых объектов. Если вы добавляете дополнительные IP-адреса, обратите внимание, что NLB также должен добавить соответствующую AZ. После создания NI(и) должны оставаться неизменными (это наше наблюдение из тестирования, но AWS официально это не документирует).

        - **Redshift Serverless**

            - Чтобы найти IP-адреса для экземпляра Redshift Serverless, найдите и скопируйте конечную точку (только URL, указанный перед портом) в разделе конфигурации рабочей группы консоли AWS для экземпляра.
            <Lightbox src="/img/docs/dbt-cloud/redshiftserverless.png" title="Конечная точка Redshift Serverless"/>

            - Выполните команду `nslookup <endpoint>` из командной строки, используя конечную точку, найденную на предыдущем шаге, и используйте соответствующий IP(адреса) для группы целевых объектов.

    - Протокол группы целевых объектов: **TCP** 

- **Сетевой балансировщик нагрузки (NLB)** — Требуется создать слушатель, который прикрепляется к только что созданной группе целевых объектов для порта `5439`
    - **Схема:** Внутренняя
    - **Тип IP-адреса:** IPv4
    - **Сетевое сопоставление:** Выберите VPC, в которой развертывается служба конечной точки VPC и NLB, и выберите подсети как минимум из двух зон доступности.
    - **Группы безопасности:** Сетевой балансировщик нагрузки (NLB), связанный со службой конечной точки VPC, не должен иметь связанную группу безопасности, или группа безопасности должна иметь правило, которое разрешает запросы от соответствующих **частных CIDR** dbt Cloud. Обратите внимание, что _это отличается_ от статических публичных IP-адресов, указанных на странице dbt Cloud [Доступ, регионы и IP-адреса](https://docs.getdbt.com/docs/cloud/about-cloud/access-regions-ip-addresses). Поддержка dbt может предоставить правильные частные CIDR по запросу. Если необходимо, пока вы не сможете уточнить правило до меньшего CIDR, предоставленного dbt, разрешите подключение, временно добавив правило разрешения `10.0.0.0/8`.
    - **Слушатели:** Создайте одного слушателя на каждую группу целевых объектов, который сопоставляет соответствующий входящий порт с соответствующей группой целевых объектов ([подробности](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-listeners.html)).
- **Служба конечной точки VPC** — Присоедините к только что созданному NLB.
    - Требуется подтверждение (по желанию) — Требует от вас [принять наш запрос на подключение](https://docs.aws.amazon.com/vpc/latest/privatelink/configure-endpoint-service.html#accept-reject-connection-requests) после того, как dbt создаст конечную точку.

<PrivateLinkCrossZone features={'/snippets/_privatelink-cross-zone-load-balancing.md'}/>

### 2. Предоставьте учетной записи dbt доступ к службе конечной точки VPC

На подготовленной службе конечной точки VPC нажмите вкладку **Разрешить принципалам**. Нажмите **Разрешить принципалам**, чтобы предоставить доступ. Введите ARN корневого пользователя в соответствующей производственной учетной записи AWS и сохраните изменения.

 - Принципал: `arn:aws:iam::346425330055:role/MTPL_Admin`

<Lightbox src="/img/docs/dbt-cloud/privatelink-allow-principals.png" title="Введите ARN"/>

### 3. Получите имя службы конечной точки VPC

После подготовки службы конечной точки VPC вы можете найти имя службы в консоли AWS, перейдя в **VPC** → **Службы конечных точек** и выбрав соответствующую службу конечной точки. Вы можете скопировать значение поля имени службы и включить его в ваше сообщение в поддержку dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/privatelink-endpoint-service-name.png" title="Получите значение поля имени службы"/>

### 4. Добавьте необходимую информацию в шаблон ниже и отправьте свой запрос в [поддержку dbt](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support):
```
Тема: Запрос на новый многоарендный PrivateLink
- Тип: PrivateLink типа Interface для Redshift
- Имя службы конечной точки VPC:
- Регион AWS кластера Redshift (например, us-east-1, eu-west-2):
- Многоарендная среда dbt Cloud (США, EMEA, AU):
```

<PrivateLinkSLA />

## Создание подключения в dbt Cloud

После завершения настройки поддержки dbt Cloud вы можете начать создавать новые подключения с использованием PrivateLink.

1. Перейдите в **настройки** → **Создать новый проект** → выберите **Redshift**
2. Вы увидите два переключателя: **Публичный** и **Частный**. Выберите **Частный**. 
3. Выберите частную конечную точку из выпадающего списка (это автоматически заполнит поле имени хоста/учетной записи).
4. Настройте оставшиеся детали платформы данных.
5. Протестируйте ваше подключение и сохраните его.

<PrivateLinkTroubleshooting features={'/snippets/_privatelink-troubleshooting.md'}/>