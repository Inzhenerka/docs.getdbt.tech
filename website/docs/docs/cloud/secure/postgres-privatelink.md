---
title: "Настройка AWS PrivateLink для Postgres"
id: postgres-privatelink
description: "Настройка PrivateLink для Postgres"
sidebar_label: "PrivateLink для Postgres"
---
import SetUpPages from '/snippets/_available-tiers-privatelink.md';
import PrivateLinkTroubleshooting from '/snippets/_privatelink-troubleshooting.md';
import PrivateLinkCrossZone from '/snippets/_privatelink-cross-zone-load-balancing.md';
import CloudProviders from '/snippets/_privatelink-across-providers.md';

<SetUpPages features={'/snippets/_available-tiers-privatelink.md'}/>

База данных Postgres, размещенная либо в AWS, либо в правильно подключенном локальном центре обработки данных, может быть доступна через частное сетевое соединение с использованием AWS Interface-type PrivateLink. Тип группы целей, подключенной к сетевому балансировщику нагрузки (NLB), может варьироваться в зависимости от местоположения и типа подключаемого экземпляра Postgres, как объясняется в следующих шагах.

<CloudProviders type='Postgres' />

## Настройка интерфейсного типа PrivateLink для Postgres

### 1. Подготовка ресурсов AWS

Создание соединения Interface VPC PrivateLink требует создания нескольких ресурсов AWS в учетной записи, содержащей или подключенной к экземпляру Postgres:

- **Группа безопасности (только для размещения в AWS)** &mdash; Если вы подключаетесь к существующему экземпляру Postgres, это, вероятно, уже существует, однако вам может потребоваться добавить или изменить правила группы безопасности, чтобы принимать трафик от сетевого балансировщика нагрузки (NLB), созданного для этой службы конечной точки.
- **Группа целей** &mdash; Группа целей будет прикреплена к NLB, чтобы указать, куда направлять запросы. Для групп целей NLB доступны различные типы целей, поэтому выберите тот, который подходит для вашей настройки Postgres.
    
    - Тип цели:

        - _[Amazon RDS для PostgreSQL](https://aws.amazon.com/rds/postgresql/)_ -  **IP**

            - Найдите IP-адрес вашего экземпляра RDS, используя командную строку, такую как `nslookup <endpoint>` или `dig +short <endpoint>` с вашим DNS-адресом RDS

            - _Примечание_: С возможностями отказоустойчивости RDS Multi-AZ IP-адрес вашего экземпляра RDS может измениться, в этом случае ваша группа целей должна быть обновлена. См. [этот блог AWS](https://aws.amazon.com/blogs/database/access-amazon-rds-across-vpcs-using-aws-privatelink-and-network-load-balancer/) для получения более подробной информации и возможного решения. 

        - _Локальный сервер Postgres_ -  **IP**

            - Используйте IP-адрес локального сервера Postgres, связанного с AWS через AWS Direct Connect или соединение VPN "сайт-сайт"

        - _Postgres на EC2_ - **Instance/ASG** (или **IP**)

            - Если ваш экземпляр Postgres размещен на EC2, тип группы целей _instance_ (или, в идеале, [использование типа instance для подключения к группе автоматического масштабирования](https://docs.aws.amazon.com/autoscaling/ec2/userguide/attach-load-balancer-asg.html)) может быть использован для подключения экземпляра без необходимости в статическом IP-адресе

            - Тип IP также может быть использован, с пониманием того, что IP-адрес экземпляра EC2 может измениться, если экземпляр будет перезапущен по какой-либо причине

    - Протокол группы целей: **TCP** 

- **Сетевой балансировщик нагрузки (NLB)** &mdash; Требуется создание слушателя, который прикрепляется к вновь созданной группе целей для порта `5432`
    - **Схема:** Внутренняя
    - **Тип IP-адреса:** IPv4
    - **Сетевое отображение:** Выберите VPC, в котором развертываются служба конечной точки VPC и NLB, и выберите подсети как минимум из двух зон доступности.
    - **Группы безопасности:** Сетевой балансировщик нагрузки (NLB), связанный с службой конечной точки VPC, должен либо не иметь связанной группы безопасности, либо группа безопасности должна иметь правило, позволяющее запросы от соответствующих **частных CIDR** dbt Cloud. Обратите внимание, что _это отличается_ от статических публичных IP-адресов, указанных на странице [Доступ, регионы и IP-адреса](https://docs.getdbt.com/docs/cloud/about-cloud/access-regions-ip-addresses) dbt Cloud. Поддержка dbt может предоставить правильные частные CIDR по запросу. Если необходимо, до того как вы сможете уточнить правило до меньшего CIDR, предоставленного dbt, разрешите подключение, временно добавив правило разрешения `10.0.0.0/8`.
    - **Слушатели:** Создайте одного слушателя на каждую группу целей, который сопоставляет соответствующий входящий порт с соответствующей группой целей ([подробности](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-listeners.html)).
- **Служба конечной точки VPC** &mdash; Подключите к вновь созданному NLB.
    - Требуется принятие (опционально) &mdash; Требует [принять наш запрос на подключение](https://docs.aws.amazon.com/vpc/latest/privatelink/configure-endpoint-service.html#accept-reject-connection-requests) после того, как dbt создаст конечную точку.

<PrivateLinkCrossZone features={'/snippets/_privatelink-cross-zone-load-balancing.md'}/>

### 2. Предоставление доступа учетной записи AWS dbt к службе конечной точки VPC

На подготовленной службе конечной точки VPC нажмите вкладку **Разрешить принципалов**. Нажмите **Разрешить принципалов**, чтобы предоставить доступ. Введите ARN корневого пользователя в соответствующей производственной учетной записи AWS и сохраните изменения.

 - Принципал: `arn:aws:iam::346425330055:role/MTPL_Admin`

<Lightbox src="/img/docs/dbt-cloud/privatelink-allow-principals.png" width="70%" title="Введите ARN"/>

### 3. Получение имени службы конечной точки VPC

После того как служба конечной точки VPC будет подготовлена, вы можете найти имя службы в консоли AWS, перейдя в **VPC** → **Службы конечных точек** и выбрав соответствующую службу конечной точки. Вы можете скопировать значение поля имени службы и включить его в ваше сообщение в поддержку dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/privatelink-endpoint-service-name.png" width="70%" title="Получите значение поля имени службы"/>

### 4. Добавьте необходимую информацию в шаблон ниже и отправьте ваш запрос в [поддержку dbt](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support):
```
Тема: Новый запрос на Multi-Tenant PrivateLink
- Тип: Интерфейсный тип Postgres
- Имя службы конечной точки VPC:
- Регион AWS сервера Postgres (например, us-east-1, eu-west-2):
- Мультиарендная среда dbt Cloud (США, EMEA, AU):
```

import PrivateLinkSLA from '/snippets/_PrivateLink-SLA.md';

<PrivateLinkSLA />

### 5. Принятие запроса на подключение

Когда вы получите уведомление о том, что ресурсы подготовлены в среде dbt Cloud, вы должны принять подключение к конечной точке (если служба конечной точки VPC не настроена на автоматическое принятие запросов на подключение). Запросы могут быть приняты через консоль AWS, как показано ниже, или через AWS CLI.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/accept-request.png" width="80%" title="Принять запрос на подключение" />

## Создание подключения в dbt Cloud

После того как поддержка dbt Cloud завершит настройку, вы можете начать создавать новые подключения, используя PrivateLink.

1. Перейдите в **настройки** → **Создать новый проект** → выберите **PostgreSQL**
2. Вы увидите две радиокнопки: **Публичный** и **Частный.** Выберите **Частный**. 
3. Выберите частную конечную точку из выпадающего списка (это автоматически заполнит поле имени хоста/учетной записи).
4. Настройте оставшиеся детали платформы данных.
5. Проверьте ваше подключение и сохраните его.

<PrivateLinkTroubleshooting features={'/snippets/_privatelink-troubleshooting.md'}/>