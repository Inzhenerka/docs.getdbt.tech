---
title: "Настройка AWS PrivateLink для Postgres"
id: postgres-privatelink
description: "Настройка PrivateLink для Postgres"
sidebar_label: "PrivateLink для Postgres"
---
import SetUpPages from '/snippets/_available-tiers-privatelink.md';
import PrivateLinkTroubleshooting from '/snippets/_privatelink-troubleshooting.md';
import PrivateLinkCrossZone from '/snippets/_privatelink-cross-zone-load-balancing.md';
import CloudProviders from '/snippets/_privatelink-across-providers.md';

<SetUpPages features={'/snippets/_available-tiers-privatelink.md'}/>

База данных Postgres, размещенная либо в AWS, либо в правильно подключенном локальном центре обработки данных, может быть доступна через частное сетевое соединение с использованием AWS PrivateLink типа Interface. Тип группы целевых ресурсов, подключенной к сетевому балансировщику нагрузки (NLB), может варьироваться в зависимости от местоположения и типа экземпляра Postgres, к которому осуществляется подключение, как объясняется в следующих шагах.

<CloudProviders type='Postgres' />

## Настройка PrivateLink типа Interface для Postgres

### 1. Подготовка ресурсов AWS

Создание соединения VPC PrivateLink типа Interface требует создания нескольких ресурсов AWS в учетной записи, содержащей или подключенной к экземпляру Postgres:

- **Группа безопасности (только для AWS)** &mdash; Если вы подключаетесь к существующему экземпляру Postgres, она, вероятно, уже существует, однако вам может потребоваться добавить или изменить правила группы безопасности, чтобы разрешить трафик от сетевого балансировщика нагрузки (NLB), созданного для этой службы конечной точки.
- **Группа целевых ресурсов** &mdash; Группа целевых ресурсов будет прикреплена к NLB, чтобы указать, куда направлять запросы. Существуют различные типы целевых ресурсов для групп целевых ресурсов NLB, поэтому выберите тот, который подходит для вашей настройки Postgres.
    
    - Тип целевого ресурса:

        - _[Amazon RDS для PostgreSQL](https://aws.amazon.com/rds/postgresql/)_ -  **IP**

            - Найдите IP-адрес вашего экземпляра RDS с помощью командной строки, используя такие инструменты, как `nslookup <endpoint>` или `dig +short <endpoint>` с вашим DNS-эндпоинтом RDS.

            - _Примечание_: С возможностями переключения на резервный экземпляр RDS Multi-AZ IP-адрес вашего экземпляра RDS может измениться, и в этом случае вашу группу целевых ресурсов необходимо будет обновить. См. [этот пост в блоге AWS](https://aws.amazon.com/blogs/database/access-amazon-rds-across-vpcs-using-aws-privatelink-and-network-load-balancer/) для получения дополнительных сведений и возможного решения.

        - _Локальный сервер Postgres_ -  **IP**

            - Используйте IP-адрес локального сервера Postgres, связанного с AWS через AWS Direct Connect или соединение Site-to-Site VPN.

        - _Postgres на EC2_ - **Экземпляр/ASG** (или **IP**)

            - Если ваш экземпляр Postgres размещен на EC2, можно использовать тип целевой группы _экземпляр_ (или, в идеале, [использовать тип экземпляра для подключения к группе автоматического масштабирования](https://docs.aws.amazon.com/autoscaling/ec2/userguide/attach-load-balancer-asg.html)), чтобы прикрепить экземпляр без необходимости в статическом IP-адресе.

            - Также можно использовать тип IP, понимая, что IP-адрес экземпляра EC2 может измениться, если экземпляр будет перезапущен по какой-либо причине.

    - Протокол группы целевых ресурсов: **TCP** 

- **Сетевой балансировщик нагрузки (NLB)** &mdash; Требует создания слушателя, который прикрепляется к вновь созданной группе целевых ресурсов для порта `5432`.
    - **Схема:** Внутренняя
    - **Тип IP-адреса:** IPv4
    - **Сетевое сопоставление:** Выберите VPC, в которой развертываются служба конечной точки VPC и NLB, и выберите подсети как минимум из двух зон доступности.
    - **Группы безопасности:** Сетевой балансировщик нагрузки (NLB), связанный со службой конечной точки VPC, не должен иметь связанную группу безопасности, или группа безопасности должна иметь правило, которое разрешает запросы от соответствующих **частных CIDR** dbt Cloud. Обратите внимание, что _это отличается_ от статических публичных IP-адресов, указанных на странице dbt Cloud [Доступ, регионы и IP-адреса](https://docs.getdbt.com/docs/cloud/about-cloud/access-regions-ip-addresses). Поддержка dbt может предоставить правильные частные CIDR по запросу. Если необходимо, пока вы не сможете уточнить правило до меньшего CIDR, предоставленного dbt, разрешите подключение, временно добавив правило разрешения `10.0.0.0/8`.
    - **Слушатели:** Создайте одного слушателя на каждую группу целевых ресурсов, который сопоставляет соответствующий входящий порт с соответствующей группой целевых ресурсов ([подробности](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-listeners.html)).
- **Служба конечной точки VPC** &mdash; Присоедините к вновь созданному NLB.
    - Требуется подтверждение (необязательно) &mdash; Требует от вас [принять наш запрос на подключение](https://docs.aws.amazon.com/vpc/latest/privatelink/configure-endpoint-service.html#accept-reject-connection-requests) после того, как dbt создаст конечную точку.

<PrivateLinkCrossZone features={'/snippets/_privatelink-cross-zone-load-balancing.md'}/>

### 2. Предоставьте учетной записи dbt доступ к службе конечной точки VPC

На подготовленной службе конечной точки VPC нажмите на вкладку **Разрешить принципалам**. Нажмите **Разрешить принципалам**, чтобы предоставить доступ. Введите ARN корневого пользователя в соответствующей производственной учетной записи AWS и сохраните изменения.

 - Принципал: `arn:aws:iam::346425330055:role/MTPL_Admin`

<Lightbox src="/img/docs/dbt-cloud/privatelink-allow-principals.png" width="70%" title="Введите ARN"/>

### 3. Получите имя службы конечной точки VPC

После того как служба конечной точки VPC будет подготовлена, вы можете найти имя службы в консоли AWS, перейдя в **VPC** → **Службы конечных точек** и выбрав соответствующую службу конечной точки. Вы можете скопировать значение поля имени службы и включить его в ваше сообщение в поддержку dbt Cloud.

<Lightbox src="/img/docs/dbt-cloud/privatelink-endpoint-service-name.png" width="70%" title="Получите значение поля имени службы"/>

### 4. Добавьте необходимую информацию в шаблон ниже и отправьте свой запрос в [поддержку dbt](https://docs.getdbt.com/community/resources/getting-help#dbt-cloud-support):
```
Тема: Запрос на новый Multi-Tenant PrivateLink
- Тип: Postgres Interface-type
- Имя службы конечной точки VPC:
- Регион AWS сервера Postgres (например, us-east-1, eu-west-2):
- Многоарендная среда dbt Cloud (США, EMEA, AU):
```

import PrivateLinkSLA from '/snippets/_PrivateLink-SLA.md';

<PrivateLinkSLA />

### 5. Принятие запроса на подключение

Когда вам сообщат, что ресурсы подготовлены в среде dbt Cloud, вы должны принять соединение конечной точки (если служба конечной точки VPC не настроена на автоматическое принятие запросов на подключение). Запросы можно принимать через консоль AWS, как показано ниже, или через AWS CLI.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/accept-request.png" width="80%" title="Принять запрос на подключение" />

## Создание соединения в dbt Cloud

После завершения настройки поддержки dbt Cloud вы можете начать создавать новые соединения с использованием PrivateLink.

1. Перейдите в **настройки** → **Создать новый проект** → выберите **PostgreSQL**.
2. Вы увидите две радиокнопки: **Публичный** и **Частный**. Выберите **Частный**. 
3. Выберите частную конечную точку из выпадающего списка (это автоматически заполнит поле имени хоста/учетной записи).
4. Настройте оставшиеся детали платформы данных.
5. Протестируйте ваше соединение и сохраните его.

<PrivateLinkTroubleshooting features={'/snippets/_privatelink-troubleshooting.md'}/>