---
title: "Семантические модели"
id: "semantic-models"
description: "Семантические модели — это абстракции yml, построенные на основе модели dbt, соединенные через ключи соединения в качестве рёбер"
keywords:
  - слой метрик dbt
sidebar_label: Семантические модели
tags: [Метрики, Семантический слой]
pagination_next: "docs/build/dimensions"
---

import CopilotBeta from '/snippets/_dbt-copilot-avail.md';

<CopilotBeta resource='semantic models' />

Семантические модели являются основой для определения данных в MetricFlow, который поддерживает семантический слой dbt:

- Рассматривайте семантические модели как узлы, соединенные сущностями в семантическом графе.
- MetricFlow использует файлы конфигурации YAML для создания этого графа для запроса метрик.
- Каждая семантическая модель соответствует модели dbt в вашем DAG и требует уникальной конфигурации YAML для каждой семантической модели.
- Вы можете создать несколько семантических моделей из одной модели dbt (SQL или Python), при условии, что каждой семантической модели будет дано уникальное имя.
- Настройте семантические модели в файле YAML в каталоге вашего проекта dbt. Обратитесь к [руководству по лучшим практикам](/best-practices/how-we-build-our-metrics/semantic-layer-1-intro) для получения дополнительной информации о структуре проекта.
- Организуйте их в папке `metrics:` или в источниках проекта по мере необходимости.

<Lightbox src="/img/docs/dbt-cloud/semantic-layer/semantic_foundation.jpg" width="70%" title="Семантическая модель состоит из различных компонентов: Сущности, Меры и Измерения."/>

import SLCourses from '/snippets/\_sl-course.md';

<SLCourses/>

Здесь мы описываем компоненты семантической модели с примерами:

| Компонент    | Описание      | Обязательный     |  Тип     | 
| ------------ | ---------------- | -------- | -------- | 
| [Имя](#name)     | Выберите уникальное имя для семантической модели. Избегайте использования двойных подчеркиваний (\_\_) в имени, так как они не поддерживаются.   | Обязательный | Строка |
| [Описание](#description)    |  Включает важные детали в описание.   | Необязательный | Строка |
| [Модель](#model)     | Указывает модель dbt для семантической модели, используя функцию `ref`.    | Обязательный | Строка |
| [По умолчанию](#defaults)      | Значения по умолчанию для модели, в настоящее время поддерживается только `agg_time_dimension`.    | Обязательный |  Словарь |
| [Сущности](#entities)         | Использует столбцы из сущностей в качестве ключей соединения и указывает их тип как первичный, внешний или уникальный ключи с параметром `type`.  | Обязательный | Список | 
| [Первичная сущность](#primary-entity) | Если существует первичная сущность, этот компонент является необязательным. Если семантическая модель не имеет первичной сущности, то это свойство обязательно.    | Необязательный | Строка | 
| [Измерения](#dimensions)     | Разные способы группировки или разбиения данных для метрики, они могут быть `временными` или `категориальными`.  | Обязательный | Список |
| [Меры](#measures)     | Агрегации, применяемые к столбцам в вашей модели данных. Они могут быть конечной метрикой или использоваться как строительные блоки для более сложных метрик.  | Необязательный | Список |
| [Метка](#label)     | Отображаемое имя для вашего семантического узла, измерения, сущности и/или мер.   | Необязательный | Строка |
| `config`   | Используйте свойство [`config`](/reference/resource-properties/config) для указания конфигураций для вашей метрики. Поддерживает конфигурации [`meta`](/reference/resource-configs/meta), [`group`](/reference/resource-configs/group) и [`enabled`](/reference/resource-configs/enabled). | Необязательный | Словарь |

## Компоненты семантических моделей

Полная спецификация для семантических моделей представлена ниже:

```yaml
semantic_models:
  - name: the_name_of_the_semantic_model ## Обязательный
    description: same as always ## Необязательный
    model: ref('some_model') ## Обязательный
    defaults: ## Обязательный
      agg_time_dimension: dimension_name ## Обязательный, если модель содержит меры
    entities: ## Обязательный
      - see more information in entities
    measures: ## Необязательный
      - see more information in the measures section
    dimensions: ## Обязательный
      - see more information in the dimensions section
    primary_entity: >-
      if the semantic model has no primary entity, then this property is required. #Необязательный, если существует первичная сущность, иначе Обязательный
```

Вы можете обратиться к [руководству по лучшим практикам](/best-practices/how-we-build-our-metrics/semantic-layer-1-intro) для получения дополнительной информации о структуре проекта.

Следующий пример демонстрирует полную конфигурацию и подробные описания каждого поля:

```yaml
semantic_models:
  - name: transaction # Семантическая модель с именем Transactions
    model: ref('fact_transactions') # Ссылается на модель dbt с именем `fact_transactions`
    description: "Фактическая таблица транзакций на уровне транзакций. Эта таблица содержит одну строку на каждую транзакцию и включает временную метку транзакции."
    defaults:
      agg_time_dimension: transaction_date

    entities: # Сущности, включенные в таблицу, определяются здесь. MetricFlow будет использовать эти столбцы в качестве ключей соединения.
      - name: transaction
        type: primary
        expr: transaction_id
      - name: customer
        type: foreign
        expr: customer_id

    dimensions: # Измерения — это качественные значения, такие как имена, даты или географические данные. Они предоставляют контекст для метрик и позволяют "разбивать метрики по группам".
      - name: transaction_date
        type: time
        type_params:
          time_granularity: day

      - name: transaction_location
        type: categorical
        expr: order_country

    measures: # Меры — это столбцы, по которым мы выполняем агрегацию. Меры являются входными данными для метрик.
      - name: transaction_total
        description: "Общая стоимость транзакции."
        agg: sum

      - name: sales
        description: "Общая продажа транзакции."
        agg: sum
        expr: transaction_total

      - name: median_sales
        description: "Медианная продажа транзакции."
        agg: median
        expr: transaction_total

  - name: customers # Другая семантическая модель с именем customers.
    model: ref('dim_customers')
    description: "Таблица измерений клиентов."

    entities:
      - name: customer
        type: primary
        expr: customer_id

    dimensions:
      - name: first_name
        type: categorical
```

Семантические модели поддерживают свойства [`meta`](/reference/resource-configs/meta), [`group`](/reference/resource-configs/group) и [`enabled`](/reference/resource-configs/enabled) [`config`](/reference/resource-properties/config) как в файле схемы, так и на уровне проекта:

- Конфигурация семантической модели в `models/semantic.yml`:

  ```yml
  semantic_models:
    - name: orders
      config:
        enabled: true | false
        group: some_group
        meta:
          some_key: some_value
  ```

- Конфигурация семантической модели в `dbt_project.yml`:

  ```yml
  semantic-models:
    my_project_name:
      +enabled: true | false
      +group: some_group
      +meta:
        some_key: some_value
  ```

Для получения дополнительной информации о `dbt_project.yml` и соглашениях о наименовании конфигураций смотрите [страницу справки по dbt_project.yml](/reference/dbt_project.yml#naming-convention).

### Имя

Определите имя семантической модели. Вы должны определить уникальное имя для семантической модели. Семантический граф будет использовать это имя для идентификации модели, и вы можете обновить его в любое время. Избегайте использования двойных подчеркиваний (\_\_) в имени, так как они не поддерживаются.

### Описание

Включает важные детали в описание семантической модели. Это описание будет в первую очередь использоваться другими участниками конфигурации. Вы можете использовать оператор пайпа `(|)` для включения нескольких строк в описание.

### Модель

Укажите модель dbt для семантической модели, используя функцию [`ref`](/reference/dbt-jinja-functions/ref).

### По умолчанию

Значения по умолчанию для семантической модели. В настоящее время поддерживается только `agg_time_dimension`. `agg_time_dimension` представляет собой стандартные временные измерения для мер. Это можно переопределить, добавив ключ `agg_time_dimension` непосредственно к мере - смотрите [Измерения](/docs/build/dimensions) для примеров.

### Сущности

Чтобы указать [сущности](/docs/build/entities) в вашей модели, используйте их столбцы в качестве ключей соединения и укажите их `type` как первичные, внешние или уникальные ключи с параметром типа.

### Первичная сущность

MetricFlow требует, чтобы все измерения были связаны с сущностью. Это необходимо для гарантии уникальных имен измерений. Если ваш источник данных не имеет первичной сущности, вам нужно назначить сущности имя, используя ключ `primary_entity: entity_name`. Это не обязательно должно соответствовать столбцу в этой таблице, и назначение имени не влияет на генерацию запросов.

Вы можете определить первичную сущность, используя следующие конфигурации:

```yaml
semantic_model:
  name: bookings_monthly_source
  description: bookings_monthly_source
  defaults:
    agg_time_dimension: ds
  model: ref('bookings_monthly_source')
  measures:
    - name: bookings_monthly
      agg: sum
      create_metric: true
  primary_entity: booking_id
```

<Tabs>

<TabItem value="entitytypes" value="Типы сущностей">

Вот типы ключей:

- **Первичный** &mdash; Только одна запись на строку в таблице, и она включает каждую запись в платформе данных.
- **Уникальный** &mdash; Только одна запись на строку в таблице, но может иметь подмножество записей в платформе данных. Также могут присутствовать нулевые значения.
- **Внешний** &mdash; Может иметь ноль, одну или несколько экземпляров одной и той же записи. Также могут присутствовать нулевые значения.
- **Естественный** &mdash; Столбец или комбинация столбцов в таблице, которые уникально идентифицируют запись на основе реальных данных. Например, `sales_person_id` может служить естественным ключом в таблице измерений `sales_person_department`.

</TabItem>
<TabItem value="sample" label="Пример конфигурации">

Этот пример показывает семантическую модель с тремя сущностями и их типами сущностей: `transaction` (первичная), `order` (внешняя) и `user` (внешняя).

Чтобы сослаться на нужный столбец, используйте фактическое имя столбца из модели в параметре `name`. Вы также можете использовать `name` в качестве псевдонима для переименования столбца, а параметр `expr` для ссылки на оригинальное имя столбца или SQL-выражение столбца.

```yaml
entity:
  - name: transaction
    type: primary
  - name: order
    type: foreign
    expr: id_order
  - name: user
    type: foreign
    expr: substring(id_order FROM 2)
```

Вы можете ссылаться на сущности (ключи соединения) в семантической модели, используя параметр `name`. Имена сущностей должны быть уникальными в пределах семантической модели, а имена идентификаторов могут быть не уникальными между семантическими моделями, так как MetricFlow использует их для [соединений](/docs/build/join-logic). <!--Вы также можете создать [составные ключи](/docs/build/entities#composite-keys), как в журналах событий, где уникальный идентификатор является комбинацией временной метки, ключей типа события и идентификаторов машин.-->

</TabItem>
</Tabs>

### Измерения

[Измерения](/docs/build/dimensions) — это разные способы организации или просмотра данных. Они фактически являются параметрами группировки для метрик. Например, вы можете группировать данные по таким параметрам, как регион, страна или должность.

MetricFlow использует динамический подход при предоставлении измерений для метрик. Вместо того чтобы пытаться заранее определить все возможные группировки, MetricFlow позволяет вам запрашивать необходимые измерения и строит любые необходимые соединения для достижения запрашиваемых измерений во время запроса. Преимущество этого подхода заключается в том, что вам не нужно настраивать систему, которая предварительно материализует каждый возможный способ группировки данных, что может занять много времени и быть подверженным ошибкам. Вместо этого вы определяете измерения (параметры группировки), которые вас интересуют, в семантической модели, и они автоматически становятся доступными для действительных метрик.

Измерения имеют следующие характеристики:

- Существует два типа измерений: категориальные и временные. Категориальные измерения предназначены для вещей, которые нельзя измерить в числах, в то время как временные измерения представляют даты и временные метки.
- Измерения связаны с первичной сущностью семантической модели, в которой они определены. Например, если измерение с именем `full_name` определено в модели с `user` в качестве первичной сущности, то `full_name` относится к сущности `user`. Чтобы сослаться на это измерение, вы должны использовать полностью квалифицированное имя измерения `user__full_name`.
- Имена измерений должны быть уникальными в каждой семантической модели с одной и той же первичной сущностью. Имена измерений могут повторяться, если они определены в семантических моделях с другой первичной сущностью.

:::info Для временных групп

Для семантических моделей с мерой вы должны иметь [первичную временную группу](/docs/build/dimensions#time).
:::

### Меры

[Меры](/docs/build/measures) — это агрегации, применяемые к столбцам в вашей модели данных. Они могут использоваться как основные строительные блоки для более сложных метрик или быть самой конечной метрикой.

Меры имеют различные параметры, которые перечислены в таблице вместе с их описаниями и типами.

import MeasuresParameters from '/snippets/\_sl-measures-parameters.md';

<MeasuresParameters />

import SetUpPages from '/snippets/\_metrics-dependencies.md';

<SetUpPages />

## Связанные документы

- [О MetricFlow](/docs/build/about-metricflow)
- [Измерения](/docs/build/dimensions)
- [Сущности](/docs/build/entities)
- [Меры](/docs/build/measures)
- [Руководство по лучшим практикам семантического слоя](/best-practices/how-we-build-our-metrics/semantic-layer-1-intro)