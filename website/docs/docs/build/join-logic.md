---
title: Соединения
id: join-logic
description: "Соединения позволяют объединять данные из разных таблиц и создавать новые метрики"
sidebar_label: "Соединения"
tags: [Метрики, Семантический уровень]
---

Соединения являются мощной частью MetricFlow и упрощают процесс предоставления всех допустимых измерений для ваших метрик во время запроса, независимо от того, где они определены в различных семантических моделях. С помощью соединений вы также можете создавать метрики, используя меры из разных семантических моделей.

Соединения используют `entities`, определенные в ваших конфигурациях семантической модели, в качестве ключей соединения между таблицами. Предполагая, что сущности определены в семантической модели, MetricFlow создает граф, используя семантические модели в качестве узлов и пути соединений в качестве рёбер для автоматического выполнения соединений. MetricFlow выбирает подходящий тип соединения и избегает соединений с разветвлением или соединений с пропусками с другими таблицами на основе типов сущностей.

<details>
  <summary>Что такое соединения с разветвлением или соединения с пропусками?</summary>
  <div>
    <div>&mdash; Соединения с разветвлением происходят, когда одна строка в таблице соединяется с несколькими строками в другой таблице, в результате чего количество выходных строк превышает количество входных строк.<br /><br />
    &mdash; Соединения с пропусками происходят, когда две таблицы имеют отношение многие-ко-многим через промежуточную таблицу, и результат соединения приводит к дублированию или отсутствию данных. </div>
  </div>
</details>


## Типы соединений

:::tip Соединения создаются автоматически
MetricFlow автоматически генерирует необходимые соединения к определенным семантическим объектам, устраняя необходимость в создании новых семантических моделей или конфигурационных файлов.

В этом документе объясняются различные типы соединений, которые могут использоваться с сущностями, и как их запрашивать с помощью CLI.
:::

MetricFlow в основном использует левое соединение и ограничивает использование соединений с разветвлением и соединений с пропусками. Обратитесь к таблице ниже, чтобы определить, какие соединения разрешены, а какие нет, в зависимости от конкретных типов сущностей, чтобы предотвратить создание рискованных соединений.

| тип сущности - Таблица A | тип сущности - Таблица B | Тип соединения        |
|---------------------------|---------------------------|----------------------|
| Первичный                 | Первичный                 | ✅ Левое              |
| Первичный                 | Уникальный                | ✅ Левое              |
| Первичный                 | Внешний                   | ❌ Разветвление (Не разрешено) |
| Уникальный                | Первичный                 | ✅ Левое              |
| Уникальный                | Уникальный                | ✅ Левое              |
| Уникальный                | Внешний                   | ❌ Разветвление (Не разрешено) |
| Внешний                   | Первичный                 | ✅ Левое              |
| Внешний                   | Уникальный                | ✅ Левое              |
| Внешний                   | Внешний                   | ❌ Разветвление (Не разрешено) |   

### Пример

Следующий пример использует две семантические модели с общей сущностью и показывает запрос MetricFlow, который требует соединения между двумя семантическими моделями. Две семантические модели:
- `transactions`
- `user_signup`

```yaml
semantic_models:
  - name: transactions
    entities:
      - name: id
        type: primary
      - name: user
        type: foreign
        expr: user_id
    measures:
      - name: average_purchase_price
        agg: avg
        expr: purchase_price
  - name: user_signup
    entities:
      - name: user
        type: primary
        expr: user_id
    dimensions:
      - name: type
        type: categorical
```

- MetricFlow использует `user_id` в качестве ключа соединения для связывания двух семантических моделей, `transactions` и `user_signup`. Это позволяет вам запрашивать метрику `average_purchase_price` в семантической модели `transactions`, сгруппировав по измерению `type` в семантической модели `user_signup`.
  - Обратите внимание, что мера `average_purchase_price` определена в `transactions`, где `user_id` является внешней сущностью. Однако в `user_signup` `user_id` является первичной сущностью. 
- Поскольку `user_id` является внешним ключом в `transactions` и первичным ключом в `user_signup`, MetricFlow выполняет левое соединение, где `transactions` соединяется с `user_signup`, чтобы получить доступ к мере `average_purchase_price`, определенной в `transactions`.
- Чтобы запрашивать измерения из разных семантических моделей, добавьте двойное подчеркивание (или dunder) к имени измерения после соединения сущности в вашем инструменте редактирования. Следующий запрос, `user_id__type`, включен как измерение с использованием флага `--group-by` (`type` является измерением).

```yaml 
dbt sl query --metrics average_purchase_price --group-by metric_time,user_id__type # В dbt Cloud
```

```yaml 
mf query --metrics average_purchase_price --group-by metric_time,user_id__type # В dbt Core
```

## Многоуровневые соединения

MetricFlow позволяет пользователям соединять меры и измерения через граф сущностей, перемещаясь от одной таблицы к другой в пределах графа. Это называется "многоуровневое соединение". 

MetricFlow может соединять до трех таблиц, поддерживая многоуровневые соединения с ограничением в два уровня. Это позволяет:
- Выполнять сложный анализ данных без неоднозначных путей.
- Поддерживать навигацию по моделям данных, например, перемещаясь от таблиц `orders` к `customers`, а затем к `country`.

Хотя прямые трехуровневые пути ограничены, чтобы предотвратить путаницу из-за нескольких маршрутов к одним и тем же данным, MetricFlow позволяет соединять более трех таблиц, если соединения не превышают два уровня для достижения измерения. 

Например, если у вас есть две модели, `country` и `region`, где клиенты связаны с странами, которые, в свою очередь, связаны с регионами, вы можете соединить все их в одном SQL-запросе и анализировать `orders` по `customer__country_country_name`, но не по `customer__country__region_name`.

![Многоуровневое соединение](/img/docs/building-a-dbt-project/multihop-diagram.png "Пример схемы для справки")

Обратите внимание, как схема может быть переведена в следующие три семантические модели MetricFlow для создания метрики 'Средняя цена покупки по стране', используя меру `purchase_price` из таблицы продаж и измерение `country_name` из таблицы `country_dim`.

```yaml
semantic_models:
  - name: sales
    defaults:
      agg_time_dimension: first_ordered_at
    entities:
      - name: id
        type: primary
      - name: user_id
        type: foreign
    measures:
      - name: average_purchase_price
        agg: avg
        expr: purchase_price
    dimensions:
      - name: metric_time
        type: time
        type_params:
  - name: user_signup
    entities:
      - name: user_id
        type: primary
      - name: country_id
        type: unique
    dimensions:
      - name: signup_date
        type: time
      - name: country_dim

  - name: country
    entities:
      - name: country_id
        type: primary
    dimensions:
      - name: country_name
        type: categorical
```

### Запрос многоуровневых соединений

Чтобы запрашивать измерения _без_ участия многоуровневого соединения, вы можете использовать полное имя измерения с синтаксисом сущность двойное подчеркивание (dunder) измерение, например, `entity__dimension`. 

Для измерений, полученных с помощью многоуровневого соединения, вам необходимо дополнительно указать путь сущности в виде списка, например, `user_id`.