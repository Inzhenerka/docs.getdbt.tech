---
title: "Заполнение нулевых значений для метрик"
id: fill-nulls-advanced
description: "Узнайте о продвинутых темах для dbt Semantic Layer и MetricFlow, таких как моделирование рабочих процессов и многое другое."
sidebar_label: Заполнение нулевых значений для метрик
---

Понимание и реализация стратегий заполнения нулевых значений в метриках являются ключевыми для точной аналитики. Этот гид объясняет `fill_nulls_with` и `join_to_timespine`, чтобы обеспечить полноту данных, помогая конечным пользователям принимать более обоснованные решения и улучшая ваши рабочие процессы dbt.

### О нулевых значениях

Вы можете использовать `fill_nulls_with`, чтобы заменить нулевые значения в метриках на значение, например, ноль (или выбранное вами целое число). Это гарантирует, что каждая строка данных показывает числовое значение.

Этот гид объясняет, как гарантировать отсутствие нулевых значений в ваших метриках:

- Используйте `fill_nulls_with` для `simple`, `cumulative` и `conversion` метрик
- Используйте `join_to_timespine` и `fill_nulls_with` вместе для производных и коэффициентных метрик, чтобы избежать появления нулевых значений.

### Заполнение нулевых значений для простых метрик

Например, если вы хотите обработать дни с посещениями сайта, но без лидов, вы можете использовать `fill_nulls_with`, чтобы установить значение для лидов на ноль в дни, когда не было конверсий.

Предположим, у вас есть три метрики:

- `website_visits` и `leads`
- и производная метрика под названием `leads_to_website_visit`, которая вычисляет отношение лидов к посещениям сайта.

В дни, когда не было конверсий, вы можете установить значение для лидов на ноль, добавив параметр `fill_nulls_with` к входным данным измерения в метрике лидов:

<File name='models/metrics/website_vists.yml'>

```yaml
metrics:
  - name: website_visits
    type: simple
    type_params:
      measure:
        name: bookings
  - name: leads
    type: simple
    type_params:
      measure:
        name: bookings
        fill_nulls_with: 0 # Это заполняет нулевые значения нулем
  - name: leads_to_website_visit
    type: derived
    type_params:
      expr: leads/website_visits
      metrics:
        - name: leads
        - name: website_visits
```

</File>

Метрики `website_visits` и `leads` имеют следующие данные:

| metric_time | website_visits |
| --- | --- |
| 2024-01-01 | 50 |
| 2024-01-02 | 37 |
| 2024-01-03 | 79 |


| metric_time | leads |
| --- | --- |
| 2024-01-01 | 5 |
| 2024-01-03 | 8 |
* Обратите внимание, что для `2024-01-02` нет данных в метрике `leads`.

Хотя нет дней без посещений, есть дни без лидов. После применения `fill_nulls_with: 0` к метрике `leads`, запрос этих метрик вместе показывает ноль для лидов в дни без конверсий:

| metric_time | website_visits | leads |
| --- | --- | --- |
| 2024-01-01 | 50 | 5 |
| 2024-01-02 | 37 | 0 |
| 2024-01-03 | 79 | 8 |

### Используйте join_to_timespine для производных и коэффициентных метрик

Чтобы гарантировать наличие полного набора данных для ежедневного покрытия метрик, рассчитанных на основе других метрик, вы можете использовать `join_to_timespine`, чтобы заполнить нулевые значения для `derived` и `ratio` метрик. Эти метрики строятся на основе других метрик (других расчетов), а не прямых измерений (сырых данных), что требует от MetricFlow наличия дополнительного уровня подзапроса для рендеринга метрики. Вложенность подзапросов следующая:

- Для `derived` и `ratio` метрик существует три уровня вложенности подзапросов — производная или коэффициентная метрика → входные метрики → входные измерения.
- Для `simple` и `cumulative` метрик существует только два уровня вложенности подзапросов — простая или кумулятивная метрика → входное измерение.

Поскольку `coalesce` не применяется к третьему уровню подзапроса для `derived` или `ratio` метрик, это означает, что в конечном наборе результатов все еще могут быть нулевые значения.

* Обратите внимание, что вы можете использовать `join_to_timespine` с метриками, которые принимают входные измерения, если вы хотите включить строку для каждой даты, даже если данных нет.

### Заполнение нулевых значений для производных и коэффициентных метрик

Чтобы заполнить нулевые значения для производных и коэффициентных метрик, вы можете связать их с временной моделью, чтобы обеспечить ежедневное покрытие данных. Как упоминалось в [предыдущем разделе](#use-join_to_timespine-for-derived-and-ratio-metrics), это связано с тем, что `derived` и `ratio` метрики принимают *метрики* в качестве входных данных, а не *измерения*.

Например, следующая структура оставляет нули в конечных результатах (в колонке `leads_to_website_visit`), потому что `COALESCE` не применяется на третьем внешнем уровне рендеринга для окончательного расчета метрики в `derived` метриках:

| metric_time | bookings | leads | leads_to_website_visit |
| --- | --- | --- | --- |
| 2024-01-01 | 50 | 5 | .1 |
| 2024-01-02 | 37 | 0 | null |
| 2024-01-03 | 79 | 8 | .1 |

Чтобы отобразить нулевое значение для `leads_to_website_visit` для `2024-01-02`, вам нужно присоединить метрику `leads` к модели временной оси, чтобы обеспечить значение для каждого дня. Это можно сделать, добавив `join_to_timespine` к параметру `measure` в конфигурации метрики `leads`:

<File name='models/metrics/leads.yml'>

```yaml
- name: leads
  type: simple
  type_params:
    measure:
      name: bookings
      fill_nulls_with: 0
      join_to_timespine: true
```
</File>

После этого, если вы запросите метрику `leads` после присоединения временной оси, будет запись для каждого дня, и любые нулевые значения будут заполнены нулем.

| metric_time |  leads | leads_to_website_visit |
| --- | --- | --- |
| 2024-01-01 |  5 | .1 |
| 2024-01-02 | 0 | 0 |
| 2024-01-03 |  8 | .1 |

Теперь, если вы объедините метрики в `derived` метрике, будет нулевое значение для `leads_to_website_visit` на `2024-01-02`, и в конечном наборе результатов не будет нулевых значений.

## Часто задаваемые вопросы

<Expandable alt_header="Как обрабатывать нулевые значения в производных метриках, определенных на основе нескольких таблиц">

Для дополнительных примеров и обсуждений о том, как обрабатывать нулевые значения в производных метриках, которые используют данные из нескольких таблиц, ознакомьтесь с [MetricFlow issue #1031](https://github.com/dbt-labs/metricflow/issues/1031).

</Expandable>