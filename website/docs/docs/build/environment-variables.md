---
title: Переменные окружения
id: "environment-variables"
description: "Используйте переменные окружения для настройки поведения вашего проекта dbt."
---

Переменные окружения можно использовать для настройки поведения проекта dbt в зависимости от того, где именно этот проект запускается. Подробнее о том, как вызывать Jinja-функцию `{{env_var('DBT_KEY','OPTIONAL_DEFAULT')}}` в коде вашего проекта, см. документацию по
[env_var](/reference/dbt-jinja-functions/env_var).

:::info Именование и префиксы переменных окружения

Переменные окружения в <Constant name="cloud" /> должны иметь префикс `DBT_`, `DBT_ENV_SECRET_` или `DBT_ENV_CUSTOM_ENV_`. Ключи переменных окружения приводятся к верхнему регистру и являются **чувствительными к регистру**. При обращении к `{{env_var('DBT_KEY')}}` в коде вашего проекта ключ должен **точно совпадать** с именем переменной, определённой в интерфейсе <Constant name="cloud" />.

:::

### Настройка и переопределение переменных окружения
В этом разделе объясняется, как задавать и переопределять переменные окружения в <Constant name="cloud" />.

<!-- no toc -->
- [Порядок приоритета](#order-of-precedence)
- [Задание переменных окружения](#setting-environment-variables)
- [Переопределение переменных окружения на уровне задания](#overriding-environment-variables-at-the-job-level)
- [Переопределение переменных окружения на персональном уровне](#overriding-environment-variables-at-the-personal-level)
- [Локальные переменные окружения](#local-environment-variables)

#### Порядок приоритета

Значения переменных окружения могут быть заданы в нескольких местах в <Constant name="cloud" />. В результате <Constant name="cloud" /> интерпретирует переменные окружения в соответствии со следующим порядком приоритета (от наименьшего к наибольшему):

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/env-var-precdence.png" title="Порядок приоритета переменных окружения"/>

Существует четыре уровня переменных окружения:

1. Необязательный аргумент `default`, переданный функции Jinja `env_var` в коде, который может быть переопределён на (_самом низком уровне приоритета_)
2. На уровне всего проекта — его значение по умолчанию, которое может быть переопределено на
3. Уровне окружения, которое, в свою очередь, может быть снова переопределено на
4. Уровне job (job override) или в <Constant name="cloud_ide" /> для отдельного разработчика (personal override). (_самый высокий уровень приоритета_)

#### Настройка переменных окружения

Чтобы задать переменные окружения на уровне проекта и окружения, нажмите **Orchestration** в меню слева, затем выберите **Environments**. Нажмите **Environment variables**, чтобы добавить или обновить переменные окружения.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/navigate-to-env-vars.png" title="Вкладка переменных окружения"/>

Вы заметите колонку **Project default**. Это отличное место, чтобы задать значение, которое будет сохраняться для всего проекта независимо от того, где выполняется код. Мы рекомендуем задавать здесь значение, если вам нужен универсальный дефолт или вы хотите добавить токен или секрет на уровне всего проекта.

Справа от колонки **Project default** расположены все ваши окружения. Значения, заданные на уровне окружения, имеют приоритет над значением по умолчанию на уровне проекта. Например, именно здесь вы можете указать <Constant name="cloud" />, чтобы он по‑разному интерпретировал значение в окружениях Staging и Production.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/job-override.gif" title="Навигация к настройкам переопределения переменных окружения для задания"/>

#### Переопределение переменных окружения на уровне задания

**Переопределение переменных окружения на личном уровне**

Вы также можете установить личное значение переопределения для переменной окружения, когда вы разрабатываете в интегрированной среде разработки dbt (IDE). По умолчанию dbt Cloud использует значения переменных окружения, установленные в среде разработки проекта. Чтобы просмотреть и переопределить эти значения, в dbt Cloud:
- Нажмите на ваше имя аккаунта в левом боковом меню и выберите **Account settings**.
- В разделе **Your profile** нажмите **Credentials** и затем выберите ваш проект.
- Прокрутите до раздела **Environment variables** и нажмите **Edit**, чтобы внести необходимые изменения.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/personal-override.gif" title="Навигация к настройкам личного переопределения переменных окружения"/>

Каждая задача (job) выполняется в определённом окружении развертывания (deployment environment). По умолчанию задача наследует значения, заданные на уровне окружения (или на уровне с наивысшим приоритетом) для того окружения, в котором она запускается. Если вам нужно задать другое значение на уровне конкретной задачи, отредактируйте его, чтобы переопределить существующее.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/job-override.png" title="Setting a job override value"/>

#### Переопределение переменных окружения на персональном уровне

Вы также можете задать персональное переопределение значения переменной окружения при разработке в интегрированной среде разработки dbt (<Constant name="cloud_ide" />). По умолчанию <Constant name="cloud" /> использует значения переменных окружения, заданные в окружении разработки проекта. Чтобы посмотреть и переопределить эти значения, в <Constant name="cloud" /> выполните следующие действия:
- Нажмите на имя своей учетной записи в левом меню и выберите **Account settings**.  
- В разделе **Your profile** нажмите **Credentials**, затем выберите свой проект.  
- Прокрутите страницу до раздела **Environment variables** и нажмите **Edit**, чтобы внести необходимые изменения.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/personal-override.gif" title="Navigating to environment variables personal override settings"/>

Чтобы задать переопределение, разработчики могут отредактировать значение и указать альтернативное. Эти значения будут использоваться в <Constant name="cloud_ide" /> как на вкладке Results, так и на вкладке Compiled SQL.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/personal-override.png" width="60%" title="Setting a personal override value"/>

:::info Appropriate coverage
Если вы не задали значение по умолчанию на уровне проекта для каждой переменной окружения, возможно, что <Constant name="cloud" /> не сможет корректно интерпретировать значение переменной окружения во всех контекстах. В таких случаях dbt выдаст ошибку компиляции: "Env var required but not provided".
:::

:::info Changing environment variables mid-session in the <Constant name="cloud_ide" />
Если вы измените значение переменной окружения в середине сессии при работе в <Constant name="cloud_ide" />, может потребоваться обновить <Constant name="cloud_ide" />, чтобы изменения вступили в силу.
:::

Чтобы обновить <Constant name="cloud_ide" /> во время разработки, нажмите либо на зелёный индикатор «ready», либо на красное сообщение «compilation error» в правом нижнем углу <Constant name="cloud_ide" />. Появится новое модальное окно, в котором нужно выбрать кнопку **Restart IDE**. После этого значения переменных окружения будут загружены в вашу среду разработки.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/refresh-ide.png" title="Обновление IDE в середине сессии"/>

Существуют некоторые известные проблемы с частичным разбором проекта и изменением переменных окружения в середине сессии в IDE. Если вы обнаружите, что ваш проект dbt не компилируется в установленные вами значения, попробуйте удалить файл `target/partial_parse.msgpack` в вашем проекте dbt, что заставит dbt перекомпилировать весь ваш проект.

#### Локальные переменные окружения

Если вы используете расширение dbt для VS Code, вы можете задать переменные окружения локально в профиле вашей оболочки (`~/.zshrc` или `~/.bashrc`) либо в файле `.env` на корневом уровне вашего dbt‑проекта.

Подробнее см. на странице [Configure the dbt VS Code extension](/docs/configure-dbt-extension#set-environment-variables-locally).

### Работа с секретами

Хотя все переменные окружения в <Constant name="cloud" /> шифруются при хранении, <Constant name="cloud" /> предоставляет дополнительные возможности для управления переменными окружения, содержащими секретные или иным образом чувствительные значения. Если вы хотите, чтобы определённая переменная окружения была удалена (scrubbed) из всех логов и сообщений об ошибках, а также чтобы её значение было скрыто в UI, вы можете добавить к имени переменной префикс `DBT_ENV_SECRET`. Эта функциональность поддерживается начиная с `dbt v1.0`.

**Примечание**: Переменная окружения может быть использована для хранения [git токена для клонирования репозитория](/docs/build/environment-variables#clone-private-packages). Мы рекомендуем сделать разрешения git токена только для чтения и рассмотреть возможность использования учетной записи машины или PAT пользователя службы с ограниченным доступом к репозиторию для соблюдения хорошей безопасности.

### Специальные переменные окружения

dbt Cloud имеет ряд встроенных переменных. Переменные устанавливаются автоматически и не могут быть изменены.

<Constant name="cloud" /> имеет ряд встроенных предопределённых переменных. Эти переменные устанавливаются автоматически и не могут быть изменены.

#### Детали Studio IDE

Следующая переменная окружения автоматически задаётся для <Constant name="cloud_ide" />:

- `DBT_CLOUD_GIT_BRANCH` &mdash; предоставляет имя ветки разработки Git в [<Constant name="cloud_ide" />](/docs/cloud/studio-ide/develop-in-studio).
  - Значение переменной изменяется при смене ветки.
  - Не требует перезапуска <Constant name="cloud_ide" /> после смены ветки.
  - В настоящее время недоступна в [<Constant name="cloud" /> CLI](/docs/cloud/cloud-cli-installation).

#### Контекст dbt Cloud

#### Контекст платформы dbt

- `DBT_ENV` &mdash; Этот ключ зарезервирован для приложения dbt Cloud и всегда будет разрешаться как 'prod'. Только для запусков развертывания.
- `DBT_CLOUD_ENVIRONMENT_NAME` &mdash; Имя окружения dbt Cloud, в котором выполняется `dbt`.
- `DBT_CLOUD_ENVIRONMENT_TYPE` &mdash; Тип окружения dbt Cloud, в котором выполняется `dbt`. Допустимые значения: `dev`, `staging` или `prod`. Может быть не установлен, поэтому используйте значение по умолчанию, например `{{env_var('DBT_CLOUD_ENVIRONMENT_TYPE', '')}}`.

- `DBT_ENV` &mdash; Этот ключ зарезервирован для приложения <Constant name="cloud" /> и всегда имеет значение `'prod'`. Используется только при запусках развертывания.
- `DBT_CLOUD_ENVIRONMENT_NAME` &mdash; Имя окружения <Constant name="cloud" />, в котором выполняется `dbt`.
- `DBT_CLOUD_ENVIRONMENT_TYPE` &mdash; Тип окружения <Constant name="cloud" />, в котором выполняется `dbt`. Допустимые значения: `dev`, `staging` или `prod`. Для [General deployment environments](/docs/dbt-cloud-environments#types-of-environments) значение будет пустым, поэтому следует использовать значение по умолчанию, например `{{ env_var('DBT_CLOUD_ENVIRONMENT_TYPE', '') }}`.
- `DBT_CLOUD_INVOCATION_CONTEXT` &mdash; Тип контекста, в котором вызывается `dbt`. Возможные значения: `dev`, `staging`, `prod` или `ci`.
    - Дополнительно рекомендуется использовать `DBT_CLOUD_INVOCATION_CONTEXT` в макросе `generate_schema_name()` для задания явных правил: использовать схему по умолчанию (с префиксом `dbt_cloud_pr`) только для запусков CI-задач, даже если эти CI-задачи выполняются в том же окружении, что и production-задачи.

- `DBT_CLOUD_PROJECT_ID` &mdash; ID проекта dbt Cloud для этого запуска
- `DBT_CLOUD_JOB_ID` &mdash; ID задания dbt Cloud для этого запуска
- `DBT_CLOUD_RUN_ID` &mdash; ID этого конкретного запуска
- `DBT_CLOUD_RUN_REASON_CATEGORY` &mdash; "Категория" триггера для этого запуска (одна из: `scheduled`, `github_pull_request`, `gitlab_merge_request`, `azure_pull_request`, `other`)
- `DBT_CLOUD_RUN_REASON` &mdash; Конкретный триггер для этого запуска (например, `Scheduled`, `Kicked off by <email>`, или пользовательский через `API`)
- `DBT_CLOUD_ENVIRONMENT_ID` &mdash; ID окружения для этого запуска
- `DBT_CLOUD_ACCOUNT_ID` &mdash; ID аккаунта dbt Cloud для этого запуска

- `DBT_CLOUD_PROJECT_ID` &mdash; Идентификатор проекта <Constant name="cloud" /> для данного запуска
- `DBT_CLOUD_JOB_ID` &mdash; Идентификатор задания <Constant name="cloud" /> для данного запуска
- `DBT_CLOUD_RUN_ID` &mdash; Идентификатор конкретного запуска
- `DBT_CLOUD_RUN_REASON_CATEGORY` &mdash; «Категория» триггера, по которому был запущен этот запуск (одно из значений: `scheduled`, `github_pull_request`, `gitlab_merge_request`, `azure_pull_request`, `other`)
- `DBT_CLOUD_RUN_REASON` &mdash; Конкретная причина запуска (например, `Scheduled`, `Kicked off by <email>` или пользовательская причина, переданная через `API`)
- `DBT_CLOUD_ENVIRONMENT_ID` &mdash; Идентификатор окружения для данного запуска
- `DBT_CLOUD_ACCOUNT_ID` &mdash; Идентификатор аккаунта <Constant name="cloud" /> для данного запуска

_Следующие переменные в настоящее время доступны только для сборок PR GitHub, GitLab и Azure DevOps, инициированных через вебхук_

- `DBT_CLOUD_PR_ID` &mdash; ID Pull Request в подключенной системе контроля версий
- `DBT_CLOUD_GIT_SHA` &mdash; git commit SHA, который выполняется для этой сборки Pull Request

### Пример использования

Переменные окружения могут быть использованы различными способами, и они дают вам возможность и гибкость делать то, что вы хотите, более легко в dbt Cloud.

<Expandable alt_header="Клонирование приватных пакетов">

Переменные окружения можно использовать разными способами — они дают вам больше возможностей и гибкости для более удобной работы в <Constant name="cloud" />.

<Expandable alt_header="Clone private packages">

Теперь, когда вы можете задавать секреты в виде переменных окружения, вы можете передавать git‑токены в HTTPS‑URL ваших пакетов, чтобы разрешить динамическое клонирование приватных репозиториев. Подробнее читайте о включении [private package cloning](/docs/build/packages#private-packages).

</Expandable>

<Expandable alt_header="Динамическая установка вашего склада в соединении Snowflake">

Переменные окружения позволяют динамически изменять размер виртуального склада Snowflake в зависимости от задания. Вместо того чтобы напрямую указывать имя склада в соединении вашего проекта, вы можете ссылаться на переменную окружения, которая будет установлена на конкретный виртуальный склад во время выполнения.

Например, предположим, что вы хотите запускать job с полным обновлением (full-refresh) в хранилище размера XL, а инкрементальный job — только в хранилище среднего размера. Оба job настроены в одном и том же окружении <Constant name="cloud" />. В конфигурации подключения вы можете использовать переменную окружения, чтобы задать имя хранилища как `{{env_var('DBT_WAREHOUSE')}}`. Затем в настройках job вы можете указать разное значение для переменной окружения `DBT_WAREHOUSE` в зависимости от нагрузки конкретного job.

В настоящее время невозможно динамически устанавливать переменные окружения для моделей в рамках одного запуска. Это связано с тем, что каждая env_var может иметь только одно установленное значение на протяжении всего выполнения.

**Примечание** &mdash; Вы также можете использовать этот метод с Databricks SQL Warehouse.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/warehouse-override.png" width="60%" title="Добавление переменных окружения в учетные данные подключения"/>

:::info Переменные окружения и ограничения Snowflake OAuth
Переменные окружения работают нормально с именем пользователя/паролем и ключевой парой, включая запланированные задания, потому что dbt Core использует Jinja, вставленную в автоматически сгенерированный `profiles.yml`, и разрешает ее для выполнения поиска `env_var`.

Однако существуют некоторые ограничения при использовании переменных окружения с настройками соединения Snowflake OAuth:

- Вы не можете использовать их в поле аккаунта/хоста, но они могут быть использованы для базы данных, склада и роли. Для этих полей [используйте расширенные атрибуты](/docs/deploy/deploy-environments#deployment-connection).

Важно отметить: если вы укажете переменную окружения в поле account/host, подключение Snowflake OAuth **не сможет** установиться. Это происходит потому, что это поле не проходит через рендеринг Jinja, поэтому `<Constant name="cloud" />` просто подставляет буквальный код `env_var` в строку URL, например `{{ env_var("DBT_ACCOUNT_HOST_NAME") }}.snowflakecomputing.com`, что является некорректным именем хоста. Вместо этого используйте [extended attributes](/docs/deploy/deploy-environments#deployment-credentials).
:::

</Expandable>

<Expandable alt_header="Аудит метаданных вашего запуска">

Вот ещё один мотивирующий пример, в котором используется идентификатор запуска <Constant name="cloud" />, автоматически устанавливаемый при каждом запуске. Это дополнительное поле данных можно использовать для аудита и отладки:

```sql

{{ config(materialized='incremental', unique_key='user_id') }}

with users_aggregated as (

    select
        user_id,
        min(event_time) as first_event_time,
        max(event_time) as last_event_time,
        count(*) as count_total_events

    from {{ ref('users') }}
    group by 1

)

select *,
    -- Вставьте ID запуска, если он присутствует, в противном случае используйте "manual"
    '{{ env_var("DBT_CLOUD_RUN_ID", "manual") }}' as _audit_run_id

from users_aggregated
```

</Expandable>

<Expandable alt_header="Настройка учетных данных Семантического слоя">

import SLEnvVars from '/snippets/_sl-env-vars.md';

<SLEnvVars/>

</Expandable>