---
title: Переменные окружения
id: "environment-variables"
description: "Используйте переменные окружения для настройки поведения вашего проекта dbt."
---

Переменные окружения могут использоваться для настройки поведения проекта dbt в зависимости от того, где проект выполняется. См. документацию по
[env_var](/reference/dbt-jinja-functions/env_var) для получения дополнительной информации о том, как вызывать функцию jinja `{{env_var('DBT_KEY','OPTIONAL_DEFAULT')}}` в коде вашего проекта.

:::info Именование и префиксы переменных окружения

Переменные окружения в dbt Cloud должны иметь префикс `DBT_`, `DBT_ENV_SECRET` или `DBT_ENV_CUSTOM_ENV_`. Ключи переменных окружения записываются в верхнем регистре и чувствительны к регистру. При ссылке на `{{env_var('DBT_KEY')}}` в коде вашего проекта ключ должен точно соответствовать переменной, определенной в интерфейсе dbt Cloud.

:::

### Установка и переопределение переменных окружения

**Порядок приоритета**

Значения переменных окружения могут быть установлены в нескольких местах в dbt Cloud. В результате dbt Cloud будет интерпретировать переменные окружения в соответствии со следующим порядком приоритета (от низшего к высшему):

 <Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/env-var-precdence.png" title="Порядок приоритета переменных окружения"/>

Существует четыре уровня переменных окружения:

 1. Необязательный аргумент по умолчанию, переданный функции `env_var` в коде, который может быть переопределен (наименьший приоритет)
 2. Уровень проекта по его значению по умолчанию, который может быть переопределен
 3. Уровень окружения, который, в свою очередь, может быть переопределен
 4. Уровень задания (переопределение задания) или в IDE для отдельного разработчика (личное переопределение). (наивысший приоритет)

**Установка переменных окружения на уровне проекта и окружения**

Чтобы установить переменные окружения на уровне проекта и окружения, нажмите **Deploy** в верхнем левом углу, затем выберите **Environments**. Нажмите **Environments Variables**, чтобы добавить и обновить ваши переменные окружения.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/navigate-to-env-vars.png" title="Вкладка переменных окружения"/>

Вы заметите, что есть столбец `Project Default`. Это отличное место для установки значения, которое будет сохраняться на протяжении всего вашего проекта, независимо от того, где выполняется код. Мы рекомендуем устанавливать это значение, когда вы хотите предоставить универсальное значение по умолчанию или добавить токен или секрет на уровне проекта.

Справа от столбца `Project Default` находятся все ваши окружения. Значения, установленные на уровне окружения, имеют приоритет над значением по умолчанию на уровне проекта. Здесь вы можете указать dbt Cloud интерпретировать значение окружения по-разному в вашем Staging и Production окружениях, например.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/project-environment-view.png" title="Установка значений на уровне проекта и окружения"/>

**Переопределение переменных окружения на уровне задания**

У вас может быть несколько заданий, которые выполняются в одном и том же окружении, и вы хотите, чтобы переменная окружения интерпретировалась по-разному в зависимости от задания.

При настройке или редактировании задания вы увидите раздел, где можете переопределить значения переменных окружения, определенные на уровне окружения или проекта.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/job-override.gif" title="Настройка переопределения переменных окружения для задания"/>

Каждое задание выполняется в конкретном окружении развертывания, и по умолчанию задание унаследует значения, установленные на уровне окружения (или наивысшем уровне приоритета) для окружения, в котором оно выполняется. Если вы хотите установить другое значение на уровне задания, отредактируйте значение, чтобы переопределить его.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/job-override.png" title="Установка значения переопределения для задания"/>

**Переопределение переменных окружения на личном уровне**

Вы также можете установить личное значение переопределения для переменной окружения, когда разрабатываете в интегрированной среде разработки dbt (IDE). По умолчанию dbt Cloud использует значения переменных окружения, установленные в среде разработки проекта. Чтобы увидеть и переопределить эти значения, в dbt Cloud:
- Нажмите на имя вашей учетной записи в левом меню и выберите **Account settings**. 
- В разделе **Your profile** нажмите **Credentials** и затем выберите ваш проект. 
- Прокрутите до раздела **Environment variables** и нажмите **Edit**, чтобы внести необходимые изменения.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/personal-override.gif" title="Настройка личного переопределения переменных окружения"/>

Чтобы предоставить переопределение, разработчики могут отредактировать и указать другое значение для использования. Эти значения будут учитываться в IDE как для вкладок Results, так и для Compiled SQL.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/personal-override.png" title="Установка личного значения переопределения"/>

:::info Соответствующее покрытие
Если вы не установили значение по умолчанию на уровне проекта для каждой переменной окружения, возможно, что dbt Cloud не знает, как интерпретировать значение переменной окружения во всех контекстах. В таких случаях dbt выдаст ошибку компиляции: "Env var required but not provided".
:::

:::info Изменение переменных окружения в середине сессии в IDE
Если вы измените значение переменной окружения в середине сессии, используя IDE, вам может потребоваться обновить IDE, чтобы изменения вступили в силу.
:::

Чтобы обновить IDE в процессе разработки, нажмите на зеленый сигнал 'готово' или красное сообщение 'ошибка компиляции' в правом нижнем углу IDE. Появится новое модальное окно, и вам следует выбрать кнопку Refresh IDE. Это загрузит значения ваших переменных окружения в вашу среду разработки.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/refresh-ide.png" title="Обновление IDE в середине сессии"/>

Существуют известные проблемы с частичным парсингом проекта и изменением переменных окружения в середине сессии в IDE. Если вы обнаружите, что ваш проект dbt не компилируется с установленными вами значениями, попробуйте удалить файл `target/partial_parse.msgpack` в вашем проекте dbt, что заставит dbt перекомпилировать весь ваш проект.

### Обработка секретов

Хотя все переменные окружения шифруются в состоянии покоя в dbt Cloud, dbt Cloud имеет дополнительные возможности для управления переменными окружения с секретными или иными чувствительными значениями. Если вы хотите, чтобы конкретная переменная окружения была скрыта во всех журналах и сообщениях об ошибках, помимо сокрытия значения в интерфейсе, вы можете префиксировать ключ `DBT_ENV_SECRET`. Эта функция поддерживается с `dbt v1.0` и выше.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/DBT_ENV_SECRET.png" title="Сокрытие префикса DBT_ENV_SECRET"/>

**Примечание**: Переменная окружения может использоваться для хранения [git токена для клонирования репозиториев](/docs/build/environment-variables#clone-private-packages). Мы рекомендуем сделать разрешения git токена только для чтения и рассмотреть возможность использования учетной записи машины или PAT сервисного пользователя с ограниченным доступом к репозиторию для соблюдения хорошей безопасности.

### Специальные переменные окружения

dbt Cloud имеет ряд предопределенных переменных. Переменные устанавливаются автоматически и не могут быть изменены.

#### Подробности IDE dbt Cloud

Следующая переменная окружения устанавливается автоматически для IDE dbt Cloud:

- `DBT_CLOUD_GIT_BRANCH` &mdash; Предоставляет имя ветки разработки Git в [IDE dbt Cloud](/docs/cloud/dbt-cloud-ide/develop-in-the-cloud).
  - Доступно в dbt v1.6 и позже.
  - Переменная изменяется при изменении ветки.
  - Не требует перезапуска IDE после изменения ветки.
  - В настоящее время недоступна в [dbt Cloud CLI](/docs/cloud/cloud-cli-installation).

Случай использования &mdash; Это полезно в случаях, когда вы хотите динамически использовать имя ветки Git в качестве префикса для [разработческой схемы](/docs/build/custom-schemas) ( `{{ env_var ('DBT_CLOUD_GIT_BRANCH') }}` ).

#### Контекст dbt Cloud

Следующие переменные окружения устанавливаются автоматически: 

- `DBT_ENV` &mdash; Этот ключ зарезервирован для приложения dbt Cloud и всегда будет равен 'prod'. Только для развертываний.
- `DBT_CLOUD_ENVIRONMENT_NAME` &mdash; Имя окружения dbt Cloud, в котором выполняется `dbt`. 
- `DBT_CLOUD_ENVIRONMENT_TYPE` &mdash; Тип окружения dbt Cloud, в котором выполняется `dbt`. Допустимые значения: `dev`, `staging` или `prod`. Может быть не установлен, поэтому используйте значение по умолчанию, например `{{env_var('DBT_CLOUD_ENVIRONMENT_TYPE', '')}}`.

#### Подробности выполнения

- `DBT_CLOUD_PROJECT_ID` &mdash; ID проекта dbt Cloud для этого выполнения
- `DBT_CLOUD_JOB_ID` &mdash; ID задания dbt Cloud для этого выполнения
- `DBT_CLOUD_RUN_ID` &mdash; ID этого конкретного выполнения
- `DBT_CLOUD_RUN_REASON_CATEGORY` &mdash; "категория" триггера для этого выполнения (один из: `scheduled`, `github_pull_request`, `gitlab_merge_request`, `azure_pull_request`, `other`)
- `DBT_CLOUD_RUN_REASON` &mdash; Конкретный триггер для этого выполнения (например, `Scheduled`, `Kicked off by <email>`, или пользовательский через `API`)
- `DBT_CLOUD_ENVIRONMENT_ID` &mdash; ID окружения для этого выполнения
- `DBT_CLOUD_ACCOUNT_ID` &mdash; ID учетной записи dbt Cloud для этого выполнения

#### Подробности Git

_Следующие переменные в настоящее время доступны только для сборок PR GitHub, GitLab и Azure DevOps, инициированных через вебхук_

- `DBT_CLOUD_PR_ID` &mdash; ID Pull Request в подключенной системе управления версиями
- `DBT_CLOUD_GIT_SHA` &mdash; SHA коммита git, который выполняется для этой сборки Pull Request


### Пример использования

Переменные окружения могут использоваться многими способами, и они дают вам возможность и гибкость делать то, что вы хотите, более легко в dbt Cloud.

<Expandable alt_header="Клонирование частных пакетов">

Теперь, когда вы можете устанавливать секреты в качестве переменных окружения, вы можете передавать git токены в ваши HTTPS URL пакетов, чтобы позволить клонирование частных репозиториев на лету. Узнайте больше о включении [клонирования частных пакетов](/docs/build/packages#private-packages).

</Expandable>

<Expandable alt_header="Динамическая установка вашего склада в соединении Snowflake">

Переменные окружения позволяют динамически изменять размер виртуального склада Snowflake в зависимости от задания. Вместо того чтобы напрямую указывать имя склада в вашем соединении проекта, вы можете сослаться на переменную окружения, которая будет установлена на конкретный виртуальный склад во время выполнения. 

Например, предположим, что вы хотите запустить задание полного обновления в XL складе, но ваше инкрементальное задание должно выполняться только в складе среднего размера. Оба задания настроены в одном и том же окружении dbt Cloud. В вашей конфигурации соединения вы можете использовать переменную окружения, чтобы установить имя склада на `{{env_var('DBT_WAREHOUSE')}}`. Затем в настройках задания вы можете установить другое значение для переменной окружения `DBT_WAREHOUSE` в зависимости от нагрузки задания.

В настоящее время невозможно динамически устанавливать переменные окружения для моделей в рамках одного выполнения. Это связано с тем, что каждая переменная env_var может иметь только одно установленное значение на протяжении всего выполнения.

**Примечание** &mdash; Вы также можете использовать этот метод с Databricks SQL Warehouse.

<Lightbox src="/img/docs/dbt-cloud/using-dbt-cloud/Environment Variables/warehouse-override.png" title="Добавление переменных окружения в ваши учетные данные соединения"/>

:::info Ограничения переменных окружения и Snowflake OAuth
Переменные окружения работают нормально с именем пользователя/паролем и ключевой парой, включая запланированные задания, поскольку dbt Core использует Jinja, вставленный в автоматически сгенерированный `profiles.yml`, и разрешает его для выполнения поиска `env_var`. 

Однако существуют некоторые ограничения при использовании переменных окружения с настройками соединения Snowflake OAuth:

- Вы не можете использовать их в поле учетной записи/хоста, но они могут использоваться для базы данных, склада и роли. Для этих полей используйте [расширенные атрибуты](/docs/deploy/deploy-environments#deployment-connection).

Важно отметить, что если вы укажете переменную окружения в поле учетной записи/хоста, соединение Snowflake OAuth **не сможет** подключиться. Это происходит потому, что поле не проходит через рендеринг Jinja, поэтому dbt Cloud просто передает буквальный код `env_var` в строку URL, например `{{ env_var("DBT_ACCOUNT_HOST_NAME") }}.snowflakecomputing.com`, что является недопустимым именем хоста. Используйте [расширенные атрибуты](/docs/deploy/deploy-environments#deployment-credentials) вместо этого.
:::

</Expandable>

<Expandable alt_header="Аудит метаданных выполнения">

Вот еще один мотивирующий пример, который использует ID выполнения dbt Cloud, который устанавливается автоматически при каждом выполнении. Это дополнительное поле данных может использоваться для аудита и отладки:

```sql

{{ config(materialized='incremental', unique_key='user_id') }}

with users_aggregated as (

    select
        user_id,
        min(event_time) as first_event_time,
        max(event_time) as last_event_time,
        count(*) as count_total_events

    from {{ ref('users') }}
    group by 1

)

select *,
    -- Вставьте ID выполнения, если он присутствует, в противном случае используйте "manual"
    '{{ env_var("DBT_CLOUD_RUN_ID", "manual") }}' as _audit_run_id

from users_aggregated
```

</Expandable>

<Expandable alt_header="Настройка учетных данных Semantic Layer">

import SLEnvVars from '/snippets/_sl-env-vars.md';

<SLEnvVars/>

</Expandable>