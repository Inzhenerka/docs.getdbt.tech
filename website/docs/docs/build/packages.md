---
title: "Пакеты"
id: "packages"
description:  "Узнайте, как пакеты dbt помогают модульно организовать код и эффективно преобразовывать данные. Узнайте о git-пакетах, пакетах из хаба, частных пакетах и расширенных конфигурациях пакетов."
keywords: [dbt пакет, частный пакет, частный пакет dbt, преобразование данных dbt, клонирование dbt, добавление пакета dbt]
---

Программисты часто модульно организуют код в библиотеки. Эти библиотеки помогают разработчикам работать более эффективно: они могут уделять больше времени своей уникальной бизнес-логике и меньше времени на реализацию кода, который кто-то другой уже потратил время на совершенствование.

В dbt такие библиотеки называются _пакетами_. Пакеты dbt настолько мощны, потому что многие аналитические проблемы, с которыми мы сталкиваемся, общие для организаций, например:
* преобразование данных из последовательно структурированных наборов данных SaaS, например:
  * преобразование [Snowplow](https://hub.getdbt.com/dbt-labs/snowplow/latest/) или [Segment](https://hub.getdbt.com/dbt-labs/segment/latest/) просмотров страниц в сессии
  * преобразование данных о расходах [AdWords](https://hub.getdbt.com/dbt-labs/adwords/latest/) или [Facebook Ads](https://hub.getdbt.com/dbt-labs/facebook_ads/latest/) в единый формат.
* написание макросов dbt, которые выполняют аналогичные функции, например:
  * [генерация SQL](https://github.com/dbt-labs/dbt-utils#sql-helpers) для объединения двух отношений, поворота столбцов или построения <Term id="surrogate-key" />
  * создание [пользовательских тестов схемы](https://github.com/dbt-labs/dbt-utils#schema-tests)
  * написание [аудиторских запросов](https://hub.getdbt.com/dbt-labs/audit_helper/latest/)
* создание моделей и макросов для конкретного инструмента, используемого в вашем стеке данных, например:
  * Модели для понимания привилегий [Redshift](https://hub.getdbt.com/dbt-labs/redshift/latest/).
  * Макросы для работы с данными, загруженными с помощью [Stitch](https://hub.getdbt.com/dbt-labs/stitch_utils/latest/).

Пакеты dbt на самом деле являются самостоятельными проектами dbt, с моделями, макросами и другими ресурсами, которые решают конкретную проблему. Как пользователь dbt, добавляя пакет в свой проект, все ресурсы пакета станут частью вашего собственного проекта. Это означает:
* Модели в пакете будут материализованы, когда вы выполните `dbt run`.
* Вы можете использовать `ref` в своих моделях для ссылки на модели из пакета.
* Вы можете использовать `source` для ссылки на источники в пакете.
* Вы можете использовать макросы из пакета в своем собственном проекте.
* Важно отметить, что определение и установка пакетов dbt отличается от [определения и установки пакетов Python](/docs/build/python-models#using-pypi-packages).

## Как добавить пакет в мой проект?
1. Добавьте файл с именем `dependencies.yml` или `packages.yml` в ваш проект dbt. Он должен находиться на том же уровне, что и ваш файл `dbt_project.yml`.
2. Укажите пакет(ы), которые вы хотите добавить, используя один из поддерживаемых синтаксисов, например:

<File>

```yaml
packages:
  - package: dbt-labs/snowplow
    version: 0.7.0

  - git: "https://github.com/dbt-labs/dbt-utils.git"
    revision: 0.9.2

  - local: /opt/dbt/redshift
```

</File>

Путь установки по умолчанию [`packages-install-path`](/reference/project-configs/packages-install-path) — `dbt_packages`.

3. Выполните `dbt deps`, чтобы установить пакет(ы). Пакеты устанавливаются в директории `dbt_packages` — по умолчанию эта директория игнорируется git, чтобы избежать дублирования исходного кода пакета.

## Как указать пакет?
Вы можете указать пакет, используя один из следующих методов, в зависимости от того, где хранится ваш пакет.

### Пакеты из хаба (рекомендуется)

dbt Labs предоставляет [Пакетный хаб](https://hub.getdbt.com), реестр пакетов dbt, как услугу для сообщества dbt, но не сертифицирует и не подтверждает целостность, работоспособность, эффективность или безопасность любых пакетов. Пожалуйста, прочитайте [Отказ от ответственности по пакетам dbt Labs](https://hub.getdbt.com/disclaimer/) перед установкой пакетов из хаба.

Вы можете установить доступные пакеты из хаба следующим образом:

<File name='packages.yml'>

```yaml
packages:
  - package: dbt-labs/snowplow
    version: 0.7.3 # номер версии
```

</File>

Пакеты из хаба требуют указания версии — вы можете найти последний номер релиза на dbt Hub. Поскольку пакеты из хаба используют [семантическое версионирование](https://semver.org/), мы рекомендуем фиксировать ваш пакет на последней патч-версии из конкретного минорного релиза, например:

```yaml
packages:
  - package: dbt-labs/snowplow
    version: [">=0.7.0", "<0.8.0"]
```

`dbt deps` по умолчанию "фиксирует" каждый пакет. См. раздел ["Фиксация пакетов"](#pinning-packages) для получения подробной информации.

Где это возможно, мы рекомендуем устанавливать пакеты через dbt Hub, так как это позволяет dbt обрабатывать дублирующиеся зависимости. Это полезно в ситуациях, таких как:
* Ваш проект использует как пакеты dbt-utils, так и Snowplow, и пакет Snowplow _также_ использует пакет dbt-utils.
* Ваш проект использует как пакеты Snowplow, так и Stripe, оба из которых используют пакет dbt-utils.

В сравнении, другие методы установки пакетов не могут обрабатывать дублирующийся пакет dbt-utils.

Расширенные пользователи могут выбрать хостинг внутренней версии хаба пакетов на основе [этого репозитория](https://github.com/dbt-labs/hub.getdbt.com) и установить переменную окружения `DBT_PACKAGE_HUB_URL`.

#### Предрелизные версии

Некоторые разработчики пакетов могут захотеть выпустить предрелизные версии пакетов в dbt Hub, чтобы протестировать новую функциональность или совместимость с новой версией dbt. Предрелизная версия обозначается суффиксом, таким как `a1` (первая альфа), `b2` (вторая бета) или `rc3` (третий кандидат на релиз).

По умолчанию `dbt deps` не будет включать предрелизные версии при разрешении зависимостей пакетов. Вы можете включить установку предрелизов одним из двух способов:
- Явно указав предрелизную версию в ваших критериях `version`
- Установив `install_prerelease` в `true` и предоставив совместимый диапазон версий

Например, обе из следующих конфигураций успешно установят `0.4.5-a2` для пакета [`dbt_artifacts`](https://hub.getdbt.com/brooklyn-data/dbt_artifacts/latest/):

```yaml
packages:
  - package: brooklyn-data/dbt_artifacts
    version: 0.4.5-a2
```

```yaml
packages:
  - package: brooklyn-data/dbt_artifacts
    version: [">=0.4.4", "<0.4.6"]
    install_prerelease: true
```

### Git-пакеты
Пакеты, хранящиеся на Git-сервере, можно установить, используя синтаксис `git`, следующим образом:

<File name='packages.yml'>

```yaml
packages:
  - git: "https://github.com/dbt-labs/dbt-utils.git" # git URL
    revision: 0.9.2 # имя тега или ветки
```

</File>

Добавьте URL Git для пакета и, при необходимости, укажите ревизию. Ревизия может быть:
- именем ветки
- отмеченным релизом
- конкретным коммитом (полный 40-символьный хэш)

Пример ревизии, указывающей 40-символьный хэш:

```yaml
packages:
  - git: "https://github.com/dbt-labs/dbt-utils.git"
    revision: 4e28d6da126e2940d17f697de783a717f2503188
```

По умолчанию `dbt deps` "фиксирует" каждый пакет. См. раздел ["Фиксация пакетов"](#pinning-packages) для получения подробной информации.

### URL tarball, размещенный внутри организации

Некоторые организации имеют требования безопасности, чтобы получать ресурсы только из внутренних сервисов. Чтобы удовлетворить необходимость установки пакетов из размещенных сред, таких как Artifactory или облачные хранилища, dbt Core позволяет устанавливать пакеты из URL tarball, размещенных внутри организации.

```yaml
packages:
  - tarball: https://codeload.github.com/dbt-labs/dbt-utils/tar.gz/0.9.6
    name: 'dbt_utils'
```

Где `name: 'dbt_utils'` указывает на подпапку `dbt_packages`, в которую будет установлен исходный код пакета.

## Частные пакеты

### Нативные частные пакеты <Lifecycle status='beta'/>

dbt Cloud поддерживает частные пакеты из [поддерживаемых](#prerequisites) Git-репозиториев, используя существующую [конфигурацию](/docs/cloud/git/git-configuration-in-dbt-cloud) в вашей среде. Ранее вам нужно было настроить [токен](#git-token-method) для получения пакетов из ваших частных репозиториев.

#### Предварительные требования

Чтобы использовать нативные частные пакеты, вы должны иметь одного из следующих поставщиков Git, настроенных в разделе **Интеграции** в настройках вашей учетной записи:
- [GitHub](/docs/cloud/git/connect-github)
- [Azure DevOps](/docs/cloud/git/connect-azure-devops)
- Поддержка GitLab скоро появится.

#### Конфигурация

Используйте ключ `private` в вашем `packages.yml` или `dependencies.yml`, чтобы клонировать репозитории пакетов, используя вашу существующую интеграцию Git dbt Cloud без необходимости предоставлять токен доступа или создавать переменную окружения dbt Cloud:

<File name="packages.yml">

```yaml
packages:
  - private: dbt-labs/awesome_repo
  - package: обычные пакеты

	[...]
```

</File>

Вы можете фиксировать частные пакеты аналогично обычным пакетам dbt:

```yaml
packages:
  - private: dbt-labs/awesome_repo
    revision: "0.9.5" # Фиксация на теге, ветке или полном 40-символьном хэше коммита
```

Если вы используете несколько интеграций Git, уточните, добавив ключ поставщика:

```yaml
packages:
  - private: dbt-labs/awesome_repo
    provider: "github" # В настоящее время поддерживаются GitHub и Azure. GitLab скоро появится.
```

С помощью этого метода вы можете получать частные пакеты от интегрированного поставщика Git без дополнительных шагов для подключения.

### Метод SSH-ключа (только командная строка)
Если вы используете командную строку, частные пакеты можно клонировать через SSH и SSH-ключ.

Когда вы используете SSH-ключи для аутентификации на вашем удаленном сервере git, вам не нужно каждый раз вводить свое имя пользователя и пароль. Узнайте больше о SSH-ключах, как их генерировать и как добавлять их к вашему поставщику git здесь: [Github](https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh) и [GitLab](https://docs.gitlab.com/ee/user/ssh.html).

<File name='packages.yml'>

```yaml
packages:
  - git: "git@github.com:dbt-labs/dbt-utils.git" # git SSH URL
```

</File>

Если вы используете dbt Cloud, метод SSH-ключа не будет работать, но вы можете использовать [Метод токена HTTPS Git](https://docs.getdbt.com/docs/build/packages#git-token-method).

### Метод токена Git

:::note

dbt Cloud имеет [нативную поддержку](#native-private-packages) для частных пакетов, размещенных в Git, с GitHub и Azure DevOps (поддержка GitLab скоро появится). Если вы используете поддерживаемую [интегрированную Git-среду](/docs/cloud/git/git-configuration-in-dbt-cloud), вам больше не нужно настраивать токены Git для получения частных пакетов.

:::

Этот метод позволяет пользователю клонировать через HTTPS, передавая токен git через переменную окружения. Будьте осторожны с датой истечения любого токена, который вы используете, так как истекший токен может привести к сбою запланированного выполнения. Кроме того, токены пользователей могут создать проблему, если пользователь когда-либо потеряет доступ к конкретному репозиторию.

:::info Использование dbt Cloud
Если вы используете dbt Cloud, вы должны соблюдать правила именования для переменных окружения. Переменные окружения в dbt Cloud должны начинаться с `DBT_` или `DBT_ENV_SECRET`. Ключи переменных окружения записываются в верхнем регистре и чувствительны к регистру. При ссылке на `{{env_var('DBT_KEY')}}` в коде вашего проекта ключ должен точно соответствовать переменной, определенной в интерфейсе dbt Cloud.
:::

В GitHub:

<File name='packages.yml'>

```yaml
packages:
  # используйте этот формат при доступе к вашему репозиторию через токен приложения github
  - git: "https://{{env_var('DBT_ENV_SECRET_GIT_CREDENTIAL')}}@github.com/dbt-labs/awesome_repo.git" # git HTTPS URL

  # используйте этот формат при доступе к вашему репозиторию через классический токен доступа
  - git: "https://{{env_var('DBT_ENV_SECRET_GIT_CREDENTIAL')}}@github.com/dbt-labs/awesome_repo.git" # git HTTPS URL
 
   # используйте этот формат при доступе к вашему репозиторию через токен доступа с тонкой настройкой (иногда требуется имя пользователя)
  - git: "https://GITHUB_USERNAME:{{env_var('DBT_ENV_SECRET_GIT_CREDENTIAL')}}@github.com/dbt-labs/awesome_repo.git" # git HTTPS URL
```

</File>

Узнайте больше о создании токена доступа GitHub [здесь](https://docs.github.com/en/enterprise-server@3.1/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token). Вы также можете использовать токен установки [GitHub App](https://docs.github.com/en/rest/reference/apps#create-an-installation-access-token-for-an-app).

В GitLab:

<File name='packages.yml'>

```yaml
packages:
  - git: "https://{{env_var('DBT_USER_NAME')}}:{{env_var('DBT_ENV_SECRET_DEPLOY_TOKEN')}}@gitlab.example.com/dbt-labs/awesome_project.git" # git HTTPS URL
```

</File>

Узнайте больше о создании токена развертывания GitLab [здесь](https://docs.gitlab.com/ee/user/project/deploy_tokens/#creating-a-deploy-token) и о том, как правильно составить ваш HTTPS URL [здесь](https://docs.gitlab.com/ee/user/project/deploy_tokens/#git-clone-a-repository). Токены развертывания могут управляться только сопровождающими.

В Azure DevOps:

<File name='packages.yml'>

```yaml
packages:
  - git: "https://{{env_var('DBT_ENV_SECRET_PERSONAL_ACCESS_TOKEN')}}@dev.azure.com/dbt-labs/awesome_project/_git/awesome_repo" # git HTTPS URL
```

</File>

Узнайте больше о создании токена доступа [здесь](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&tabs=preview-page#create-a-pat).

В Bitbucket:

<File name='packages.yml'>

```yaml
packages:
  - git: "https://{{env_var('DBT_USER_NAME')}}:{{env_var('DBT_ENV_SECRET_PERSONAL_ACCESS_TOKEN')}}@bitbucketserver.com/scm/awesome_project/awesome_repo.git" # для Bitbucket Server
```

</File>

Узнайте больше о создании токена доступа [здесь](https://confluence.atlassian.com/bitbucketserver/personal-access-tokens-939515499.html).

## Настройка подпапки для упакованных проектов

В общем, dbt ожидает, что `dbt_project.yml` будет находиться в корневом каталоге пакета. Если упакованный проект находится в подпапке — возможно, в гораздо большем монорепозитории — вы можете опционально указать путь к папке как `subdirectory`. dbt попытается выполнить [разреженную проверку](https://git-scm.com/docs/git-sparse-checkout) только для файлов, находящихся в этой подпапке. Обратите внимание, что вы должны использовать недавнюю версию `git` (`>=2.26.0`).

<File name='packages.yml'>

```yaml
packages:
  - git: "https://github.com/dbt-labs/dbt-labs-experimental-features" # git URL
    subdirectory: "materialized-views" # имя подпапки, содержащей `dbt_project.yml`
```

</File>

### Локальные пакеты
"Локальный" пакет — это проект dbt, доступный из вашей локальной файловой системы. Вы можете установить его, указав путь к проекту. Он лучше всего работает, когда вы помещаете проект в подпапку относительно каталога вашего текущего проекта.

<File name='packages.yml'>

```yaml
packages:
  - local: relative/path/to/subdirectory
```

</File>

Другие шаблоны могут работать в некоторых случаях, но не всегда. Например, если вы установите этот проект как пакет в другом месте или попытаетесь запустить его на другой системе, относительные и абсолютные пути дадут одинаковые результаты.

<File name='packages.yml'>

```yaml
packages:
  # не рекомендуется - поддержка этих шаблонов варьируется
  - local: /../../redshift   # относительный путь к родительскому каталогу
  - local: /opt/dbt/redshift # абсолютный путь на системе
```

</File>

Существуют несколько конкретных случаев, когда мы рекомендуем использовать "локальный" пакет:
1. **Монорепозиторий** &mdash; Когда у вас есть несколько проектов, каждый из которых вложен в подпапку, в монорепозитории. "Локальные" пакеты позволяют вам объединять проекты для согласованной разработки и развертывания.
2. **Тестирование изменений** &mdash; Чтобы протестировать изменения в одном проекте или пакете в контексте последующего проекта или пакета, который его использует. Временно переключив установку на "локальный" пакет, вы можете вносить изменения в первый и немедленно тестировать их во втором для более быстрой итерации. Это похоже на [редактируемые установки](https://pip.pypa.io/en/stable/topics/local-project-installs/) в Python.
3. **Вложенный проект** &mdash; Когда у вас есть вложенный проект, который определяет фикстуры и тесты для проекта полезных макросов, как [интеграционные тесты в пакете `dbt-utils`](https://github.com/dbt-labs/dbt-utils/tree/main/integration_tests).

## Какие пакеты доступны?
Посмотрите [dbt Hub](https://hub.getdbt.com), чтобы увидеть библиотеку опубликованных пакетов dbt!

## Расширенная конфигурация пакетов
### Обновление пакета
Когда вы обновляете версию или ревизию в вашем файле `packages.yml`, она не обновляется автоматически в вашем проекте dbt. Вам следует выполнить `dbt deps`, чтобы обновить пакет. Вам также может потребоваться выполнить [полное обновление](/reference/commands/run) моделей в этом пакете.

### Удаление пакета
Когда вы удаляете пакет из вашего файла `packages.yml`, он не удаляется автоматически из вашего проекта dbt, так как он все еще существует в вашей директории `dbt_packages/`. Если вы хотите полностью удалить пакет, вам следует либо:
* удалить директорию пакета в `dbt_packages/`;  или
* выполнить `dbt clean`, чтобы удалить _все_ пакеты (и любые скомпилированные модели), а затем выполнить `dbt deps`.

### Фиксация пакетов

Начиная с версии 1.7, выполнение [`dbt deps`](/reference/commands/deps) "фиксирует" каждый пакет, создавая или обновляя файл `package-lock.yml` в _корне проекта_, где записан `packages.yml`.

- Файл `package-lock.yml` содержит запись обо всех установленных пакетах.
- Если последующие запуски `dbt deps` не содержат изменений в `dependencies.yml` или `packages.yml`, dbt-core устанавливает из `package-lock.yml`. 

Например, если вы используете имя ветки, файл `package-lock.yml` фиксирует на последнем коммите. Если вы используете диапазон версий, он фиксирует на последнем релизе. В любом случае последующие коммиты или версии **не** будут установлены. Чтобы получить новые коммиты или версии, выполните `dbt deps --upgrade` или добавьте `package-lock.yml` в ваш .gitignore.

Начиная с версии 0.14.0, dbt будет предупреждать вас, если вы установите пакет, используя синтаксис `git`, не указав ревизию (см. ниже).

### Конфигурирование пакетов
Вы можете настроить модели и семена в пакете из файла `dbt_project.yml`, следующим образом:

<File name='dbt_project.yml'>

```yml

vars:
  snowplow:
    'snowplow:timezone': 'America/New_York'
    'snowplow:page_ping_frequency': 10
    'snowplow:events': "{{ ref('sp_base_events') }}"
    'snowplow:context:web_page': "{{ ref('sp_base_web_page_context') }}"
    'snowplow:context:performance_timing': false
    'snowplow:context:useragent': false
    'snowplow:pass_through_columns': []

models:
  snowplow:
    +schema: snowplow

seeds:
  snowplow:
    +schema: snowplow_seeds
```

</File>

Например, при использовании пакета, специфичного для набора данных, вам может потребоваться настроить переменные для имен таблиц, содержащих ваши сырые данные.

Конфигурации, сделанные в вашем файле `dbt_project.yml`, будут переопределять любые конфигурации в пакете (либо в файле `dbt_project.yml` пакета, либо в блоках конфигурации).

### Указание неприжатых Git-пакетов
Если ваш проект указывает "неприжатый" Git-пакет, вы можете увидеть предупреждение, например:
```
Git-пакет "https://github.com/dbt-labs/dbt-utils.git" не зафиксирован.
Это может привести к внесению разрушающих изменений в ваш проект без предупреждения!
```

Это предупреждение можно отключить, установив `warn-unpinned: false` в спецификации пакета. **Примечание:** Это не рекомендуется.

<File name='packages.yml'>

```yaml
packages:
  - git: https://github.com/dbt-labs/dbt-utils.git
    warn-unpinned: false
```

</File>

### Установка версий с двумя частями
В dbt v0.17.0 _только_, если версия пакета, которую вы хотите, указана только как `major`.`minor`, а не `major.minor.patch`, вы можете получить ошибку, что `1.0 не является типом 'строка'`. В этом случае вам нужно будет сообщить dbt, что ваш номер версии является строкой. Эта проблема была решена в v0.17.1 и всех последующих версиях.

<File name='packages.yml'>

```yaml
packages:
 - git: https://github.com/dbt-labs/dbt-codegen.git
   version: "{{ 1.0 | as_text }}"
```

</File>