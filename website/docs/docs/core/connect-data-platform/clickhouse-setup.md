---
title: "Настройка ClickHouse"
description: "Прочитайте это руководство, чтобы узнать о настройке хранилища ClickHouse в dbt."
meta:
  maintained_by: Сообщество
  authors: 'Geoff Genz & Bentsi Leviav'
  github_repo: 'ClickHouse/dbt-clickhouse'
  pypi_package: 'dbt-clickhouse'
  min_core_version: 'v0.19.0'
  cloud_support: Не поддерживается
  min_supported_version: '?'
  slack_channel_name: '#db-clickhouse'
  slack_channel_link: 'https://getdbt.slack.com/archives/C01DRQ178LQ'
  platform_name: 'Clickhouse'
  config_page: '/reference/resource-configs/clickhouse-configs'
---

Некоторые основные функции могут быть ограничены. Если вы хотите внести свой вклад, ознакомьтесь с исходным кодом для каждого
репозитория, перечисленного ниже.

import SetUpPages from '/snippets/_setup-pages-intro.md';

<SetUpPages meta={frontMatter.meta} />

## Подключение к ClickHouse с помощью **dbt-clickhouse**

Чтобы подключиться к ClickHouse из dbt, вам нужно добавить [профиль](https://docs.getdbt.com/docs/core/connection-profiles)
в ваш файл `profiles.yml`. Профиль ClickHouse соответствует следующему синтаксису:

<File name='profiles.yml'>

```yaml
<profile-name>:
  target: <target-name>
  outputs:
    <target-name>:
      type: clickhouse
      schema: [ default ] # База данных ClickHouse для моделей dbt

      # необязательно
      driver: [ http ] # http или native. Если не настроено, это будет автоматически определено на основе настройки порта
      host: [ localhost ]
      port: [ 8123 ]  # По умолчанию 8123, 8443, 9000, 9440 в зависимости от настроек безопасности и драйвера 
      user: [ default ] # Пользователь для всех операций с базой данных
      password: [ <empty string> ] # Пароль для пользователя
      cluster: [ <empty string> ] # Если настроено, определенные операции DDL/таблиц будут выполняться с помощью клаузулы `ON CLUSTER`, используя этот кластер. Распределенные материализации требуют этой настройки для работы. См. раздел о кластере ClickHouse для получения дополнительной информации.
      verify: [ True ] # Проверить сертификат TLS, если используется TLS/SSL
      secure: [ False ] # Использовать TLS (родной протокол) или HTTPS (http протокол)
      retries: [ 1 ] # Количество попыток повторного подключения при "восстанавливаемом" исключении базы данных (например, ошибка 503 'Служба недоступна')
      compression: [ <empty string> ] # Использовать сжатие gzip, если истинно (http), или тип сжатия для родного соединения
      connect_timeout: [ 10 ] # Тайм-аут в секундах для установления соединения с ClickHouse
      send_receive_timeout: [ 300 ] # Тайм-аут в секундах для получения данных от сервера ClickHouse
      cluster_mode: [ False ] # Использовать специальные настройки, предназначенные для улучшения работы с реплицированными базами данных (рекомендуется для ClickHouse Cloud)
      use_lw_deletes: [ False ] # Использовать стратегию `delete+insert` в качестве стратегии инкрементного обновления по умолчанию.
      check_exchange: [ True ] # Проверить, поддерживает ли ClickHouse атомарную команду EXCHANGE TABLES. (Не требуется для большинства версий ClickHouse)
      local_suffix: [ _local ] # Суффикс таблицы локальных таблиц на шардов для распределенных материализаций.
      local_db_prefix: [ <empty string> ] # Префикс базы данных локальных таблиц на шардов для распределенных материализаций. Если пусто, используется та же база данных, что и для распределенной таблицы.
      allow_automatic_deduplication: [ False ] # Включить автоматическую дедупликацию ClickHouse для реплицированных таблиц
      tcp_keepalive: [ False ] # Только для родного клиента, укажите конфигурацию TCP keepalive. Укажите пользовательские настройки keepalive в виде [idle_time_sec, interval_sec, probes].
      custom_settings: [ { } ] # Словарь/отображение пользовательских настроек ClickHouse для соединения - по умолчанию пусто.

      # Настройки соединения для родного (clickhouse-driver)
      sync_request_timeout: [ 5 ] # Тайм-аут для пинга сервера
      compress_block_size: [ 1048576 ] # Размер блока сжатия, если сжатие включено


```

</File>

### Описание полей профиля ClickHouse

| Поле                           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `type`                          | Это должно быть включено либо в `profiles.yml`, либо в файл `dbt_project.yml`. Должно быть установлено на `clickhouse`.                                                                                                                                                                                                                                                                                                                                                        |
| `schema`                        | Обязательно. Имя базы данных ClickHouse. База данных модели dbt.database.schema.table несовместима с ClickHouse, потому что ClickHouse не поддерживает схему. Поэтому мы используем простую модель schema.table, где schema - это база данных ClickHouse. Мы не рекомендуем использовать базу данных `default`.                                                                                                                                                                               |
| `driver`                        | Необязательно. Интерфейс клиента ClickHouse, `http` или `native`. По умолчанию `http`, если порт не установлен на 9440 или 9400, в этом случае предполагается драйвер `native`.                                                                                                                                                                                                                                                                                                   |
| `host`                          | Необязательно. Имя хоста соединения. По умолчанию `localhost`.                                                                                                                                                                                                                                                                                                                                                                                                           |
| `port`                          | Необязательно. Номер порта сервера ClickHouse. По умолчанию 8123/8443 (безопасный), если драйвер `http`, и 9000/9440 (безопасный), если драйвер `native`.                                                                                                                                                                                                                                                                                                                        |
| `user`                          | Обязательно. Имя пользователя ClickHouse с достаточными правами для доступа к указанной `schema`.                                                                                                                                                                                                                                                                                                                                                                                  |
| `password`                      | Обязательно. Пароль, связанный с указанным `user`.                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `cluster`                       | Необязательно. Если установлено, определенные операции DDL/таблиц будут выполняться с помощью клаузулы `ON CLUSTER`, используя этот кластер. Распределенные материализации требуют этой настройки для работы. См. раздел о кластере ClickHouse для получения дополнительной информации.                                                                                                                                                                                                                                   |
| `verify`                        | Необязательно. Для соединений (`secure=True`) проверьте сертификат TLS сервера ClickHouse, включая соответствие имени хоста, сроку действия и подписи доверенным центром сертификации. По умолчанию True.                                                                                                                                                                                                                                                                         |
| `secure`                        | Необязательно. Является ли соединение (либо http, либо native) защищенным с помощью TLS. Это преобразует соединение драйвера http в https, а соединение драйвера native в родной протокол ClickHouse через TLS. По умолчанию False.                                                                                                                                                                                                                                            |
| `retries`                       | Необязательно. Количество попыток повторного подключения при возникновении ошибки, которую можно восстановить.                                                                                                                                                                                                                                                                                                                                                                    |
| `compression`                   | Необязательно. Использовать сжатие в соединении. По умолчанию `False`. Если установлено в `True` для HTTP, это включает сжатие gzip. Если установлено в `True` для родного протокола, это включает сжатие lz4. Другие допустимые значения - `lz4hc` и `zstd` только для родного драйвера.                                                                                                                                                                                                |
| `connect_timeout`               | Необязательно. Тайм-аут соединения в секундах. По умолчанию 10 секунд.                                                                                                                                                                                                                                                                                                                                                                                                             |
| `send_receive_timeout`          | Необязательно. Тайм-аут для получения данных от или отправки данных в ClickHouse. По умолчанию 5 минут (300 секунд)                                                                                                                                                                                                                                                                                                                                                                |
| `cluster_mode`                  | Необязательно. Добавить настройки соединения для улучшения совместимости с кластерами, использующими движок реплицированной базы данных. По умолчанию False.                                                                                                                                                                                                                                                                                                                                                |
| `use_lw_deletes`                | Необязательно. Если доступны экспериментальные легкие удаления ClickHouse, используйте стратегию `delete+insert` в качестве стратегии инкрементных материализаций по умолчанию. По умолчанию False (использовать устаревшую стратегию).                                                                                                                                                                                                                                                               |
| `check_exchange`                | Необязательно. При подключении к ClickHouse, если этот параметр установлен в `True`, DBT проверит, поддерживает ли сервер ClickHouse атомарный обмен таблицами. Использование атомарного обмена (когда доступно) улучшает надежность и параллелизм. Эта проверка не требуется для ClickHouse, работающего на современных операционных системах Linux, и в этих случаях ее можно отключить, установив `check_exchange` в `False`, чтобы избежать дополнительных затрат на запуск. По умолчанию True. |
| `local_suffix`                  | Необязательно. Суффикс таблицы локальных таблиц на шардов для распределенных материализаций. По умолчанию '_local'.                                                                                                                                                                                                                                                                                                                                                                     |
| `local_db_prefix`               | Необязательно. Префикс базы данных локальных таблиц на шардов для распределенных материализаций. Если пусто, используется та же база данных, что и для распределенной таблицы. По умолчанию пустая строка.                                                                                                                                                                                                                                                                                                |
| `allow_automatic_deduplication` | Необязательно. Включить автоматическую дедупликацию ClickHouse для реплицированных таблиц. По умолчанию False.                                                                                                                                                                                                                                                                                                                                                                                |
| `tcp_keepalive`                 | Необязательно. Только для родного клиента, укажите конфигурацию TCP keepalive. Укажите пользовательские настройки keepalive в виде `idle_time_sec`, `interval_sec`, `probes`. По умолчанию False.                                                                                                                                                                                                                                                                                                        |
| `sync_request_timeout`          | Необязательно. Тайм-аут для запроса пинга соединения (только для родного соединения). По умолчанию 5 секунд.                                                                                                                                                                                                                                                                                                                                                                              |
| `compress_block_size`           | Необязательно. Размер блока сжатия (в байтах) при использовании сжатия с родным драйвером. По умолчанию 1 МБ                                                                                                                                                                                                                                                                                                                                                                  |
| `database_engine`               | Необязательно. Движок базы данных, который следует использовать при создании новых схем ClickHouse (баз данных). Если не установлен (по умолчанию), новые базы данных будут использовать стандартный движок базы данных ClickHouse (обычно Atomic).                                                                                                                                                                                                                                                                                |
| `custom_settings`               | Необязательно. Отображение специфичных для ClickHouse пользовательских настроек для использования с соединением. См. документацию ClickHouse для поддерживаемых настроек.                                                                                                                                                                                                                                                                                                                               |

## Устранение неполадок при подключении

Если вы столкнулись с проблемами подключения к ClickHouse из dbt, убедитесь, что выполнены следующие условия:

- Движок должен быть одним из [поддерживаемых движков](/reference/resource-configs/clickhouse-configs#supported-table-engines).
- У вас должны быть достаточные права для доступа к базе данных.
- Если вы не используете стандартный движок таблицы для базы данных, вы должны указать движок таблицы в конфигурации вашей модели.