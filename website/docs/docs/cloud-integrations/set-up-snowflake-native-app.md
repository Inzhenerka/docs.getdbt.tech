---
title: "Настройка dbt Snowflake Native App"
description: "Узнайте, как настроить dbt Snowflake Native App"
pagination_prev: "docs/cloud-integrations/snowflake-native-app"
pagination_next: null
---

# Настройка dbt Snowflake Native App <Lifecycle status='preview' />

[dbt Snowflake Native App](/docs/cloud-integrations/snowflake-native-app) включает в себя такие функции в интерфейсе Snowflake, как: dbt Explorer, чат-бот **Ask dbt** и функции наблюдаемости оркестрации dbt Cloud.

Настройте как dbt Cloud, так и Snowflake для интеграции. Основные шаги описаны следующим образом:

1. Настройте конфигурацию **Ask dbt**.
1. Настройте Snowflake.
1. Настройте dbt Cloud.
1. Приобретите и установите dbt Snowflake Native App.
1. Настройте приложение.
1. Проверьте успешную установку приложения.
1. Включите новых пользователей в приложение.

Порядок шагов немного отличается, если вы приобрели публичный список Native App; вы начнете с покупки Native App, удовлетворения предварительным требованиям, а затем выполните оставшиеся шаги в порядке.

## Предварительные требования
Следующие требования необходимы для dbt Cloud и Snowflake.

### dbt Cloud

- У вас должен быть аккаунт dbt Cloud на корпоративном плане, который находится в регионе AWS или Azure. Если у вас его еще нет, пожалуйста, [свяжитесь с нами](mailto:sales_snowflake_marketplace@dbtlabs.com), чтобы начать.
    - В настоящее время Semantic Layer недоступен для экземпляров Azure ST, и чат-бот **Ask dbt** не будет работать в dbt Snowflake Native App без него.
- Ваш аккаунт dbt Cloud должен иметь разрешение на создание [токена службы](/docs/dbt-cloud-apis/service-tokens). Для получения подробной информации обратитесь к [разделу о разрешениях для предприятий](/docs/cloud/manage-access/enterprise-permissions).
- Должен быть проект dbt с [настроенным Semantic Layer](/docs/use-dbt-semantic-layer/setup-sl) и объявленными метриками.
- Вы настроили [среду развертывания в производственной среде](/docs/deploy/deploy-environments#set-as-production-environment).
    - Должен быть хотя бы один успешный запуск задания, который включает шаг `docs generate` в среде развертывания.

### Snowflake

- У вас должен быть доступ **ACCOUNTADMIN** в Snowflake.
- Ваш аккаунт Snowflake должен иметь доступ к интеграции Native App/SPCS и конфигурациям NA/SPCS (публичный предварительный просмотр запланирован на конец июня). Если вы не уверены, пожалуйста, проверьте это с вашим менеджером по аккаунту Snowflake.
- Аккаунт Snowflake должен находиться в регионе AWS. Azure в настоящее время не поддерживается для интеграции Native App/SPCS.
- У вас есть доступ к Snowflake Cortex через ваши разрешения Snowflake, и [Snowflake Cortex доступен в вашем регионе](https://docs.snowflake.com/en/user-guide/snowflake-cortex/llm-functions#availability). Без этого Ask dbt не будет работать.

## Настройка конфигурации для Ask dbt

Настройте dbt Cloud и Snowflake Cortex для работы чат-бота **Ask dbt**.

1. В dbt Cloud перейдите к вашим конфигурациям Semantic Layer.

    1. Перейдите в левую панель и нажмите на имя вашего аккаунта. Затем выберите **Настройки аккаунта**.
    1. В левой боковой панели выберите **Проекты** и выберите ваш проект dbt из списка проектов.

    1. В панели **Детали проекта** нажмите на ссылку **Изменить конфигурацию Semantic Layer** (которая находится под опцией **GraphQL URL**).
2. В панели **Детали конфигурации Semantic Layer** определите учетные данные Snowflake (которые вы будете использовать для доступа к Snowflake Cortex) и среду, в которой выполняется Semantic Layer. Сохраните имя пользователя, роль и среду в временном месте для дальнейшего использования.

    <Lightbox src="/img/docs/cloud-integrations/semantic_layer_configuration.png" width="100%" title="Учетные данные Semantic Layer"/>

3. В Snowflake проверьте, что вашему SL и пользователю развертывания предоставлены разрешения на использование Snowflake Cortex. Для получения дополнительной информации обратитесь к [Необходимым привилегиям](https://docs.snowflake.com/en/user-guide/snowflake-cortex/llm-functions#required-privileges) в документации Snowflake.

    По умолчанию все пользователи должны иметь доступ к Snowflake Cortex. Если это отключено для вас, откройте рабочий лист SQL Snowflake и выполните следующие команды:

    ```sql
    create role cortex_user_role;
    grant database role SNOWFLAKE.CORTEX_USER to role cortex_user_role;
    grant role cortex_user_role to user SL_USER;
    grant role cortex_user_role to user DEPLOYMENT_USER;
    ```

    Убедитесь, что вы заменили `SNOWFLAKE.CORTEX_USER`, `DEPLOYMENT_USER` и `SL_USER` на соответствующие строки для вашей среды.

## Настройка dbt Cloud
Соберите следующую информацию из dbt Cloud для настройки приложения.

1. Перейдите в левую панель и нажмите на имя вашего аккаунта. Затем выберите **Настройки аккаунта**. Затем нажмите **API токены > Токены службы**. Создайте токен службы с доступом ко всем проектам, к которым вы хотите получить доступ в dbt Snowflake Native App. Предоставьте следующие наборы разрешений:
    - **Управление приложениями в маркетплейсе**
    - **Администратор заданий**
    - **Только метаданные**
    - **Только Semantic Layer**

    Убедитесь, что вы сохранили информацию о токене в временном месте для дальнейшего использования при настройке Native App.

    Следующий пример показывает, как предоставить наборы разрешений для всех проектов:

    <Lightbox src="/img/docs/cloud-integrations/example-snowflake-native-app-service-token.png" title="Пример нового токена службы для dbt Snowflake Native App"/>

2. В левой боковой панели выберите **Аккаунт** и сохраните эту информацию в временном месте для дальнейшего использования при настройке Native App:
    - **ID аккаунта** &mdash; Числовая строка, представляющая ваш аккаунт dbt Cloud.
    - **URL доступа** &mdash; Если у вас есть многопользовательский аккаунт в Северной Америке, используйте `cloud.getdbt.com` в качестве URL доступа. Для всех других регионов обратитесь к [Доступу, регионам и IP-адресам](/docs/cloud/about-cloud/access-regions-ip-addresses) и найдите URL доступа, который вы должны использовать в таблице.

## Установка dbt Snowflake Native App
1. Перейдите к списку dbt Snowflake Native App:
    - **Частный список** (рекомендуется) &mdash; Используйте ссылку из отправленного вам электронного письма.
    - **Публичный список** &mdash; Перейдите на [Snowflake Marketplace](https://app.snowflake.com/marketplace/listing/GZTYZSRT2R3).
2. Нажмите **Получить** в списке, чтобы установить dbt Snowflake Native App. Это может занять несколько минут. Когда установка завершится, вам будет отправлено электронное письмо.

    Появится сообщение с вопросом, хотите ли вы изменить приложение и предоставить доступ к складу для установки. dbt Labs настоятельно рекомендует не изменять имя приложения, если это не необходимо.
3. Когда dbt Snowflake Native App будет успешно установлен, нажмите **Настроить** в модальном окне.

## Настройка dbt Snowflake Native App

1. На странице **Активировать dbt** нажмите **Предоставить** в **Шаге 1: Предоставить привилегии аккаунта**.
2. Когда привилегии будут успешно предоставлены, нажмите **Просмотреть** в **Шаге 2: Разрешить подключения**.

    Пройдите через шаги **Подключение к интеграции внешнего доступа dbt Cloud**. Вам понадобятся данные вашего аккаунта dbt Cloud, которые вы собрали ранее. Введите ваш ID аккаунта, URL доступа и токен API службы в качестве **Секретного значения**, когда будет предложено.
3. На странице **Активировать dbt** нажмите **Активировать**, когда вы установите успешное соединение с интеграцией внешнего доступа dbt Cloud. Это может занять несколько минут для запуска необходимых сервисов Snowflake и вычислительных ресурсов.
4. Когда активация завершится, выберите вкладку **Телеметрия** и включите опцию для совместного использования ваших логов `INFO`. Эта опция может занять некоторое время для отображения. Это связано с тем, что Snowflake должен создать таблицу событий, чтобы ее можно было совместно использовать.
5. Когда опция будет успешно включена, нажмите **Запустить приложение**. Затем войдите в приложение с помощью ваших учетных данных Snowflake.

    Если вас перенаправляет на рабочий лист Snowsight (вместо страницы входа), это означает, что приложение еще не завершило установку. Обычно вы можете решить эту проблему, обновив страницу.

    Следующий пример показывает dbt Snowflake Native App после настройки:

    <Lightbox src="/img/docs/cloud-integrations/example-dbt-snowflake-native-app.png" title="Пример dbt Snowflake Native App"/>

## Проверьте, что приложение установлено успешно

Чтобы проверить, что приложение установлено успешно, выберите любой из следующих пунктов в боковой панели:

- **Исследовать** &mdash; Запустите dbt Explorer и убедитесь, что вы можете получить доступ к информации о вашем проекте dbt.
- **Задания** &mdash; Просмотрите историю выполнения заданий dbt.
- **Ask dbt** &mdash; Нажмите на любой из предложенных запросов, чтобы задать вопрос чат-боту. В зависимости от количества метрик, определенных для проекта dbt, загрузка **Ask dbt** в первый раз может занять несколько минут, так как dbt строит Retrieval Augmented Generation (RAG). Последующие запуски будут загружаться быстрее.

Следующий пример показывает чат-бота **Ask dbt** с предложенными запросами в верхней части:

<Lightbox src="/img/docs/cloud-integrations/example-ask-dbt-native-app.png" title="Пример чат-бота Ask dbt"/>

## Включение новых пользователей
1. В боковой панели Snowflake выберите **Продукты данных > Приложения**. Выберите **dbt** из списка, чтобы открыть страницу конфигурации приложения. Затем нажмите **Управление доступом** (в правом верхнем углу), чтобы включить новых пользователей в приложение. Предоставьте роль **APP_USER** соответствующим ролям, которые должны иметь доступ к приложению, но не должны иметь возможности редактировать конфигурации. Предоставьте **APP_ADMIN** ролям, которые должны иметь доступ к редактированию или удалению конфигураций.

2. Новые пользователи могут получить доступ к приложению либо по URL приложения Snowflake, который был с ними поделён, либо нажав **Запустить приложение** на странице конфигурации приложения.

## Часто задаваемые вопросы

<Expandable alt_header="Не удается установить dbt Cloud Snowflake Native app из Snowflake Marketplace">

dbt Cloud Snowflake Native App недоступен для аккаунтов Snowflake Free Trial.

</Expandable>

<Expandable alt_header="Получено сообщение об ошибке `Не удается получить доступ к схеме dbt_sl_llm` от Ask dbt">

Проверьте, что пользователю SL предоставлен доступ к схеме `dbt_sl_llm` и убедитесь, что у него есть все необходимые разрешения для чтения и записи в схему.

</Expandable>

<Expandable alt_header="Необходимо обновить параметры конфигурации dbt, используемые Native App">

Если произошли изменения в ID аккаунта dbt Cloud, URL доступа или токене API службы, вам необходимо обновить конфигурацию для dbt Snowflake Native App. В Snowflake перейдите на страницу конфигурации приложения и удалите существующие конфигурации. Добавьте новую конфигурацию, а затем выполните `CALL app_public.restart_app();` в базе данных приложения в Snowsight.
</Expandable>

<Expandable alt_header="Поддерживаются ли переменные окружения в Native App?">

[Переменные окружения](/docs/build/environment-variables), такие как `{{env_var('DBT_WAREHOUSE') }}`, пока не поддерживаются в Semantic Layer dbt. Чтобы использовать функцию 'Ask dbt', вы должны использовать фактические учетные данные вместо этого.
</Expandable>