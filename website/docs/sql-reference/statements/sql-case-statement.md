---
id: case
title: SQL CASE WHEN
description: Операторы CASE позволяют вам проходить через несколько сценариев (или случаев) в ваших данных, оценивать их на истинность и выводить соответствующее значение для каждого случая.
slug: /sql-reference/case
---

<head>
    <title>Работа с операторами SQL CASE</title>
</head>

Операторы SQL CASE являются основой для аналитических инженеров и проектов dbt. Они помогают добавить контекст к данным, делают поля более читаемыми или удобными для использования и позволяют создавать определенные группы с вашими данными.

Неформально говоря, операторы CASE являются SQL-эквивалентом оператора if-then в других языках программирования. Они позволяют вам проходить через несколько сценариев (или случаев) в ваших данных, оценивать их на истинность и выводить соответствующее значение для каждого случая.

На этой странице мы разберем, как использовать операторы SQL CASE и продемонстрируем, почему они ценны для современных команд данных.

## Как использовать операторы SQL CASE

Операторы CASE WHEN создаются в [операторах SELECT](/sql-reference/select) вместе с другими полями, которые вы выбираете для выбора. Общий синтаксис для операторов SQL CASE WHEN выглядит следующим образом:

```sql
case when [сценарий 1] then [результат 1]
     when [сценарий 2] then [результат 2]
    -- …столько сценариев, сколько вам нужно
     when [сценарий n] then [результат n]
     else [резервный результат] -- этот else является необязательным
end as <имя_нового_поля>
```

Некоторые примечания о функциональности операторов CASE:
- Сценарии в операторах CASE *оцениваются в порядке их перечисления*. Что это означает? Это означает, что если несколько сценариев оцениваются как истинные, результат возвращается для первого истинного сценария.
- Результаты в каждом сценарии должны быть одного и того же типа данных; если результат сценария 1 — строка, все остальные сценарии также должны быть [строками](/sql-reference/strings).
- Часто команды данных опускают последний сценарий `else`, так как `else [резервный результат]` является необязательным и по умолчанию равен `else null`.
- В общем, производительность операторов CASE в операторах SELECT относительно эффективна (по сравнению с другой функциональностью SQL, такой как агрегаты или громоздкие соединения с использованием AND и OR); это не значит, что эффективно (или разумно) сравнивать множество сценариев, но это, вероятно, не станет узким местом в ваших моделях данных.
- Результаты операторов CASE WHEN также могут быть переданы в агрегатные функции, такие как [MAX](/sql-reference/max), [MIN](/sql-reference/min) и [COUNT](/sql-reference/count), или даже в функции работы с датами (например, `date_trunc('month', <оператор CASE WHEN>`).

Ниже мы рассмотрим практический пример использования оператора CASE.

### Пример SQL CASE WHEN

```sql
select
    order_id,
    round(amount) as amount,
    case when amount between 0 and 10 then 'low'
         when amount between 11 and 20 then 'medium'
         else 'high'
    end as order_value_bucket
from {{ ref('orders') }}
```

Этот простой запрос, использующий таблицу `orders` из [Jaffle Shop](https://github.com/dbt-labs/jaffle_shop), вернет новое поле, которое группирует сумму заказа на основе критериев:

| **order_id** | **amount** | **order_value_bucket** |
|:---:|:---:|:---:|
| 1 | 10 | low |
| 2 | 20 | medium |
| 3 | 1 | low |
| 4 | 25 | high |
| 5 | 17 | medium |

## Синтаксис SQL CASE WHEN в Snowflake, Databricks, BigQuery и Redshift

Поскольку это основа SQL, большинство, если не все, современные хранилища данных поддерживают возможность добавления операторов CASE WHEN в свои запросы. Snowflake, Databricks, Google BigQuery и Amazon Redshift все поддерживают операторы CASE и имеют одинаковый синтаксис для них.

## Сценарии использования CASE WHEN

Сценарии использования операторов CASE в моделях dbt и ad hoc запросах практически безграничны; в результате мы не сможем создать исчерпывающий список того, где вы можете встретить операторы CASE в реальной жизни.

Вместо этого важно знать, *почему* вы хотите использовать их в своей работе с данными и когда вы не хотите их использовать. Некоторые примеры причин, по которым вы можете захотеть использовать операторы CASE:
- Создание булевых значений на основе ваших существующих данных (например, `case when cnt > 1 then true else false end as is_active`)
- Установление соответствий между сырыми данными и более общими группами данных (см. пример выше на странице); обратите внимание, что если вы создаете много сценариев CASE для соответствия, которое не меняется со временем, вам, вероятно, стоит импортировать это соответствие либо как свою модель dbt, либо как источник данных (хороший случай для [seeds](https://docs.getdbt.com/docs/build/seeds))
- Если вы часто создаете один и тот же оператор CASE в своих моделях, подумайте о том, чтобы абстрагировать этот оператор CASE в отдельную модель или в <Term id="dry" /> [макрос](https://docs.getdbt.com/docs/build/jinja-macros)
- Генерация более удобных для бизнес-пользователей значений столбцов, которые могут быть легко поняты бизнес-пользователями