---
title: "Лучшие практики для dbt и Unity Catalog"
id: "dbt-unity-catalog-best-practices"
description: Узнайте, как настроить ваш проект.
displayText: Написание пользовательских общих тестов
hoverSnippet: Узнайте, как определить свои собственные пользовательские общие тесты.
---

Ваш проект dbt на Databricks должен быть настроен после выполнения руководства ["Как настроить ваш проект databricks dbt"](/guides/set-up-your-databricks-dbt-project). Теперь мы готовы начать создание проекта dbt с использованием Unity Catalog. Однако сначала мы должны рассмотреть, как мы хотим позволить пользователям dbt взаимодействовать с нашими различными каталогами. Мы рекомендуем следующие лучшие практики для обеспечения целостности ваших производственных данных:

## Изолируйте ваши данные Bronze (также известные как исходные)

Мы рекомендуем использовать Unity Catalog, так как он позволяет вам ссылаться на данные по всей вашей организации из любого другого каталога, устаревшего метастора Hive, внешнего метастора или выходных данных Delta Live Table. Кроме того, Databricks предлагает возможность [взаимодействовать с внешними данными](https://docs.databricks.com/external-data/index.html#interact-with-external-data-on-databricks) и поддерживает федерацию запросов к многим [решениям баз данных](https://docs.databricks.com/query-federation/index.html#what-is-query-federation-for-databricks-sql). Это означает, что ваши среды разработки и производства будут иметь доступ к вашим исходным данным, даже если они определены в другом каталоге или внешнем источнике данных.

Сырые данные в вашем слое Bronze должны быть определены как dbt [sources](https://docs.getdbt.com/docs/build/sources) и должны быть только для чтения для всех взаимодействий dbt как в разработке, так и в производстве. По умолчанию мы рекомендуем, чтобы все эти входные данные были доступны всем пользователям dbt во всех средах dbt. Это гарантирует, что преобразования во всех средах начинаются с одних и тех же входных данных, и результаты, наблюдаемые в разработке, будут воспроизведены при развертывании этого кода. Тем не менее, бывают случаи, когда требования к управлению данными вашей компании требуют использования нескольких рабочих пространств или каталогов данных в зависимости от среды.

Если у вас есть разные каталоги/схемы данных для ваших исходных данных в зависимости от вашей среды, вы можете использовать [target.name](https://docs.getdbt.com/reference/dbt-jinja-functions/target#use-targetname-to-change-your-source-database), чтобы изменить каталог/схему данных, из которой вы извлекаете данные в зависимости от среды.

Если вы используете несколько рабочих пространств Databricks для изоляции разработки от производства, вы можете использовать [переменные окружения](https://docs.getdbt.com/docs/build/environment-variables) dbt Cloud в ваших строках конфигурации подключения, чтобы ссылаться на несколько рабочих пространств из одного проекта dbt Cloud. Вы также можете сделать то же самое для вашего SQL-склада, чтобы иметь разные размеры в зависимости от ваших сред.

Для этого используйте [синтаксис переменных окружения](https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-environment-variables#special-environment-variables) dbt для имени хоста сервера вашего URL-адреса рабочего пространства Databricks и HTTP-пути для SQL-склада в ваших настройках подключения. Обратите внимание, что имя хоста сервера все еще должно выглядеть как действительное доменное имя для прохождения проверок валидации, поэтому вам нужно будет жестко закодировать суффикс домена в URL, например `{{env_var('DBT_HOSTNAME')}}.cloud.databricks.com`, и префикс пути для ваших складов, например `/sql/1.0/warehouses/{{env_var('DBT_HTTP_PATH')}}`.

<Lightbox src="/img/guides/databricks-guides/databricks-connection-env-vars.png" title="Использование синтаксиса переменных окружения в конфигурациях подключения" />

Когда вы создаете среды в dbt Cloud, вы можете назначать переменные окружения для динамического заполнения информации о подключении. Не забудьте убедиться, что токены, которые вы используете в учетных данных для этих сред, были сгенерированы из связанного рабочего пространства.

<Lightbox src="/img/guides/databricks-guides/databricks-env-variables.png" title="Определение значений переменных окружения по умолчанию" />

## Контроль доступа

Для предоставления доступа потребителям данных используйте [настройки прав доступа](https://docs.getdbt.com/reference/resource-configs/grants) dbt, чтобы применить разрешения к объектам базы данных, созданным моделями dbt. Это позволяет вам настраивать права доступа в виде структурированного словаря, а не писать весь SQL самостоятельно, и позволяет dbt выбрать наиболее эффективный путь для применения этих прав.

Что касается разрешений на выполнение dbt и чтение источников данных, не предназначенных для потребителей, таблица ниже обобщает модель доступа. Эффективно, все разработчики должны получать не более чем доступ на чтение к производственному каталогу и доступ на запись в каталоге разработки. При использовании dbt создание схемы осуществляется автоматически; в отличие от традиционных рабочих процессов хранения данных, вам не нужно вручную создавать какие-либо активы Unity Catalog, кроме верхнеуровневых каталогов.

**Служебный принципал prod** должен иметь доступ "чтение" к сырым исходным данным и доступ "запись" к производственному каталогу. Если вы добавите каталог **test** и связанную среду dbt, вам следует создать отдельный служебный принципал. Служебный принципал тестирования должен иметь *чтение* на сырые исходные данные и *запись* на каталог **test**, но не иметь разрешений на производственные или разработческие каталоги. Для [CI-тестирования](https://www.getdbt.com/blog/adopting-ci-cd-with-dbt-cloud/) следует использовать отдельную тестовую среду.

**Права доступа на уровне таблицы:**

|  | Исходные данные | Каталог разработки | Производственный каталог | Тестовый каталог |
| --- | --- | --- | --- | --- |
| разработчики | select | select & modify | select or none | none |
| служебный принципал производства | select | none | select & modify | none |
| служебный принципал тестирования | select | none | none | select & modify |

**Права доступа на уровне схемы:**

|  | Исходные данные | Каталог разработки | Производственный каталог | Тестовый каталог |
| --- | --- | --- | --- | --- |
| разработчики | use | use, create schema, table, & view | use or none | none |
| служебный принципал производства | use | none | use, create schema, table & view | none |
| служебный принципал тестирования | use | none | none | use, create schema, table & view |

## Следующие шаги

Готовы начать преобразование ваших наборов данных Unity Catalog с помощью dbt?

Посмотрите ресурсы ниже для руководств, советов и лучших практик:

- [Как мы структурируем наши проекты dbt](/best-practices/how-we-structure/1-guide-overview)
- [Курс по основам dbt в формате самообучения](https://learn.getdbt.com/courses/dbt-fundamentals)
- [Настройка CI/CD](/guides/custom-cicd-pipelines)
- [Отладка ошибок](/guides/debug-errors)
- [Написание пользовательских общих тестов](/best-practices/writing-custom-generic-tests)
- [Центр пакетов dbt](https://hub.getdbt.com/)