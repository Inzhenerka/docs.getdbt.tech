---
title: ÐšÐ°Ðº Ð¼Ñ‹ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑÐµÐ¼ Ð½Ð°Ñˆ SQL
id: 2-how-we-style-our-sql
---

## ÐžÑÐ½Ð¾Ð²Ñ‹

- â˜ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ [SQLFluff](https://sqlfluff.com/) Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ ÑÑ‚Ð¸Ñ… Ð¿Ñ€Ð°Ð²Ð¸Ð» ÑÑ‚Ð¸Ð»Ñ.
  - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ `.sqlfluff` Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸.
  - ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð½Ð°ÑˆÐµÐ¼Ñƒ [Ñ„Ð°Ð¹Ð»Ñƒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ SQLFluff](https://github.com/dbt-labs/jaffle-shop-template/blob/main/.sqlfluff) Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð», ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð² Ð½Ð°ÑˆÐ¸Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°Ñ….
  - Ð˜ÑÐºÐ»ÑŽÑ‡Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» `.sqlfluffignore`. Ð£Ð·Ð½Ð°Ð¹Ñ‚Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¾ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐµ Ð² [Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÑƒ .sqlfluffignore](https://docs.sqlfluff.com/en/stable/configuration/index.html).
    - Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ñ… Ð¿Ð°Ð¿Ð¾Ðº Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ñ‚Ð°ÐºÐ¸Ñ… ÐºÐ°Ðº `target/`, `dbt_packages/` Ð¸ `macros/`) Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ, ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð½ÐµÑ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð².
- ðŸ‘» Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Jinja (`{# #}`) Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ², ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹ Ð² ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ SQL.
- â­ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÑŽÑ‰Ð¸Ðµ Ð·Ð°Ð¿ÑÑ‚Ñ‹Ðµ.
- 4ï¸âƒ£ ÐžÑ‚ÑÑ‚ÑƒÐ¿Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð°.
- ðŸ“ Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ SQL Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 80 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².
- â¬‡ï¸ Ð˜Ð¼ÐµÐ½Ð° Ð¿Ð¾Ð»ÐµÐ¹, ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð¸ Ð¸Ð¼ÐµÐ½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð½Ð¸Ð¶Ð½ÐµÐ¼ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ðµ.
- ðŸ«§ ÐšÐ»ÑŽÑ‡ÐµÐ²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ `as` Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ ÑÐ²Ð½Ð¾ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿ÑÐµÐ²Ð´Ð¾Ð½Ð¸Ð¼Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»Ñ Ð¸Ð»Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹.

:::info
â˜ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ dbt Cloud Ð¼Ð¾Ð³ÑƒÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½ÑƒÑŽ [Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÑŽ SQLFluff Cloud IDE](https://docs.getdbt.com/docs/cloud/dbt-cloud-ide/lint-format) Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ²Ð¾ÐµÐ³Ð¾ SQL. Ð¡Ñ‚Ð¸Ð»ÑŒ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¾ÑÐ½Ð¾Ð²Ð°Ð½ Ð½Ð° ÑÑ‚Ð¸Ð»Ðµ dbt Labs, Ð¾Ð¿Ð¸ÑÐ°Ð½Ð½Ð¾Ð¼ Ð² ÑÑ‚Ð¾Ð¼ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ðµ, Ð½Ð¾ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð¿Ð¾Ð´ ÑÐ²Ð¾Ð¸ Ð½ÑƒÐ¶Ð´Ñ‹. ÐÐµÑ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒ ÐºÐ°ÐºÐ¸Ðµ-Ð»Ð¸Ð±Ð¾ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ `Lint`! Ð¢Ð°ÐºÐ¶Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð±Ð¾Ð»ÐµÐµ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€ [sqlfmt](http://sqlfmt.com/), ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÑ‚Ð¸Ð»ÑŒ.
:::

## ÐŸÐ¾Ð»Ñ, Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°

- ðŸ”™ ÐŸÐ¾Ð»Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð°Ð¼Ð¸ Ð¸ Ð¾ÐºÐ¾Ð½Ð½Ñ‹Ð¼Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸.
- ðŸ¤ðŸ» ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒÑÑ ÐºÐ°Ðº Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°Ð½ÑŒÑˆÐµ (Ð½Ð° ÑÐ°Ð¼Ð¾Ð¼ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¾Ð¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾Ð¼ Ð½Ð°Ð±Ð¾Ñ€Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…) Ð¿ÐµÑ€ÐµÐ´ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸ÐµÐ¼ Ñ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÐµÐ¹ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸.
- ðŸ”¢ ÐŸÑ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ¿Ð¾Ñ€ÑÐ´Ð¾Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, group by 1, 2) Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ñ Ð¸Ð¼ÐµÐ½ ÑÑ‚Ð¾Ð»Ð±Ñ†Ð¾Ð² (ÑÐ¼. [ÑÑ‚Ð¾Ñ‚ ÐºÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚](https://www.getdbt.com/blog/write-better-sql-a-defense-of-group-by-1) Ð¾ Ñ‚Ð¾Ð¼, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ). ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÑ‚Ðµ Ð¿Ð¾ Ð±Ð¾Ð»ÐµÐµ Ñ‡ÐµÐ¼ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼ ÑÑ‚Ð¾Ð»Ð±Ñ†Ð°Ð¼, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, ÑÑ‚Ð¾Ð¸Ñ‚ Ð¿ÐµÑ€ÐµÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð´Ð¸Ð·Ð°Ð¹Ð½ Ð²Ð°ÑˆÐµÐ¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸.

## ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ

- ðŸ‘­ðŸ» ÐŸÑ€ÐµÐ´Ð¿Ð¾Ñ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ `union all` Ð²Ð¼ÐµÑÑ‚Ð¾ `union`, ÐµÑÐ»Ð¸ Ð²Ñ‹ ÑÐ²Ð½Ð¾ Ð½Ðµ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹.
- ðŸ‘­ðŸ» Ð•ÑÐ»Ð¸ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚Ðµ Ð´Ð²Ðµ Ð¸Ð»Ð¸ Ð±Ð¾Ð»ÐµÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†, _Ð²ÑÐµÐ³Ð´Ð°_ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ Ðº Ð¸Ð¼ÐµÐ½Ð°Ð¼ ÑÑ‚Ð¾Ð»Ð±Ñ†Ð¾Ð² Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹. Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð· Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹, Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÑ‹ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ñ‹.
- ðŸ‘­ðŸ» Ð‘ÑƒÐ´ÑŒÑ‚Ðµ ÑÐ²Ð½Ñ‹Ð¼Ð¸ Ð² Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ð¸ Ñ‚Ð¸Ð¿Ð° Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ (Ñ‚.Ðµ. Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ `inner join` Ð²Ð¼ÐµÑÑ‚Ð¾ `join`).
- ðŸ¥¸ Ð˜Ð·Ð±ÐµÐ³Ð°Ð¹Ñ‚Ðµ Ð¿ÑÐµÐ²Ð´Ð¾Ð½Ð¸Ð¼Ð¾Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð² ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ… Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¼Ð¾Ð²) â€” ÑÐ»Ð¾Ð¶Ð½ÐµÐµ Ð¿Ð¾Ð½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° "c" Ð¿Ð¾ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÑŽ Ñ "customers".
- âž¡ï¸ Ð’ÑÐµÐ³Ð´Ð° Ð´Ð²Ð¸Ð³Ð°Ð¹Ñ‚ÐµÑÑŒ ÑÐ»ÐµÐ²Ð° Ð½Ð°Ð¿Ñ€Ð°Ð²Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ð±Ñ‹Ð»Ð¾ Ð»ÐµÐ³ÐºÐ¾ Ð¿Ð¾Ð½ÑÑ‚ÑŒ - `right joins` Ñ‡Ð°ÑÑ‚Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ð°Ð¼ ÑÐ»ÐµÐ´ÑƒÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ, Ð¸Ð· ÐºÐ°ÐºÐ¾Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð²Ñ‹ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚Ðµ `from` Ð¸ Ðº ÐºÐ°ÐºÐ¾Ð¹ `join`.

## 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚' CTE

- ðŸ” Ð’ÑÐµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ `{{ ref('...') }}` Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ñ‹ Ð² CTE Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ñ„Ð°Ð¹Ð»Ð°.
- ðŸ“¦ 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚' CTE Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð°Ð·Ð²Ð°Ð½Ñ‹ Ð² Ñ‡ÐµÑÑ‚ÑŒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¾Ð½Ð¸ ÑÑÑ‹Ð»Ð°ÑŽÑ‚ÑÑ.
- ðŸ¤ðŸ» ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÑŒÑ‚Ðµ Ð¾Ð±ÑŠÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ñ…, ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ñ… CTE, Ð½Ð°ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾. ÐŸÐ¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ðµ ÑÑ‚Ð¾Ð»Ð±Ñ†Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ, Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `where` Ð´Ð»Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ….
- ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€:

```sql
with

orders as (

    select
        order_id,
        customer_id,
        order_total,
        order_date

    from {{ ref('orders') }}

    where order_date >= '2020-01-01'

)
```

## 'Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ' CTE

- â˜ðŸ» Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚, CTE Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒ Ð¾Ð´Ð½Ñƒ Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.
- ðŸ“– Ð˜Ð¼ÐµÐ½Ð° CTE Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼Ð¸, Ð½Ð°ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ð¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¾Ð½Ð¸ Ð´ÐµÐ»Ð°ÑŽÑ‚, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `events_joined_to_users` Ð²Ð¼ÐµÑÑ‚Ð¾ `user_events` (ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ð½Ð¾ Ð½Ðµ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¸Ð»Ð¸ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ).
- ðŸŒ‰ CTE, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÑÑ…, Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑŽÑ‰Ð¸ÐµÑÑ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ñ‹ Ð»Ð¾Ð³Ð¸ÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐ»ÐµÐ´ÑƒÐµÑ‚ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ.
- ðŸ”š ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ `select *` Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ CTE. Ð­Ñ‚Ð¾ ÑƒÐ¿Ñ€Ð¾Ñ‰Ð°ÐµÑ‚ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð¸ Ð°ÑƒÐ´Ð¸Ñ‚ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÑ‚Ð°Ð¿Ð¾Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ ÐµÐµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ CTE, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÑÑ‹Ð»Ð°ÐµÑ‚ÑÑ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ `select`, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð°.

## ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸

- ðŸ“ ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹, ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐºÐ»ÑŽÑ‡Ð¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸/Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ), Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸.
- ðŸ“‚ Ð•ÑÐ»Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ ÐºÐ¾ Ð²ÑÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑÐ¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸, Ð¾Ð½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ð° Ð² Ñ„Ð°Ð¹Ð»Ðµ `dbt_project.yml`.
- ðŸ‘“ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼ Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸:

```sql
{{
    config(
      materialized = 'table',
      sort = 'id',
      dist = 'id'
    )
}}
```

## ÐŸÑ€Ð¸Ð¼ÐµÑ€ SQL

```sql
with

events as (

    ...

),

{# CTE ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð·Ð´ÐµÑÑŒ #}
filtered_events as (

    ...

)

select * from filtered_events
```

### ÐŸÑ€Ð¸Ð¼ÐµÑ€ SQL

```sql
with

my_data as (

    select
        field_1,
        field_2,
        field_3,
        cancellation_date,
        expiration_date,
        start_date

    from {{ ref('my_data') }}

),

some_cte as (

    select
        id,
        field_4,
        field_5

    from {{ ref('some_cte') }}

),

some_cte_agg as (

    select
        id,
        sum(field_4) as total_field_4,
        max(field_5) as max_field_5

    from some_cte

    group by 1

),

joined as (

    select
        my_data.field_1,
        my_data.field_2,
        my_data.field_3,

        -- Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€Ð°Ð·Ñ€Ñ‹Ð²Ñ‹ ÑÑ‚Ñ€Ð¾Ðº Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ñ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹ Ð½Ð° Ð±Ð»Ð¾ÐºÐ¸
        case
            when my_data.cancellation_date is null
                and my_data.expiration_date is not null
                then expiration_date
            when my_data.cancellation_date is null
                then my_data.start_date + 7
            else my_data.cancellation_date
        end as cancellation_date,

        some_cte_agg.total_field_4,
        some_cte_agg.max_field_5

    from my_data

    left join some_cte_agg
        on my_data.id = some_cte_agg.id

    where my_data.field_1 = 'abc' and
        (
            my_data.field_2 = 'def' or
            my_data.field_2 = 'ghi'
        )

    having count(*) > 1

)

select * from joined
```