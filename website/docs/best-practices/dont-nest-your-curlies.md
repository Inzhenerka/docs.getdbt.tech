---
title: "Не вкладывайте фигурные скобки"
id: "dont-nest-your-curlies"
---

### Поэзия

**Не вкладывайте фигурные скобки**

> Если dbt выдает ошибку на раннем этапе
>
> и ваш Jinja заставляет вас сердиться
>
> не пишите в Slack
>
> просто сделайте шаг назад
>
> и проверьте, не вкладываете ли вы фигурные скобки.

### Jinja

При написании кода jinja в проекте dbt может возникнуть соблазн вложить выражения друг в друга. Рассмотрим этот пример:

```
  {{ dbt_utils.date_spine(
      datepart="day",
      start_date=[ ИСПОЛЬЗУЙТЕ JINJA ЗДЕСЬ ]
      )
  }}
```

Чтобы вложить выражение jinja в другое выражение jinja, просто поместите нужный код (без фигурных скобок) непосредственно в выражение.

**Правильный пример**
Здесь возвращаемое значение метода контекста `var()` передается в качестве аргумента `start_date` для макроса `date_spine`. Отлично!

```
  {{ dbt_utils.date_spine(
      datepart="day",
      start_date=var('start_date')
      )
  }}
```

**Неправильный пример**
*Этот код не работает в dbt &gt;= v0.15.0*. Как только мы обозначили, что находимся внутри выражения jinja (используя синтаксис `{{`), больше никаких фигурных скобок не требуется внутри выражения jinja. Этот код передаст буквальное строковое значение, `"{{ var('start_date') }}"`, в качестве аргумента `start_date` для макроса `date_spine`. Это, вероятно, не то, что вы на самом деле хотите сделать!

```
-- Не делайте этого! Это не сработает!

  {{ dbt_utils.date_spine(
      datepart="day",
      start_date="{{ var('start_date') }}"
      )
  }}
```

Вот еще один пример:

```sql
{# Любой из этих вариантов работает #}

{% set query_sql = 'select * from ' ~ ref('my_model') %}

{% set query_sql %}
select * from {{ ref('my_model') }}
{% endset %}

{# Это не работает #}
{% set query_sql = "select * from {{ ref('my_model')}}" %}

```

### Исключение

Существует одно исключение из этого правила: фигурные скобки внутри фигурных скобок допустимы в хуках (например, `on-run-start`, `on-run-end`, `pre-hook` и `post-hook`).

Код, подобный этому, является как допустимым, так и рекомендуемым:
```
{{ config(post_hook="grant select on {{ this }} to role bi_role") }}
```

Почему же фигурные скобки внутри фигурных скобок допустимы в этом случае? Здесь мы на самом деле _хотим_, чтобы строка `"grant select on {{ this }} ..."` была сохранена как значение конфигурации для пост-хука в этой модели. Эта строка будет повторно отрендерена, когда модель будет выполняться, в результате чего будет выполнено разумное SQL-выражение, такое как `grant select on "schema"."table"....` против базы данных. Эти хуки являются специальным исключением из вышеуказанного правила.