---
title: "Ограничения и особенности сравнения состояния"
description: "Узнайте об ограничениях и особенностях сравнения состояния в dbt."
pagination_prev: "reference/node-selection/configure-state"
---

import StateModified from '/snippets/_state-modified-compare.md';

Метод выбора [`state:`](/reference/node-selection/methods#state) — это мощная функция с множеством сложностей. Ниже приведены некоторые соображения при настройке автоматизированных задач, использующих сравнение состояний.

### Сиды

dbt сохраняет хэш-файл seed-файлов размером менее 1 МиБ. Если содержимое этих seed-файлов изменено, seed будет включен в `state:modified`.

Если seed-файл больше 1 МиБ, dbt не может сравнить его содержимое и выдаст предупреждение. Вместо этого dbt будет использовать только путь к файлу seed для обнаружения изменений. Если путь к файлу изменился, seed будет включен в `state:modified`; если нет, то не будет.

### Макросы

dbt пометит как измененные все ресурсы, которые зависят от измененного макроса или от макроса, который зависит от измененного макроса.

### Переменные

Если модель использует `var` или `env_var` в своём определении, dbt не может определить такую зависимость (lineage) таким образом, чтобы включить модель в `state:modified` из‑за изменения значения `var` или `env_var`. При этом модель, скорее всего, будет помечена как изменённая, если изменение значения переменной приводит к другой конфигурации.

### Тесты

Команда `dbt test -s state:modified` будет включать как:
- тесты, которые выбирают из нового/измененного ресурса
- тесты, которые сами по себе новые или измененные

Пока вы добавляете или изменяете тесты одновременно с добавлением или изменением ресурсов (моделей, seed-файлов, снимков), из которых они выбирают, все должно работать так, как вы ожидаете, с "простым" выбором состояния:

```shell
dbt run -s "state:modified"
dbt test -s "state:modified"
```

Однако это может усложниться. Если вы добавите новый тест без изменения его базовой модели или добавите тест, который выбирает из новой модели и старой неизмененной, вам может понадобиться протестировать модель, не запустив ее сначала.

Вы можете отложить ссылки на вышестоящие элементы при тестировании. Например, если тест выбирает из модели, которая не существует как объект базы данных в вашей текущей среде, dbt обратится к другой среде — той, которая определена в вашем манифесте состояния. Это позволяет использовать "простой" выбор состояния без риска сбоя запроса, но может иметь неожиданные последствия для тестов с несколькими родителями. Например, если у вас есть тест `relationships`, который зависит от одной измененной модели и одной неизмененной, запрос теста будет выбирать данные "между" двумя разными средами. Если вы ограничиваете или выбираете данные в разработке и CI, может не иметь смысла проверять целостность ссылок, зная, что есть большая вероятность несоответствия.

Если вы часто используете тесты `relationships` или тесты данных, или часто добавляете тесты без изменения их базовых моделей, рассмотрите возможность настройки критериев выбора для вашей CI-задачи. Например:

```shell
dbt run -s "state:modified"
dbt test -s "state:modified" --exclude "test_name:relationships"
```
### Перезаписывает `manifest.json`

import Overwritesthemanifest from '/snippets/_overwrites-the-manifest.md';

<Overwritesthemanifest />

#### Рекомендация

import Recommendationoverwritesthemanifest from '/snippets/_recommendation-overwriting-manifest.md'; 

<Recommendationoverwritesthemanifest />

### Ложные срабатывания

<VersionBlock firstVersion="1.9">

Чтобы уменьшить количество ложных срабатываний при выборе `state:modified` из-за логики, зависящей от окружения, вы можете установить флаг поведения `state_modified_compare_more_unrendered_values` в значение `True`.

<StateModified features={'/snippets/_state-modified-compare.md'}/>

</VersionBlock>

### Заключительное примечание

Сравнение состояний — сложная задача. Мы стремимся со временем обеспечить согласованность между всеми вариантами конфигурации, а также предоставить пользователям необходимый контроль, чтобы они могли надёжно возвращать все изменённые ресурсы — и только те, которые они ожидают. Если вам интересно узнать больше, ознакомьтесь с [открытыми задачами с меткой "state"](https://github.com/dbt-labs/dbt-core/issues?q=is%3Aopen+is%3Aissue+label%3Astate) в репозитории dbt.

## Связанные материалы
- [О состоянии в dbt](/reference/node-selection/state-selection)
- [Настройка выбора по состоянию](/reference/node-selection/configure-state)
