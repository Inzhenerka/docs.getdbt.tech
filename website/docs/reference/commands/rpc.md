---
title: "О команде dbt rpc"
sidebar_label: "rpc"
id: "rpc"
description: "Удаленный вызов процедур (rpc) сервер dbt компилирует и выполняет запросы, а также предоставляет методы, которые позволяют вам перечислять и завершать выполняющиеся процессы."
---

:::caution Плагин dbt-rpc устарел

dbt Labs активно поддерживал `dbt-rpc` для совместимости с версиями dbt-core до v1.5. Начиная с версии dbt-core v1.6 (выпущенной в июле 2023 года), `dbt-rpc` больше не поддерживается для дальнейшей совместимости.

В то же время dbt Labs будет выполнять критическое обслуживание только для `dbt-rpc`, пока последняя совместимая версия dbt-core не достигнет [конца официальной поддержки](/docs/dbt-versions/core#latest-releases). В этот момент dbt Labs архивирует этот репозиторий, чтобы он стал доступен только для чтения.

:::

### Обзор

Вы можете использовать плагин `dbt-rpc` для запуска удаленного вызова процедур (rpc) сервера dbt. Этот сервер компилирует и выполняет запросы в контексте проекта dbt. Кроме того, RPC сервер предоставляет методы, которые позволяют вам перечислять и завершать выполняющиеся процессы. Мы рекомендуем запускать rpc сервер из директории, содержащей проект dbt. Сервер загрузит проект в память, а затем будет принимать запросы для работы с контекстом dbt этого проекта.

:::caution Запуск на Windows
Мы не рекомендуем запускать rpc сервер на Windows из-за проблем с надежностью. Контейнер Docker может стать полезным обходным решением, если это необходимо.
:::

Для получения дополнительной информации смотрите исходный код [репозитория `dbt-rpc`](https://github.com/dbt-labs/dbt-rpc).

**Запуск сервера:**

```
$ dbt-rpc serve
Запуск с dbt=0.15.0

16:34:31 | Параллелизм: 8 потоков (target='dev')
16:34:31 |
16:34:31 | Готово.
Обслуживание RPC сервера на 0.0.0.0:8580
Отправляйте запросы на http://localhost:8580/jsonrpc
```

**Настройка сервера**

* `--host`: Укажите хост для прослушивания (по умолчанию=`0.0.0.0`)
* `--port`: Укажите порт для прослушивания (по умолчанию=`8580`)

**Отправка запросов на сервер:**
RPC сервер ожидает запросы в следующем формате:

<File name='rpc-spec.json'>

```json
{
    "jsonrpc": "2.0",
    "method": "{ допустимая команда rpc сервера }",
    "id": "{ уникальный идентификатор для этого запроса }",
    "params": {
        "timeout": { таймаут для запроса в секундах, необязательный },
    }
}
```

</File>

## Встроенные методы

### status

Метод `status` вернет статус rpc сервера. Ответ этого метода включает общий статус, такой как `ready`, `compiling` или `error`, а также набор логов, накопленных во время начальной компиляции проекта. Когда rpc сервер находится в состоянии `compiling` или `error`, будут приниматься только встроенные методы RPC сервера.

**Пример запроса**

```json
{
    "jsonrpc": "2.0",
    "method": "status",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d"
}
```

**Пример ответа**

```json
{
    "result": {
        "status": "ready",
        "error": null,
        "logs": [..],
        "timestamp": "2019-10-07T16:30:09.875534Z",
        "pid": 76715
    },
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "jsonrpc": "2.0"
}
```

### poll

Эндпоинт `poll` вернет статус, логи и результаты (если доступны) для выполняемой или завершенной задачи. Метод `poll` требует параметр `request_token`, который указывает задачу, для которой нужно получить ответ. `request_token` возвращается в ответах задач dbt, таких как `compile`, `run` и `test`.

**Параметры**:

- `request_token`: Токен для получения ответов
- `logs`: Булевый флаг, указывающий, должны ли логи быть возвращены в ответе (по умолчанию=false)
- `logs_start`: Нулевой индекс строки лога, с которой нужно получить логи (по умолчанию=0)

**Пример запроса**

```json
{
    "jsonrpc": "2.0",
    "method": "poll",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "params": {
        "request_token": "f86926fa-6535-4891-8d24-2cfc65d2a347",
        "logs": true,
        "logs_start": 0
    }
}
```

**Пример ответа**

```json
{
    "result": {
        "results": [],
        "generated_at": "2019-10-11T18:25:22.477203Z",
        "elapsed_time": 0.8381369113922119,
        "logs": [],
        "tags": {
            "command": "run --select my_model",
            "branch": "abc123"
        },
        "status": "success"
    },
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "jsonrpc": "2.0"
}
```

### ps

Метод `ps` перечисляет выполняющиеся и завершенные процессы, выполненные RPC сервером.

**Параметры**

- `completed`: Если true, также вернуть завершенные задачи (по умолчанию=false)

**Пример запроса:**
```json
{
    "jsonrpc": "2.0",
    "method": "ps",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "params": {
        "completed": true
    }
}
```

**Пример ответа:**
```json
{
    "result": {
        "rows": [
            {
                "task_id": "561d4a02-18a9-40d1-9f01-cd875c3ec56d",
                "request_id": "3db9a2fe-9a39-41ef-828c-25e04dd6b07d",
                "request_source": "127.0.0.1",
                "method": "run",
                "state": "success",
                "start": "2019-10-07T17:09:49.865976Z",
                "end": null,
                "elapsed": 1.107261,
                "timeout": null,
                "tags": {
                    "command": "run --select my_model",
                    "branch": "feature/add-models"
                }
            }
        ]
    },
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "jsonrpc": "2.0"
}
```

### kill

Метод `kill` завершит выполняющуюся задачу. Вы можете найти `task_id` для выполняющейся задачи либо в оригинальном ответе, который вызвал эту задачу, либо в результатах метода `ps`.

**Пример запроса**
```json
{
    "jsonrpc": "2.0",
    "method": "kill",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "params": {
        "task_id": "{ id задачи для завершения }"
    }
}
```

## Запуск проектов dbt

Следующие методы позволяют запускать проекты dbt через RPC сервер.

### Общие параметры

Все RPC запросы принимают следующие параметры в дополнение к перечисленным параметрам:
- `timeout`: Максимальное время ожидания перед отменой запроса.
- `task_tags`: Произвольные пары ключ/значение, которые будут прикреплены к этой задаче. Эти теги будут возвращены в выводе методов `poll` и `ps` (необязательный).

### Запуск задачи с синтаксисом CLI

**Параметры:**
 - `cli`: Команда dbt (например, `run --select abc+ --exclude +def`), которую нужно выполнить (обязательно)

```json
{
    "jsonrpc": "2.0",
    "method": "cli_args",
    "id": "<идентификатор запроса>",
    "params": {
        "cli": "run --select abc+ --exclude +def",
        "task_tags": {
            "branch": "feature/my-branch",
            "commit": "c0ff33b01"
        }
    }
}
```

Несколько следующих типов запросов принимают эти дополнительные параметры:
- `threads`: Количество [потоков](/docs/core/connect-data-platform/connection-profiles#understanding-threads), которые будут использоваться при компиляции (необязательный)
- `select`: Набор ресурсов, которые нужно выполнить, разделенный пробелами (необязательный). (`models` также поддерживается для некоторых типов запросов для обратной совместимости.)
- `selector`: Имя предопределенного [YAML селектора](/reference/node-selection/yaml-selectors), который определяет набор ресурсов для выполнения (необязательный)
- `exclude`: Набор ресурсов, которые нужно исключить из компиляции, выполнения, тестирования, посева или создания снимков, разделенный пробелами (необязательный)
- `state`: Путь к артефактам, которые будут использоваться при установлении [состояния](/reference/node-selection/syntax#about-node-selection) (необязательный)

### Компиляция проекта ([docs](/reference/commands/compile))

```json
{
	"jsonrpc": "2.0",
	"method": "compile",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "state": "<str> (необязательный)"
        }
}
```

### Запуск моделей ([docs](/reference/commands/run))

**Дополнительные параметры:**
- `defer`: Указывает, следует ли отложить ссылки на вышестоящие, невыбранные ресурсы (необязательный, требует `state`)

```json
{
	"jsonrpc": "2.0",
	"method": "run",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "state": "<str> (необязательный)",
            "defer": "<bool> (необязательный)"
        }
}
```

### Запуск тестов ([docs](/reference/commands/test))

**Дополнительные параметры:**
 - `data`: Если True, выполняются тесты данных (необязательный, по умолчанию=true)
 - `schema`: Если True, выполняются тесты схемы (необязательный, по умолчанию=true)

```json
{
	"jsonrpc": "2.0",
	"method": "test",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "state": "<str> (необязательный)",
            "data": "<bool> (необязательный)",
            "schema": "<bool> (необязательный)"
        }
}
```

### Запуск посевов ([docs](/reference/commands/seed))

**Параметры:**
 - `show`: Если True, показать образец посеянных данных в ответе (необязательный, по умолчанию=false)

```json
{
	"jsonrpc": "2.0",
	"method": "seed",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "show": "<bool> (необязательный)",
            "state": "<str> (необязательный)"
        }
}
```

### Запуск снимков ([docs](/docs/build/snapshots))

```json
{
	"jsonrpc": "2.0",
	"method": "snapshot",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "state": "<str> (необязательный)"
        }
}
```

### Построение ([docs](/reference/commands/build))

```json
{
	"jsonrpc": "2.0",
	"method": "build",
	"id": "<идентификатор запроса>",
	"params": {
            "threads": "<int> (необязательный)",
            "select": "<str> (необязательный)",
            "exclude": "<str> (необязательный)",
            "selector": "<str> (необязательный)",
            "state": "<str> (необязательный)",
            "defer": "<str> (необязательный)"
        }
}
```

### Перечисление ресурсов проекта ([docs](cmd-docs#dbt-docs-generate))

**Дополнительные параметры:**
 - `resource_types`: Фильтровать выбранные ресурсы по типу
 - `output_keys`: Указать, какие свойства узлов включить в вывод

 ```json
 {
 	"jsonrpc": "2.0",
 	"method": "ls",
 	"id": "<идентификатор запроса>",
 	"params": {
         "select": "<str> (необязательный)",
         "exclude": "<str> (необязательный)",
         "selector": "<str> (необязательный)",
         "resource_types": ["<list> (необязательный)"],
         "output_keys": ["<list> (необязательный)"],
     }
 }
 ```

### Генерация документации ([docs](cmd-docs#dbt-docs-generate))

**Дополнительные параметры:**
 - `compile`: Если True, скомпилировать проект перед генерацией каталога (необязательный, по умолчанию=false)

```json
{
	"jsonrpc": "2.0",
	"method": "docs.generate",
	"id": "<идентификатор запроса>",
	"params": {
            "compile": "<bool> (необязательный)",
            "state": "<str> (необязательный)"
        }
}
```

## Компиляция и выполнение SQL-запросов

### Компиляция запроса

Этот запрос компилирует sql `select {{ 1 + 1 }} as id` (в кодировке base64) на rpc сервере:

<File name='rpc-spec.json'>

```json
{
    "jsonrpc": "2.0",
    "method": "compile_sql",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "params": {
        "timeout": 60,
        "sql": "c2VsZWN0IHt7IDEgKyAxIH19IGFzIGlk",
        "name": "my_first_query"
    }
}
```

</File>

В результате ответа будет включен ключ с названием `compiled_sql` и значением `'select 2'`.

### Выполнение запроса

Этот запрос выполняет sql `select {{ 1 + 1 }} as id` (в кодировке base64) на rpc сервере:

<File name='rpc-run.json'>

```json
{
    "jsonrpc": "2.0",
    "method": "run_sql",
    "id": "2db9a2fe-9a39-41ef-828c-25e04dd6b07d",
    "params": {
        "timeout": 60,
        "sql": "c2VsZWN0IHt7IDEgKyAxIH19IGFzIGlk",
        "name": "my_first_query"
    }
}
```

</File>

В результате ответа будет включен ключ с названием `table` и значением `{'column_names': ['?column?'], 'rows': [[2.0]]}`

## Перезагрузка RPC сервера

Когда сервер dbt RPC запускается, он загружает проект dbt в память, используя файлы, присутствующие на диске при запуске. Если файлы в проекте dbt должны измениться (либо во время разработки, либо в процессе развертывания), сервер dbt RPC может быть обновлен в реальном времени без перезапуска процесса сервера. Чтобы перезагрузить файлы, присутствующие на диске, отправьте сигнал "hangup" выполняющемуся процессу сервера, используя идентификатор процесса (pid) выполняющегося процесса.

### Поиск PID сервера

Чтобы найти PID сервера, либо получите значение `.result.pid` из ответа метода `status` на сервере, либо используйте `ps`:

```
# Найдите PID сервера, используя `ps`:
ps aux | grep 'dbt-rpc serve' | grep -v grep
```

После нахождения PID процесса (например, 12345) отправьте сигнал выполняющемуся серверу с помощью команды `kill`:

```
kill -HUP 12345
```

Когда сервер получает сигнал HUP (hangup), он повторно проанализирует файлы на диске и будет использовать обновленный код проекта при обработке последующих запросов.