---
title: "Обновление до Fusion, часть 1: подготовка к обновлению"
id: "prepare-fusion-upgrade"
level: 'Intermediate'
icon: 'zap'
hide_table_of_contents: true
tags: ['dbt Fusion engine', 'dbt platform', 'Upgrade']
recently_updated: true
intro_text: Это руководство поможет вам подготовиться к обновлению «на месте» с dbt Core на движок dbt Fusion в платформе dbt.
---

<div style={{maxWidth: '900px'}}>

import FusionAdapters from '/snippets/_fusion-dwh.md';

## Введение

import FusionPreview from '/snippets/_fusion-private-preview.md';

<FusionPreview />

<Constant name="fusion_engine" /> представляет собой следующий этап эволюции трансформации данных. dbt был переработан с нуля, но в своей основе <Constant name="fusion" /> — это новая версия, и, как и для любой новой версии, перед обновлением необходимо подготовиться. Это руководство проведёт вас через все этапы такой подготовки.

Если <Constant name="fusion" /> для вас — совершенно новый продукт, рекомендуем сначала ознакомиться с нашей [подробной документацией](/docs/fusion), где описано, что это такое, как он работает и чем отличается от <Constant name="core" />. После этого можно переходить к подготовке ваших проектов к скорости и возможностям, которые предлагает <Constant name="fusion" />.

## Предварительные требования

Это руководство посвящено подготовке к обновлению до <Constant name="fusion_engine" /> и предназначено для клиентов, которые уже используют <Constant name="dbt_platform" /> с одной из версий <Constant name="core" />. Если вы только начинаете работать с dbt, ознакомьтесь с нашими [quickstart guides](/guides).

Чтобы следовать шагам из этого руководства, необходимо выполнить следующие условия:

- Вы используете аккаунт <Constant name="dbt_platform" /> на любом тарифе.
- У вас есть лицензия разработчика.
- У вас есть [необходимые права доступа](/docs/cloud/manage-access/enterprise-permissions) для редактирования проектов.
- В вашем проекте используется адаптер, поддерживаемый <Constant name="fusion" />:
    <FusionAdapters/>

:::tip Обновление вашего первого проекта

Начинайте с небольших, новых или хорошо знакомых проектов. Так проще выявить и устранить возможные проблемы перед обновлением крупных и более сложных проектов.

:::

## Обновитесь до последней версии dbt Core

Перед обновлением до <Constant name="fusion" /> необходимо перевести все окружения на трек релизов `Latest` для [<Constant name="core" />](/docs/dbt-versions/cloud-release-tracks). Трек `Latest` включает все функции и инструменты, необходимые для подготовки к <Constant name="fusion" />. Он обеспечивает максимально плавный процесс обновления, проверяя, что ваш проект не зависит от устаревшего поведения.

:::tip Тестируйте перед развертыванием

Всегда тестируйте обновления версий сначала в разработке. Используйте функцию [Override dbt version](#step-1-test-in-development-using-override), чтобы безопасно попробовать трек `Latest`, не затрагивая команду или production-запуски.

:::

### Шаг 1: Протестируйте в development (используя override)

Протестируйте трек `Latest` для своей учётной записи, не меняя окружение для всей команды:

1. Нажмите на имя своей учётной записи в левом сайдбаре и выберите **Account settings**.
2. В сайдбаре выберите **Credentials** и укажите ваш проект.
3. В боковой панели нажмите **Edit** и прокрутите до **User development settings**.
4. В выпадающем списке **dbt version** выберите **Latest** и нажмите **Save**.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/choosing-dbt-version/example-override-version.png" width="60%" title="Переопределите версию dbt в настройках учётной записи"/>

5. Запустите <Constant name="cloud_ide" /> или <Constant name="cloud_cli" /> и протестируйте ваши обычные рабочие процессы.
6. Убедитесь, что override активен, выполнив любую команду dbt и проверив **System Logs**. В первой строке должно быть указано `Running with dbt=` и выбранная версия. Если номер версии `v1.11` или выше, вы на верном пути к готовности к <Constant name="fusion" />.

Если всё работает как ожидается, переходите к следующему шагу — обновлению окружений. Если вы видите предупреждения о депрекации, не переживайте: мы разберём их [далее в этом руководстве](/guides/prepare-fusion-upgrade?step=4). Если возникают ошибки, вернитесь к предыдущей версии и воспользуйтесь [руководствами по обновлению версий](/docs/dbt-versions/core-upgrade), чтобы устранить различия между вашей текущей версией и последней доступной версией <Constant name="core" />.

### Шаг 2: Обновите окружение разработки

После успешного тестирования индивидуального окружения разработки с override обновите окружение разработки для всего проекта (обязательно заранее предупредите команду):

1. Перейдите в **Environments** в настройках проекта.
2. Выберите окружение **Development** и нажмите **Edit**.
3. В выпадающем списке **dbt version** выберите **Latest**.
4. Нажмите **Save**, чтобы применить изменения.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/choosing-dbt-version/select-development.png" width="90%" title="Обновите окружение разработки до release track Latest для dbt Core"/>

:::info Уберите override

После обновления окружения разработки вы можете убрать персональный override, вернувшись к настройкам credentials и выбрав ту же версию, что и у окружения.

:::

### Шаг 3: Обновите staging и pre-production

Если в вашей организации есть staging или pre-production окружения, обновите их перед production:

1. Перейдите в **Environments** и выберите нужное staging/pre-production окружение.
2. Нажмите **Edit** и выберите **Latest** в списке **dbt version**.
3. Нажмите **Save**.
4. В течение нескольких дней запускайте джобы в этом окружении, чтобы убедиться, что всё работает корректно.

Это создаёт дополнительный уровень проверки перед обновлением production.

### Шаг 4: Обновите продакшен‑окружение

После валидации в staging (или в development, если staging нет) обновите production-окружение:

1. Перейдите в **Environments** и выберите **Production**.
2. Нажмите **Edit** и выберите **Latest** в списке **dbt version**.
3. Нажмите **Save**, чтобы применить изменения.
4. Внимательно отслеживайте первые production-запуски, чтобы убедиться, что всё выполняется успешно.

### Шаг 5: Обновите jobs

Хотя в большинстве случаев версию dbt определяет окружение, в некоторых старых конфигурациях джоб могут быть заданы override-версии. Проверьте свои джобы и [обновите те, где явно указана версия dbt](/docs/dbt-versions/upgrade-dbt-version-in-cloud#jobs), чтобы они использовали трек `Latest`, заданный в окружении.

## Устраните все предупреждения об устаревании

<Constant name="fusion" /> применяет строгую валидацию и не принимает устаревший код, который в <Constant name="core" /> пока лишь вызывает предупреждения. Перед обновлением до <Constant name="fusion" /> необходимо устранить все предупреждения о депрекации. К счастью, инструмент autofix в <Constant name="cloud_ide" /> может автоматически исправить большинство распространённых случаев.

:::tip Расширение VS Code

В этом руководстве описаны шаги по устранению депрекаций, не покидая <Constant name="dbt_platform" />. Если вы предпочитаете работать локально в VS Code или Cursor, вы можете запускать autofix через наше расширение dbt для VS Code. Подробнее см. в [руководстве по установке](/docs/install-dbt-extension).

:::

### Что исправляет инструмент autofix

Инструмент autofix может автоматически исправлять многие депрекации, включая:

- Перенос пользовательских конфигураций в словарь `meta`
- Исправление дублирующихся ключей YAML
- Коррекцию нераспознанных свойств ресурсов
- Обновление устаревших паттернов конфигурации

Полный список поддерживаемых депрекаций см. в [autofix readme](https://github.com/dbt-labs/dbt-autofix/).

:::note Совместимость пакетов с Fusion

Помимо депрекаций, autofix пытается обновить пакеты до минимальной версии, совместимой с <Constant name="fusion" />. Подробнее см. в разделе [package support](/docs/fusion/supported-features#package-support).

:::

### Шаг 1: Создайте новую ветку

Перед запуском autofix создайте новую ветку, чтобы изолировать изменения:

1. Перейдите в <Constant name="cloud_ide" />, нажав **Studio** в левом меню.
2. Откройте панель **Version control** (иконка git-ветки) в левом сайдбаре.
3. Нажмите **Create branch** и задайте понятное имя, например `fusion-deprecation-fixes`.
4. Нажмите **Create**, чтобы переключиться на новую ветку.

:::warning Save before autofixing

Инструмент autofix изменяет файлы проекта. Обязательно закоммитьте или сохраните незакоммиченные изменения, чтобы избежать потери данных.

:::

### Шаг 2: Запустите инструмент autofix

Теперь вы готовы просканировать проект и автоматически исправить депрекации:

1. Нажмите на **меню с тремя точками** в правом нижнем углу <Constant name="cloud_ide" />.
2. Выберите **Check & fix deprecations**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/ide-options-menu-with-save.png" width="90%" title="Откройте меню опций Studio IDE"/>

Инструмент запускает команду `dbt parse --show-all-deprecations --no-partial-parse` для поиска всех депрекаций в проекте. В зависимости от размера проекта это может занять некоторое время.

3. После завершения парсинга посмотрите результаты в панели **Command history** внизу слева.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/command-history.png" width="90%" title="Просмотр истории команд и результатов проверки deprecation"/>

### Шаг 3: Просмотрите и примените исправления

После завершения сканирования депрекаций просмотрите результаты и примените автоматические исправления:

1. В панели **Command history** изучите список предупреждений о депрекации.
2. Нажмите кнопку **Autofix warnings**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/autofix-button.png" width="90%" title="Нажмите Autofix warnings, чтобы автоматически устранить deprecations"/>

3. В диалоге **Proceed with autofix** ознакомьтесь с предупреждением и нажмите **Continue**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/proceed-with-autofix.png" width="90%" title="Подтвердите выполнение autofix"/>

Инструмент автоматически изменит файлы проекта для устранения исправляемых депрекаций, а затем выполнит повторный parse для поиска оставшихся предупреждений.

4. По завершении появится сообщение об успехе. Нажмите **Review changes**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/autofix-success.png" width="90%" title="Autofix завершён"/>

### Шаг 4: Проверьте изменения

Проверьте изменения, внесённые инструментом autofix, чтобы убедиться в их корректности:

1. Откройте панель **Version control**, чтобы увидеть все изменённые файлы.
2. Откройте отдельные файлы и изучите конкретные изменения.
3. Обратите внимание на перемещённые конфигурации, исправленные свойства и обновлённый синтаксис.
4. При необходимости внесите дополнительные ручные правки.

### Шаг 5: Закоммитьте изменения

Когда вы будете удовлетворены результатами autofix, закоммитьте изменения в свою ветку:

1. В панели **Version control** добавьте осмысленное сообщение коммита, например: "Fix deprecation warnings for Fusion upgrade".
2. Нажмите **Commit and sync**.

### Шаг 6: Устраните оставшиеся депрекейты

Если после autofix остались предупреждения, которые нельзя исправить автоматически:

1. Просмотрите сообщения в панели **Command history** — в них указаны путь к файлу и номер строки.
2. Вручную обновите код в соответствии с рекомендациями по депрекации:
   - Пользовательские входные параметры следует перенести в конфигурацию `meta`.
   - Устаревшие свойства нужно заменить их новыми эквивалентами.
   - Используйте соответствующие [руководства по обновлению версий](/docs/dbt-versions/core-upgrade).
3. После ручных исправлений снова запустите **Check & fix deprecations**, чтобы убедиться, что все предупреждения устранены.
4. Закоммитьте изменения.

### Шаг 7: Слейте изменения в вашу основную ветку

После устранения всех депрекаций:

1. Создайте pull request в вашем git-провайдере для слияния изменений.
2. Проведите код-ревью командой.
3. Смерджите PR в основную ветку разработки.
4. Убедитесь, что изменения задеплоены во все окружения перед обновлением до <Constant name="fusion" />.

## Проверьте и обновите ваши dbt‑пакеты

:::tip Сначала запустите autofix

В этом разделе описаны шаги по ручному обновлению пакетов. Мы рекомендуем сначала запустить autofix.

Autofix находит пакеты, несовместимые с <Constant name="fusion" />, и обновляет их до минимально совместимой версии. Подробнее см. в разделе [package support](/docs/fusion/supported-features#package-support).

:::

Пакеты dbt расширяют функциональность проекта, но они должны быть совместимы с <Constant name="fusion" />. Большинство популярных пакетов от dbt Labs (например, `dbt_utils` и `dbt_project_evaluator`) и многие community-пакеты [уже поддерживают <Constant name="fusion" />](/docs/fusion/supported-features#package-support). Перед обновлением убедитесь в совместимости пакетов и обновите их до актуальных версий. Ищите пакеты, поддерживающие версию 2.0.0, или уточняйте у мейнтейнеров.

Что делать, если пакет несовместим?

Если критически важный пакет ещё не поддерживает <Constant name="fusion" />:
- Свяжитесь с мейнтейнером и узнайте их планы.
- Откройте issue с запросом поддержки <Constant name="fusion" />.
- Рассмотрите возможность внести изменения самостоятельно.
- Попробуйте использовать пакет — возможно, несовместимая часть не затрагивает ваш проект.

import FusionPackageCompatibility from '/snippets/_fusion-package-compatibility.md';

<FusionPackageCompatibility />

### Шаг 1: Просмотрите текущие пакеты

Определите, какие пакеты используются в проекте:

1. В <Constant name="cloud_ide" /> откройте корневую директорию проекта.
2. Найдите файл `packages.yml` или `dependencies.yml`.
3. Просмотрите список пакетов и их версии.

Пример:

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.0.0
  - package: dbt-labs/codegen
    version: 0.9.0
```

### Шаг 2: Проверьте совместимость и найдите последние версии пакетов

Просмотрите [dbt package hub](https://hub.getdbt.com), чтобы найти пакеты, совместимые с <Constant name="fusion" />, проверив, что в `require-dbt-version` указано `2.0.0` или выше. Подробнее см. [package support](/docs/fusion/supported-features#package-support).

Для пакетов без поддержки <Constant name="fusion" />:
- Перейдите в GitHub-репозиторий пакета.
- Проверьте README и последние релизы.
- Посмотрите issues и обсуждения о поддержке <Constant name="fusion" />.

Для каждого пакета определите последнюю версию:

- Используйте [dbt Hub](https://hub.getdbt.com) для пакетов оттуда.
- Для GitHub-пакетов смотрите страницу релизов.
- Зафиксируйте номер последней версии.

Для пакетов с Hub можно использовать диапазоны версий:

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: [">=1.0.0", "<3.0.0"]  # Получает последнюю версию 1.x или 2.x
```

### Шаг 3: Обновите версии пакетов

Обновите `packages.yml` или `dependencies.yml`, указав последние совместимые версии:

1. В <Constant name="cloud_ide" /> откройте `packages.yml` или `dependencies.yml`.
2. Обновите версии пакетов.
3. Сохраните файл.

   До обновления:
   ```yaml
   packages:
   - package: dbt-labs/dbt_utils
      version: 0.9.6
   - package: dbt-labs/codegen
      version: 0.9.0
   ```

   После обновления:
   ```yaml
   packages:
   - package: dbt-labs/dbt_utils
      version: [">=1.0.0", "<2.0.0"]
   - package: dbt-labs/codegen
      version: [">=0.12.0", "<1.0.0"]
   ```

### Шаг 4: Установите обновлённые пакеты

После обновления версий установите пакеты:

1. В командной строке <Constant name="cloud_ide" /> выполните:
   ```bash
   dbt deps --upgrade
   ```

Флаг `--upgrade` гарантирует установку последних версий в заданных диапазонах и обновление файла `package-lock.yml`.

2. Проверьте вывод команды и убедитесь, что все пакеты установились успешно.
3. Убедитесь, что `package-lock.yml` обновлён.

:::info About package-lock.yml

Файл `package-lock.yml` фиксирует конкретные версии пакетов для воспроизводимых сборок. Мы рекомендуем коммитить его в систему контроля версий.

:::

### Шаг 5: Протестируйте проект с обновлёнными пакетами

После обновления пакетов протестируйте проект:

1. Запустите часть моделей для проверки базовой работоспособности:
   ```bash
   dbt run --select tag:daily
   ```

2. Запустите тесты:
   ```bash
   dbt test
   ```

3. Если возникают проблемы:
   - Изучите changelog пакета
   - Адаптируйте код под новое поведение
   - При необходимости временно зафиксируйте более старую совместимую версию

### Шаг 6: Закоммитьте обновления пакетов

После успешной проверки:

1. В панели **Version control** добавьте изменения:
   - `packages.yml` или `dependencies.yml`
   - `package-lock.yml`

2. Добавьте коммит с сообщением вроде "Upgrade dbt packages for Fusion compatibility".
3. Нажмите **Commit and sync**.

## Проверьте известные ограничения Fusion

Хотя <Constant name="fusion" /> поддерживает большую часть возможностей <Constant name="core" />, некоторые функции пока имеют ограничения или находятся в разработке. Перед обновлением проанализируйте проект и определите такие места, чтобы заранее спланировать действия — удалить некритичные функции, применить обходные решения или дождаться поддержки.

:::note Fusion is rapidly evolving

Многие ограничения постепенно устраняются по мере приближения <Constant name="fusion" /> к General Availability. Следите за прогрессом в [dbt-fusion GitHub milestones](https://github.com/dbt-labs/dbt-fusion/milestones) и через [Fusion Diaries](https://github.com/dbt-labs/dbt-fusion/discussions/categories/announcements).

:::

### Шаг 1: Просмотрите таблицу ограничений

Начните с изучения функций с ограниченной поддержкой:

Перейдите на страницу [Fusion supported features](/docs/fusion/supported-features#limitations) и ознакомьтесь с таблицей ограничений.

Часто встречающиеся ограничения:
- **Python models:** не поддерживаются
- **Microbatch incremental strategy:** пока недоступна
- **Model-level notifications:** доступны только job-level
- **Semantic Layer development:** активная разработка должна оставаться на <Constant name="core" />
- **SQLFluff linting:** пока не интегрирован

### Шаг 2: Поиск в проекте ограниченных функций

Проверьте, использует ли проект функции с ограниченной поддержкой. Например:

1. Python-модели:
   - Ищите файлы `.py` в каталоге `models/`

2. Конфигурации в `dbt_project.yml`:
   - `store_failures`
   - пользовательские materializations
   - `warn-error` и `warn-error-options`

3. Конфигурации джоб:
   - флаг `--fail-fast`
   - `--store-failures`
   - Advanced CI workflows

4. Настройки governance:
   - `deprecation_date` у моделей

### Шаг 3: Оцените влияние

Для каждого ограничения определите его критичность:

- **Критично:** без функции проект не работает
- **Желательно:** можно временно заменить
- **Минимально:** легко обойти

### Шаг 4: Создайте план действий

На основе оценки примите решения:

- Удалите некритичные функции
- Используйте обходные решения

Пример:

```SQL
{{ config(
  materialized='incremental'
) }}
```

### Шаг 5: Задокументируйте свои находки

Зафиксируйте результаты:

1. Создайте документ (например, `FUSION_MIGRATION.md`) с описанием ограничений, затронутых моделей и стратегий обхода.
2. Поделитесь документом с заинтересованными сторонами.

### Шаг 6: Отслеживайте прогресс функций

Следите за прогрессом:

1. Подпишитесь на relevant GitHub issues.
2. Следите за [Fusion Diaries](https://github.com/dbt-labs/dbt-fusion/discussions/categories/announcements).
3. Проверяйте [dbt-fusion milestones](https://github.com/dbt-labs/dbt-fusion/milestones).

## Что дальше?

После выявления и устранения ограничений вы завершили все подготовительные шаги. Ваш проект готов к обновлению до <Constant name="fusion" />!

Переходите к [Часть 2: переход](/guides/upgrade-to-fusion)

</div>
