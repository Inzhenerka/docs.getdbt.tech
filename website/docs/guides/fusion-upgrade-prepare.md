---
title: "Обновление до Fusion, часть 1: Подготовка к обновлению"
id: "prepare-fusion-upgrade"
level: 'Intermediate'
icon: 'zap'
hide_table_of_contents: true
tags: ['dbt Fusion engine', 'dbt platform', 'Upgrade']
recently_updated: true
intro_text: Это руководство поможет вам подготовиться к обновлению «на месте» с dbt Core на движок dbt Fusion в платформе dbt.
---

<div style={{maxWidth: '900px'}}>

import FusionAdapters from '/snippets/_fusion-dwh.md';

## Введение

import FusionPreview from '/snippets/_fusion-private-preview.md';

<FusionPreview />

<Constant name="fusion_engine" /> представляет собой следующий этап эволюции трансформации данных. dbt был полностью переработан с нуля, но в своей основе <Constant name="fusion" /> — это новая версия, а к любой новой версии необходимо подготовиться перед обновлением. Это руководство проведёт вас через все необходимые подготовительные шаги.

Если <Constant name="fusion" /> для вас совершенно новый, сначала ознакомьтесь с нашей [подробной документацией](/docs/fusion), чтобы понять, что это такое, как он работает и чем отличается от <Constant name="core" />, прежде чем продолжить работу с этим руководством. Когда вы будете готовы, самое время начать подготовку ваших проектов к скорости и возможностям, которые предлагает <Constant name="fusion" />.

## Предварительные требования

Это руководство описывает подготовку к обновлению до <Constant name="fusion_engine" /> и предназначено для клиентов, которые уже используют <Constant name="dbt_platform" /> с версией <Constant name="core" />. Если вы только начинаете работать с dbt, ознакомьтесь с нашими [руководствами для быстрого старта](/guides).

Чтобы следовать шагам этого руководства, необходимо выполнить следующие условия:

- Вы используете аккаунт <Constant name="dbt_platform" /> на любом тарифе.
- У вас есть лицензия разработчика.
- У вас есть [необходимые права доступа](/docs/cloud/manage-access/enterprise-permissions) для редактирования проектов.
- Ваш проект использует адаптер, поддерживаемый <Constant name="fusion" />:
    <FusionAdapters/>

:::tip Обновление первого проекта

Начните с небольших, новых или хорошо знакомых вам проектов. Это упростит выявление и устранение проблем перед обновлением более крупных и сложных проектов.

:::

## Обновление до последней версии dbt Core

Перед обновлением до <Constant name="fusion" /> вам необходимо перевести все окружения на трек релизов `Latest` для [<Constant name="core" />](/docs/dbt-versions/cloud-release-tracks). Трек `Latest` включает все функции и инструменты, необходимые для подготовки к <Constant name="fusion" />. Он обеспечивает наиболее плавный процесс обновления, проверяя, что ваш проект не зависит от устаревшего поведения.

:::tip Тестируйте перед деплоем

Всегда тестируйте обновления версий сначала в разработке. Используйте функцию [Override dbt version](#step-1-test-in-development-using-override), чтобы безопасно попробовать трек `Latest`, не затрагивая команду или продакшн-запуски.

:::

### Шаг 1: Тестирование в разработке (с использованием override)

Протестируйте трек релизов `Latest` для своего аккаунта, не меняя окружение для всей команды:

1. Нажмите на имя своего аккаунта в левом сайдбаре и выберите **Account settings**.
2. В сайдбаре выберите **Credentials** и выберите проект.
3. В боковой панели нажмите **Edit** и прокрутите до **User development settings**.
4. В выпадающем списке **dbt version** выберите **Latest** и нажмите **Save**.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/choosing-dbt-version/example-override-version.png" width="60%" title="Переопределение версии dbt в настройках аккаунта"/>

5. Запустите <Constant name="cloud_ide" /> или <Constant name="cloud_cli" /> и протестируйте свои обычные процессы разработки.
6. Убедитесь, что override активен, выполнив любую команду dbt и проверив **System Logs**. В первой строке должно быть указано `Running with dbt=` и выбранная версия. Если номер версии `v1.11` или выше, вы на верном пути к готовности к <Constant name="fusion" />.

Если всё работает корректно, переходите к следующему шагу и начинайте обновление окружений. Если вы видите предупреждения об устаревших возможностях, не переживайте — мы разберём их [позже в этом руководстве](/guides/prepare-fusion-upgrade?step=4). Если вы столкнулись с ошибками, вернитесь к предыдущей версии и воспользуйтесь [руководствами по обновлению версий](/docs/dbt-versions/core-upgrade), чтобы устранить различия между вашей текущей версией и последней доступной версией <Constant name="core" />.

### Шаг 2: Обновление окружения разработки

После успешного тестирования индивидуального окружения разработки с override обновите окружение разработки для всего проекта (обязательно предупредите команду):

1. Перейдите в раздел **Environments** в настройках проекта.
2. Выберите окружение **Development** и нажмите **Edit**.
3. В выпадающем списке **dbt version** выберите **Latest**.
4. Нажмите **Save**, чтобы применить изменения.

<Lightbox src="/img/docs/dbt-cloud/cloud-configuring-dbt-cloud/choosing-dbt-version/select-development.png" width="90%" title="Обновление окружения разработки до трека Latest dbt Core"/>

:::info Удалите персональный override

После обновления окружения разработки вы можете удалить персональный override, вернувшись к настройкам учётных данных аккаунта и выбрав ту же версию, что и в окружении.

:::

### Шаг 3: Обновление staging и pre-production

Если в вашей организации есть окружения staging или pre-production, обновите их перед продакшном:

1. Перейдите в **Environments** и выберите окружение staging/pre-production.
2. Нажмите **Edit** и выберите **Latest** в выпадающем списке **dbt version**.
3. Нажмите **Save**.
4. Запускайте джобы в этом окружении в течение нескольких дней, чтобы убедиться, что всё работает корректно.

Это добавляет финальный уровень проверки перед обновлением продакшн-окружений.

### Шаг 4: Обновление продакшн-окружения

После проверки в staging (или в development, если staging отсутствует) обновите продакшн-окружение:

1. Перейдите в **Environments** и выберите окружение **Production**.
2. Нажмите **Edit** и выберите **Latest** в выпадающем списке **dbt version**.
3. Нажмите **Save**, чтобы применить изменения.
4. Отслеживайте первые несколько продакшн-запусков, чтобы убедиться, что всё выполняется успешно.

### Шаг 5: Обновление jobs

Хотя в большинстве случаев версия dbt определяется окружениями, некоторые старые конфигурации jobs могут содержать override версии. Просмотрите ваши jobs и [обновите те, в которых явно указана версия dbt](/docs/dbt-versions/upgrade-dbt-version-in-cloud#jobs), чтобы они использовали трек Latest, заданный в окружении.

## Устранение всех предупреждений об устаревании

<Constant name="fusion" /> применяет строгую валидацию и не принимает устаревший код, который в <Constant name="core" /> сейчас лишь вызывает предупреждения. Перед обновлением до <Constant name="fusion" /> необходимо устранить все такие предупреждения. К счастью, инструмент autofix в <Constant name="cloud_ide" /> может автоматически исправить большинство распространённых устареваний.

:::tip Расширение VS Code

В этом руководстве описаны шаги по устранению предупреждений об устаревании, не покидая <Constant name="dbt_platform" />. Если вы предпочитаете работать локально в VS Code или Cursor, вы можете запустить autofix с помощью нашего расширения dbt для VS Code. Подробнее см. [руководство по установке](/docs/install-dbt-extension).

:::

### Что обрабатывает инструмент autofix

Инструмент autofix может автоматически исправлять многие устаревания, включая:

- Перенос пользовательских конфигураций в словарь `meta`
- Исправление дублирующихся ключей YAML
- Коррекцию нераспознанных свойств ресурсов
- Обновление устаревших конфигурационных паттернов

Полный список поддерживаемых устареваний см. в [autofix readme](https://github.com/dbt-labs/dbt-autofix/).

:::note Совместимость пакетов с Fusion

Помимо устареваний, инструмент autofix пытается обновить пакеты до минимальной версии, совместимой с <Constant name="fusion" />. Подробнее см. в разделе [поддержка пакетов](/docs/fusion/supported-features#package-support).

:::

### Шаг 1: Создание новой ветки

Перед запуском инструмента autofix создайте новую ветку, чтобы изолировать изменения:

1. Перейдите в <Constant name="cloud_ide" />, нажав **Studio** в левом меню.
2. Откройте панель **Version control** (иконка git-ветки) в левом сайдбаре.
3. Нажмите **Create branch** и задайте описательное имя, например `fusion-deprecation-fixes`.
4. Нажмите **Create**, чтобы переключиться на новую ветку.

:::warning Сохраните изменения перед autofix

Инструмент autofix изменяет файлы проекта. Убедитесь, что все текущие изменения закоммичены или сохранены, чтобы избежать потери данных.

:::

### Шаг 2: Запуск инструмента autofix

Теперь вы готовы просканировать проект и автоматически исправить предупреждения об устаревании:

1. Нажмите на **меню с тремя точками** в правом нижнем углу <Constant name="cloud_ide" />.
2. Выберите **Check & fix deprecations**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/ide-options-menu-with-save.png" width="90%" title="Доступ к меню опций Studio IDE"/>

Инструмент запускает `dbt parse --show-all-deprecations --no-partial-parse` для выявления всех устареваний в проекте. В зависимости от размера проекта это может занять некоторое время.

3. После завершения парсинга просмотрите результаты в панели **Command history** в левом нижнем углу.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/command-history.png" width="90%" title="Просмотр истории команд и результатов устареваний"/>

### Шаг 3: Просмотр и применение autofix

После завершения сканирования просмотрите найденные предупреждения и примените автоматические исправления:

1. В панели **Command history** просмотрите список предупреждений об устаревании.
2. Нажмите кнопку **Autofix warnings**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/autofix-button.png" width="90%" title="Запуск Autofix warnings для автоматического устранения устареваний"/>

3. В диалоге **Proceed with autofix** ознакомьтесь с предупреждением и нажмите **Continue**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/proceed-with-autofix.png" width="90%" title="Подтверждение операции autofix"/>

Инструмент автоматически изменит файлы проекта, устранит исправляемые устаревания и затем выполнит повторный парсинг для выявления оставшихся предупреждений.

4. После завершения появится сообщение об успехе. Нажмите **Review changes**.

<Lightbox src="/img/docs/dbt-cloud/cloud-ide/autofix-success.png" width="90%" title="Autofix завершён"/>

### Шаг 4: Проверка изменений

Проверьте изменения, внесённые инструментом autofix, чтобы убедиться в их корректности:

1. Откройте панель **Version control**, чтобы увидеть все изменённые файлы.
2. Откройте отдельные файлы для просмотра конкретных изменений.
3. Обратите внимание на файлы с перенесёнными конфигурациями, исправленными свойствами или обновлённым синтаксисом.
4. При необходимости внесите дополнительные ручные правки.

### Шаг 5: Коммит изменений

Когда вы убедитесь, что изменения корректны, закоммитьте их в ветку:

1. В панели **Version control** добавьте понятное сообщение коммита, например: "Fix deprecation warnings for Fusion upgrade".
2. Нажмите **Commit and sync**, чтобы сохранить изменения.

### Шаг 6: Устранение оставшихся устареваний

Если инструмент autofix сообщает о предупреждениях, которые не удалось исправить автоматически:

1. Просмотрите сообщения в панели **Command history**. В каждом предупреждении указан путь к файлу и номер строки.
2. Внесите изменения вручную в соответствии с рекомендациями:
   - Пользовательские параметры следует перенести в конфигурацию `meta`.
   - Устаревшие свойства необходимо заменить на актуальные аналоги.
   - Используйте соответствующие [руководства по обновлению версий](/docs/dbt-versions/core-upgrade) для детальных инструкций.
3. После ручных правок снова запустите **Check & fix deprecations**, чтобы убедиться, что все предупреждения устранены.
4. Закоммитьте изменения.

### Шаг 7: Слияние с основной веткой

После устранения всех устареваний:

1. Создайте pull request в вашем git-провайдере для слияния изменений.
2. Проведите командный код-ревью.
3. Смерджите PR в основную ветку разработки.
4. Убедитесь, что изменения задеплоены во все окружения перед обновлением до <Constant name="fusion" />.

## Проверка и обновление dbt-пакетов

:::tip Сначала запустите autofix

Этот раздел содержит инструкции по ручному обновлению пакетов. Мы рекомендуем сначала использовать инструмент autofix.

Autofix выявляет пакеты, несовместимые с <Constant name="fusion" />, и обновляет их до минимально совместимой версии. Подробнее см. в разделе [поддержка пакетов](/docs/fusion/supported-features#package-support).

:::

Пакеты dbt расширяют функциональность проекта, но они должны быть совместимы с <Constant name="fusion" />. Большинство популярных пакетов от dbt Labs (таких как `dbt_utils` и `dbt_project_evaluator`), а также многие пакеты сообщества [уже поддерживают <Constant name="fusion" />](/docs/fusion/supported-features#package-support). Перед обновлением убедитесь в совместимости пакетов и обновите их до последних версий. Обращайте внимание на пакеты, поддерживающие версию 2.0.0, или уточняйте у мейнтейнеров при сомнениях.

Что делать, если пакет не совместим?

Если критически важный пакет пока не поддерживает <Constant name="fusion" />:
- Уточните у мейнтейнера планы по поддержке.
- Создайте issue с запросом поддержки <Constant name="fusion" />.
- Рассмотрите возможность внести изменения самостоятельно.
- Попробуйте использовать пакет — возможно, несовместимая часть не влияет на ваш проект.

import FusionPackageCompatibility from '/snippets/_fusion-package-compatibility.md';

<FusionPackageCompatibility />

### Шаг 1: Просмотр текущих пакетов

Определите, какие пакеты используются в проекте:

1. В <Constant name="cloud_ide" /> откройте корневую директорию проекта.
2. Найдите файл `packages.yml` или `dependencies.yml`.
3. Просмотрите список пакетов и их текущие версии.

Пример содержимого файла:

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.0.0
  - package: dbt-labs/codegen
    version: 0.9.0
```

### Шаг 2: Проверка совместимости и поиск последних версий пакетов

Используйте [dbt package hub](https://hub.getdbt.com), чтобы найти проверенные пакеты, совместимые с <Constant name="fusion" />, убедившись, что параметр `require-dbt-version` включает `2.0.0` или выше. Дополнительную информацию см. в разделе [поддержка пакетов](/docs/fusion/supported-features#package-support).

Для пакетов, не совместимых с <Constant name="fusion" />:
   - Перейдите в GitHub-репозиторий пакета.
   - Проверьте README или последние релизы на предмет совместимости с <Constant name="fusion" />.
   - Изучите issues и обсуждения, связанные с поддержкой <Constant name="fusion" />.

Для каждого пакета определите последнюю доступную версию:

- Посетите [dbt Hub](https://hub.getdbt.com) для пакетов, размещённых там.
- Для пакетов с GitHub проверьте страницу релизов репозитория.
- Зафиксируйте номер последней версии для каждого пакета.

Для пакетов из Hub можно использовать диапазоны версий, чтобы оставаться актуальными:

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: [">=1.0.0", "<3.0.0"]  # Получает последнюю версию 1.x или 2.x
```

### Шаг 3: Обновление версий пакетов

Обновите файл `packages.yml` или `dependencies.yml`, указав последние совместимые версии:

1. В <Constant name="cloud_ide" /> откройте `packages.yml` или `dependencies.yml`.
2. Обновите версии каждого пакета до последних совместимых.
3. Сохраните файл.

   До обновления:
   ```yaml
   packages:
   - package: dbt-labs/dbt_utils
      version: 0.9.6
   - package: dbt-labs/codegen
      version: 0.9.0
   ```

   После обновления:
   ```yaml
   packages:
   - package: dbt-labs/dbt_utils
      version: [">=1.0.0", "<2.0.0"]
   - package: dbt-labs/codegen
      version: [">=0.12.0", "<1.0.0"]
   ```

### Шаг 4: Установка обновлённых пакетов

После обновления версий установите пакеты:

1. В командной строке <Constant name="cloud_ide" /> выполните:
   ```bash
   dbt deps --upgrade
   ```

Флаг `--upgrade` гарантирует установку последних версий в рамках указанных диапазонов и обновляет файл `package-lock.yml`.

2. Проверьте вывод команды и убедитесь, что все пакеты установлены успешно.
3. Убедитесь, что файл `package-lock.yml` обновился и содержит новые версии пакетов.

:::info О файле package-lock.yml

Файл `package-lock.yml` фиксирует версии пакетов для воспроизводимых сборок. Мы рекомендуем коммитить этот файл в систему контроля версий, чтобы вся команда использовала одинаковые версии пакетов.

:::

### Шаг 5: Тестирование проекта с обновлёнными пакетами

После обновления пакетов протестируйте проект:

1. Запустите часть моделей для базовой проверки:
   ```bash
   dbt run --select tag:daily
   ```

2. Запустите тесты, чтобы выявить возможные изменения поведения:
   ```bash
   dbt test
   ```

3. При возникновении проблем:
   - Изучите changelog пакета на предмет breaking changes
   - Адаптируйте код под новое поведение пакета
   - При необходимости временно зафиксируйте более старую совместимую версию

### Шаг 6: Коммит обновлений пакетов

После успешной проверки обновлённых пакетов:

1. В панели **Version control** добавьте в staging:
   - `packages.yml` или `dependencies.yml`
   - `package-lock.yml`

2. Добавьте сообщение коммита, например "Upgrade dbt packages for Fusion compatibility".
3. Нажмите **Commit and sync**.

## Проверка известных ограничений Fusion

Хотя <Constant name="fusion" /> поддерживает большую часть возможностей <Constant name="core" />, некоторые функции имеют ограниченную поддержку или всё ещё находятся в разработке. Перед обновлением важно проанализировать проект и выявить такие особенности, чтобы заранее спланировать действия — будь то временный отказ от некритичных функций, использование обходных решений или ожидание появления нужных возможностей.

:::note Fusion активно развивается

Многие ограничения устраняются по мере приближения <Constant name="fusion" /> к General Availability. Вы можете отслеживать прогресс по функциям через [GitHub milestones dbt-fusion](https://github.com/dbt-labs/dbt-fusion/milestones) и следить за обновлениями в [Fusion Diaries](https://github.com/dbt-labs/dbt-fusion/discussions/categories/announcements).

:::

### Шаг 1: Ознакомьтесь с таблицей ограничений

Начните с понимания того, какие функции имеют ограниченную или отсутствующую поддержку в <Constant name="fusion" />:

Перейдите на страницу [поддерживаемых возможностей Fusion](/docs/fusion/supported-features#limitations) и изучите таблицу ограничений.

Распространённые ограничения включают:
- **Python-модели:** пока не поддерживаются (Fusion не может парсить Python для извлечения зависимостей)
- **Microbatch incremental strategy:** пока недоступна
- **Уведомления на уровне моделей:** работают уведомления на уровне jobs, но не моделей
- **Разработка Semantic Layer:** активная разработка должна оставаться на <Constant name="core" />
- **SQLFluff linting:** пока не интегрирован (линтинг будет встроен напрямую в <Constant name="fusion" />)

### Шаг 2: Поиск ограниченных функций в проекте

Проверьте, использует ли ваш проект функции с ограниченной поддержкой. Например:

1. Проверка Python-моделей:
   - В <Constant name="cloud_ide" /> просмотрите директорию `models/`
   - Найдите файлы с расширением `.py`
   - При их наличии потребуется либо удалить их, либо оставить эти модели на <Constant name="core" />

2. Просмотрите `dbt_project.yml`:
   - Найдите настройки `store_failures`
   - Проверьте пользовательские материализации, отличные от `view`, `table` и `incremental`
   - Изучите конфигурации `warn-error` и `warn-error-options`

3. Проверьте конфигурации jobs:
   - Найдите jobs с флагом `--fail-fast`
   - Определите jobs с `--store-failures`
   - Обратите внимание на Advanced CI workflows с "compare changes"

4. Проверьте настройки governance моделей:
   - Найдите модели с заданным `deprecation_date`
   - Учтите, что они могут пока не генерировать предупреждения в <Constant name="fusion" />

### Шаг 3: Оценка влияния

Для каждого ограничения определите его критичность:

- **Критичные функции:** без них проект не может работать:
    - Если Python-модели необходимы, возможно, стоит подождать или переписать их на SQL
    - При активной разработке Semantic Layer продолжайте использовать <Constant name="core" />

- **Желательные функции:** улучшают процессы, но не блокируют работу:
    - Уведомления на уровне моделей можно временно заменить уведомлениями на уровне jobs
    - SQLFluff можно продолжать запускать в CI с <Constant name="core" />

- **Минимальное влияние:** функции, для которых легко найти обход:
    - Флаг `--fail-fast` можно временно убрать
    - `--store-failures` можно временно отключить

### Шаг 4: Формирование плана действий

На основе оценки решите, как поступать с каждым ограничением:

- Удалить некритичные функции:

    Временно отключите функции, без которых можно обойтись:
   
   До (в конфигурации модели): 

   ```SQL
   {{ config(
     materialized='incremental',
     store_failures=true
   ) }}
   ```
   
   После:
   ```SQL
   {{ config(
     materialized='incremental'
   ) }}
   ```

- Реализовать обходные решения для функций с низким влиянием:
   - Использовать уведомления на уровне jobs вместо модельных
   - Запускать SQLFluff отдельно в CI с <Constant name="core" />
   - Использовать стандартный state selection вместо более гранулярных подвыборок

### Шаг 5: Документирование результатов

Зафиксируйте ограничения, влияющие на ваш проект:

1. В <Constant name="cloud_ide" /> создайте документ (например, `FUSION_MIGRATION.md`) со списком:
   - Функций проекта, которые <Constant name="fusion" /> пока не полностью поддерживает
   - Затронутых моделей или jobs
   - Стратегии обхода для каждого ограничения
   - Ссылок на GitHub issues для отслеживания статуса функций

2. Важно, чтобы команды понимали эти ограничения, поэтому обязательно поделитесь документом со всеми заинтересованными сторонами.

### Шаг 6: Отслеживание прогресса функций

Оставайтесь в курсе появления необходимых возможностей:

1. Подпишитесь на соответствующие GitHub issues для нужных функций (ссылки есть в [таблице ограничений](/docs/fusion/supported-features#limitations)).
2. Следите за обновлениями в [Fusion Diaries](https://github.com/dbt-labs/dbt-fusion/discussions/categories/announcements).
3. Проверяйте [milestones dbt-fusion](https://github.com/dbt-labs/dbt-fusion/milestones), чтобы понимать сроки релизов.

## Что дальше?

После выявления и учёта ограничений вы завершили все подготовительные шаги. Ваш проект готов к обновлению до <Constant name="fusion" />!

Переходите к [Части 2: Переход на Fusion](/guides/upgrade-to-fusion)

</div>
