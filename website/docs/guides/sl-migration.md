---
title: "Руководство по миграции устаревшего семантического слоя dbt"
id: "sl-migration"
description: "Узнайте, как перейти с устаревшего семантического слоя dbt на новый."
hoverSnippet: Переход с устаревшего семантического слоя dbt на новый.
icon: 'guides'
hide_table_of_contents: true
tags: ['Semantic Layer','Migration']
level: 'Intermediate'
---

<div style={{maxWidth: '900px'}}>

## Введение

Устаревший семантический слой будет снят с поддержки во второй половине 2023 года. Кроме того, пакет `dbt_metrics` не будет поддерживаться в dbt версии 1.6 и выше. Если вы используете `dbt_metrics`, вам нужно обновить ваши конфигурации перед обновлением до версии 1.6. Это руководство предназначено для тех, кто использует устаревший семантический слой dbt и хочет перейти на новый семантический слой dbt. Оценочное время миграции составляет две недели.

## Миграция конфигураций метрик на новую спецификацию

Спецификация метрик в dbt Core изменилась в версии 1.6 для поддержки интеграции с MetricFlow. Настоятельно рекомендуется ознакомиться с [Создание метрик](/docs/build/build-metrics-intro) перед началом, чтобы понять основные концепции семантического слоя.

Спецификация метрик в <Constant name="core" /> была изменена в версии v1.6 для поддержки интеграции MetricFlow. Настоятельно рекомендуется перед началом ознакомиться с разделом [Build your metrics](/docs/build/build-metrics-intro), чтобы вы понимали основные концепции <Constant name="semantic_layer" />.

dbt Labs рекомендует выполнять следующие шаги в локальной среде разработки (например, с использованием [<Constant name="cloud" /> CLI](/docs/cloud/cloud-cli-installation)), а не в <Constant name="cloud_ide" />:

1. Создайте новые конфигурации Semantic Model в виде YAML-файлов в вашем dbt‑проекте.*
1. Обновите конфигурации метрик в вашем проекте до новой спецификации.*
1. Удалите старый файл метрик или уберите у него расширение `.yml`, чтобы он игнорировался на этапе парсинга. Удалите пакет `dbt-metrics` из вашего проекта. Удалите все макросы, которые ссылаются на `dbt-metrics`, например `metrics.calculate()`. Убедитесь, что используемые вами пакеты не содержат ссылок на старую спецификацию метрик.
1. Установите [<Constant name="cloud" /> CLI](/docs/cloud/cloud-cli-installation) для запуска команд MetricFlow и определения конфигураций вашей семантической модели.
   - Если вы используете dbt Core, установите [MetricFlow CLI](/docs/build/metricflow-commands) с помощью команды `python -m pip install "dbt-metricflow[your_adapter_name]"`. Например:

    ```bash
    python -m pip install "dbt-metricflow[snowflake]"
    ```
**Примечание** — команды MetricFlow в настоящее время ещё не поддерживаются в <Constant name="cloud_ide" />.

2. Запустите `dbt parse`. Это разберет ваш проект и создаст файл `semantic_manifest.json` в вашей целевой директории. MetricFlow нуждается в этом файле для выполнения запросов к метрикам. Если вы внесете изменения в ваши конфигурации, вам нужно будет снова разобрать ваш проект.
3. Запустите `mf list metrics`, чтобы просмотреть метрики в вашем проекте.
4. Протестируйте запрос к метрике, запустив `mf query --metrics <metric_name> --group-by <dimensions_name>`. Например:
    ```bash
    mf query --metrics revenue --group-by metric_time
    ```
5. Запустите `mf validate-configs` для выполнения семантических и складских проверок. Это гарантирует, что ваши конфигурации действительны и что базовые объекты существуют в вашем хранилище.
6. Отправьте эти изменения в новую ветку вашего репозитория.

:::info `ref` не поддерживается
API семантического слоя dbt не поддерживает `ref` для вызова объектов dbt. Это связано с различиями в архитектуре между устаревшим семантическим слоем и переизданным семантическим слоем. Вместо этого используйте полное квалифицированное имя таблицы. Если вы используете макросы dbt во время запроса для вычисления ваших метрик, вы должны перенести эти вычисления в определения метрик вашего семантического слоя в виде кода.
:::

**Чтобы упростить этот процесс, dbt Labs предоставляет [пользовательский инструмент миграции](https://github.com/dbt-labs/dbt-converter), который автоматизирует эти шаги для вас. Вы можете найти инструкции по установке в [README](https://github.com/dbt-labs/dbt-converter/blob/master/README.md). Производные метрики не поддерживаются в инструменте миграции и должны быть перенесены вручную.*

## Аудит значений метрик после миграции

Возможно, вам потребуется провести аудит значений метрик во время миграции, чтобы убедиться, что исторические значения ключевых бизнес-метрик остаются неизменными.

1. В CLI выполните запрос к метрике(ам) и измерениям, которые вы хотите протестировать, и включите опцию `--explain`. Например:
    ```bash 
    mf query --metrics orders,revenue --group-by metric_time__month,customer_type --explain
    ``` 
1. Используйте SQL MetricFlow для создания временной модели в вашем проекте, например, `tmp_orders_revenue audit.sql`. Вы будете использовать эту временную модель для сравнения с вашими устаревшими метриками.
1. Если вы еще этого не сделали, создайте модель, используя `metrics.calculate()` для метрик, которые вы хотите сравнить. Например:

    ```bash
    select * 
    from {{ metrics.calculate(  
    [metric('orders)',
    metric('revenue)'],
        grain='week',
        dimensions=['metric_time', 'customer_type'],
    ) }}
    ```

1. Запустите помощник [dbt-audit](https://github.com/dbt-labs/dbt-audit-helper) на обеих моделях, чтобы сравнить значения метрик.

## Настройка семантического слоя в новой среде

Этот шаг актуален только для пользователей, которые хотят, чтобы устаревший и новый семантический слой работали параллельно в течение короткого времени. Это позволит вам воссоздать контент в инструментах, таких как Hex и Mode, с минимальным временем простоя. Если вам не нужно воссоздавать активы в этих инструментах, пропустите шаг 5.

1. Создайте новую среду развертывания в <Constant name="cloud" /> и установите версию dbt 1.6 или выше.
   
2. Выберите **Только запуск на пользовательской ветке** и укажите ветку, в которой определены обновленные метрики.

3. Установите схему развертывания на временную миграционную схему, такую как `tmp_sl_migration`. По желанию, вы можете создать новую базу данных для миграции.

4. Создайте задание для разбора вашего проекта, например, `dbt parse`, и запустите его. Убедитесь, что это задание выполнено успешно. В вашей среде должно быть успешное задание для настройки семантического слоя.

5. Выберите **Account Settings** → **Projects** → **Project details** и нажмите **Configure the <Constant name="semantic_layer" />**.

6. В разделе **Среда** выберите среду развертывания, созданную на предыдущем шаге. Сохраните вашу конфигурацию.

7. На странице **Project details** нажмите **Generate service token** и выдайте ему права **<Constant name="semantic_layer" /> Only** и **Metadata Only**. Надёжно сохраните этот токен. Он понадобится вам для подключения к семантическому слою.

На этом этапе как новый, так и старый семантический слой будут работать. Новый семантический слой будет указывать на вашу миграционную ветку с обновленными определениями метрик.

## Обновление подключения в интеграциях нижнего уровня

Теперь, когда ваш семантический слой настроен, вам нужно обновить все интеграции нижнего уровня, которые использовали устаревший семантический слой.

Теперь, когда ваш <Constant name="semantic_layer" /> настроен, вам нужно обновить все нижестоящие интеграции, которые использовали устаревший <Constant name="semantic_layer" />.

Чтобы узнать больше о интеграции с Hex, ознакомьтесь с их [документацией](https://learn.hex.tech/docs/connect-to-data/data-connections/dbt-integration#dbt-semantic-layer-integration) для получения дополнительной информации. Кроме того, обратитесь к [ячейкам семантического слоя dbt](https://learn.hex.tech/docs/logic-cell-types/transform-cells/dbt-metrics-cells) для настройки SQL ячеек в Hex.

Чтобы узнать больше об интеграции с Hex, ознакомьтесь с их [документацией](https://learn.hex.tech/docs/connect-to-data/data-connections/dbt-integration#dbt-semantic-layer-integration). Также см. [ячейки <Constant name="semantic_layer" />](https://learn.hex.tech/docs/logic-cell-types/transform-cells/dbt-metrics-cells), чтобы настроить SQL‑ячейки в Hex.

1. Настройте новое подключение к <Constant name="semantic_layer" /> для вашей учетной записи. Обратите внимание, что ваше устаревшее подключение продолжит работать.

2. Пересоздайте дашборды или отчеты, которые используют устаревший <Constant name="semantic_layer" />.

   * **Примечание** &mdash; Вам нужно будет обновить ваше подключение к вашей производственной среде после слияния изменений в основную ветку. В настоящее время это подключение будет указывать на среду миграции семантического слоя.

### Руководство по миграции для Mode

1. Настройте новое подключение для семантического слоя для вашего аккаунта. Следуйте [документации Mode для настройки вашего подключения](https://mode.com/help/articles/supported-databases/#dbt-semantic-layer).

2. Воссоздайте панели или отчеты, которые используют устаревший семантический слой dbt.

2. Пересоздайте дашборды или отчёты, которые используют устаревший <Constant name="semantic_layer" />.

## Слияние вашей ветки миграции метрик в основную и обновление вашей производственной среды до версии 1.6

1. Обновите вашу производственную среду до версии 1.6 или выше.
   * **Примечание** &mdash; Старые определения метрик больше не действительны, поэтому ваши задания dbt не будут проходить.

2. Слейте ваши обновленные определения метрик в основную ветку. **На этом этапе устаревший семантический слой больше не будет работать.**

Если вы создали новую среду на [Шаге 3](#step-3-setup-the-semantic-layer-in-a-new-environment):

3. Обновите окружение в **Account Settings** -> **Project Details** -> **Edit <Constant name="semantic_layer" /> Configuration**, указав ваше production‑окружение

4. Удалите вашу миграционную среду. Обязательно обновите детали подключения в любых инструментах нижнего уровня, чтобы учесть изменение среды.

### Связанные документы

- [Краткое руководство по началу работы с <Constant name="semantic_layer" />](/guides/sl-snowflake-qs)
- [Часто задаваемые вопросы (FAQ) по <Constant name="semantic_layer" />](/docs/use-dbt-semantic-layer/sl-faqs)
- [Конвертер метрик dbt](https://github.com/dbt-labs/dbt-converter)
- [Почему мы выводим из эксплуатации пакет dbt_metrics](/blog/deprecating-dbt-metrics) — запись в блоге
- [Синтаксис запросов к API <Constant name="semantic_layer" />](/docs/dbt-cloud-apis/sl-jdbc#querying-the-api-for-metric-metadata) 
- [Курс по <Constant name="semantic_layer" /> в формате on-demand](https://learn.getdbt.com/courses/semantic-layer)

</div>