---
title: "Руководство по миграции с устаревшего слоя семантики dbt"
id: "sl-migration"
description: "Узнайте, как мигрировать с устаревшего слоя семантики dbt на новый."
hoverSnippet: Миграция с устаревшего слоя семантики dbt на новый.
# time_to_complete: '30 минут' закомментировано до тестирования
icon: 'guides'
hide_table_of_contents: true
tags: ['Слой семантики', 'Миграция']
level: 'Средний'
recently_updated: true
---

<div style={{maxWidth: '900px'}}>

## Введение

Устаревший слой семантики будет снят с поддержки во втором полугодии 2023 года. Кроме того, пакет `dbt_metrics` не будет поддерживаться в dbt версии 1.6 и позже. Если вы используете `dbt_metrics`, вам необходимо обновить ваши конфигурации перед переходом на версию 1.6. Это руководство предназначено для тех, кто настроил устаревший слой семантики dbt и хочет мигрировать на новый слой семантики dbt. Оценочное время миграции составляет две недели. 

## Миграция конфигураций метрик на новую спецификацию

Спецификация метрик в dbt Core была изменена в версии 1.6 для поддержки интеграции с MetricFlow. Настоятельно рекомендуется ознакомиться с [Создание ваших метрик](/docs/build/build-metrics-intro) перед началом, чтобы понять основные концепции слоя семантики. 

dbt Labs рекомендует выполнять эти шаги в локальной среде разработки (например, в [dbt Cloud CLI](/docs/cloud/cloud-cli-installation)), а не в IDE dbt Cloud: 

1. Создайте новые конфигурации семантической модели в виде YAML файлов в вашем проекте dbt.*
1. Обновите конфигурации метрик в вашем проекте до новой спецификации.* 
1. Удалите ваш старый файл метрик или уберите расширение `.yml`, чтобы они игнорировались во время парсинга. Удалите пакет `dbt-metrics` из вашего проекта. Удалите любые макросы, которые ссылаются на `dbt-metrics`, такие как `metrics.calculate()`. Убедитесь, что используемые вами пакеты не ссылаются на старую спецификацию метрик. 
1. Установите [dbt Cloud CLI](/docs/cloud/cloud-cli-installation) для выполнения команд MetricFlow и определения конфигураций вашей семантической модели.
   - Если вы используете dbt Core, установите [MetricFlow CLI](/docs/build/metricflow-commands) с помощью команды `python -m pip install "dbt-metricflow[your_adapter_name]"`. Например: 

    ```bash
    python -m pip install "dbt-metricflow[snowflake]"
    ```
    **Примечание** - Команды MetricFlow в данный момент не поддерживаются в IDE dbt Cloud.

2. Выполните команду `dbt parse`. Это парсит ваш проект и создает файл `semantic_manifest.json` в вашей целевой директории. MetricFlow нуждается в этом файле для запроса метрик. Если вы внесете изменения в ваши конфигурации, вам нужно будет снова распарсить ваш проект. 
3. Выполните команду `mf list metrics`, чтобы просмотреть метрики в вашем проекте.
4. Протестируйте запрос метрики, выполнив команду `mf query --metrics <metric_name> --group-by <dimensions_name>`. Например:
    ```bash
    mf query --metrics revenue --group-by metric_time
    ```
5. Выполните команду `mf validate-configs`, чтобы провести семантические и складские проверки. Это гарантирует, что ваши конфигурации действительны и что соответствующие объекты существуют в вашем складе. 
6. Отправьте эти изменения в новую ветку в вашем репозитории.

:::info `ref` не поддерживается
API слоя семантики dbt не поддерживает `ref` для вызова объектов dbt. Это связано с различиями в архитектуре между устаревшим слоем семантики и вновь выпущенным слоем семантики. Вместо этого используйте полное квалифицированное имя таблицы. Если вы используете макросы dbt во время запроса для вычисления ваших метрик, вам следует перенести эти вычисления в определения метрик вашего слоя семантики в виде кода.
:::

**Чтобы упростить этот процесс, dbt Labs предоставляет [инструмент для миграции](https://github.com/dbt-labs/dbt-converter), который автоматизирует эти шаги для вас. Инструкции по установке можно найти в [README](https://github.com/dbt-labs/dbt-converter/blob/master/README.md). Производные метрики не поддерживаются в инструменте миграции и должны быть мигрированы вручную.*

## Аудит значений метрик после миграции

Вам может потребоваться провести аудит значений метрик во время миграции, чтобы убедиться, что исторические значения ключевых бизнес-метрик совпадают.

1. В CLI запросите метрики и размеры, которые вы хотите протестировать, и добавьте опцию `--explain`. Например:
    ```bash 
    mf query --metrics orders,revenue --group-by metric_time__month,customer_type --explain
    ``` 
1. Используйте SQL MetricFlow для создания временной модели в вашем проекте, например `tmp_orders_revenue audit.sql`. Вы будете использовать эту временную модель для сравнения с вашими устаревшими метриками.
1. Если вы еще этого не сделали, создайте модель, используя `metrics.calculate()`, для метрик, с которыми вы хотите сравнить. Например: 

    ```bash
    select * 
    from {{ metrics.calculate(  
    [metric('orders'),
    metric('revenue')],
        grain='week',
        dimensions=['metric_time', 'customer_type'],
    ) }}
    ```

1. Запустите помощник [dbt-audit](https://github.com/dbt-labs/dbt-audit-helper) на обеих моделях, чтобы сравнить значения метрик.

## Настройка слоя семантики в новой среде

Этот шаг актуален только для пользователей, которые хотят, чтобы устаревший и новый слои семантики работали параллельно в течение короткого времени. Это позволит вам воссоздать контент в downstream-инструментах, таких как Hex и Mode, с минимальным временем простоя. Если вам не нужно воссоздавать активы в этих инструментах, перейдите к шагу 5.

1. Создайте новую среду развертывания в dbt Cloud и установите версию dbt на 1.6 или выше.
   
2. Выберите **Только запуск на пользовательской ветке** и укажите ветку, в которой определены обновленные метрики.

3. Установите схему развертывания на временную схему миграции, такую как `tmp_sl_migration`. По желанию, вы можете создать новую базу данных для миграции. 

4. Создайте задачу для парсинга вашего проекта, например `dbt parse`, и выполните ее. Убедитесь, что эта задача завершилась успешно. В вашей среде должна быть успешная задача для настройки слоя семантики.

5. Выберите **Настройки аккаунта** -> **Проекты** -> **Детали проекта** и выберите **Настроить слой семантики**. 

6. В разделе **Среда** выберите созданную вами в предыдущем шаге среду развертывания. Сохраните вашу конфигурацию.

7. На странице **Детали проекта** нажмите **Сгенерировать токен службы** и предоставьте ему разрешения **Только слой семантики** и **Только метаданные**. Сохраните этот токен в безопасном месте. Он понадобится вам для подключения к слою семантики. 

На этом этапе оба слоя семантики — новый и старый — будут работать. Новый слой семантики будет указывать на вашу ветку миграции с обновленными определениями метрик. 

## Обновите соединение в downstream-интеграциях

Теперь, когда ваш слой семантики настроен, вам нужно будет обновить любые downstream-интеграции, которые использовали устаревший слой семантики. 

### Руководство по миграции для Hex 

Чтобы узнать больше о интеграции с Hex, ознакомьтесь с их [документацией](https://learn.hex.tech/docs/connect-to-data/data-connections/dbt-integration#dbt-semantic-layer-integration) для получения дополнительной информации. Кроме того, обратитесь к [ячейкам слоя семантики dbt](https://learn.hex.tech/docs/logic-cell-types/transform-cells/dbt-metrics-cells), чтобы настроить SQL ячейки в Hex. 

1. Настройте новое соединение для слоя семантики dbt для вашего аккаунта. Обратите внимание, что ваше устаревшее соединение все еще будет работать.

2. Воссоздайте панели инструментов или отчеты, которые используют устаревший слой семантики dbt. 

3. Для получения конкретных деталей синтаксиса SQL обратитесь к [Запросу API для метаданных метрик](/docs/dbt-cloud-apis/sl-jdbc#querying-the-api-for-metric-metadata) для запроса метрик с использованием API.

   * **Примечание** &mdash; Вам нужно будет обновить ваше соединение с вашей производственной средой, как только вы объедините ваши изменения с основной веткой. В данный момент это соединение будет указывать на среду миграции слоя семантики.

### Руководство по миграции для Mode

1. Настройте новое соединение для слоя семантики для вашего аккаунта. Следуйте [документации Mode для настройки вашего соединения](https://mode.com/help/articles/supported-databases/#dbt-semantic-layer).

2. Воссоздайте панели инструментов или отчеты, которые используют устаревший слой семантики dbt. 

3. Для получения конкретных деталей синтаксиса SQL обратитесь к [Запросу API для метаданных метрик](/docs/dbt-cloud-apis/sl-jdbc#querying-the-api-for-metric-metadata) для запроса метрик с использованием API.
   
## Объедините вашу ветку миграции метрик с основной веткой и обновите вашу производственную среду до версии 1.6.

1. Обновите вашу производственную среду до версии 1.6 или выше. 
   * **Примечание** &mdash; Старые определения метрик больше не действительны, поэтому ваши задачи dbt не пройдут. 

2. Объедините ваши обновленные определения метрик с основной веткой. **На этом этапе устаревший слой семантики больше не будет работать.**

Если вы создали новую среду в [Шаге 3](#step-3-setup-the-semantic-layer-in-a-new-environment):

3. Обновите вашу среду в **Настройки аккаунта** -> **Детали проекта** -> **Редактировать конфигурацию слоя семантики**, чтобы указать на вашу производственную среду.

4. Удалите вашу среду миграции. Обязательно обновите детали соединения в любых downstream-инструментах, чтобы учесть изменение среды.

### Связанные документы 

- [Руководство по быстрому старту с слоем семантики dbt](/guides/sl-snowflake-qs)
- [Часто задаваемые вопросы по слою семантики dbt](/docs/use-dbt-semantic-layer/sl-faqs)
- [Конвертер метрик dbt](https://github.com/dbt-labs/dbt-converter)
- [Почему мы снимаем поддержку пакета dbt_metrics](/blog/deprecating-dbt-metrics) блог пост
- [Синтаксис запросов API слоя семантики dbt](/docs/dbt-cloud-apis/sl-jdbc#querying-the-api-for-metric-metadata) 
- [Курс по слою семантики dbt по запросу](https://learn.getdbt.com/courses/semantic-layer)

</div>