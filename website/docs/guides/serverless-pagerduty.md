---
title: "Запуск сигналов PagerDuty при сбоях заданий dbt Cloud"
id: serverless-pagerduty 
description: Используйте вебхуки для настройки безсерверного приложения, которое будет запускать сигналы PagerDuty.
hoverSnippet: Узнайте, как настроить безсерверное приложение, использующее вебхуки для запуска сигналов PagerDuty.
# time_to_complete: '30 минут' закомментировано до тестирования
icon: 'guides'
hide_table_of_contents: true
tags: ['Вебхуки']
level: 'Продвинутый'
recently_updated: true
---

<div style={{maxWidth: '900px'}}>

## Введение

Этот гид научит вас, как создать и разместить простое приложение на Python, которое будет отслеживать задания dbt Cloud и создавать сигналы PagerDuty на основе сбоев. Для этого, когда задание dbt Cloud завершится, оно:
 - Проверит наличие неудачных узлов (например, не прошедших тестов или моделей с ошибками), и
 - создаст сигнал PagerDuty на основе этих узлов, вызвав API событий PagerDuty. События дублируются по идентификатору запуска.

![Скриншот интерфейса PagerDuty, показывающий сигнал, созданный из-за некорректного SQL в модели dbt](/img/guides/orchestration/webhooks/serverless-pagerduty/pagerduty-example-alarm.png)

В этом примере мы будем использовать fly.io для размещения/запуска сервиса. fly.io — это платформа для запуска полнофункциональных приложений без необходимости вProvisioning серверов и т.д. Этот уровень использования должен удобно вписываться в бесплатный тариф. Вы также можете использовать альтернативные инструменты, такие как [AWS Lambda](https://adem.sh/blog/tutorial-fastapi-aws-lambda-serverless) или [Google Cloud Run](https://github.com/sekR4/FastAPI-on-Google-Cloud-Run).

### Предварительные требования

Этот гид предполагает некоторую знакомость с:
- [Вебхуками dbt Cloud](/docs/deploy/webhooks)
- CLI-приложениями
- Развертыванием кода на безсерверном кодовом исполнителе, таком как fly.io или AWS Lambda


## Клонирование репозитория `dbt-cloud-webhooks-pagerduty`

[Этот репозиторий](https://github.com/dpguthrie/dbt-cloud-webhooks-pagerduty) содержит пример кода для проверки вебхука и создания событий в PagerDuty.


## Установка `flyctl` и регистрация на fly.io

Следуйте инструкциям для вашей операционной системы в [документации fly.io](https://fly.io/docs/hands-on/install-flyctl/), затем из командной строки выполните следующие команды: 

Перейдите в директорию, содержащую репозиторий, который вы клонировали на шаге 1:
```shell
#пример: замените на ваш фактический путь
cd ~/Documents/GitHub/dbt-cloud-webhooks-pagerduty
```

Зарегистрируйтесь на fly.io:
```shell
flyctl auth signup
```

Ваша консоль должна показать `успешно вошли как YOUR_EMAIL`, когда вы закончите, но если этого не произошло, войдите в fly.io из командной строки:
```shell
flyctl auth login
```

## Запуск вашего приложения на fly.io
Запуск вашего приложения публикует его в интернете и делает готовым к приему событий вебхука:
```shell
flyctl launch
```

Вы увидите сообщение о том, что был найден существующий файл `fly.toml`. Введите `y`, чтобы скопировать его конфигурацию в ваше новое приложение. 

Выберите имя приложения по вашему выбору, например `YOUR_COMPANY-dbt-cloud-webhook-pagerduty`, или оставьте пустым, и оно будет сгенерировано для вас. Обратите внимание, что ваше имя может содержать только цифры, строчные буквы и дефисы.

Выберите регион развертывания и запомните сгенерированное имя хоста (обычно `APP_NAME.fly.dev`). 

Когда вас спросят, хотите ли вы настроить базы данных Postgresql или Redis, введите `n` для каждой.

Введите `y`, когда вас спросят, хотите ли вы развернуть сейчас.

<details>
<summary>Пример вывода из мастера настройки:</summary>
<code>
joel@Joel-Labes dbt-cloud-webhooks-pagerduty % flyctl launch<br/>
Был найден существующий файл fly.toml для приложения dbt-cloud-webhooks-pagerduty<br/>
? Хотите ли вы скопировать его конфигурацию в новое приложение? Да<br/>
Создание приложения в /Users/joel/Documents/GitHub/dbt-cloud-webhooks-pagerduty<br/>
Сканирование исходного кода<br/>
Обнаружено приложение Dockerfile<br/>
? Выберите имя приложения (оставьте пустым для генерации): demo-dbt-cloud-webhook-pagerduty<br/>
автоматически выбрана личная организация: Joel Labes<br/>
Некоторые регионы требуют платного плана (fra, maa).<br/>
Смотрите https://fly.io/plans для настройки плана.<br/>
? Выберите регион для развертывания:  [Используйте стрелки для перемещения, введите для фильтрации]<br/>
? Выберите регион для развертывания: Сидней, Австралия (syd)<br/>
Создано приложение dbtlabs-dbt-cloud-webhook-pagerduty в организации личной<br/>
URL администратора: https://fly.io/apps/demo-dbt-cloud-webhook-pagerduty<br/>
Имя хоста: demo-dbt-cloud-webhook-pagerduty.fly.dev<br/>
? Хотите ли вы настроить базу данных Postgresql сейчас? Нет<br/>
? Хотите ли вы настроить базу данных Upstash Redis сейчас? Нет<br/>
Записан файл конфигурации fly.toml<br/>
? Хотите ли вы развернуть сейчас? Да
</code>
</details>

## Создание интеграционного приложения PagerDuty
Смотрите [руководство PagerDuty](https://developer.pagerduty.com/docs/ZG9jOjExMDI5NTgw-events-api-v2-overview#getting-started) для получения полных инструкций. 

Запомните ключ интеграции для дальнейшего использования. 

## Настройка нового вебхука в dbt Cloud
Смотрите [Создание подписки на вебхук](/docs/deploy/webhooks#create-a-webhook-subscription) для получения полных инструкций. Ваше событие должно быть **Запуск завершен**.

Установите URL вебхука на имя хоста, которое вы создали ранее (`APP_NAME.fly.dev`)

Запомните секретный ключ вебхука для дальнейшего использования.

*Не тестируйте конечную точку*; она не будет работать, пока вы не сохранили ключи аутентификации (следующий шаг)

## Хранение секретов
Приложение требует установки трех секретов с использованием следующих имен:
- `DBT_CLOUD_SERVICE_TOKEN`: личный токен доступа dbt Cloud [personal access token](https://docs.getdbt.com/docs/dbt-cloud-apis/user-tokens) или [токен сервисной учетной записи](https://docs.getdbt.com/docs/dbt-cloud-apis/service-tokens) с как минимум разрешением `Только метаданные`.
- `DBT_CLOUD_AUTH_TOKEN`: секретный ключ для вебхука dbt Cloud, который вы создали ранее.
- `PD_ROUTING_KEY`: ключ интеграции для интеграции PagerDuty, которую вы создали ранее.

Установите эти секреты следующим образом, заменив `abc123` и т.д. на фактические значения:
```shell
flyctl secrets set DBT_CLOUD_SERVICE_TOKEN=abc123 DBT_CLOUD_AUTH_TOKEN=def456 PD_ROUTING_KEY=ghi789
```

## Развертывание вашего приложения

После установки секретов fly.io повторно развернет ваше приложение. Когда оно успешно завершится, вернитесь к настройкам вебхука dbt Cloud и нажмите **Тестировать конечную точку**.

</div>