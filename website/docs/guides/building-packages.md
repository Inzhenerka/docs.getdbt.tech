---
title: Создание пакетов dbt
id: building-packages
description: "Когда у вас есть код dbt, который может помочь другим, вы можете создать пакет для dbt, используя репозиторий GitHub."
displayText: Создание пакетов dbt
hoverSnippet: Узнайте, как создавать пакеты для dbt.
# time_to_complete: '30 минут' закомментировано до тестирования
icon: 'guides'
hide_table_of_contents: true
tags: ['dbt Core']
level: 'Продвинутый'
recently_updated: true
---

<div style={{maxWidth: '900px'}}>

## Введение

Создание пакетов — это **продвинутое использование dbt**. Если вы новичок в этом инструменте, мы рекомендуем сначала использовать продукт для своей аналитики, прежде чем пытаться создать пакет для других.

### Предварительные требования

Необходимы глубокие знания:
- [пакетов](/docs/build/packages)
- администрирования репозитория на GitHub
- [семантического версионирования](https://semver.org/)

### Оцените, является ли пакет правильным решением
Пакеты обычно содержат либо:
- макросы, которые решают конкретную задачу в области аналитического проектирования — например, [аудит результатов запроса](https://hub.getdbt.com/dbt-labs/audit_helper/latest/), [генерация кода](https://hub.getdbt.com/dbt-labs/codegen/latest/) или [добавление дополнительных тестов схемы в проект dbt](https://hub.getdbt.com/calogica/dbt_expectations/latest/).
- модели для общих наборов данных — например, набор данных для программного обеспечения, такого как [MailChimp](https://hub.getdbt.com/fivetran/mailchimp/latest/) или [Snowplow](https://hub.getdbt.com/dbt-labs/snowplow/latest/), или даже модели для метаданных о вашем стеке данных, таких как [расходы на запросы Snowflake](https://hub.getdbt.com/gitlabhq/snowflake_spend/latest/) и [артефакты, созданные с помощью `dbt run`](https://hub.getdbt.com/tailsdotcom/dbt_artifacts/latest/). В общем, должны быть общие наборы стандартных метрик отрасли, которые вы можете смоделировать (например, коэффициент открытия электронной почты).

Пакеты _не_ подходят для обмена моделями, содержащими бизнес-специфическую логику, например, написание кода для атрибуции маркетинга или ежемесячного повторяющегося дохода. Вместо этого рассмотрите возможность публикации блога и ссылки на пример репозитория, а не упаковки этого кода в пакет (вот наш блог о [маркетинговой атрибуции](https://blog.getdbt.com/modeling-marketing-attribution/) в качестве примера).

## Создайте свой новый проект
:::note Использование командной строки для разработки пакетов
Мы обычно используем интерфейс командной строки для разработки пакетов. Рабочий процесс разработки часто включает установку локальной копии вашего пакета в другом проекте dbt — в настоящее время dbt Cloud не предназначен для этого рабочего процесса.
:::

1. Используйте команду [dbt init](/reference/commands/init) для создания нового проекта dbt, который будет вашим пакетом:
```shell
$ dbt init [package_name]
```
2. Создайте публичный репозиторий GitHub¹ с именем `dbt-<package-name>`, например, `dbt-mailchimp`. Следуйте инструкциям GitHub, чтобы связать его с проектом dbt, который вы только что создали.
3. Обновите `name:` проекта в `dbt_project.yml` на имя вашего пакета, например, `mailchimp`.
4. Определите допустимые версии dbt, используя конфигурацию [`require-dbt-version`](/reference/project-configs/require-dbt-version).

¹В настоящее время наш реестр пакетов поддерживает только пакеты, размещенные на GitHub.

## Разработка вашего пакета
Мы рекомендуем авторам пакетов, которые делают это впервые, сначала разрабатывать макросы и модели для использования в своем собственном проекте dbt. После создания вашего нового пакета вы можете приступить к переносу их, реализуя некоторые дополнительные специфические для пакета шаблоны проектирования по пути.

При работе над вашим пакетом мы часто находим полезным установить локальную копию пакета в другом проекте dbt — этот рабочий процесс описан [здесь](https://discourse.getdbt.com/t/contributing-to-an-external-dbt-package/657).

### Следуйте лучшим практикам
_Только для моделирования пакетов_

Используйте наши [конвенции кодирования dbt](https://github.com/dbt-labs/corp/blob/main/dbt_style_guide.md), нашу статью о [том, как мы структурируем наши проекты dbt](https://docs.getdbt.com/best-practices/how-we-structure/1-guide-overview) и наши [лучшие практики](/best-practices) для всех наших советов о том, как построить ваш проект dbt.

Здесь особенно полезно, если вы ранее работали над своим собственным проектом dbt.

### Сделайте местоположение сырых данных настраиваемым
_Только для моделирования пакетов_

Не каждый пользователь вашего пакета будет хранить свои данные Mailchimp в схеме с именем `mailchimp`. Поэтому вам нужно сделать местоположение сырых данных настраиваемым.

Мы рекомендуем использовать [sources](/docs/build/sources) и [variables](/docs/build/project-variables) для достижения этой цели. Ознакомьтесь с [этим пакетом](https://github.com/fivetran/dbt_facebook_ads_source/blob/main/models/src_facebook_ads.yml#L5-L6) для примера — особенно README [включает инструкции](https://github.com/fivetran/dbt_facebook_ads_source#configuration) о том, как переопределить схему по умолчанию из файла `dbt_project.yml`.

### Установите пакеты из hub.getdbt.com

Если ваш пакет зависит от другого пакета (например, вы используете некоторые макросы кросс-базы данных из [dbt-utils](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/)), мы рекомендуем установить пакет из [hub.getdbt.com](https://hub.getdbt.com), указав диапазон версий следующим образом:

<File name='packages.yml'>

```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: [">0.6.5", "0.7.0"]
```

</File>

Когда пакеты устанавливаются из hub.getdbt.com, dbt может обрабатывать дублирующиеся зависимости.

### Реализуйте совместимость между базами данных

Многие функции SQL специфичны для определенной базы данных. Например, имя функции и порядок аргументов для вычисления разницы между двумя датами различаются между Redshift, Snowflake и BigQuery, и аналогичной функции не существует в Postgres!

Если вы хотите поддерживать несколько хранилищ, у нас есть несколько приемов:
- Мы написали несколько макросов, которые компилируются в действительные фрагменты SQL для каждого из четырех оригинальных адаптеров. По возможности используйте эти макросы.
- Если вам нужно реализовать совместимость между базами данных для одного из ваших макросов, используйте макрос [`adapter.dispatch`](/reference/dbt-jinja-functions/dispatch) для достижения этой цели. Ознакомьтесь с кросс-базовыми макросами в dbt-utils для примеров.
- Если вы работаете над пакетом моделирования, вы можете заметить, что вам нужно писать разные модели для каждого хранилища (например, если инструмент EL, с которым вы работаете, хранит данные по-разному в каждом хранилище). В этом случае вы можете написать разные версии каждой модели и использовать конфигурацию [`enabled`](/reference/resource-configs/enabled) в сочетании с [`target.type`](/reference/dbt-jinja-functions/target), чтобы включить правильные модели — ознакомьтесь с [этим пакетом](https://github.com/fivetran/dbt_facebook_ads_creative_history/blob/main/dbt_project.yml#L11-L16) в качестве примера.

Если ваш пакет был написан только для работы с одним <Term id="data-warehouse" />, убедитесь, что вы задокументировали это в README вашего пакета.

### Используйте специфические имена моделей
_Только для моделирования пакетов_

Многие наборы данных имеют концепцию "пользователя", "аккаунта" или "сессии". Чтобы избежать неоднозначности в dbt, добавляйте префикс ко всем вашим моделям в формате `[package_name]_`. Например, `mailchimp_campaigns.sql` — хорошее имя для модели, в то время как `campaigns.sql` — нет.

### По умолчанию используйте представления
_Только для моделирования пакетов_

dbt позволяет пользователям вашего пакета переопределять настройки <Term id="materialization" /> вашей модели. В общем, по умолчанию используйте материализацию моделей как `view`, а не `table`.

Основное исключение из этого правила — работа с источниками данных, которые выигрывают от инкрементного моделирования (например, просмотры веб-страниц). Реализация инкрементной логики от имени ваших конечных пользователей, вероятно, будет полезной в этом случае.

### Тестируйте и документируйте ваш пакет
Крайне важно, чтобы вы [тестировали](/docs/build/data-tests) свои модели и источники. Это даст вашим конечным пользователям уверенность в том, что ваш пакет действительно работает с их набором данных так, как задумано.

Кроме того, добавление [документации](/docs/build/documentation) через описания поможет донести информацию о вашем пакете до конечных пользователей и будет полезно их заинтересованным сторонам, использующим результаты этого пакета.

### Включите полезные артефакты GitHub
Со временем мы разработали набор полезных артефактов GitHub, которые упрощают администрирование наших пакетов. В частности, мы гарантируем, что включаем:
- Полезный README, который содержит:
    - инструкции по установке, ссылающиеся на последнюю версию пакета на hub.getdbt.com, и включает любые необходимые конфигурации ([пример](https://github.com/dbt-labs/segment))
    - Примеры использования для любых макросов ([пример](https://github.com/dbt-labs/dbt-audit-helper#macros))
    - Описания основных моделей, включенных в пакет ([пример](https://github.com/dbt-labs/snowplow))
- Шаблоны GitHub, включая шаблоны PR и шаблоны для проблем ([пример](https://github.com/dbt-labs/dbt-audit-helper/tree/master/.github))

## Добавьте интеграционные тесты
_Необязательно_

Мы рекомендуем вам реализовать интеграционные тесты, чтобы подтвердить, что пакет работает так, как ожидалось — это еще более _продвинутый_ шаг, поэтому вы можете постепенно к этому прийти.

Этот шаблон можно увидеть в большинстве пакетов, включая пакеты [`audit-helper`](https://github.com/dbt-labs/dbt-audit-helper/tree/master/integration_tests) и [`snowplow`](https://github.com/dbt-labs/snowplow/tree/master/integration_tests).

В качестве грубой рекомендации:

1. Создайте подкаталог с именем `integration_tests`
2. В этом подкаталоге создайте новый проект dbt — вы можете использовать команду `dbt init` для этого. Однако наш предпочтительный метод — скопировать файлы из существующего проекта `integration_tests`, например, из [здесь](https://github.com/dbt-labs/dbt-codegen/tree/HEAD/integration_tests) (удалив содержимое папок `macros`, `models` и `tests`, так как они специфичны для проекта)
3. Установите пакет в подкаталоге `integration_tests`, используя синтаксис `local`, а затем запустите `dbt deps`

<File name='packages.yml'>

```yml
packages:
    - local: ../ # это означает "на один уровень выше текущего каталога"
```

</File>

4. Добавьте ресурсы в пакет (семена, модели, тесты), чтобы вы могли успешно запустить свой проект и сравнить вывод с ожидаемым. Точный подход здесь будет варьироваться в зависимости от ваших пакетов. В общем, вы обнаружите, что вам нужно:
    - Добавить тестовые данные через [seed](/docs/build/seeds) с несколькими образцами (анонимизированными) записями. Настройте проект `integration_tests` так, чтобы он указывал на семена вместо таблиц сырых данных.
    - Добавить больше семян, которые представляют ожидаемый вывод ваших моделей, и использовать тест [dbt_utils.equality](https://github.com/dbt-labs/dbt-utils#equality-source), чтобы подтвердить, что вывод вашего пакета соответствует ожидаемому.

5. Подтвердите, что вы можете успешно запустить `dbt run` и `dbt test` из командной строки.

6. (Необязательно) Используйте инструмент CI, такой как CircleCI или GitHub Actions, чтобы автоматизировать запуск вашего проекта dbt при открытии нового Pull Request. Для вдохновения ознакомьтесь с одной из наших [конфигураций CircleCI](https://github.com/dbt-labs/snowplow/blob/main/.circleci/config.yml), которая запускает тесты против наших четырех основных хранилищ. Примечание: это продвинутый шаг — если вы идете по этому пути, вам может быть полезно поздороваться в [dbt Slack](https://community.getdbt.com/).

## Разверните документацию для вашего пакета
_Необязательно_

Сайт документации dbt может помочь потенциальному пользователю вашего пакета понять написанный вами код. Поэтому мы рекомендуем развернуть сайт, сгенерированный с помощью `dbt docs generate`, и связать его с развернутым сайтом из вашего пакета.

Самый простой способ, который мы нашли для этого, — использовать [GitHub Pages](https://pages.github.com/).

1. На новой ветке git выполните `dbt docs generate`. Если у вас настроены интеграционные тесты (выше), используйте проект интеграционного теста для этого.
2. Переместите следующие файлы в каталог с именем `docs` ([пример](https://github.com/fivetran/dbt_ad_reporting/tree/HEAD/docs)): `catalog.json`, `index.html`, `manifest.json`, `run_results.json`.
3. Объедините эти изменения в основную ветку.
4. Включите GitHub Pages в репозитории на вкладке настроек и укажите его на подкаталог "docs".
5. GitHub должен развернуть документацию по адресу `<org-name>.github.io/<repo-name>`, например: [fivetran.github.io/dbt_ad_reporting](https://fivetran.github.io/dbt_ad_reporting/)

## Выпустите ваш пакет
Создайте новый [релиз](https://docs.github.com/en/github/administering-a-repository/managing-releases-in-a-repository), когда будете готовы, чтобы другие могли использовать вашу работу! Обязательно используйте [семантическое версионирование](https://semver.org/) при именовании вашего релиза.

В частности, если новые изменения вызовут ошибки у пользователей более ранних версий пакета, обязательно используйте _по крайней мере_ минорный релиз (например, переходите с `0.1.1` на `0.2.0`).

В заметках о релизе должно быть общее описание изменений, введенных в новой версии. Обязательно укажите любые изменения, которые нарушают существующий интерфейс!

## Добавьте пакет в hub.getdbt.com

Наш реестр пакетов, [hub.getdbt.com](https://hub.getdbt.com/), обновляется с помощью [скрипта hubcap](https://github.com/dbt-labs/hubcap). Чтобы добавить ваш пакет в hub.getdbt.com, создайте PR в [репозиторий hubcap](https://github.com/dbt-labs/hubcap), чтобы включить его в файл `hub.json`.

</div>